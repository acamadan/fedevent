<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hotel Profile Registration</title>
<!-- BUILD: CREATA-SUITE 2025-08-11 v3 (localhost) -->
<style>
  :root { --bg:#f4f8fb; --card:#fff; --ink:#0b2545; --muted:#5b6b7b; --accent:#0a58ca; --danger:#dc3545; --ring:rgba(10,88,202,.25); }
  *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto 64px;padding:0 16px} .card{background:var(--card);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
  h1{font-size:1.6rem;margin:0 0 6px} p.lead{margin:0 0 16px;color:var(--muted)}
  fieldset{border:1px solid #e6ecf2;border-radius:12px;padding:14px;margin:16px 0} legend{padding:0 8px;color:var(--muted);font-size:.95rem}
  label{font-weight:600;font-size:.92rem;display:block;margin:8px 0 4px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
  input:not([type=file]):not([type=checkbox]):not([type=radio]),select{width:100%;padding:10px 12px;border:1px solid #d7dee6;border-radius:10px;background:#fff;font-size:1rem;line-height:1.2;height:44px;outline:0;transition:box-shadow .15s,border-color .15s}
  textarea{width:100%;padding:10px 12px;border:1px solid #d7dee6;border-radius:10px;background:#fff;font-size:1rem;outline:0;transition:box-shadow .15s,border-color .15s;min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
  .hint{color:var(--muted);font-size:.85rem;margin-top:2px} .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.subtle{background:#eef4ff;color:var(--accent)} .btn.danger{background:#dc3545} .btn:disabled{opacity:.55;cursor:not-allowed}
  .hr{height:1px;background:#e6ecf2;margin:12px 0} .item{border:1px solid #e6ecf2;border-radius:12px;padding:12px;margin-top:8px;background:#fafcff}
  .right{text-align:right} .required{color:var(--danger)}
  .steps{display:flex;gap:10px;align-items:center;margin:8px 0 4px;flex-wrap:wrap}
  .step{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600}
  .dot{width:28px;height:28px;border-radius:50%;display:inline-grid;place-items:center;background:#eef4ff;color:#0a58ca;font-weight:800}
  .step.active{color:var(--ink)} .step.active .dot{background:#0a58ca;color:#fff}
  .page{display:none} .page.active{display:block} .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
  .submitting{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(2px);z-index:10000}
  .submitting.show{display:flex}
  .panel{background:#fff;border:1px solid #e6ecf2;border-radius:12px;padding:14px 16px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:flex;gap:12px;align-items:center}
  .loader{width:36px;height:36px;border-radius:50%;border:3px solid #c5d6f3;border-top-color:#0a58ca;animation:spin 1s linear infinite} @keyframes spin{to{transform:rotate(360deg)}}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2545;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:10001}
  .muted{color:var(--muted);font-size:.9rem}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 720px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Hotel Profile Registration</h1>
    <p class="lead">Complete this profile so we can match your property to U.S. Government group events. <strong>NET30 payment terms and PO acceptance are required.</strong></p>

    <div class="steps" id="steps">
      <div class="step" data-step="0"><span class="dot">0</span> Start</div>
      <div class="step" data-step="1"><span class="dot">1</span> Company & Terms</div>
      <div class="step" data-step="2"><span class="dot">2</span> Logistics & Policies</div>
      <div class="step" data-step="3"><span class="dot">3</span> Rooms & Spaces + Rates</div>
      <div class="step" data-step="4"><span class="dot">4</span> Uploads & Submit</div>
    </div>

    <form id="hotel-form" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="form_type" value="hotel_profile_v2">

      <!-- PAGE 0 -->
      <div class="page active" data-page="0">
        <fieldset>
          <legend>Start</legend>
          <div class="grid2">
            <div class="item">
              <label class="inline" style="gap:10px">
                <input type="radio" name="start_mode" value="guest" checked>
                <span><b>Continue as Guest</b></span>
              </label>
              <p class="muted">No login required. You can create an account later to edit your profile.</p>
            </div>
            <div class="item">
              <label class="inline" style="gap:10px">
                <input type="radio" name="start_mode" value="account">
                <span><b>Create an Account</b></span>
              </label>
              <div id="signupBox" style="display:none;margin-top:8px">
                <label>Email</label><input type="email" id="su_email" placeholder="name@hotel.com">
                <label>Username</label><input id="su_user" placeholder="your-username">
                <label>Password</label><input type="password" id="su_pass" placeholder="••••••••">
                <button type="button" class="btn" id="btnSignup">Create account</button>
                <div class="hint">We’ll email a confirmation link. We only work with <strong>NET30 + Government PO</strong>.</div>
              </div>
            </div>
            <div class="item">
              <label class="inline" style="gap:10px">
                <input type="radio" name="start_mode" value="signin">
                <span><b>Sign In</b></span>
              </label>
              <div id="signinBox" style="display:none;margin-top:8px">
                <label>Email or Username</label><input id="si_user" placeholder="email or username">
                <label>Password</label><input type="password" id="si_pass" placeholder="••••••••">
                <button type="button" class="btn" id="btnSignin">Sign in</button>
                <div class="hint"><a href="#" id="forgotLink">Forgot password?</a></div>
              </div>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 1 -->
      <div class="page" data-page="1">
        <fieldset>
          <legend>1) Property Identity</legend>
          <div class="item">
            <label>Upload facts sheet / presentation to autofill (PDF, DOCX, PPTX)</label>
            <input type="file" id="autofillFile" accept=".pdf,.doc,.docx,.ppt,.pptx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.presentationml.presentation" />
            <button type="button" class="btn subtle" id="btnAutofill">Autofill from file</button>
            <div class="hint">Best with DOCX/PPTX or text-based PDFs. Scanned PDFs require OCR (optional).</div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col-6"><label>Hotel Name <span class="required">*</span></label><input name="hotel_name" required /></div>
            <div class="col-3"><label>Brand</label><input name="brand" /></div>
            <div class="col-3"><label>Chain</label><input name="chain" /></div>
            <div class="col-6"><label>Management Company</label><input name="management_company" /></div>
            <div class="col-6"><label>Website</label><input type="url" name="website" placeholder="https://"/></div>
            <div class="col-6"><label>Street Address <span class="required">*</span></label><input name="address" required /></div>
            <div class="col-3"><label>City <span class="required">*</span></label><input name="city" required /></div>
            <div class="col-3"><label>State / Province</label><input name="state" /></div>
            <div class="col-3"><label>Postal Code</label><input name="zip" /></div>
            <div class="col-3"><label>Country <span class="required">*</span></label><input name="country" required /></div>
            <div class="col-3"><label>Year Built</label><input type="number" name="year_built" min="1900" max="2100" /></div>
            <div class="col-3"><label>Last Renovation (Year)</label><input type="number" name="last_renovation" min="1900" max="2100" /></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>2) Primary Contacts</legend>
          <div class="row">
            <div class="col-4">
              <label>Sales Director Name <span class="required">*</span></label><input name="sales_director_name" required />
              <label>Email <span class="required">*</span></label><input type="email" name="sales_director_email" required />
              <label>Phone</label><input type="tel" name="sales_director_phone" />
            </div>
            <div class="col-4">
              <label>Conference Services (CSM) Name</label><input name="csm_name" />
              <label>Email</label><input type="email" name="csm_email" />
              <label>Phone</label><input type="tel" name="csm_phone" />
            </div>
            <div class="col-4">
              <label>Billing / AR Contact <span class="required">*</span></label><input name="ar_name" required />
              <label>AR Email <span class="required">*</span></label><input type="email" name="ar_email" required />
              <label>AR Phone</label><input type="tel" name="ar_phone" />
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>3) Payment & Compliance</legend>
          <div class="row">
            <div class="col-4">
              <label>Accepts NET30 (CREATA prime)? <span class="required">*</span></label>
              <select name="accepts_net30" id="accepts_net30" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
            </div>
            <div class="col-4">
              <label>Accepts Purchase Orders (PO)? <span class="required">*</span></label>
              <select name="accepts_po" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
            </div>
            <div class="col-4"><label>Invoice Submission Email</label><input type="email" name="invoice_email" placeholder="invoices@hotel.com" /></div>
            <div class="col-12">
              <div class="inline"><input id="terms_ack" type="checkbox" required />
                <label for="terms_ack" style="font-weight:500">I acknowledge that <strong>NET30</strong> is required and CREATA issues a Government-backed <strong>PO</strong>.</label>
              </div>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 2 -->
      <div class="page" data-page="2">
        <fieldset>
          <legend>4) Catering</legend>
          <div class="row">
            <div class="col-4"><label>On-Site Kitchen</label><select name="onsite_kitchen"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Outside Catering Allowed</label><select name="outside_catering"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Special Diets</label><input name="special_diets" placeholder="Halal, Kosher, Vegan, etc." /></div>
            <div class="col-6"><label>F&amp;B Minimums</label><input name="fb_minimums" placeholder="e.g., $15,000/day in ballroom" /></div>
            <div class="col-6"><label>Liquor License</label><select name="liquor_license"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>5) Logistics, Security & Accessibility</legend>
          <div class="row">
            <div class="col-4"><label>Bus / Motorcoach Parking</label><input name="bus_parking" /></div>
            <div class="col-4"><label>Loading Dock / Freight Elevator</label><input name="freight" /></div>
            <div class="col-4"><label>Security</label><input name="security" /></div>
            <div class="col-4"><label>ADA Features</label><input name="ada_features" /></div>
            <div class="col-4"><label>EV Chargers (qty/type)</label><input name="ev_chargers" /></div>
            <div class="col-4">
              <label>Childcare via Third-Party? <span class="required">*</span></label>
              <select name="childcare_third_party" required><option value="">Select…</option><option>Yes – Hotel arranges</option><option>Yes – Referral list only</option><option>No</option></select>
            </div>
            <div class="col-12"><label>Childcare Provider Details</label><input name="childcare_notes" placeholder="Providers, certifications, hours, ratios" /></div>
            <div class="col-4"><label>Union Status</label><select name="union_status"><option value="">Select…</option><option>Union</option><option>Non-Union</option><option>Hybrid</option></select></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>6) Blackout Dates</legend>
          <textarea name="blackout_dates" placeholder="List known blackout dates or citywides. "></textarea>
        </fieldset>
      </div>

      <!-- PAGE 3 -->
      <div class="page" data-page="3">
        <fieldset>
          <legend>7) Sleeping Rooms Inventory</legend>
          <div class="row">
            <div class="col-3"><label>Total Guest Rooms</label><input type="number" name="total_rooms" min="0" /></div>
            <div class="col-3"><label>Kings</label><input type="number" name="king_rooms" min="0" /></div>
            <div class="col-3"><label>Doubles / Queens</label><input type="number" name="double_rooms" min="0" /></div>
            <div class="col-3"><label>Suites</label><input type="number" name="suites" min="0" /></div>
            <div class="col-3"><label>Accessible (ADA) Rooms</label><input type="number" name="ada_rooms" min="0" /></div>
            <div class="col-3"><label>Max Group Block (rooms)</label><input type="number" name="max_group_block" min="0" /></div>
            <div class="col-3"><label>Comp Room Ratio</label><input name="comp_ratio" placeholder="e.g., 1:40" /></div>
            <div class="col-3"><label>Cutoff (days)</label><input type="number" name="cutoff_days" min="0" /></div>
            <div class="col-12">
              <label>Breakfast Included?</label>
              <select name="breakfast_included"><option value="">Select…</option><option>Yes – Full</option><option>Yes – Continental</option><option>No</option></select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>8) Extended Stay</legend>
          <div class="row">
            <div class="col-12">
              <label>Is your property an Extended Stay hotel? <span class="required">*</span></label>
              <select name="is_extended_stay" id="is_extended_stay" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
              <div class="hint">If Yes, more questions appear below.</div>
            </div>
          </div>
        </fieldset>

        <fieldset id="extendedStaySection" style="display:none;">
          <legend>8b) Extended Stay Amenities</legend>
          <div class="row">
            <div class="col-4"><label>In-Room Kitchen <span class="required">*</span></label><select name="ext_kitchen" data-es-required="1"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Fully Equipped? <span class="required">*</span></label><select name="ext_kitchen_equipped" data-es-required="1"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Washer / Dryer <span class="required">*</span></label><select name="ext_washer_dryer" data-es-required="1"><option value="">Select…</option><option>In-room</option><option>On-site – self-service</option><option>On-site – valet</option><option>None</option></select></div>
            <div class="col-4"><label>Stovetop</label><select name="ext_equipment_stovetop"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Oven</label><select name="ext_equipment_oven"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Microwave</label><select name="ext_equipment_microwave"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Refrigerator</label><select name="ext_equipment_fridge"><option value="">Select…</option><option>Full-size</option><option>Mid-size</option><option>Mini</option></select></div>
            <div class="col-4"><label>Dishwasher</label><select name="ext_equipment_dishwasher"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Cookware & Utensils</label><select name="ext_equipment_cookware"><option value="">Select…</option><option>Yes – Full set</option><option>Yes – Basic</option><option>No</option></select></div>
            <div class="col-6"><label>Laundry Details / Cost</label><input name="ext_laundry_cost_notes" /></div>
            <div class="col-6"><label>Housekeeping Frequency</label><input name="ext_housekeeping_frequency" /></div>
            <div class="col-6"><label>Long-Stay Rate Options</label><input name="ext_long_stay_rates" /></div>
            <div class="col-3"><label>Pet Friendly</label><select name="ext_pet_friendly"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-9"><label>Pet Policy / Fees</label><input name="ext_pet_notes" /></div>
            <div class="col-4"><label>On-site Market/Pantry</label><select name="ext_market_pantry"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Grocery Delivery Partnership</label><select name="ext_grocery_delivery"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Grocery Partner</label><input name="ext_grocery_partner" /></div>
            <div class="col-4"><label>Ventilated Range Hood</label><select name="ext_kitchen_ventilation"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Fire Suppression at Cooktop</label><select name="ext_fire_suppression"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Cooking Restrictions</label><input name="ext_cooking_restrictions" /></div>
            <div class="col-12"><label>Notes (Extended Stay)</label><textarea name="ext_extended_stay_notes"></textarea></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>9) Meeting Spaces</legend>
          <div class="inline">
            <button class="btn subtle" type="button" id="addRoomBtn">+ Add Meeting Space</button>
            <span class="hint">Add each room with dimensions and capacities.</span>
          </div>
          <div id="rooms"></div>
        </fieldset>

        <fieldset>
          <legend>10) Rates & Fees</legend>
          <div class="row">
            <div class="col-4"><label>Accepts U.S. Government Per Diem?</label>
              <select name="accepts_per_diem"><option value="">Select…</option><option>Yes – Year-round</option><option>Yes – Seasonal</option><option>No</option></select>
            </div>
            <div class="col-4"><label>Resort / Destination Fee</label><input name="resort_fee" /></div>
            <div class="col-4"><label>Taxes (Total %)</label><input name="tax_percent" placeholder="e.g., 14.5%" /></div>
            <div class="col-4"><label>Self-Parking Fee</label><input name="self_parking" /></div>
            <div class="col-4"><label>Valet Parking Fee</label><input name="valet_parking" /></div>
            <div class="col-4"><label>In-Room Wi-Fi Fee</label><input name="wifi_fee" /></div>
            <div class="col-6"><label>Attrition Policy</label><input name="attrition_policy" /><div class="hint"><strong>Decision Note:</strong> No attrition is prioritized.</div></div>
            <div class="col-6"><label>Cancellation Policy</label><input name="cancellation_policy" /><div class="hint"><strong>Decision Note:</strong> No cancellation penalties are favored.</div></div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 4 -->
      <div class="page" data-page="4">
        <fieldset>
          <legend>11) Uploads</legend>
          <div class="row">
            <div class="col-6"><label>Hotel Fact Sheet (PDF)</label><input type="file" name="fact_sheet" accept="application/pdf" /></div>
            <div class="col-6"><label>Floor Plans / Diagrams (PDF, multiple)</label><input type="file" name="floor_plans" accept="application/pdf" multiple /></div>
            <div class="col-6"><label>AV Rate Card (PDF)</label><input type="file" name="av_rate_card" accept="application/pdf" /></div>
            <div class="col-6"><label>Banquet Menus (PDF)</label><input type="file" name="banquet_menus" accept="application/pdf" /></div>
            <div class="col-6"><label>Fire/Life Safety Certificate (PDF)</label><input type="file" name="fls_certificate" accept="application/pdf" /></div>
            <div class="col-6"><label>Insurance COI (PDF)</label><input type="file" name="coi" accept="application/pdf" /></div>
            <div class="col-12"><label>Photos (JPG/PNG, multiple)</label><input type="file" name="photos" accept="image/*" multiple /></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>12) Notes (Optional)</legend>
          <textarea name="notes" placeholder="Anything else we should know about your hotel. "></textarea>
        </fieldset>
      </div>

      <!-- Room template -->
      <template id="room-template">
        <div class="item room">
          <div class="row">
            <div class="col-4"><label>Room Name <span class="required">*</span></label><input name="room_name[]" required /></div>
            <div class="col-2"><label>Level</label><input name="room_level[]" /></div>
            <div class="col-3"><label>Area (sq ft)</label><input type="number" name="room_area_sqft[]" min="0" /></div>
            <div class="col-3"><label>Area (m²)</label><input type="number" step="0.1" name="room_area_sqm[]" min="0" /></div>
            <div class="col-3"><label>Dimensions (ft)</label><input name="room_dims_ft[]" placeholder="L x W" /></div>
            <div class="col-3"><label>Ceiling (ft)</label><input type="number" step="0.1" name="room_ceiling_ft[]" min="0" /></div>
            <div class="col-2"><label>Pillar-Free</label><select name="room_pillar_free[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-2"><label>Natural Light</label><select name="room_natural_light[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-2"><label>Divisible</label><select name="room_divisible[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-3"><label>Theater</label><input type="number" name="cap_theater[]" min="0" /></div>
            <div class="col-3"><label>Classroom</label><input type="number" name="cap_classroom[]" min="0" /></div>
            <div class="col-3"><label>Banquet</label><input type="number" name="cap_banquet[]" min="0" /></div>
            <div class="col-3"><label>U-Shape</label><input type="number" name="cap_ushape[]" min="0" /></div>
            <div class="col-4"><label>Built-in A/V</label><input name="room_built_in_av[]" /></div>
            <div class="col-4"><label>Power (closest)</label><input name="room_power[]" /></div>
            <div class="col-4"><label>Load-in Door</label><input name="room_loadin[]" /></div>
            <div class="col-12 right"><button class="btn danger remove-room" type="button">Remove Room</button></div>
          </div>
        </div>
      </template>

      <!-- Wizard nav -->
      <div class="hr"></div>
      <div class="nav" id="wizardNav">
        <button type="button" class="btn subtle" id="backBtn">← Back</button>
        <div class="hint" id="navHint">Submit is enabled only when NET30 is accepted.</div>
        <div class="inline">
          <button type="button" class="btn" id="nextBtn">Next →</button>
          <button class="btn" id="submitBtn" type="submit" disabled>
            <span class="btn-label">Submit Profile</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- overlays -->
<div class="submitting" id="submitting"><div class="panel"><div class="loader"></div><div><div style="font-weight:700;color:#0b2545">Working…</div><div class="hint">Please wait. Don’t close this page.</div></div></div></div>
<div class="toast" id="toast"></div>
<div class="submitting" id="thanks"><div class="panel" style="flex-direction:column;align-items:flex-start">
  <div style="font-size:1.1rem;font-weight:700;color:#0b2545;margin-bottom:6px">Thank you — profile submitted!</div>
  <div id="thanksId" class="hint" style="margin-bottom:10px"></div>
  <div><button class="btn" id="submitAnother">Submit Another Hotel</button></div>
</div></div>

<script>
  // Same-origin calls (no CORS)
  const API_BASE = '';

  const form = document.getElementById('hotel-form');
  const pages = Array.from(document.querySelectorAll('.page'));
  const steps = Array.from(document.querySelectorAll('.step'));
  const backBtn = document.getElementById('backBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const navHint = document.getElementById('navHint');

  const addRoomBtn = document.getElementById('addRoomBtn');
  const rooms = document.getElementById('rooms');
  const isExtendedStay = document.getElementById('is_extended_stay');
  const acceptsNet30 = document.getElementById('accepts_net30');

  const submitting = document.getElementById('submitting');
  const thanks = document.getElementById('thanks');
  const thanksId = document.getElementById('thanksId');
  const submitAnother = document.getElementById('submitAnother');
  const toast = document.getElementById('toast');

  const btnAutofill = document.getElementById('btnAutofill');
  const autofillFile = document.getElementById('autofillFile');

  const startRadios = Array.from(document.querySelectorAll('input[name="start_mode"]'));
  const signupBox = document.getElementById('signupBox');
  const signinBox = document.getElementById('signinBox');
  const btnSignup = document.getElementById('btnSignup');
  const btnSignin = document.getElementById('btnSignin');
  const forgotLink = document.getElementById('forgotLink');

  let current = 0, submittingFlag = false, signedIn = false;

  function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=>toast.style.display='none', 2600); }
  function updateWizardNav(){
    const last = pages.length - 1;
    nextBtn.style.display   = (current < last) ? 'inline-block' : 'none';
    submitBtn.style.display = (current === last) ? 'inline-block' : 'none';
    backBtn.disabled        = (current === 0);
    navHint.style.visibility= (current === last) ? 'visible' : 'hidden';
    if (current === 0) {
      const mode = (startRadios.find(r=>r.checked)||{}).value || 'guest';
      const canProceed = (mode === 'guest') || signedIn;
      nextBtn.disabled = !canProceed;
    } else {
      nextBtn.disabled = false;
    }
  }
  function setActiveStep(i){
    current = i;
    pages.forEach((p,idx)=>p.classList.toggle('active', idx===current));
    steps.forEach((s,idx)=>s.classList.toggle('active', idx===current));
    updateWizardNav(); window.scrollTo(0,0);
  }
  function validateCurrentPage(){
    const req = pages[current].querySelectorAll('[required]');
    for (let i=0;i<req.length;i++){ if(!req[i].checkValidity()){ req[i].reportValidity(); return false; } }
    return true;
  }
  function updateSubmitState(){ submitBtn.disabled = (acceptsNet30 && acceptsNet30.value !== 'Yes'); }
  function toggleES(){
    const sec = document.getElementById('extendedStaySection');
    const on = (isExtendedStay && isExtendedStay.value === 'Yes');
    if (sec) sec.style.display = on ? '' : 'none';
    if (sec) sec.querySelectorAll('[data-es-required]').forEach(el => el.required = on);
  }

  backBtn.addEventListener('click', ()=>{ if(current>0){ setActiveStep(current-1); } });
  nextBtn.addEventListener('click', ()=>{ if (!validateCurrentPage()) return; if (current < pages.length-1){ setActiveStep(current+1); } });
  if (addRoomBtn) addRoomBtn.addEventListener('click', ()=>{
    const tpl = document.getElementById('room-template').content.cloneNode(true);
    const block = tpl.querySelector('.room');
    block.querySelector('.remove-room').addEventListener('click', ()=>block.remove());
    rooms.appendChild(tpl);
  });
  if (isExtendedStay) isExtendedStay.addEventListener('change', toggleES);
  if (acceptsNet30) acceptsNet30.addEventListener('change', updateSubmitState);

  function refreshStartMode(){
    const val = (startRadios.find(r=>r.checked)||{}).value || 'guest';
    signupBox.style.display = (val==='account') ? '' : 'none';
    signinBox.style.display = (val==='signin') ? '' : 'none';
    if (current === 0) updateWizardNav();
  }
  startRadios.forEach(r=> r.addEventListener('change', refreshStartMode));
  refreshStartMode();
  setActiveStep(0); toggleES(); updateSubmitState();

  // Sign up
  if (btnSignup) btnSignup.addEventListener('click', async ()=>{
    const email = document.getElementById('su_email').value.trim();
    const user  = document.getElementById('su_user').value.trim();
    const pass  = document.getElementById('su_pass').value;
    if (!email || !user || !pass){ showToast('Enter email, username, and password.'); return; }
    try{
      submitting.classList.add('show');
      const resp = await fetch(API_BASE+'/api/signup', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, username:user, password:pass})});
      const j = await resp.json().catch(()=>({}));
      if (!resp.ok || !j.ok){ showToast(j.error||'Sign up not available. Continue as guest.'); }
      else { showToast('Confirmation email sent. Verify, then sign in.'); if (j.devVerifyUrl) console.log('DEV verify link:', j.devVerifyUrl); }
    }catch(e){ showToast('Signup unavailable. Continue as guest.'); }
    finally{ submitting.classList.remove('show'); }
  });

  // Sign in
  if (btnSignin) btnSignin.addEventListener('click', async ()=>{
    const user = document.getElementById('si_user').value.trim();
    const pass = document.getElementById('si_pass').value;
    if (!user || !pass){ showToast('Enter username/email and password.'); return; }
    try{
      submitting.classList.add('show');
      const resp = await fetch(API_BASE+'/api/signin', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user, password:pass})});
      const j = await resp.json().catch(()=>({}));
      if (!resp.ok || !j.ok){ showToast(j.error||'Sign in failed.'); signedIn = false; }
      else { showToast('Signed in. You can proceed.'); signedIn = true; updateWizardNav(); }
    }catch(e){ showToast('Sign in unavailable.'); }
    finally{ submitting.classList.remove('show'); }
  });

  if (forgotLink) forgotLink.addEventListener('click', (e)=>{ e.preventDefault(); showToast('Password reset (not implemented in local dev).'); });

  // Autofill
  const btnAutofillEl = document.getElementById('btnAutofill');
  const autofillFileEl = document.getElementById('autofillFile');
  function pickField(obj, keys){
    const entries = Object.entries(obj || {});
    for (const k of keys){
      const re = (k instanceof RegExp) ? k : new RegExp('^'+k+'$', 'i');
      const hit = entries.find(([kk,v])=> re.test(kk) && v && String(v).trim() );
      if (hit) return String(hit[1]).trim();
    }
    for (const [kk,v] of entries){
      if (!v) continue;
      const low = kk.toLowerCase();
      for (const k of keys){
        if (typeof k==='string' && low.includes(k.toLowerCase())) return String(v).trim();
      }
    }
    return '';
  }
  btnAutofillEl.addEventListener('click', async ()=>{
    const f = autofillFileEl.files && autofillFileEl.files[0];
    if (!f) { showToast('Choose a file first.'); return; }
    const fd = new FormData(); fd.append('info_sheet', f);
    try{
      submitting.classList.add('show');
      const resp = await fetch('/api/autofill', { method:'POST', body: fd });
      let json;
      try { json = await resp.json(); } catch(parseErr){
        const text = await resp.text(); throw new Error('Autofill parse error: ' + text.slice(0,180));
      }
      if (!json.ok){ showToast(json.error || 'Could not extract data.'); return; }
      const fields = json.fields || {};
      const map = {
        hotel_name: ['hotel_name','hotel','property','property_name','name'],
        brand: ['brand','hotel_brand'],
        chain: ['chain','chain_brand','chain_name'],
        management_company: ['management_company','management','operator','owner','ownership'],
        website: ['website','url','web','site','web_site'],
        address: ['address','street','street_address','addr'],
        city: ['city','town'],
        state: ['state','province','state_province','region'],
        zip: ['zip','postal','postal_code','postcode','zip_code'],
        country: ['country'],
        year_built: ['year_built','built','opening_year'],
        last_renovation: ['last_renovation','renovation','renovated','last_renovated','renovation_year']
      };
      let filled = 0;
      for (const target in map){
        const el = form.querySelector('[name="'+target+'"]');
        if (!el) continue;
        const val = pickField(fields, map[target]);
        if (val && !el.value){ el.value = val; filled++; }
      }
      showToast(filled ? ('Autofilled '+filled+' field(s).') : 'No obvious fields found.');
    } catch (e) {
      showToast((e && e.message) ? e.message : ('Autofill error: ' + e));
    } finally {
      submitting.classList.remove('show');
    }
  });

  // Submit
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!validateCurrentPage()) return;
    if (submitBtn.disabled){ alert('NET30 acceptance is required to submit.'); return; }
    if (submittingFlag) return;
    submittingFlag = true; submitting.classList.add('show');
    try{
      const fd = new FormData(form);
      const resp = await fetch('/api/submit', { method:'POST', body: fd });
      let json;
      try { json = await resp.json(); } catch(parseErr){
        const text = await resp.text(); throw new Error('Submit parse error: ' + text.slice(0,200));
      }
      if (!json.ok){ showToast(json.error || 'Submit failed.'); return; }
      thanksId.textContent = 'Hotel ID: ' + (json.hotelId || '');
      submitting.classList.remove('show'); thanks.classList.add('show'); window.scrollTo(0,0);
    }catch(e){
      showToast((e && e.message) ? e.message : ('Submit error: ' + e));
    } finally {
      submittingFlag = false;
      submitting.classList.remove('show');
    }
  });

  submitAnother.addEventListener('click', ()=>{
    form.reset(); rooms.innerHTML=''; if (isExtendedStay) isExtendedStay.value='';
    toggleES(); updateSubmitState(); setActiveStep(0); thanks.classList.remove('show');
  });

  function validateCurrentPage(){
    const req = pages[current].querySelectorAll('[required]');
    for (let i=0;i<req.length;i++){ if(!req[i].checkValidity()){ req[i].reportValidity(); return false; } }
    return true;
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Google Places API (New) - Best Practices Implementation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .main-content {
            flex: 3;
            min-width: 300px;
            padding: 20px;
        }
        
        .sidebar {
            flex: 1;
            min-width: 250px;
            padding: 20px;
            background-color: #f1f3f4;
            border-radius: 8px;
            margin-left: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #5f6368;
        }
        
        .input-container {
            position: relative;
        }
        
        #autocomplete-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #dadce0;
            border-radius: 8px;
            transition: border-color 0.3s;
        }
        
        #autocomplete-input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        .suggestions-container {
            position: relative;
            width: 100%;
        }
        
        .suggestions-list {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dadce0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-item {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-name {
            font-weight: 600;
            color: #202124;
            margin-bottom: 4px;
        }
        
        .suggestion-address {
            font-size: 14px;
            color: #5f6368;
        }
        
        #place-details {
            margin-top: 30px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #place-details h2 {
            color: #202124;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dadce0;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #5f6368;
            min-width: 120px;
        }
        
        .detail-value {
            flex: 1;
            color: #202124;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #5f6368;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background-color: #fce8e6;
            color: #d93025;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            border-left: 4px solid #d93025;
        }
        
        .success {
            background-color: #e6f4ea;
            color: #137333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            border-left: 4px solid #137333;
        }
        
        .mock-mode-indicator {
            background-color: #fef7e0;
            color: #f9ab00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            border-left: 4px solid #f9ab00;
        }
        
        .config-info {
            background-color: #e8eaed;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .config-info h3 {
            margin-top: 0;
            color: #202124;
        }
        
        .config-info ul {
            padding-left: 20px;
        }
        
        .config-info li {
            margin-bottom: 10px;
        }
        
        .instructions {
            background-color: #d2e3fc;
            border-left: 4px solid #4285f4;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #1a73e8;
        }
        
        .btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #3367d6;
        }
        
        .btn:disabled {
            background-color: #dadce0;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #34a853;
        }
        
        .status-inactive {
            background-color: #ea4335;
        }
        
        .status-pending {
            background-color: #fbbc04;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                margin-left: 0;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Google Places API (New)</h1>
            <p class="subtitle">Best Practices Implementation with Direct HTTP Requests</p>
        </header>
        
        <div class="content">
            <div class="main-content">
                <div class="instructions">
                    <h3>Configuration Instructions</h3>
                    <p>Based on the diagnostic feedback, ensure your Google Cloud Console is properly configured:</p>
                    <ol>
                        <li>Enable "Maps JavaScript API" and "Places API (New)" in Google Cloud Console</li>
                        <li>Set API key restrictions to HTTP referrers: http://localhost:5050/*</li>
                        <li>Restrict API key to only "Maps JavaScript API" and "Places API (New)"</li>
                        <li>Ensure billing is enabled for your FEDEVENT project</li>
                    </ol>
                </div>
                
                <div class="mock-mode-indicator" id="mockModeIndicator">
                    <div class="status-indicator status-pending"></div>
                    Running in mock mode - using sample data instead of real API
                </div>
                
                <div class="error" id="errorMessage"></div>
                <div class="success" id="successMessage"></div>
                
                <div class="form-group">
                    <label for="autocomplete-input">Find Hotel or Location:</label>
                    <div class="suggestions-container">
                        <div class="input-container">
                            <input id="autocomplete-input" type="text" placeholder="Start typing a hotel or place name..." autocomplete="off" />
                        </div>
                        <div class="suggestions-list" id="suggestions-list"></div>
                    </div>
                </div>
                
                <div id="place-details">
                    <h2>Selected Place Details</h2>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value" id="place-name">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value" id="place-address">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value" id="place-phone">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Website:</span>
                        <span class="detail-value" id="place-website">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Coordinates:</span>
                        <span class="detail-value" id="place-latlng">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Place ID:</span>
                        <span class="detail-value" id="place-id">-</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <h3>Implementation Status</h3>
                <div class="status-item">
                    <p><span class="status-indicator status-pending" id="apiKeyStatus"></span> API Key Configuration</p>
                </div>
                <div class="status-item">
                    <p><span class="status-indicator status-pending" id="apiConnectionStatus"></span> API Connection</p>
                </div>
                <div class="status-item">
                    <p><span class="status-indicator status-pending" id="fieldMaskStatus"></span> Field Mask Compliance</p>
                </div>
                <div class="status-item">
                    <p><span class="status-indicator status-pending" id="sessionTokenStatus"></span> Session Token Usage</p>
                </div>
                
                <div class="config-info">
                    <h3>Best Practices</h3>
                    <ul>
                        <li>Direct HTTP requests to Google Places API (New)</li>
                        <li>Server-side API key management</li>
                        <li>Explicit X-Goog-FieldMask headers</li>
                        <li>Session tokens for billing optimization</li>
                        <li>No Maps JavaScript API library loading</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let googlePlacesApiKey = null;
        let isMockMode = false;
        let sessionToken = null;
        let currentRequestController = null;
        
        // DOM Elements
        const autocompleteInput = document.getElementById('autocomplete-input');
        const suggestionsList = document.getElementById('suggestions-list');
        const placeDetails = document.getElementById('place-details');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const mockModeIndicator = document.getElementById('mockModeIndicator');
        
        // Status indicators
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const apiConnectionStatus = document.getElementById('apiConnectionStatus');
        const fieldMaskStatus = document.getElementById('fieldMaskStatus');
        const sessionTokenStatus = document.getElementById('sessionTokenStatus');
        
        // Update status indicators
        function updateStatus(element, status) {
            element.className = 'status-indicator';
            switch(status) {
                case 'active':
                    element.classList.add('status-active');
                    break;
                case 'inactive':
                    element.classList.add('status-inactive');
                    break;
                case 'pending':
                    element.classList.add('status-pending');
                    break;
            }
        }
        
        // Initialize the application
        async function initApp() {
            try {
                // Update status indicators
                updateStatus(apiKeyStatus, 'pending');
                updateStatus(apiConnectionStatus, 'pending');
                updateStatus(fieldMaskStatus, 'pending');
                updateStatus(sessionTokenStatus, 'pending');
                
                // Fetch the Google Places API key from our server
                const response = await fetch('/api/google-places-key');
                const data = await response.json();
                
                if (data.mockMode) {
                    isMockMode = true;
                    mockModeIndicator.style.display = 'block';
                    updateStatus(apiKeyStatus, 'inactive');
                    console.warn('Running in mock mode - using sample data instead of real API');
                    showSuccessMessage('Running in mock mode - using sample data for development');
                } else {
                    googlePlacesApiKey = data.apiKey;
                    mockModeIndicator.style.display = 'none';
                    updateStatus(apiKeyStatus, 'active');
                    showSuccessMessage('API key successfully loaded');
                }
                
                // Initialize session token
                generateNewSessionToken();
                updateStatus(sessionTokenStatus, 'active');
                
                // Set up event listeners
                setupEventListeners();
                
                // Update field mask status
                updateStatus(fieldMaskStatus, 'active');
            } catch (error) {
                console.error('Error initializing app:', error);
                updateStatus(apiKeyStatus, 'inactive');
                showErrorMessage('Failed to initialize the application. Please check console for details.');
            }
        }
        
        // Generate a new session token for billing optimization
        function generateNewSessionToken() {
            // Generate a simple UUID-like token for session tracking
            sessionToken = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            console.log('New session token generated:', sessionToken);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            autocompleteInput.addEventListener('input', handleInput);
            autocompleteInput.addEventListener('focus', handleFocus);
            autocompleteInput.addEventListener('blur', () => {
                // Hide suggestions after a short delay to allow clicks
                setTimeout(() => {
                    suggestionsList.style.display = 'none';
                }, 200);
            });
            
            // Close suggestions when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!autocompleteInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = 'none';
                }
            });
        }
        
        // Handle input focus - generate new session token
        function handleFocus() {
            generateNewSessionToken();
            updateStatus(sessionTokenStatus, 'active');
        }
        
        // Handle input changes
        async function handleInput(event) {
            const query = event.target.value.trim();
            
            if (query.length < 3) {
                suggestionsList.style.display = 'none';
                return;
            }
            
            try {
                const results = await searchPlaces(query);
                displaySuggestions(results);
                updateStatus(apiConnectionStatus, 'active');
            } catch (error) {
                console.error('Error searching places:', error);
                updateStatus(apiConnectionStatus, 'inactive');
                showErrorMessage('Failed to search places: ' + error.message);
            }
        }
        
        // Search for places using Google Places API (New) with direct HTTP requests
        async function searchPlaces(query) {
            // Cancel previous request if exists
            if (currentRequestController) {
                currentRequestController.abort();
            }
            
            // Create new AbortController for this request
            currentRequestController = new AbortController();
            const { signal } = currentRequestController;
            
            // In mock mode, return sample data
            if (isMockMode) {
                await new Promise(resolve => setTimeout(resolve, 300)); // Simulate network delay
                return getMockPlacesData(query);
            }
            
            // Validate API key
            if (!googlePlacesApiKey) {
                throw new Error('Google Places API key not available');
            }
            
            // Show loading indicator
            suggestionsList.innerHTML = '<div class="suggestion-item"><div class="loading"><div class="spinner"></div>Searching...</div></div>';
            suggestionsList.style.display = 'block';
            
            try {
                // Make direct HTTP request to Google Places API (New)
                const response = await fetch(`https://places.googleapis.com/v1/places:searchText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-Api-Key': googlePlacesApiKey,
                        // Include session token in the request for billing optimization
                        'X-Goog-Request-Params': `session_token=${sessionToken}`,
                        // Required field mask as per project specifications
                        'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.location,places.internationalPhoneNumber,places.websiteUri'
                    },
                    body: JSON.stringify({
                        textQuery: query,
                        maxResultCount: 5
                    }),
                    signal // Pass the abort signal
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                return data.places || [];
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was cancelled');
                    return [];
                }
                console.error('Places API error:', error);
                throw error;
            }
        }
        
        // Display suggestions in the dropdown
        function displaySuggestions(places) {
            if (!places || places.length === 0) {
                suggestionsList.style.display = 'none';
                return;
            }
            
            suggestionsList.innerHTML = '';
            
            places.forEach(place => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-name">${escapeHtml(place.displayName?.text || 'Unnamed Place')}</div>
                    <div class="suggestion-address">${escapeHtml(place.formattedAddress || 'Address not available')}</div>
                `;
                
                item.addEventListener('click', () => {
                    selectPlace(place);
                });
                
                suggestionsList.appendChild(item);
            });
            
            suggestionsList.style.display = 'block';
        }
        
        // Select a place and display its details
        async function selectPlace(place) {
            // Hide suggestions
            suggestionsList.style.display = 'none';
            
            // Update input value
            autocompleteInput.value = place.displayName?.text || '';
            
            // Display place details
            document.getElementById('place-name').textContent = place.displayName?.text || 'N/A';
            document.getElementById('place-address').textContent = place.formattedAddress || 'N/A';
            document.getElementById('place-phone').textContent = place.internationalPhoneNumber || 'N/A';
            document.getElementById('place-website').textContent = place.websiteUri || 'N/A';
            
            // Extract latitude and longitude
            if (place.location) {
                document.getElementById('place-latlng').textContent = 
                    `${place.location.latitude}, ${place.location.longitude}`;
            } else {
                document.getElementById('place-latlng').textContent = 'N/A';
            }
            
            document.getElementById('place-id').textContent = place.id || 'N/A';
            
            // Show details section
            placeDetails.style.display = 'block';
            
            // Generate new session token after selection (as recommended for billing optimization)
            generateNewSessionToken();
            updateStatus(sessionTokenStatus, 'active');
            
            // Scroll to details
            placeDetails.scrollIntoView({ behavior: 'smooth' });
            
            showSuccessMessage('Place details loaded successfully');
        }
        
        // Get mock places data for development/testing
        function getMockPlacesData(query) {
            // Sample mock data based on common hotel chains
            const mockHotels = [
                {
                    id: 'ChIJd8BlQ2BZwokRAFUEcm_qrcA',
                    displayName: { text: 'The Ritz-Carlton' },
                    formattedAddress: '123 Main Street, New York, NY 10001, USA',
                    location: { latitude: 40.7128, longitude: -74.0060 },
                    internationalPhoneNumber: '+1 212-555-1234',
                    websiteUri: 'https://www.ritzcarlton.com'
                },
                {
                    id: 'ChIJGz24MwZYwokRYBJwF-7VcK8',
                    displayName: { text: 'Marriott International' },
                    formattedAddress: '456 Business Ave, Washington, DC 20001, USA',
                    location: { latitude: 38.8951, longitude: -77.0364 },
                    internationalPhoneNumber: '+1 202-555-5678',
                    websiteUri: 'https://www.marriott.com'
                },
                {
                    id: 'ChIJi8MeVwZYwokRyH5nS2TSDWI',
                    displayName: { text: 'Hilton Worldwide' },
                    formattedAddress: '789 Hospitality Blvd, Chicago, IL 60601, USA',
                    location: { latitude: 41.8781, longitude: -87.6298 },
                    internationalPhoneNumber: '+1 312-555-9012',
                    websiteUri: 'https://www.hilton.com'
                },
                {
                    id: 'ChIJ5z5r8M8xwokR2Hin8d5gk7c',
                    displayName: { text: 'Hyatt Regency' },
                    formattedAddress: '321 Travel Lane, San Francisco, CA 94102, USA',
                    location: { latitude: 37.7749, longitude: -122.4194 },
                    internationalPhoneNumber: '+1 415-555-3456',
                    websiteUri: 'https://www.hyatt.com'
                },
                {
                    id: 'ChIJ3S8x8yUxwokRz3c4p4d5e6f',
                    displayName: { text: 'Sheraton Hotels' },
                    formattedAddress: '654 Lodging Way, Boston, MA 02108, USA',
                    location: { latitude: 42.3601, longitude: -71.0589 },
                    internationalPhoneNumber: '+1 617-555-7890',
                    websiteUri: 'https://www.sheraton.com'
                }
            ];
            
            // Filter mock data based on query
            const filtered = mockHotels.filter(hotel => 
                hotel.displayName.text.toLowerCase().includes(query.toLowerCase()) ||
                hotel.formattedAddress.toLowerCase().includes(query.toLowerCase())
            );
            
            return filtered.slice(0, 5);
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Show error message
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // Show success message
        function showSuccessMessage(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }
        
        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
    <script src="/footer.js"></script>
<footer id="contact">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>FEDEVENT</h3>
                <p>Professional event planning services for U.S. Government agencies.</p>
            </div>
            <div class="footer-section">
                <h3>Services</h3>
                <a href="/hotel-signup.html">Hotel Sourcing</a>
                <a href="/contact.html">Event Planning</a>
                <a href="/government-portal.html">Venue Matching</a>
                <a href="/support-ticket.html">Support Ticket</a>
            </div>
            <div class="footer-section footer-contact">
                <h3>Contact</h3>
                <p>Email: info@fedevent.com</p>
                <p>Phone: (305) 850-7848</p>
                <a href="/admin-login.html" style="color: #d1d5db; text-decoration: none; margin-top: 10px; display: inline-block; padding: 5px 10px; border: 1px solid #374151; border-radius: 4px; font-size: 0.9rem;">
                    🔐 Admin Access
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>fedevent.com is a service of CREATA Global Event Agency LLC</p>
            <p>&copy; 2025 FEDEVENT. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <a href="/admin-login.html" style="color: #9ca3af; text-decoration: none; border-bottom: 1px dotted #9ca3af;">
                    🔐 Admin Sign In
                </a>
            </p>
        </div>
    </div>
</footer>

<style>
    /* Footer Styles */
    footer {
        background: var(--text, #1f2937);
        color: white;
        padding: 3rem 0 1rem;
        margin-top: auto;
    }

    .footer-content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .footer-section h3 {
        margin-bottom: 1rem;
        color: var(--secondary, #f59e0b);
    }

    .footer-section a {
        display: block;
        color: #d1d5db;
        text-decoration: none;
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }

    .footer-section a:hover {
        color: var(--secondary, #f59e0b);
    }

    .footer-contact {
        text-align: right;
    }

    .footer-bottom {
        border-top: 1px solid #374151;
        padding-top: 2rem;
        text-align: center;
        color: #9ca3af;
    }

    /* Responsive Footer */
    @media (max-width: 768px) {
        .footer-content {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .footer-contact {
            text-align: left;
        }
    }
</style>
</body>
</html>
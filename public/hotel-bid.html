<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Bid - FEDEVENT</title>
  <link rel="stylesheet" href="/site.css">
  <style>
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{margin-bottom:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-1{display:grid;grid-template-columns:1fr;gap:16px}
    label{font-weight:600;margin-bottom:6px;display:block}
    input,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px}
    .muted{color:#6b7280}
    .btn{appearance:none;border:0;border-radius:8px;background:#1e40af;color:#fff;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .hint{font-size:.85rem;color:#6b7280;margin-top:4px}
    .error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;padding:12px;border-radius:8px;margin:12px 0}
    .success{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;padding:12px;border-radius:8px;margin:12px 0}
  </style>
</head>
<body>
  <header>
    <nav class="container" style="display:flex;align-items:center;justify-content:space-between;padding:16px 0">
      <a href="/hotel-contracts.html" class="logo">FEDEVENT</a>
      <div>
        <a href="/hotel-contracts.html" style="margin-right:12px;text-decoration:none">Available Contracts</a>
        <a href="/hotel-contracts.html#my-active" style="text-decoration:none">My Active Bids</a>
      </div>
    </nav>
  </header>

  <main class="container">
    <div class="header">
      <h1 id="pageTitle">Submit Bid</h1>
      <p class="muted" id="pageSubtitle">Loading contract...</p>
    </div>

    <div class="grid">
      <section class="card" id="contractInfo">
        <!-- Filled by JS -->
      </section>

      <section class="card">
        <h2 style="margin-top:0">Your Bid</h2>
        <form id="bidForm" class="grid-1">
          <div>
            <label for="contracted_rate">Contracted Rate ($/night)</label>
            <input type="number" id="contracted_rate" step="0.01" min="0" required>
            <div class="hint" id="contracted_hint"></div>
          </div>
          <div>
            <label for="self_pay_rate">Self-Pay Rate ($/night)</label>
            <input type="number" id="self_pay_rate" step="0.01" min="0" required>
            <div class="hint" id="selfpay_hint"></div>
          </div>
          <div>
            <label for="breakdown">Breakdown (JSON)</label>
            <textarea id="breakdown" rows="3" placeholder='{"rooms":100,"nights":90}'></textarea>
            <div class="hint">Optional: provide line items as JSON.</div>
          </div>
          <div>
            <label for="total_price">Total Price (optional)</label>
            <input type="number" id="total_price" step="0.01" min="0">
          </div>
          <div>
            <label for="additional_notes">Additional Notes (optional)</label>
            <textarea id="additional_notes" rows="3" placeholder="Add any relevant details..."></textarea>
          </div>
          <div>
            <label for="bid_file">Attach File (PDF/DOC)</label>
            <input type="file" id="bid_file" accept=".pdf,.doc,.docx,.txt">
          </div>
          <div id="msg"></div>
          <div class="row">
            <button type="submit" class="btn" id="submitBtn">Save Draft</button>
            <button type="button" class="btn" id="finalBtn" style="background:#16a34a">Submit Final</button>
            <a href="/hotel-contracts.html#my-active" class="btn secondary">Cancel</a>
          </div>
        </form>
      </section>
    </div>
  </main>

  <script>
    const API_BASE = '';
    const qs = new URLSearchParams(location.search);
    const contractId = qs.get('contractId');
    let currentContract = null;
    let myBid = null;

    function fmt(d){ if(!d) return '-'; const x=new Date(d); return x.toLocaleDateString()+' '+x.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

    function authHeaders(){
      const sessionId = localStorage.getItem('fedevent_session');
      return { 'Authorization': `Bearer ${sessionId}`, 'Content-Type':'application/json' };
    }

    async function loadContract(){
      if(!contractId){ document.getElementById('msg').innerHTML = '<div class="error">Missing contractId</div>'; return; }
      const res = await fetch(`/api/hotel/contracts/${contractId}`, { headers: authHeaders() });
      const data = await res.json();
      if(!data.ok){ document.getElementById('msg').innerHTML = `<div class="error">${data.error||'Failed to load contract'}</div>`; return; }
      currentContract = data.contract; myBid = data.myBid || null;
      renderContract();
      prefillBid();
    }

    function renderContract(){
      document.getElementById('pageTitle').textContent = currentContract.title || 'Submit Bid';
      document.getElementById('pageSubtitle').textContent = currentContract.bidding_deadline ? `Bidding deadline: ${fmt(currentContract.bidding_deadline)}` : '';
      document.getElementById('contracted_hint').textContent = `Maximum: $${currentContract.max_contracted_rate} (30% off per diem)`;
      document.getElementById('selfpay_hint').textContent = `Maximum: $${currentContract.max_self_pay_rate} (10% off per diem)`;
      const html = `
        <h2 style="margin-top:0">Contract Review</h2>
        <div class="grid-1">
          <div><strong>Location:</strong> ${[currentContract.location_city,currentContract.location_state,currentContract.location_country].filter(Boolean).join(', ')}</div>
          <div><strong>Duration:</strong> ${currentContract.start_date} to ${currentContract.end_date}</div>
          <div><strong>Rooms:</strong> ${currentContract.room_count}</div>
          <div><strong>Per Diem:</strong> $${currentContract.per_diem_rate}/night</div>
          ${currentContract.bidding_deadline ? `<div><strong>Deadline:</strong> ${fmt(currentContract.bidding_deadline)}</div>`:''}
          ${currentContract.requirements ? `<div><strong>Requirements:</strong> ${currentContract.requirements}</div>`:''}
          ${currentContract.sow_document ? `<div><strong>Statement of Work:</strong><div style="white-space:pre-wrap;margin-top:6px">${currentContract.sow_document}</div></div>`:''}
        </div>
      `;
      document.getElementById('contractInfo').innerHTML = html;
    }

    function prefillBid(){
      if(!myBid) return;
      document.getElementById('submitBtn').textContent = 'Save Draft';
      document.getElementById('contracted_rate').value = myBid.contracted_rate;
      document.getElementById('self_pay_rate').value = myBid.self_pay_rate;
      document.getElementById('additional_notes').value = myBid.additional_notes || '';
      if (myBid.breakdown) document.getElementById('breakdown').value = myBid.breakdown;
      if (myBid.total_price) document.getElementById('total_price').value = myBid.total_price;
      if (myBid.status === 'submitted') {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('finalBtn').disabled = true;
        document.getElementById('msg').innerHTML = '<div class="success">This bid is submitted and locked.</div>';
      }
    }

    document.getElementById('bidForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('msg');
      msg.innerHTML = '';
      const contracted = parseFloat(document.getElementById('contracted_rate').value);
      const selfpay = parseFloat(document.getElementById('self_pay_rate').value);
      const notes = document.getElementById('additional_notes').value.trim();
      if(isNaN(contracted)||isNaN(selfpay)){ msg.innerHTML = '<div class="error">Enter both rates.</div>'; return; }
      if(contracted > currentContract.max_contracted_rate){ msg.innerHTML = `<div class="error">Contracted cannot exceed $${currentContract.max_contracted_rate}.</div>`; return; }
      if(selfpay > currentContract.max_self_pay_rate){ msg.innerHTML = `<div class="error">Self-Pay cannot exceed $${currentContract.max_self_pay_rate}.</div>`; return; }
      document.getElementById('submitBtn').disabled = true; document.getElementById('submitBtn').textContent='Submitting...';
      try{
        const res = await fetch(`/api/hotel/contracts/${contractId}/bid`,{
          method:'POST', headers: authHeaders(),
          body: JSON.stringify({ 
            contracted_rate: contracted, self_pay_rate: selfpay, additional_notes: notes,
            breakdown: parseJsonSafe(document.getElementById('breakdown').value),
            total_price: parseFloat(document.getElementById('total_price').value)||null
          })
        });
        const data = await res.json();
        if(!data.ok){ msg.innerHTML = `<div class=\"error\">${data.error||'Failed to submit bid'}</div>`; }
        else {
          // upload file if any
          const f = document.getElementById('bid_file');
          if (f && f.files && f.files[0]){
            const fd = new FormData(); fd.append('file', f.files[0]);
            const res2 = await fetch(`/api/hotel/contracts/${contractId}/bid/upload`, { method:'POST', headers:{ 'Authorization': authHeaders()['Authorization'] }, body: fd });
            await res2.json();
          }
          msg.innerHTML = '<div class="success">Bid saved.</div>';
          setTimeout(()=>{ location.href='/hotel-contracts.html#my-active'; }, 1200);
        }
      }catch(err){ msg.innerHTML = '<div class="error">Network error</div>'; }
      finally{ document.getElementById('submitBtn').disabled = false; document.getElementById('submitBtn').textContent = 'Save Draft'; }
    });

    document.getElementById('finalBtn').addEventListener('click', async ()=>{
      const btn = document.getElementById('finalBtn'); const msg = document.getElementById('msg');
      btn.disabled = true; msg.innerHTML='';
      try{
        const res = await fetch(`/api/hotel/contracts/${contractId}/bid/submit`, { method:'POST', headers: authHeaders() });
        const data = await res.json();
        if(!data.ok){ msg.innerHTML = `<div class=\"error\">${data.error||'Failed to submit'}</div>`; btn.disabled=false; }
        else { msg.innerHTML = '<div class="success">Bid submitted and locked.</div>'; setTimeout(()=>{ location.href='/hotel-contracts.html#submitted'; }, 1200); }
      } catch(err) { msg.innerHTML = '<div class="error">Network error</div>'; btn.disabled=false; }
    });

    function parseJsonSafe(s){ try { return s && JSON.parse(s); } catch(e){ return null; } }

    // init
    loadContract();
  </script>
</body>
</html>


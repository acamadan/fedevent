<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Contracts - FEDEVENT Hotel Portal</title>
    <link rel="stylesheet" href="/site.css">
    
    <!-- Google Analytics 4 (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX', {
            // Enhanced ecommerce and event tracking
            send_page_view: true,
            custom_map: {
                'custom_parameter_1': 'fedevent_website'
            }
        });
        
        // Custom event tracking functions
        function trackNavigationClick(section) {
            gtag('event', 'navigation_click', {
                'event_category': 'Website Navigation',
                'event_label': section,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackButtonClick(buttonName) {
            gtag('event', 'button_click', {
                'event_category': 'Website Interaction',
                'event_label': buttonName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackFormSubmission(formName) {
            gtag('event', 'form_submission', {
                'event_category': 'Website Forms',
                'event_label': formName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackPageView(pageName) {
            gtag('event', 'page_view', {
                'event_category': 'Page Views',
                'event_label': pageName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
    </script>
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #f59e0b;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #f8fafc;
            --white: #ffffff;
            --error: #dc2626;
            --success: #16a34a;
            --border: #e5e7eb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        
        .nav-links a {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            color: var(--primary);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .logout-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text);
        }
        
        .contracts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }
        
        .contract-card {
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .contract-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .contract-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .contract-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        
        .contract-deadline {
            font-size: 0.875rem;
            color: var(--error);
            font-weight: 500;
        }
        
        .contract-info {
            margin-bottom: 1.5rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .info-label {
            color: var(--text-light);
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .rate-limits {
            background: var(--bg);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }
        
        .rate-limits h4 {
            font-size: 0.875rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .rate-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .current-bid {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .current-bid h4 {
            font-size: 0.875rem;
            color: #92400e;
            margin-bottom: 0.25rem;
        }
        
        .bid-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-no-bid {
            background: #f3f4f6;
            color: #374151;
        }
        
        .status-submitted {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            text-align: center;
        }
        
        .btn:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #d97706;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--white);
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .sow-section {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 6px;
            margin: 1.5rem 0;
        }
        
        .sow-section h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .competitors-section {
            margin: 2rem 0;
        }
        
        .competitor-bid {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .competitor-info {
            font-weight: 500;
        }
        
        .competitor-rates {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .bid-form {
            background: var(--white);
            border: 2px solid var(--primary);
            padding: 1.5rem;
            border-radius: 6px;
            margin-top: 2rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .rate-hint {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }
        
        .error {
            background: #fef2f2;
            color: var(--error);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .success {
            background: #f0fdf4;
            color: var(--success);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }
    </style>
</head>
<body>
    
    <div class="container">
        <h1 class="page-title">Contracts & Bidding</h1>

        <div class="tabs" role="tablist" style="margin: 12px 0; display:flex; gap:8px; border-bottom:1px solid #e5e7eb; flex-wrap:wrap;">
            <button id="tab-available" class="tab-btn" role="tab" aria-selected="true" style="appearance:none;background:#eef2ff;border:1px solid #c7d2fe;border-bottom:none;padding:.5rem .75rem;border-top-left-radius:.5rem;border-top-right-radius:.5rem;font-weight:600;color:#1e40af;cursor:pointer;">Available</button>
            <button id="tab-my-active" class="tab-btn" role="tab" aria-selected="false" style="appearance:none;background:#fff;border:1px solid #e5e7eb;border-bottom:none;padding:.5rem .75rem;border-top-left-radius:.5rem;border-top-right-radius:.5rem;font-weight:600;color:#6b7280;cursor:pointer;">My Active Bids</button>
            <button id="tab-submitted" class="tab-btn" role="tab" aria-selected="false" style="appearance:none;background:#fff;border:1px solid #e5e7eb;border-bottom:none;padding:.5rem .75rem;border-top-left-radius:.5rem;border-top-right-radius:.5rem;font-weight:600;color:#6b7280;cursor:pointer;">Submitted/Drafts</button>
            <button id="tab-archived" class="tab-btn" role="tab" aria-selected="false" style="appearance:none;background:#fff;border:1px solid #e5e7eb;border-bottom:none;padding:.5rem .75rem;border-top-left-radius:.5rem;border-top-right-radius:.5rem;font-weight:600;color:#6b7280;cursor:pointer;">Archived</button>
        </div>

        <section id="panel-available" class="tab-panel" role="tabpanel" style="display:block;">
            <div id="contractsContent">
                <div class="loading">Loading available contracts...</div>
            </div>
        </section>
        <section id="panel-my-active" class="tab-panel" role="tabpanel" style="display:none;">
            <div id="myActiveBidsContent" class="loading">Loading my active bids...</div>
        </section>
        <section id="panel-submitted" class="tab-panel" role="tabpanel" style="display:none;">
            <div id="submittedBidsContent" class="loading">Loading submitted/drafts...</div>
        </section>
        <section id="panel-archived" class="tab-panel" role="tabpanel" style="display:none;">
            <div id="archivedBidsContent" class="loading">Loading archived bids...</div>
        </section>
    </div>
    
    <!-- Contract Bidding Modal -->
    <div id="biddingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="biddingModalTitle">Contract Details & Bidding</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="biddingModalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentUser = null;
        let allContracts = [];
        let currentContract = null;
        let myBids = { active: [], submitted: [], archived: [] };
        
        // Check authentication
        async function checkAuth() {
            const sessionId = localStorage.getItem('fedevent_session');
            if (!sessionId) { window.location.href = 'hotel-login.html'; return false; }
            try {
                const res = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${sessionId}` } });
                const data = await res.json();
                if (!data.ok) { throw new Error('not ok'); }
                currentUser = data.user;
                const ui = document.getElementById('userInfo');
                if (ui) ui.textContent = `${currentUser.first_name||''} ${currentUser.last_name||''}`.trim();
                return true;
            } catch (e) {
                localStorage.removeItem('fedevent_session');
                localStorage.removeItem('fedevent_user');
                window.location.href = 'hotel-login.html';
                return false;
            }
        }
        
        // API call helper
        async function apiCall(endpoint, options = {}) {
            const sessionId = localStorage.getItem('fedevent_session');
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${sessionId}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            const result = await response.json();
            
            if (!result.ok && response.status === 401) {
                localStorage.removeItem('fedevent_session');
                localStorage.removeItem('fedevent_user');
                localStorage.removeItem('fedevent_hotel');
                window.location.href = 'hotel-login.html';
                return null;
            }
            
            return result;
        }
        
        // Load contracts
        async function loadContracts() {
            try {
                const result = await apiCall('/api/hotel/contracts');
                
                if (result && result.ok) {
                    allContracts = result.contracts;
                    renderContracts();
                } else {
                    document.getElementById('contractsContent').innerHTML = 
                        '<div class="error">Failed to load contracts</div>';
                }
            } catch (error) {
                console.error('Load contracts error:', error);
                document.getElementById('contractsContent').innerHTML = 
                    '<div class="error">Failed to load contracts</div>';
            }
        }
        
        async function loadBids(status, targetKey) {
            try {
                const result = await apiCall(`/api/hotel/bids?status=${encodeURIComponent(status)}`);
                if (result && result.ok) {
                    myBids[targetKey] = result.bids || [];
                    renderBids(targetKey);
                } else {
                    setBidsError(targetKey, 'Failed to load bids');
                }
            } catch (e) {
                console.error('Load bids error:', e);
                setBidsError(targetKey, 'Failed to load bids');
            }
        }

        async function loadQnA(contractId){
            try {
                const r = await apiCall(`/api/contracts/${contractId}/qna`);
                const list = document.getElementById('qnaList');
                if (!r || !r.ok) { list.innerHTML = '<div class="error">Failed to load Q&A</div>'; return; }
                const qna = r.qna || [];
                if (qna.length === 0) { list.innerHTML = '<div class="empty-state">No questions yet.</div>'; return; }
                list.innerHTML = qna.map(item => `
                    <div style="padding: .75rem; border:1px solid var(--border); border-radius:6px; margin-bottom:.5rem;">
                        <div style="font-weight:600;">Q: ${escapeHtml(item.question)}</div>
                        ${item.answer ? `<div style=\"margin-top:.25rem;color:#065f46;background:#ecfdf5;padding:.5rem;border-radius:4px;\">A: ${escapeHtml(item.answer)}</div>` : '<div style="margin-top:.25rem;color:#6b7280;">Awaiting answer</div>'}
                        <div style="margin-top:.25rem;font-size:.75rem;color:#6b7280;">${item.hotel_name ? `Asked by ${escapeHtml(item.hotel_name)} • ` : ''}${formatDate(item.created_at)}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Load QnA error', e);
                const list = document.getElementById('qnaList');
                list.innerHTML = '<div class="error">Failed to load Q&A</div>';
            }
        }

        function escapeHtml(str){
            if (!str) return '';
            return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        function setBidsError(key, msg){
            const map = { active: 'myActiveBidsContent', submitted: 'submittedBidsContent', archived: 'archivedBidsContent' };
            const el = document.getElementById(map[key]);
            if (el) el.innerHTML = `<div class="error">${msg}</div>`;
        }

        // Render contracts
        function renderContracts() {
            const content = document.getElementById('contractsContent');
            
            if (allContracts.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h3>No Available Contracts</h3>
                        <p>You haven't expressed interest in any contracts yet, or there are no active contracts for your location.</p>
                        <p>Check your email for new contract notifications.</p>
                    </div>
                `;
                return;
            }
            
            const contractsHTML = `
                <div class="contracts-grid">
                    ${allContracts.map(contract => `
                        <div class="contract-card">
                            <div class="contract-header">
                                <div>
                                    <h3 class="contract-title">${contract.title}</h3>
                                    ${contract.bidding_deadline ? `
                                        <div class="contract-deadline">
                                            Deadline: ${formatDate(contract.bidding_deadline)}
                                        </div>
                                    ` : ''}
                                </div>
                                <div>
                                    ${(contract.notification_response ? '' : '<span class="bid-status status-submitted" style="margin-right:6px;">Advertised</span>')}
                                    <span class="bid-status status-${(contract.my_bid_status||'').toLowerCase()==='submitted' ? 'submitted' : ((contract.my_contracted_rate||contract.contracted_rate) ? 'submitted' : 'no-bid')}">
                                        ${(contract.my_bid_status||'').toLowerCase()==='submitted' ? 'Submitted' : ((contract.my_contracted_rate||contract.contracted_rate) ? 'In Progress' : 'No Bid Yet')}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="contract-info">
                                <div class="info-item">
                                    <span class="info-label">Location:</span>
                                    <span class="info-value">${[contract.location_city, contract.location_state].filter(Boolean).join(', ')}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Duration:</span>
                                    <span class="info-value">${contract.start_date} to ${contract.end_date}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Rooms:</span>
                                    <span class="info-value">${contract.room_count}</span>
                                </div>
                            </div>
                            
                            <div class="rate-limits">
                                <h4>Maximum Acceptable Rates:</h4>
                                <div class="rate-item">
                                    <span>Contracted Rate:</span>
                                    <span>$${contract.max_contracted_rate}/night</span>
                                </div>
                                <div class="rate-item">
                                    <span>Self-Pay Rate:</span>
                                    <span>$${contract.max_self_pay_rate}/night</span>
                                </div>
                            </div>
                            
                            ${(contract.my_contracted_rate||contract.contracted_rate) ? `
                                <div class="current-bid">
                                    <h4>Your Current Bid:</h4>
                                    <div class="rate-item">
                                        <span>Contracted:</span>
                                        <span>$${(contract.my_contracted_rate||contract.contracted_rate)}/night</span>
                                    </div>
                                    <div class="rate-item">
                                        <span>Self-Pay:</span>
                                        <span>$${(contract.my_self_pay_rate||contract.self_pay_rate)}/night</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <a class="btn" href="/hotel-bid.html?contractId=${contract.id}">
                                ${(contract.my_bid_status||'').toLowerCase()==='submitted' ? 'View Bid' : ((contract.my_contracted_rate||contract.contracted_rate) ? 'Update Bid' : 'Start Bid')}
                            </a>
                        </div>
                    `).join('')}
                </div>
            `;
            
            content.innerHTML = contractsHTML;
        }

        function renderBids(key){
            const map = { active: 'myActiveBidsContent', submitted: 'submittedBidsContent', archived: 'archivedBidsContent' };
            const list = myBids[key] || [];
            const target = document.getElementById(map[key]);
            if (!target) return;
            if (list.length === 0){
                target.innerHTML = `<div class="empty-state">No ${key} bids.</div>`;
                return;
            }
            target.innerHTML = `
                <div class="contracts-grid">
                    ${list.map(b => `
                        <div class="contract-card">
                            <div class="contract-header">
                                <div>
                                    <h3 class="contract-title">${b.title}</h3>
                                    ${b.bidding_deadline ? `<div class=\"contract-deadline\">Deadline: ${formatDate(b.bidding_deadline)}</div>` : ''}
                                </div>
                                <div class="bid-status status-${b.status}">${b.status}</div>
                            </div>
                            <div class="contract-info">
                                <div class="info-item"><span class="info-label">Location:</span><span class="info-value">${[b.location_city, b.location_state].filter(Boolean).join(', ')}</span></div>
                                <div class="info-item"><span class="info-label">Your Contracted:</span><span class="info-value">$${b.contracted_rate}/night</span></div>
                                <div class="info-item"><span class="info-label">Your Self-Pay:</span><span class="info-value">$${b.self_pay_rate}/night</span></div>
                            </div>
                            <button class="btn" onclick="showBiddingModal(${b.contract_id})">View / Update Bid</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Show bidding modal
        async function showBiddingModal(contractId) {
            try {
                const result = await apiCall(`/api/hotel/contracts/${contractId}`);
                
                if (result && result.ok) {
                    currentContract = result.contract;
                    const { contract, bids, myBid, leadingBid, countdown } = result;
                    
                    document.getElementById('biddingModalTitle').textContent = contract.title;
                    
                    const content = `
                        <div class="contract-details">
                            <h4>Contract Information</h4>
                            <div class="sow-section">
                                <div style="margin-bottom: 1rem;">
                                    <strong>Description:</strong> ${contract.description || 'See Statement of Work below'}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Location:</strong> ${[contract.location_city, contract.location_state, contract.location_country].filter(Boolean).join(', ')}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Duration:</strong> ${contract.start_date} to ${contract.end_date}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Room Count:</strong> ${contract.room_count} rooms
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Per Diem Rate:</strong> $${contract.per_diem_rate}/night
                                </div>
                                ${contract.bidding_deadline ? `
                                    <div style="margin-bottom: 1rem; display:flex; gap:1rem; align-items:center;">
                                        <div><strong>Bidding Deadline:</strong> ${formatDate(contract.bidding_deadline)}</div>
                                        <div id="countdownTimer" style="background:#1e40af;color:#fff;padding:.25rem .5rem;border-radius:4px;font-weight:600;">
                                            Calculating time left...
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${contract.requirements ? `
                                <div class="sow-section">
                                    <h3>Requirements</h3>
                                    <p>${contract.requirements}</p>
                                </div>
                            ` : ''}
                            
                            ${(contract.sow_summary || contract.sow_redacted) ? `
                                <div class="sow-section">
                                    <h3>Statement of Work (Hotel-Facing)</h3>
                                ${contract.description ? `<div style="margin-bottom:1rem;">${contract.description}</div>` : ''}
                                ${contract.sow_redacted ? `<div style="white-space: pre-wrap; line-height: 1.6;">${contract.sow_redacted}</div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="competitors-section">
                            <h4>Current Bids (${bids.length})</h4>
                            ${bids.length > 0 ? `
                                <div style="margin-top: 1rem;">
                                    ${bids.map((bid, index) => `
                                        <div class="competitor-bid">
                                            <div class="competitor-info">
                                                <strong>Bid #${index + 1}</strong>
                                                <div class="competitor-rates">
                                                    Contracted: $${bid.contracted_rate}/night | Self-Pay: $${bid.self_pay_rate}/night
                                                </div>
                                            </div>
                                            <div style="font-size: 0.875rem; color: var(--text-light);">
                                                ${formatDate(bid.submitted_at)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 6px;">
                                    <strong>Leading (Lowest) Bid:</strong> $${(leadingBid?leadingBid.contracted_rate:bids[0].contracted_rate)}/night (Contracted) | $${(leadingBid?leadingBid.self_pay_rate:bids[0].self_pay_rate)}/night (Self-Pay)
                                    <div class="rate-hint">Reverse auction: lower prices improve your rank.</div>
                                </div>
                            ` : '<p style="color: var(--text-light);">No bids submitted yet. Be the first to bid!</p>'}
                        </div>
                        
                        <div class="bid-form">
                            <h4>Submit Your Bid</h4>
                            <form id="bidForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="contracted_rate">Contracted Rate ($/night)</label>
                                        <input type="number" id="contracted_rate" step="0.01" min="0" max="${contract.max_contracted_rate}" 
                                               value="${myBid ? myBid.contracted_rate : ''}" required>
                                        <div class="rate-hint">Maximum: $${contract.max_contracted_rate} (30% off per diem)</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="self_pay_rate">Self-Pay Rate ($/night)</label>
                                        <input type="number" id="self_pay_rate" step="0.01" min="0" max="${contract.max_self_pay_rate}" 
                                               value="${myBid ? myBid.self_pay_rate : ''}" required>
                                        <div class="rate-hint">Maximum: $${contract.max_self_pay_rate} (10% off per diem)</div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="tax_rate">Tax Rate (e.g., 0.085 for 8.5%)</label>
                                        <input type="number" id="tax_rate" step="0.0001" min="0" max="1" value="${myBid && myBid.tax_rate != null ? myBid.tax_rate : ''}">
                                        <div class="rate-hint">Used to compute total with tax.</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="total_price">Total Price (optional)</label>
                                        <input type="number" id="total_price" step="0.01" min="0" value="${myBid && myBid.total_price ? myBid.total_price : ''}">
                                        <div class="rate-hint">If provided, we compute total with tax.</div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="breakdown">Breakdown (JSON)</label>
                                    <textarea id="breakdown" rows="4" placeholder='{"rooms":100,"nights":90,"extras":0}'>${myBid && myBid.breakdown ? myBid.breakdown : ''}</textarea>
                                    <div class="rate-hint">Provide line items as JSON. We'll validate on submit.</div>
                                </div>

                                <div class="form-group">
                                    <label for="additional_notes">Additional Notes (Optional)</label>
                                    <textarea id="additional_notes" rows="3" placeholder="Any additional information about your bid...">${myBid ? (myBid.additional_notes || '') : ''}</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="bid_file">Attach File (PDF/DOC)</label>
                                    <input type="file" id="bid_file" accept=".pdf,.doc,.docx,.txt">
                                    <div class="rate-hint">Uploading will attach to your current bid draft.</div>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn" id="saveBidBtn">${myBid && myBid.status !== 'submitted' ? 'Save Draft' : 'Save'}</button>
                                    <button type="button" class="btn btn-secondary" id="finalSubmitBtn" ${myBid && myBid.status === 'submitted' ? 'disabled' : ''}>Submit Final</button>
                                    <button type="button" class="btn" onclick="closeModal()" style="background: #6b7280;">
                                        Close
                                    </button>
                                </div>
                                
                                <div id="bidMessage"></div>
                            </form>
                        </div>

                        <div class="sow-section" id="qnaSection" style="margin-top:2rem;">
                            <h3>Q&A</h3>
                            <div id="qnaList" style="margin: 1rem 0;">
                                <div class="loading">Loading questions...</div>
                            </div>
                            <form id="qnaForm" style="margin-top:1rem;">
                                <label for="qnaQuestion">Ask a question</label>
                                <textarea id="qnaQuestion" rows="2" placeholder="Type your question about the requirements or SOW..."></textarea>
                                <div style="display:flex; gap: .75rem; margin-top:.75rem;">
                                    <button type="submit" class="btn" style="width:auto;">Post Question</button>
                                    <button type="button" class="btn" style="width:auto;background:#6b7280;" onclick="loadQnA(${contract.id})">Refresh</button>
                                </div>
                                <div id="qnaMessage" style="margin-top:.5rem;"></div>
                            </form>
                        </div>
                    `;
                    
                    document.getElementById('biddingModalContent').innerHTML = content;
                    document.getElementById('biddingModal').style.display = 'block';
                    
                    // Setup countdown
                    if (contract.bidding_deadline && countdown) {
                        startCountdown('countdownTimer', countdown.serverTime, countdown.remainingMs);
                    }

                    // Setup form handler
                    setupBidForm(contractId);
                    // Load Q&A and wire post
                    loadQnA(contractId);
                    const qnaForm = document.getElementById('qnaForm');
                    if (qnaForm) {
                        qnaForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const q = (document.getElementById('qnaQuestion').value||'').trim();
                            const msg = document.getElementById('qnaMessage');
                            msg.innerHTML='';
                            if (!q) { msg.innerHTML = '<div class="error">Please enter a question.</div>'; return; }
                            try {
                                const r = await apiCall(`/api/contracts/${contractId}/qna`, { method:'POST', body: JSON.stringify({ question: q })});
                                if (r && r.ok) {
                                    document.getElementById('qnaQuestion').value='';
                                    loadQnA(contractId);
                                    msg.innerHTML = '<div class="success">Question posted.</div>';
                                } else {
                                    msg.innerHTML = `<div class=\"error\">${r?.error||'Failed to post'}</div>`;
                                }
                            } catch (err) {
                                console.error('QnA post error', err);
                                msg.innerHTML = '<div class="error">Failed to post</div>';
                            }
                        });
                    }
                } else {
                    alert('Failed to load contract details');
                }
            } catch (error) {
                console.error('Contract details error:', error);
                alert('Failed to load contract details');
            }
        }
        
        // Setup bid form
        function setupBidForm(contractId) {
            document.getElementById('bidForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    contracted_rate: parseFloat(document.getElementById('contracted_rate').value),
                    self_pay_rate: parseFloat(document.getElementById('self_pay_rate').value),
                    additional_notes: document.getElementById('additional_notes').value
                };
                const taxRateEl = document.getElementById('tax_rate');
                if (taxRateEl && taxRateEl.value !== '') {
                    const tr = parseFloat(taxRateEl.value);
                    if (!Number.isNaN(tr)) formData.tax_rate = tr;
                }
                const breakdownEl = document.getElementById('breakdown');
                const totalPriceEl = document.getElementById('total_price');
                if (breakdownEl && breakdownEl.value.trim()) {
                    try { formData.breakdown = JSON.parse(breakdownEl.value.trim()); } catch (_) {}
                }
                if (totalPriceEl && totalPriceEl.value) {
                    const tp = parseFloat(totalPriceEl.value);
                    if (!Number.isNaN(tp)) formData.total_price = tp;
                }
                
                const submitBtn = document.getElementById('saveBidBtn');
                const message = document.getElementById('bidMessage');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                message.innerHTML = '';
                
                try {
                    const result = await apiCall(`/api/hotel/contracts/${contractId}/bid`, {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    
                        if (result && result.ok) {
                        // upload file if any
                        const fileInput = document.getElementById('bid_file');
                        if (fileInput && fileInput.files && fileInput.files[0]) {
                            const fd = new FormData();
                            fd.append('file', fileInput.files[0]);
                            const sessionId = localStorage.getItem('fedevent_session');
                            await fetch(`/api/hotel/contracts/${contractId}/bid/upload`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${sessionId}` },
                                body: fd
                            });
                        }
                        message.innerHTML = '<div class="success">Bid saved.</div>';
                        setTimeout(() => {
                            closeModal();
                            loadContracts();
                        }, 1200);
                    } else {
                        message.innerHTML = `<div class=\"error\">${result.error}</div>`;
                    }
                } catch (error) {
                    console.error('Submit bid error:', error);
                    message.innerHTML = '<div class="error">Failed to save bid</div>';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Draft';
                }
            });

            const finalBtn = document.getElementById('finalSubmitBtn');
            if (finalBtn) {
                finalBtn.addEventListener('click', async () => {
                    finalBtn.disabled = true;
                    const message = document.getElementById('bidMessage');
                    message.innerHTML = '';
                    try {
                        const result = await apiCall(`/api/hotel/contracts/${contractId}/bid/submit`, { method: 'POST' });
                        if (result && result.ok) {
                            message.innerHTML = '<div class="success">Bid submitted. You can still edit until the deadline.</div>';
                            setTimeout(() => { closeModal(); loadContracts(); }, 1200);
                        } else {
                            message.innerHTML = `<div class=\"error\">${result.error}</div>`;
                            finalBtn.disabled = false;
                        }
                    } catch (e) {
                        console.error('Final submit error:', e);
                        message.innerHTML = '<div class="error">Failed to submit</div>';
                        finalBtn.disabled = false;
                    }
                });
            }
        }

        // Countdown utilities
        function startCountdown(elementId, serverIso, remainingMs) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const serverNow = new Date(serverIso).getTime();
            const clientStart = Date.now();
            const endAt = clientStart + remainingMs + (Date.now() - clientStart) + (serverNow - clientStart);

            const update = () => {
                const now = Date.now();
                const left = Math.max(0, endAt - now);
                const h = Math.floor(left / 3600000);
                const m = Math.floor((left % 3600000) / 60000);
                const s = Math.floor((left % 60000) / 1000);
                el.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} remaining`;
                if (left <= 0) {
                    clearInterval(timer);
                    el.textContent = 'Bidding closed';
                }
            };
            update();
            const timer = setInterval(update, 1000);
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('biddingModal').style.display = 'none';
            currentContract = null;
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // Logout
        async function logout() {
            try {
                await apiCall('/api/auth/logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            localStorage.removeItem('fedevent_hotel');
            window.location.href = 'hotel-login.html';
        }
        
        function activateTab(tab){
            const tabs = [
                {btn:'tab-available', panel:'panel-available'},
                {btn:'tab-my-active', panel:'panel-my-active'},
                {btn:'tab-submitted', panel:'panel-submitted'},
                {btn:'tab-archived', panel:'panel-archived'},
            ];
            tabs.forEach(t => {
                const isActive = (t.btn === tab);
                const btn = document.getElementById(t.btn);
                const panel = document.getElementById(t.panel);
                if (btn) {
                    btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                    btn.style.background = isActive ? '#eef2ff' : '#fff';
                    btn.style.color = isActive ? '#1e40af' : '#6b7280';
                    btn.style.borderColor = isActive ? '#c7d2fe' : '#e5e7eb';
                }
                if (panel) panel.style.display = isActive ? 'block' : 'none';
            });
            if (tab==='tab-available') {
                loadContracts();
            } else if (tab==='tab-my-active') {
                loadBids('active','active');
            } else if (tab==='tab-submitted') {
                loadBids('submitted','submitted');
            } else if (tab==='tab-archived') {
                loadBids('archived','archived');
            }
        }

        // Initialize
        if (checkAuth()) {
            // wire tabs
            document.getElementById('tab-available').addEventListener('click', () => { activateTab('tab-available'); location.hash='available'; });
            document.getElementById('tab-my-active').addEventListener('click', () => { activateTab('tab-my-active'); location.hash='my-active'; });
            document.getElementById('tab-submitted').addEventListener('click', () => { activateTab('tab-submitted'); location.hash='submitted'; });
            document.getElementById('tab-archived').addEventListener('click', () => { activateTab('tab-archived'); location.hash='archived'; });

            const hash = (location.hash||'').replace('#','');
            if (hash === 'my-active') activateTab('tab-my-active');
            else if (hash === 'submitted') activateTab('tab-submitted');
            else if (hash === 'archived') activateTab('tab-archived');
            else activateTab('tab-available');
        }
        
        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('biddingModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
    <script src="/nav.js"></script>
</body>
</html>



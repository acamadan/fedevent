<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hotel Profile Registration</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230a58ca'/%3E%3Cpath d='M18 44h28v-4H18v4zm0-8h28V20H18v16zm6-12h16v8H24v-8z' fill='white'/%3E%3C/svg%3E">
<!-- BUILD: CREATA-SUITE 2025-08-11 v3 (localhost) -->
<link rel="stylesheet" href="/site.css">
<style>
  :root { --bg:#f4f8fb; --card:#fff; --ink:#0b2545; --muted:#5b6b7b; --accent:#0a58ca; --danger:#dc3545; --ring:rgba(10,88,202,.25); }
  *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto 64px;padding:0 16px} .card{background:var(--card);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
  h1{font-size:1.6rem;margin:0 0 6px} p.lead{margin:0 0 16px;color:var(--muted)}
  fieldset{border:1px solid #e6ecf2;border-radius:12px;padding:14px;margin:16px 0} legend{padding:0 8px;color:var(--ink);font-size:1.1rem;font-weight:700}
  label{font-weight:600;font-size:.92rem;display:block;margin:8px 0 4px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
  input:not([type=file]):not([type=checkbox]):not([type=radio]):not([type=radio]),select{width:100%;padding:10px 12px;border:1px solid #d7dee6;border-radius:10px;background:#fff;font-size:1rem;line-height:1.2;height:44px;outline:0;transition:box-shadow .15s,border-color .15s}
  textarea{width:100%;padding:10px 12px;border:1px solid #d7dee6;border-radius:10px;background:#fff;font-size:1rem;outline:0;transition:box-shadow .15s,border-color .15s;min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
  .hint{color:var(--muted);font-size:.85rem;margin-top:2px} .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.subtle{background:#eef4ff;color:var(--accent)} .btn.danger{background:#dc3545} .btn:disabled{opacity:.55;cursor:not-allowed}
  .hr{height:1px;background:#e6ecf2;margin:12px 0} .item{border:1px solid #e6ecf2;border-radius:12px;padding:12px;margin-top:8px;background:#fafcff}
  .right{text-align:right} .required{color:var(--danger)}
  .steps{display:flex;gap:10px;align-items:center;margin:8px 0 4px;flex-wrap:wrap}
  .step{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600;transition:all 0.3s ease;cursor:pointer;padding:4px 8px;border-radius:8px}
  .step:hover{background:#f8fafc;color:var(--ink)}
  .step.completed{color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0}
  .step.completed .dot{background:#10b981;color:white}
  .step.incomplete{color:#991b1b; background:#fee2e2; border:1px solid #fca5a5}
  .step.incomplete .dot{background:#dc2626;color:white}
  .step:hover .dot{transform:scale(1.1)}
  .dot{width:28px;height:28px;border-radius:50%;display:inline-grid;place-items:center;background:#eef4ff;color:#0a58ca;font-weight:800;transition:all 0.3s ease}
  .step.active{color:var(--ink)} .step.active .dot{background:#0a58ca;color:#fff}
  .step.completed{color:#10b981} .step.completed .dot{background:#10b981;color:#fff}
  .page{display:none} .page.active{display:block} .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
  .submitting{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(2px);z-index:10000}
  .submitting.show{display:flex}
  .panel{background:#fff;border:1px solid #e6ecf2;border-radius:12px;padding:14px 16px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:flex;gap:12px;align-items:center}
  .loader{width:36px;height:36px;border-radius:50%;border:3px solid #c5d6f3;border-top-color:#0a58ca;animation:spin 1s linear infinite} @keyframes spin{to{transform:rotate(360deg)}}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2545;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:10001}
  .muted{color:var(--muted);font-size:.9rem}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 720px){ .grid2{grid-template-columns:1fr} }
  
  /* Navigation styles */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  nav {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 1rem 0;
    gap: 24px;
  }
  
  .logo {
    font-size: 1.75rem;
    font-weight: bold;
    color: var(--accent);
    cursor: pointer;
    position: relative;
    user-select: none;
  }
  
  .logo:hover {
    color: #084298;
  }
  
  .nav-links {
    display: flex;
    list-style: none;
    gap: 1.25rem;
    margin-left: 16px;
  }
  
  .nav-links a {
    text-decoration: none;
    color: var(--ink);
    font-weight: 500;
    transition: color 0.2s ease;
  }
  
  .nav-links a:hover {
    color: var(--accent);
  }
  
  .user-menu { 
    position: relative; 
  }
  
  .user-trigger { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    cursor: pointer; 
    font-weight: 600; 
    color: var(--ink); 
    text-decoration: none; 
  }
  
  .user-avatar { 
    width: 28px; 
    height: 28px; 
    border-radius: 50%; 
    background: #e5e7eb; 
    display: grid; 
    place-items: center; 
    font-size: 0.85rem; 
    color: #374151; 
  }
  
  .user-dropdown { 
    position: absolute; 
    right: 0; 
    top: calc(100% + 8px); 
    background: #fff; 
    border: 1px solid #e5e7eb; 
    box-shadow: 0 8px 24px rgba(0,0,0,.08); 
    border-radius: 10px; 
    min-width: 200px; 
    padding: 6px; 
    display: none; 
    z-index: 1002; 
  }
  
  .user-dropdown a, .user-dropdown button { 
    display: block; 
    width: 100%; 
    text-align: left; 
    padding: 10px 12px; 
    border-radius: 8px; 
    background: transparent; 
    border: 0; 
    font: inherit; 
    color: #111827; 
    cursor: pointer; 
    text-decoration: none; 
  }
  
  .user-dropdown a:hover, .user-dropdown button:hover { 
    background: #f3f4f6; 
  }
  
  /* User info styling */
  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #374151;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .user-info span {
    color: #059669;
  }
  
  .logout-btn:hover {
    background: #b91c1c !important;
  }
  
  /* Autocomplete suggestions styling */
  .autocomplete-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #d7dee6;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 10001;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    width: 100%;
  }
  
  .autocomplete-suggestions .suggestion-item {
    padding: 10px 12px;
    border-bottom: 1px solid #e6ecf2;
    cursor: pointer;
    font-size: 0.95rem;
    transition: background-color 0.2s ease;
  }
  
  .autocomplete-suggestions .suggestion-item:hover {
    background-color: #f8fafc;
  }
  
  .autocomplete-suggestions .suggestion-item:last-child {
    border-bottom: none;
  }
</style>

    <!-- Google Analytics 4 (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <!-- Add Google Places API - Will be configured with API key from server -->
    <script>
      let googlePlacesApiKey = null;
      
      // IMMEDIATE TEST FUNCTIONS - Available right away
      window.testAutocomplete = function() {
        console.log('üß™ Testing autocomplete functions...');
        
        // Test if functions exist
        console.log('populateHotelNameOnly exists:', typeof populateHotelNameOnly);
        console.log('populateHotelAddressFields exists:', typeof populateHotelAddressFields);
        console.log('selectPlace exists:', typeof selectPlace);
        
        // Test if autocomplete is initialized
        console.log('Google Places API key:', googlePlacesApiKey ? 'Available' : 'Not available');
        
        // Test if input fields exist
        const hotelNameField = document.querySelector('input[name="hotel_name"]');
        const addressField = document.querySelector('input[name="address"]');
        console.log('Hotel name field found:', !!hotelNameField);
        console.log('Address field found:', !!addressField);
        
        // Test a simple place selection
        if (typeof populateHotelNameOnly === 'function') {
          const testPlace = {
            displayName: { text: 'Test Hotel' },
            id: 'test123'
          };
          console.log('Testing populateHotelNameOnly with test place...');
          populateHotelNameOnly(testPlace);
        }
      };
      
      window.testClickHandler = function() {
        console.log('üß™ Testing click handler...');
        
        // Find all autocomplete suggestions
        const suggestions = document.querySelectorAll('.autocomplete-suggestions .suggestion-item');
        console.log('Found suggestions:', suggestions.length);
        
        if (suggestions.length > 0) {
          console.log('Testing click on first suggestion...');
          const firstSuggestion = suggestions[0];
          firstSuggestion.click();
        } else {
          console.log('No suggestions found. Try typing in a field first.');
        }
      };
      
      window.testFieldPopulation = function() {
        console.log('üß™ Testing field population...');
        
        const testPlace = {
          displayName: { text: 'Test Hotel Name' },
          formattedAddress: '123 Test Street, Test City, Test State',
          addressComponents: [
            { types: ['street_number'], longText: '123' },
            { types: ['route'], longText: 'Test Street' },
            { types: ['locality'], longText: 'Test City' },
            { types: ['administrative_area_level_1'], longText: 'Test State' }
          ],
          id: 'test123'
        };
        
        console.log('Testing populateHotelFields with test place...');
        if (typeof populateHotelFields === 'function') {
          populateHotelFields(testPlace);
        } else {
          console.log('populateHotelFields function not found');
        }
      };
      
      window.testSave = function() {
        console.log('üß™ Testing save...');
        console.log('üß™ Document ready state:', document.readyState);
        console.log('üß™ Document body exists:', !!document.body);
        
        try {
          const form = document.getElementById('hotel-form');
          console.log('üß™ Form found:', !!form);
          if (!form) {
            console.log('üö® Form not found for save');
            return;
          }
          
          const formData = new FormData(form);
          const data = {};
          
          for (const [key, value] of formData.entries()) {
            data[key] = value;
          }
          
          console.log('üß™ Form data collected:', Object.keys(data).length, 'fields');
          console.log('üß™ Sample data:', Object.keys(data).slice(0, 3));
          
          localStorage.setItem('hotel_draft', JSON.stringify(data));
          console.log('üö® SAVED:', Object.keys(data).length, 'fields to localStorage');
          
          // Show save notification
          console.log('üß™ Creating toast notification...');
          const toast = document.createElement('div');
          toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-weight:600;';
          toast.textContent = '‚úì Saved';
          console.log('üß™ Toast created, adding to body...');
          document.body.appendChild(toast);
          console.log('üß™ Toast added to body');
          setTimeout(() => {
            console.log('üß™ Removing toast...');
            toast.remove();
          }, 1500);
          
        } catch (e) {
          console.error('üö® Save error:', e);
          console.error('üö® Error stack:', e.stack);
        }
      };
      
      window.testInput = function() {
        console.log('üß™ Testing input...');
        const hotelName = document.querySelector('[name="hotel_name"]');
        if (hotelName) {
          hotelName.value = 'Test Hotel ' + Date.now();
          console.log('üß™ Set hotel name to:', hotelName.value);
          window.testSave(); // Auto-save after setting
        } else {
          console.error('üß™ Hotel name field not found!');
        }
      };
      
      // SIMPLE POPUP TEST - Just shows a popup
      window.testPopup = function() {
        console.log('üß™ Testing popup...');
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#ef4444; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-weight:600;';
        toast.textContent = 'üö® TEST POPUP';
        document.body.appendChild(toast);
        console.log('üß™ Popup added to body');
        setTimeout(() => {
          toast.remove();
          console.log('üß™ Popup removed');
        }, 3000);
      };
      
      // AUTO-SAVE EVERY 10 SECONDS
      window.startAutoSave = function() {
        console.log('‚è∞ Starting auto-save every 10 seconds...');
        
        // Clear any existing interval
        if (window.autoSaveInterval) {
          clearInterval(window.autoSaveInterval);
        }
        
        // Start new interval
        window.autoSaveInterval = setInterval(function() {
          console.log('‚è∞ Auto-save triggered (10s interval)');
          try {
            const form = document.getElementById('hotel-form');
            if (!form) {
              console.log('‚è∞ Form not found for auto-save');
              return;
            }
            
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
              data[key] = value;
            }
            
            // Only save if there's actual data
            if (Object.keys(data).length > 0) {
              localStorage.setItem('hotel_draft', JSON.stringify(data));
              console.log('‚è∞ Auto-saved:', Object.keys(data).length, 'fields');
              
              // Show subtle notification
              const existingToast = document.querySelector('.autosave-toast');
              if (existingToast) existingToast.remove();
              
              const toast = document.createElement('div');
              toast.className = 'autosave-toast';
              toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:6px 10px; border-radius:4px; z-index:10000; font-size:0.8rem; font-weight:600; opacity:0.8;';
              toast.textContent = '‚úì Auto-saved';
              document.body.appendChild(toast);
              setTimeout(() => {
                if (toast.parentNode) toast.remove();
              }, 1000);
            }
          } catch (e) {
            console.error('‚è∞ Auto-save error:', e);
          }
        }, 10000); // 10 seconds
        
        console.log('‚è∞ Auto-save started successfully');
      };
      
      // STOP AUTO-SAVE
      window.stopAutoSave = function() {
        console.log('‚è∞ Stopping auto-save...');
        if (window.autoSaveInterval) {
          clearInterval(window.autoSaveInterval);
          window.autoSaveInterval = null;
          console.log('‚è∞ Auto-save stopped');
        }
      };
      
      // Function to load Google Places API key from server
      async function loadGooglePlacesAPI() {
        try {
          console.log('Loading Google Places API key...');
          const response = await fetch('/api/google-places-key');
          
          if (!response.ok) {
            console.log('Google Places API not configured - skipping');
            showToast('‚ÑπÔ∏è Google Places API not configured');
            return;
          }
          
          const data = await response.json();
          console.log('Google Places API response:', data);
          
          // Handle mock mode
          if (data.mockMode) {
            console.log('Development Mode: Google Places API not configured, using mock data');
            showToast('‚ÑπÔ∏è Development Mode: Google Places API not configured');
            return;
          }
          
          if (data && data.apiKey) {
            googlePlacesApiKey = data.apiKey;
            console.log('Google Places API key loaded successfully');
            showToast('‚úÖ Google Places API loaded');
            // Initialize autocomplete functionality with a small delay
            setTimeout(() => {
              initAutocomplete();
            }, 200);
          } else {
            console.log('Google Places API key not available');
            showToast('‚ö†Ô∏è Google Places API key not available');
          }
        } catch (error) {
          console.error('Error loading Google Places API:', error);
          showToast('‚ùå Google Places API error: ' + error.message);
        }
      }
      
      // Initialize Google Places Autocomplete using direct HTTP requests
      async function initAutocomplete() {
        console.log('Initializing Google Places Autocomplete...');
        console.log('Google Places API key available:', !!googlePlacesApiKey);
        
        if (!googlePlacesApiKey) {
          console.error('Google Places API key not available');
          showToast('‚ùå Google Places API key not available');
          return;
        }
        
        // Set up autocomplete for hotel name field
        const hotelNameInput = document.querySelector('input[name="hotel_name"]');
        console.log('Hotel name input found:', !!hotelNameInput);
        if (hotelNameInput) {
          console.log('Setting up autocomplete for hotel name field');
          setupAutocompleteForField(hotelNameInput, 'hotel_name');
        } else {
          console.log('Hotel name input not found');
        }
        
        // Set up autocomplete for hotel address field
        const addressInput = document.querySelector('input[name="address"]');
        console.log('Address input found:', !!addressInput);
        if (addressInput) {
          console.log('Setting up autocomplete for hotel address field');
          setupAutocompleteForField(addressInput, 'hotel_address');
        } else {
          console.log('Hotel address input not found');
        }
        
        // Set up autocomplete for management company name field
        const managementCompanyNameInput = document.querySelector('input[name="management_company"]');
        if (managementCompanyNameInput) {
          console.log('Setting up autocomplete for management company name field');
          setupAutocompleteForField(managementCompanyNameInput, 'management');
        } else {
          console.log('Management company name input not found');
        }
        
        // Set up autocomplete for management company address field
        const managementCompanyAddressInput = document.querySelector('input[name="management_company_address"]');
        if (managementCompanyAddressInput) {
          console.log('Setting up autocomplete for management company address field');
          setupAutocompleteForField(managementCompanyAddressInput, 'management');
        } else {
          console.log('Management company address input not found');
        }
      }
      
      // Helper function to set up autocomplete for any field
      function setupAutocompleteForField(inputField, type) {
        // Create a container for autocomplete suggestions
        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.className = 'autocomplete-suggestions';
        suggestionsContainer.style.cssText = `
          position: absolute;
          background: white;
          border: 1px solid #d7dee6;
          border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          z-index: 10001;
          max-height: 300px;
          overflow-y: auto;
          display: none;
          width: 100%;
          top: 100%;
          left: 0;
        `;
        // Ensure the input field's parent has relative positioning
        if (inputField.parentNode.style.position !== 'relative') {
          inputField.parentNode.style.position = 'relative';
        }
        inputField.parentNode.appendChild(suggestionsContainer);
        
        let debounceTimer;
        inputField.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          const query = this.value;
          
          if (query.length < 3) {
            suggestionsContainer.style.display = 'none';
            return;
          }
          
          debounceTimer = setTimeout(() => {
            searchPlaces(query, suggestionsContainer, type);
          }, 300);
        });
        
        // Hide suggestions when clicking outside (use once flag to prevent duplicates)
        const clickOutsideHandler = function(event) {
          if (!inputField.contains(event.target) && !suggestionsContainer.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
            suggestionsContainer.innerHTML = '';
          }
        };
        
        // Remove any existing handler before adding new one
        document.removeEventListener('click', clickOutsideHandler);
        document.addEventListener('click', clickOutsideHandler);
      }
      
      // Search for places using the new Google Places API
      async function searchPlaces(query, suggestionsContainer, type) {
        if (!googlePlacesApiKey) {
          console.error('Google Places API key not available for search');
          return;
        }
        
        try {
          console.log('Searching places for query:', query);
          const response = await fetch(`https://places.googleapis.com/v1/places:searchText`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Goog-Api-Key': googlePlacesApiKey,
              'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.addressComponents,places.internationalPhoneNumber,places.websiteUri'
            },
            body: JSON.stringify({
              textQuery: query,
              maxResultCount: 5
            })
          });
          
          const responseText = await response.text();
          
          if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}: ${responseText}`);
          }
          
          const data = JSON.parse(responseText);
          console.log('Places search results:', data);
          
          if (!data.places || data.places.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
          }
          
          // Display suggestions
          displaySuggestions(data.places, suggestionsContainer, type);
        } catch (error) {
          console.error('Error searching places:', error);
          showToast('‚ùå Error searching places: ' + error.message);
        }
      }
      
      // Display autocomplete suggestions
      function displaySuggestions(places, suggestionsContainer, type) {
        suggestionsContainer.innerHTML = '';
        
        places.forEach(place => {
          const suggestionItem = document.createElement('div');
          suggestionItem.className = 'suggestion-item';
          suggestionItem.innerHTML = `
            <div style="font-weight: 600;">${place.displayName.text}</div>
            <div style="font-size: 0.85rem; color: #5b6b7b;">${place.formattedAddress || ''}</div>
          `;
          
          // Use mousedown instead of click for more reliable event handling
          suggestionItem.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üß™ Autocomplete item clicked:', place.displayName.text);
            console.log('üß™ Click type:', type);
            console.log('üß™ Place object:', place);
            
            // Hide ALL autocomplete suggestions to prevent stuck dropdowns
            document.querySelectorAll('.autocomplete-suggestions').forEach(container => {
              container.style.display = 'none';
              container.innerHTML = '';
            });
            
            // Then select the place
            console.log('üß™ Calling selectPlace with type:', type);
            setTimeout(() => {
              selectPlace(place, type);
              console.log('‚úÖ Place selected and autocomplete hidden');
            }, 50);
          });
          
          suggestionsContainer.appendChild(suggestionItem);
        });
        
        suggestionsContainer.style.display = 'block';
      }
      // Handle place selection
      function selectPlace(place, type) {
        console.log('üß™ selectPlace called with:', { place, type });
        console.log('üß™ Place display name:', place.displayName?.text);
        console.log('üß™ Place formatted address:', place.formattedAddress);
        
        if (type === 'hotel_name') {
          // Populate full hotel fields when selecting from Hotel Name autocomplete
          console.log('üß™ Type is hotel_name, populating full hotel fields...');
          populateHotelFields(place);
          const hid = document.getElementById('hotel_place_id');
          if (hid) hid.value = place.id || '';
        } else if (type === 'hotel_address') {
          console.log('Populating hotel address fields...');
          populateHotelAddressFields(place);
          const hid = document.getElementById('hotel_place_id');
          if (hid) hid.value = place.id || '';
        } else if (type === 'hotel') {
          console.log('Populating all hotel fields...');
          populateHotelFields(place);
          const hid = document.getElementById('hotel_place_id');
          if (hid) hid.value = place.id || '';
        } else if (type === 'management') {
          console.log('Populating management company fields...');
          populateManagementCompanyFields(place);
          const mid = document.getElementById('management_company_place_id');
          if (mid) mid.value = place.id || '';
        }
      }
      
      // Populate only hotel name field
      function populateHotelNameOnly(place) {
        console.log('üß™ populateHotelNameOnly called with place:', place);
        console.log('üß™ Place display name:', place.displayName?.text);
        
        const hotelNameField = document.querySelector('input[name="hotel_name"]');
        const offName = document.getElementById('hotel_official_name');
        
        console.log('üß™ Hotel name field found:', !!hotelNameField);
        console.log('üß™ Official name field found:', !!offName);
        
        if (place.displayName && place.displayName.text && hotelNameField) {
          console.log('üß™ Setting hotel name to:', place.displayName.text);
          hotelNameField.value = place.displayName.text;
          console.log('üß™ Hotel name field value set to:', hotelNameField.value);
          
          if (offName) {
            offName.value = place.displayName.text;
            console.log('üß™ Official name field value set to:', offName.value);
          }
          showToast('‚úÖ Hotel name updated!');
        } else {
          console.log('üß™ Could not set hotel name - missing data or field');
          console.log('üß™ Place display name exists:', !!place.displayName);
          console.log('üß™ Place display name text exists:', !!place.displayName?.text);
          console.log('üß™ Hotel name field exists:', !!hotelNameField);
        }
      }
      
      // Populate hotel address fields only
      function populateHotelAddressFields(place) {
        console.log('Populating hotel address fields only');
        showToast('üîÑ Auto-populating address information...');
        
        // Extract address components
        const addressComponents = {};
        if (place.addressComponents) {
          for (const component of place.addressComponents) {
            const types = component.types;
            for (const type of types) {
              addressComponents[type] = component.longText || component.shortText;
            }
          }
        }
        
        // Populate only address-related fields
        const addressField = document.querySelector('input[name="address"]');
        const cityField = document.querySelector('input[name="city"]');
        const stateField = document.querySelector('input[name="state"]');
        const zipField = document.querySelector('input[name="zip"]');
        const countryField = document.querySelector('input[name="country"]');
        const phoneField = document.querySelector('input[name="hotel_phone"]');
        const websiteField = document.querySelector('input[name="website"]');
        
        // Fill address field - extract street address intelligently
        if (place.formattedAddress && addressField) {
          let streetAddress = '';
          
          // Try to build street address from components first (more reliable)
          const streetNumber = addressComponents['street_number'] || '';
          const route = addressComponents['route'] || '';
          const sublocality = addressComponents['sublocality'] || '';
          const neighborhood = addressComponents['neighborhood'] || '';
          
          // Build street address from components
          // US format: street number FIRST, then street name (e.g., "123 Main St")
          if (route) {
            streetAddress = streetNumber ? `${streetNumber} ${route}` : route;
          } else if (neighborhood && route) {
            streetAddress = `${neighborhood}, ${route}`;
          } else if (sublocality && route) {
            streetAddress = `${sublocality}, ${route}`;
          } else {
            // Fallback: extract from formatted address
            const addressParts = place.formattedAddress.split(',').map(p => p.trim());
            
            // For international addresses, take first 2 parts if they look like street info
            if (addressParts.length >= 2) {
              const firstPart = addressParts[0];
              const secondPart = addressParts[1];
              
              // Check if second part looks like a street (contains "Cd", "St", "Ave", "Rd", "No:", etc.)
              if (secondPart && /\b(Cd\.|St\.|Ave\.|Rd\.|No:|Street|Avenue|Road|Boulevard|Blvd)\b/i.test(secondPart)) {
                streetAddress = `${firstPart}, ${secondPart}`;
              } else {
                streetAddress = firstPart;
              }
            } else {
              streetAddress = addressParts[0];
            }
          }
          
          addressField.value = streetAddress;
          console.log('üìç Address field set to:', streetAddress);
        }
        
        // Fill other address fields
        if (addressComponents['locality'] && cityField) {
          cityField.value = addressComponents['locality'];
        } else if (addressComponents['sublocality'] && cityField) {
          cityField.value = addressComponents['sublocality'];
        } else if (addressComponents['administrative_area_level_2'] && cityField) {
          cityField.value = addressComponents['administrative_area_level_2'].replace(' County', '');
        }
        
        if (addressComponents['administrative_area_level_1'] && stateField) {
          stateField.value = addressComponents['administrative_area_level_1'];
        }
        
        if (addressComponents['postal_code'] && zipField) {
          zipField.value = addressComponents['postal_code'];
        }
        
        if (addressComponents['country'] && countryField) {
          countryField.value = addressComponents['country'];
        }
        
        // Fill phone number if available
        if (place.internationalPhoneNumber && phoneField) {
          phoneField.value = place.internationalPhoneNumber;
        }
        
        // Fill website if available and not already filled
        if (place.websiteUri && websiteField && !websiteField.value) {
          const cleanUrl = cleanWebsiteUrl(place.websiteUri);
          websiteField.value = cleanUrl;
        }
        
        const offAddr = document.getElementById('hotel_official_address');
        if (offAddr && place.formattedAddress) offAddr.value = place.formattedAddress;
        
        showToast('‚úÖ Address information updated!');
      }
      
      // Populate hotel form fields with place data
      function populateHotelFields(place) {
        showToast('üîÑ Auto-populating hotel information...');
        
        // Extract address components
        const addressComponents = {};
        if (place.addressComponents) {
          for (const component of place.addressComponents) {
            const types = component.types;
            for (const type of types) {
              addressComponents[type] = component.longText || component.shortText;
            }
          }
        }
        
        // Populate the hotel form fields
        const addressField = document.querySelector('input[name="address"]');
        const cityField = document.querySelector('input[name="city"]');
        const stateField = document.querySelector('input[name="state"]');
        const zipField = document.querySelector('input[name="zip"]');
        const countryField = document.querySelector('input[name="country"]');
        const phoneField = document.querySelector('input[name="hotel_phone"]');
        const hotelNameField = document.querySelector('input[name="hotel_name"]');
        const websiteField = document.querySelector('input[name="website"]');
        
        // Fill address field - extract street address intelligently
        if (place.formattedAddress && addressField) {
          let streetAddress = '';
          
          // Try to build street address from components first (more reliable)
          const streetNumber = addressComponents['street_number'] || '';
          const route = addressComponents['route'] || '';
          const sublocality = addressComponents['sublocality'] || '';
          const neighborhood = addressComponents['neighborhood'] || '';
          
          // Build street address from components
          // US format: street number FIRST, then street name (e.g., "123 Main St")
          if (route) {
            streetAddress = streetNumber ? `${streetNumber} ${route}` : route;
          } else if (neighborhood && route) {
            streetAddress = `${neighborhood}, ${route}`;
          } else if (sublocality && route) {
            streetAddress = `${sublocality}, ${route}`;
          } else {
            // Fallback: extract from formatted address
            // Take everything before the city/postal code
            const addressParts = place.formattedAddress.split(',').map(p => p.trim());
            
            // For international addresses, take first 2 parts if they don't contain numbers suggesting postal code
            if (addressParts.length >= 2) {
              const firstPart = addressParts[0];
              const secondPart = addressParts[1];
              
              // Check if second part looks like a street (contains "Cd", "St", "Ave", "Rd", "No:", etc.)
              if (secondPart && /\b(Cd\.|St\.|Ave\.|Rd\.|No:|Street|Avenue|Road|Boulevard|Blvd)\b/i.test(secondPart)) {
                streetAddress = `${firstPart}, ${secondPart}`;
              } else {
                streetAddress = firstPart;
              }
            } else {
              streetAddress = addressParts[0];
            }
          }
          
          addressField.value = streetAddress;
          console.log('üìç Street address set to:', streetAddress);
        }
        
        // Fill other fields
        if (addressComponents['locality'] && cityField) {
          cityField.value = addressComponents['locality'];
        } else if (addressComponents['sublocality'] && cityField) {
          cityField.value = addressComponents['sublocality'];
        } else if (addressComponents['administrative_area_level_2'] && cityField) {
          cityField.value = addressComponents['administrative_area_level_2'].replace(' County', '');
        }
        
        if (addressComponents['administrative_area_level_1'] && stateField) {
          stateField.value = addressComponents['administrative_area_level_1'];
        }
        
        if (addressComponents['postal_code'] && zipField) {
          zipField.value = addressComponents['postal_code'];
        }
        
        if (addressComponents['country'] && countryField) {
          countryField.value = addressComponents['country'];
        }
        
        // Fill phone number if available
        if (place.internationalPhoneNumber && phoneField) {
          phoneField.value = place.internationalPhoneNumber;
        }
        
        // Always fill/replace hotel name with the selected place's official name
        console.log('Hotel name field found:', !!hotelNameField);
        console.log('Place display name:', place.displayName?.text);
        if (place.displayName && place.displayName.text && hotelNameField) {
          console.log('Setting hotel name to:', place.displayName.text);
          hotelNameField.value = place.displayName.text;
          
          // Force the value to persist by triggering change event
          const changeEvent = new Event('change', { bubbles: true });
          hotelNameField.dispatchEvent(changeEvent);
          
          const offName = document.getElementById('hotel_official_name');
          if (offName) {
            offName.value = place.displayName.text;
            console.log('Set official name to:', place.displayName.text);
          }
          
          // Mark that autocomplete was used (to prevent clearing)
          hotelNameField.dataset.autocompleteUsed = 'true';
          console.log('‚úÖ Hotel name set successfully via autocomplete');
        } else {
          console.log('Could not set hotel name - missing data or field');
        }
        
        // Fill website if available and not already filled
        if (place.websiteUri && websiteField && !websiteField.value) {
          // Clean the website URL - remove parameters and protocol for display
          const cleanUrl = cleanWebsiteUrl(place.websiteUri);
          websiteField.value = cleanUrl;
        }
        const offAddr = document.getElementById('hotel_official_address');
        if (offAddr && place.formattedAddress) offAddr.value = place.formattedAddress;
        const hid = document.getElementById('hotel_place_id');
        if (hid) hid.value = place.id || '';
        
        // Show success message
        showToast('‚úÖ Hotel information auto-populated successfully!');
        console.log('Hotel place details:', place);
        
        // FORCE SAVE after Places API fills the form
        console.log('üî¥üî¥üî¥ HOTEL ADDRESS AUTOCOMPLETE COMPLETED üî¥üî¥üî¥');
        
        setTimeout(() => {
          try {
            if (typeof window.handleSaveDraft === 'function') {
              if (window.isPopulatingForm) {
                window.isPopulatingForm = false;
              }
              window.handleSaveDraft('places-api-auto');
            } else {
              console.warn('handleSaveDraft not available after autocomplete selection');
            }
          } catch (saveError) {
            console.error('Failed to auto-save after Places selection:', saveError);
          }
        }, 600);
      }

      // Populate management company form fields with place data
      function populateManagementCompanyFields(place) {
        // Don't show toast to avoid scroll
        console.log('üîÑ Auto-populating management company information...');
        
        // Extract address components
        const addressComponents = {};
        if (place.addressComponents) {
          for (const component of place.addressComponents) {
            const types = component.types;
            for (const type of types) {
              addressComponents[type] = component.longText || component.shortText;
            }
          }
        }
        
        // Populate the management company form fields
        const managementCompanyField = document.querySelector('input[name="management_company"]');
        const managementCompanyStreetField = document.querySelector('input[name="management_company_street"]');
        const managementCompanyCityField = document.querySelector('input[name="management_company_city"]');
        const managementCompanyStateField = document.querySelector('input[name="management_company_state"]');
        const managementCompanyZipField = document.querySelector('input[name="management_company_zip"]');
        const managementCompanyCountryField = document.querySelector('input[name="management_company_country"]');
        const managementCompanyWebsiteField = document.querySelector('input[name="management_company_website"]');
        
        // Always fill/replace management company name with the selected place's official name
        if (place.displayName && place.displayName.text && managementCompanyField) {
          managementCompanyField.value = place.displayName.text;
          const offName = document.getElementById('management_company_official_name');
          if (offName) offName.value = place.displayName.text;
        }
        
        // Fill street address field - extract street address only
        if (place.formattedAddress && managementCompanyStreetField) {
          // Extract just the street address part (building number + street name)
          const addressParts = place.formattedAddress.split(',');
          managementCompanyStreetField.value = addressParts[0].trim(); // Just the street address part
          
          const offAddr = document.getElementById('management_company_official_address');
          if (offAddr) offAddr.value = place.formattedAddress; // Keep full address in hidden field
        }
        
        // Fill other fields
        if (addressComponents['locality'] && managementCompanyCityField) {
          managementCompanyCityField.value = addressComponents['locality'];
        } else if (addressComponents['sublocality'] && managementCompanyCityField) {
          managementCompanyCityField.value = addressComponents['sublocality'];
        } else if (addressComponents['administrative_area_level_2'] && managementCompanyCityField) {
          managementCompanyCityField.value = addressComponents['administrative_area_level_2'].replace(' County', '');
        }
        
        if (addressComponents['administrative_area_level_1'] && managementCompanyStateField) {
          managementCompanyStateField.value = addressComponents['administrative_area_level_1'];
        }
        
        if (addressComponents['postal_code'] && managementCompanyZipField) {
          managementCompanyZipField.value = addressComponents['postal_code'];
        }
        
        if (addressComponents['country'] && managementCompanyCountryField) {
          managementCompanyCountryField.value = addressComponents['country'];
        }
        
        // Fill website if available and field exists
        if (place.websiteUri && managementCompanyWebsiteField) {
          // Clean the website URL - remove parameters and protocol for display
          const cleanUrl = cleanWebsiteUrl(place.websiteUri);
          managementCompanyWebsiteField.value = cleanUrl;
          console.log('Management company website populated:', cleanUrl, '(cleaned from:', place.websiteUri, ')');
        } else if (managementCompanyWebsiteField) {
          console.log('No website found for management company place');
        }
        
        const mid = document.getElementById('management_company_place_id');
        if (mid) mid.value = place.id || '';
        
        // Log success (no toast to avoid scroll)
        console.log('‚úÖ Management company information auto-populated successfully!');
        console.log('Management company place details:', place);
        
        // Auto-save after Places API fills the management company form (always save)
        setTimeout(() => {
          if (typeof handleSaveDraft === 'function') {
            handleSaveDraft('places-api-auto');
          } else if (typeof simpleSave === 'function') {
            simpleSave();
          }
        }, 500); // Small delay to ensure all fields are updated
        
        // Update visibility to show the fields now that they have data
        setTimeout(() => {
          const selectEl = document.getElementById('is_management_company_managed');
          if (selectEl) {
            selectEl.dispatchEvent(new Event('change'));
          }
        }, 100);
      }
      
      // Function to clean website URLs for better display
      function cleanWebsiteUrl(url) {
        if (!url) return '';
        
        try {
          // Create URL object to parse the URL
          let cleanUrl = url;
          
          // Remove duplicate protocols (e.g., "https://aimbridgehospitality.com/https://aimbridgehospitality.com/")
          if (cleanUrl.includes('://') && cleanUrl.lastIndexOf('://') > cleanUrl.indexOf('://')) {
            // Find the second occurrence of protocol and take everything from there
            const secondProtocolIndex = cleanUrl.lastIndexOf('://');
            cleanUrl = cleanUrl.substring(secondProtocolIndex - 5); // Include "https" or "http"
          }
          
          const urlObj = new URL(cleanUrl);
          
          // Get just the protocol and hostname (no path, no parameters)
          const baseUrl = `${urlObj.protocol}//${urlObj.hostname}`;
          
          console.log('Cleaned URL:', url, '->', baseUrl);
          return baseUrl;
          
        } catch (error) {
          console.error('Error cleaning URL:', url, error);
          // Fallback: try to extract domain manually
          try {
            // Remove protocol
            let domain = url.replace(/^https?:\/\//, '');
            
            // Remove duplicate protocols if they exist
            if (domain.includes('://')) {
              domain = domain.substring(domain.lastIndexOf('://') + 3);
            }
            
            // Remove path and parameters
            domain = domain.split('/')[0].split('?')[0].split('#')[0];
            
            // Add back https protocol
            const cleanUrl = `https://${domain}`;
            console.log('Fallback cleaned URL:', url, '->', cleanUrl);
            return cleanUrl;
            
          } catch (fallbackError) {
            console.error('Fallback URL cleaning failed:', fallbackError);
            return url; // Return original if all cleaning fails
          }
        }
      }
      
      // Function to show a toast message
      function showToast(message) {
        // Only scroll to top for important messages, not autocomplete
        if (!message.includes('autocomplete') && !message.includes('suggestion')) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Remove any existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = message;
        document.body.appendChild(toast);
        
        // Show toast
        toast.style.display = 'block';
        
        // Hide toast after 3 seconds
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 500);
        }, 3000);
      }
      
      // Close suggestions when clicking outside
      document.addEventListener('click', function(event) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestions');
        suggestions.forEach(suggestion => {
          if (!suggestion.contains(event.target) && !event.target.closest('input[name="address"], input[name="management_company_address"]')) {
            suggestion.style.display = 'none';
          }
        });
      });
      
      // Load the API when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing Google Places API...');
        
        // Add a small delay to ensure all form elements are loaded
        setTimeout(() => {
          loadGooglePlacesAPI();
        }, 100);
        
        // Initialize FDIC Bank Lookup
        initializeFDICLookup();
      });
      
      // FDIC Bank Lookup Functionality
      function initializeFDICLookup() {
        console.log('üè¶ Initializing FDIC bank lookup...');
        
        // Set up ACH routing number lookup
        const achRoutingInput = document.getElementById('ach_routing_number');
        const achBankNameInput = document.getElementById('ach_bank_name');
        
        if (achRoutingInput && achBankNameInput) {
          achRoutingInput.addEventListener('input', function() {
            const routingNumber = this.value.replace(/\D/g, ''); // Remove non-digits
            
            // Format routing number as user types
            if (routingNumber.length <= 9) {
              this.value = routingNumber;
            }
            
            // Lookup bank name when 9 digits are entered
            if (routingNumber.length === 9) {
              lookupBankByRoutingNumber(routingNumber, achBankNameInput);
            } else {
              // Clear bank name if routing number is incomplete
              achBankNameInput.value = '';
              achBankNameInput.style.backgroundColor = '';
            }
          });
          
          console.log('üè¶ ACH routing number lookup initialized');
        }
        
        // Set up Wire routing number lookup (if needed)
        const wireRoutingInput = document.getElementById('wire_routing_number');
        const wireBankNameInput = document.getElementById('wire_bank_name');
        
        if (wireRoutingInput && wireBankNameInput) {
          wireRoutingInput.addEventListener('input', function() {
            const routingNumber = this.value.replace(/\D/g, '');
            
            if (routingNumber.length <= 9) {
              this.value = routingNumber;
            }
            
            if (routingNumber.length === 9) {
              lookupBankByRoutingNumber(routingNumber, wireBankNameInput);
            } else {
              wireBankNameInput.value = '';
              wireBankNameInput.style.backgroundColor = '';
            }
          });
          
          console.log('üè¶ Wire routing number lookup initialized');
        }
      }
      
      // FDIC Bank Lookup Function
      async function lookupBankByRoutingNumber(routingNumber, bankNameField) {
        console.log('üè¶ Looking up bank for routing number:', routingNumber);
        
        try {
          // Show loading state
          bankNameField.value = 'Looking up bank...';
          bankNameField.style.backgroundColor = '#f0f9ff';
          bankNameField.disabled = true;
          
          // Call FDIC API via our backend
          const response = await fetch(`/api/routing/${routingNumber}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          
          if (response.ok && result.bankName) {
            // Successfully found bank
            bankNameField.value = result.bankName;
            bankNameField.style.backgroundColor = '#dcfce7'; // Light green
            bankNameField.disabled = false;
            
            console.log('üè¶ Bank found:', result.bankName);
            showToast(`‚úÖ Bank found: ${result.bankName}`);
            
            // Auto-save after bank lookup
            if (signedIn || window.signedIn) {
              setTimeout(() => {
                handleSaveDraft('bank-lookup');
              }, 500);
            }
            
          } else {
            // Bank not found or invalid routing number
            bankNameField.value = '';
            bankNameField.style.backgroundColor = '#fef2f2'; // Light red
            bankNameField.disabled = false;
            bankNameField.placeholder = 'Bank not found - please enter manually';
            
            console.log('üè¶ Bank not found for routing number:', routingNumber);
            showToast('‚ö†Ô∏è Bank not found for this routing number');
          }
          
        } catch (error) {
          console.error('üè¶ FDIC lookup error:', error);
          
          // Reset field on error
          bankNameField.value = '';
          bankNameField.style.backgroundColor = '#fef2f2';
          bankNameField.disabled = false;
          bankNameField.placeholder = 'Error looking up bank - please enter manually';
          
          showToast('‚ùå Error looking up bank name');
        }
      }
    </script>
    <script>
      // Show/hide Management/Franchise Company fields based on selection in Section 2
      document.addEventListener('DOMContentLoaded', function(){
        const selectEl = document.getElementById('is_management_company_managed');
        const fieldsEl = document.getElementById('managementCompanyFields');
        
        function updateVisibility() {
          if (!selectEl || !fieldsEl) return;
          
          console.log('Management company visibility check:', {
            selectValue: selectEl.value,
            fieldsElement: !!fieldsEl
          });
          
          // Check if dropdown is set to "Yes"
          const isYes = (selectEl.value === 'Yes');
          
          // Also check if any management company fields have data
          const hasData = Array.from(fieldsEl.querySelectorAll('input')).some(input => input.value.trim() !== '');
          
          console.log('Management company data check:', {
            isYes: isYes,
            hasData: hasData,
            fieldValues: Array.from(fieldsEl.querySelectorAll('input')).map(input => ({name: input.name, value: input.value}))
          });
          
          // Show fields if dropdown is "Yes" OR if there's data in the fields
          const shouldShow = isYes || hasData;
          fieldsEl.style.display = shouldShow ? 'block' : 'none';
          
          console.log('Management company fields visibility:', {
            shouldShow: shouldShow,
            actualDisplay: fieldsEl.style.display
          });
          
          // If there's data but dropdown isn't "Yes", set it to "Yes" to maintain consistency
          if (hasData && !isYes) {
            selectEl.value = 'Yes';
            console.log('Auto-set dropdown to Yes due to existing data');
          }
        }
        
        if (selectEl) {
          selectEl.addEventListener('change', updateVisibility);
          // Initialize on load with delay to ensure all data is loaded
          setTimeout(updateVisibility, 100);
          setTimeout(updateVisibility, 500); // Additional check after draft loading
          setTimeout(updateVisibility, 1000); // Final check
        }

        // Re-run visibility when returning via bfcache/back navigation
        window.addEventListener('pageshow', function(){
          if (selectEl) {
            setTimeout(updateVisibility, 100);
          }
        });
        
        // Also run when form data is populated (for draft loading)
        window.addEventListener('formDataLoaded', function(){
          if (selectEl) {
            setTimeout(updateVisibility, 100);
          }
        });
      });
    </script>
    
    <script>
      window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX', {
            // Enhanced ecommerce and event tracking
            send_page_view: true,
            custom_map: {
                'custom_parameter_1': 'fedevent_website'
            }
        });
        
        // Custom event tracking functions
        function trackNavigationClick(section) {
            gtag('event', 'navigation_click', {
                'event_category': 'Website Navigation',
                'event_label': section,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackButtonClick(buttonName) {
            gtag('event', 'button_click', {
                'event_category': 'Website Interaction',
                'event_label': buttonName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackFormSubmission(formName) {
            gtag('event', 'form_submission', {
                'event_category': 'Website Forms',
                'event_label': formName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        // Dropdown functionality
        function toggleLogoDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('logoDropdown');
            const userDropdown = document.getElementById('userDropdown');
            
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (userDropdown) userDropdown.style.display = 'none';
        }
        
        function toggleUserDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            const logoDropdown = document.getElementById('logoDropdown');
            
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (logoDropdown) logoDropdown.style.display = 'none';
        }

        function logoutUser() {
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            window.location.href = '/hotel-login.html';
        }

        function loadUserMenu() {
            try {
                const sessionId = localStorage.getItem('fedevent_session');
                const userRaw = localStorage.getItem('fedevent_user');
                if (!sessionId || !userRaw) return;
                const user = JSON.parse(userRaw);
                let name = user.first_name && user.last_name ? `${user.first_name} ${user.last_name}` : (user.first_name || user.username || user.email || 'User');
                name = name.replace(/\b(Hotel|User)\b/gi, '').trim();
                const initial = (name || 'U').trim().charAt(0).toUpperCase();
                document.getElementById('userNameLabel').textContent = name;
                document.getElementById('userInitial').textContent = initial;
                document.getElementById('userMenu').style.display = 'list-item';
            } catch (e) { /* noop */ }
        }

        document.addEventListener('DOMContentLoaded', loadUserMenu);
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const logoDropdown = document.getElementById('logoDropdown');
            const userDropdown = document.getElementById('userDropdown');
            const logoMenu = document.querySelector('.logo-menu');
            const userMenu = document.getElementById('userMenu');
            
            if (logoDropdown && logoMenu && !logoMenu.contains(event.target)) {
                logoDropdown.style.display = 'none';
            }
            
            if (userDropdown && userMenu && !userMenu.contains(event.target)) {
                userDropdown.style.display = 'none';
            }
        });
        
        function trackPageView(pageName) {
            gtag('event', 'page_view', {
                'event_category': 'Page Views',
                'event_label': pageName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
    </script>
</head>
<body>
    <header>
      <nav class="container">
        <div class="logo-menu" style="position: relative;">
          <a href="javascript:void(0)" class="logo" onclick="toggleLogoDropdown(event)">FEDEVENT <span style="font-size: 0.7em;">‚ñæ</span></a>
          <div class="logo-dropdown" id="logoDropdown" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 200px; display: none; z-index: 1000;">
            <a href="/" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Home</a>
            <a href="/hotel-signup.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Hotel Registration</a>
            <a href="/hotel-login.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Hotel Portal</a>
            <a href="/government-portal.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Government Portal</a>
            <a href="/resources.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Resources</a>
            <a href="/about.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151;">About</a>
          </div>
        </div>
        <ul class="nav-links">
          <li id="userMenu" class="user-menu" style="display:none;">
            <a class="user-trigger" href="javascript:void(0)" onclick="toggleUserDropdown(event)">
              <span class="user-avatar" id="userInitial">U</span>
              <span id="userNameLabel">User</span>
              <span aria-hidden>‚ñæ</span>
            </a>
            <div class="user-dropdown" id="userDropdown">
              <a href="/hotel-dashboard.html">Hotel Portal</a>
              <a href="/hotel-profile.html">User Settings</a>
              <button type="button" onclick="logoutUser()">Logout</button>
            </div>
          </li>
        </ul>
      </nav>
    </header>

<div class="wrap">
  <!-- Command Bar -->
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin:12px 0 8px 0;">
    <div style="display:flex; gap:12px; align-items:center;">
      <button onclick="window.location.href='/hotel-dashboard.html'" class="btn" style="background:#065f46; color:#fff; padding:10px 20px; border:none; border-radius:8px; font-weight:600; white-space:nowrap;">
        ‚Üê Back to Profile
      </button>
      <button onclick="localLogout()" class="btn" style="background:#dc2626; color:#fff; padding:10px 20px; border:none; border-radius:8px; font-weight:600;">
        Logout
      </button>
    </div>
  </div>
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <div>
        <h1 style="margin: 0;">Hotel Profile Registration</h1>
        <p class="lead" style="margin: 6px 0 0 0;">Complete this profile so we can match your property to U.S. Government group events. <strong>NET30 payment terms and PO acceptance are required.</strong></p>
      </div>
      
    </div>
    
    <!-- Draft Status -->
    <div id="draftStatus" style="display: none; background: #eef4ff; border: 1px solid #c5d6f3; border-radius: 8px; padding: 12px; margin: 16px 0;">
      <div style="display: flex; align-items: center; gap: 8px; color: #0a58ca;">
        <span>üíæ</span>
        <strong>Draft Saved</strong>
        <span id="draftInfo" style="color: #5b6b7b; font-size: 0.9rem;"></span>
      </div>
    </div>
    
    <!-- Auto-save Status (only visible in continue mode) -->
    <div id="autoSaveInfo" style="display: none; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin: 16px 0; font-size: 0.85rem;">
      <div style="color: #0369a1; display: flex; align-items: center; gap: 8px;">
        <span id="autoSaveIcon">üíæ</span>
        <strong>Auto-save enabled:</strong> 
        <span id="autoSaveText">Your progress is automatically saved every 2 minutes and when you make changes</span>
        <span id="autoSaveStatus" style="margin-left: auto; font-size: 0.8rem; opacity: 0.8;"></span>
      </div>
    </div>
    

    <div class="steps" id="steps">
      <div class="step" data-step="1"><span class="dot">1</span> Company Information</div>
      <div class="step" data-step="2"><span class="dot">2</span> Sleeping Room Details</div>
      <div class="step" data-step="3"><span class="dot">3</span> Meeting Space Details</div>
      <div class="step" data-step="4"><span class="dot">4</span> Amenities</div>
      <div class="step" data-step="5"><span class="dot">5</span> Terms & Uploads</div>
      <div class="step" data-step="6"><span class="dot">6</span> Review</div>
      <div class="step" data-step="7"><span class="dot">7</span> Submit</div>
    </div>

    <form id="hotel-form" method="POST" enctype="multipart/form-data" autocomplete="off">
      <input type="hidden" name="form_type" value="hotel_profile_v2">

      <!-- PAGE 0 removed: Start/Pre-Qualification & Account Options. Wizard begins at Company Information. -->
      <div class="page" data-page="0" style="display:none"></div>

      <!-- PAGE 1 -->
      <div class="page" data-page="1">
        <fieldset>
          <legend>1) Property Identity</legend>
          <div class="row" style="margin-top:8px">
            <div class="col-6"><label>Hotel Name <span class="required">*</span></label><input name="hotel_name" required /></div>
            <div class="col-3">
              <label>Chain</label>
              <select id="chain_select" name="chain">
                <option value="">Select chain‚Ä¶</option>
                <option>Hilton Worldwide</option>
                <option>Marriott International</option>
                <option>IHG Hotels & Resorts</option>
                <option>Hyatt Hotels Corporation</option>
                <option>Wyndham Hotels & Resorts</option>
                <option>Choice Hotels International</option>
                <option>Best Western Hotels & Resorts</option>
                <option>Radisson Hotel Group</option>
                <option>Accor Hotels</option>
                <option>Other</option>
              </select>
              <input id="chain_other" name="chain_other" placeholder="Enter chain" style="display:none; margin-top:6px;" />
            </div>
            <div class="col-3">
              <label>Brand</label>
              <select id="brand_select" name="brand">
                <option value="">Select brand‚Ä¶</option>
                <option>Other</option>
              </select>
              <input id="brand_other" name="brand_other" placeholder="Enter brand" style="display:none; margin-top:6px;" />
            </div>
            <div class="col-6"><label>Hotel Property Code</label><input name="hotel_property_code" /></div>
            <div class="col-6"><label>Hotel Address <span class="required">*</span></label><input name="address" required /></div>
            <div class="col-3"><label>City <span class="required">*</span></label><input name="city" required /></div>
            <div class="col-3"><label>State / Province</label><input name="state" /></div>
            <div class="col-3"><label>Postal Code</label><input name="zip" /></div>
            <div class="col-3"><label>Country <span class="required">*</span></label><input name="country" required /></div>
            <div class="col-3"><label>Hotel Phone <span class="required">*</span></label><input type="tel" name="hotel_phone" required /></div>
            <div class="col-3"><label>Year Built</label><input type="number" name="year_built" min="1900" max="2100" /></div>
            <div class="col-3"><label>Last Renovation (Year)</label><input type="number" name="last_renovation" min="1900" max="2100" /></div>
            <div class="col-6"><label>Website</label><input type="url" name="website" placeholder="https://"/></div>
            <input type="hidden" id="hotel_place_id" name="hotel_place_id" />
          </div>
        </fieldset>
        <script>
          (function(){
            const srState = { suites: [], singles: [], doubles: [], adas: [] };

            function srClampInt(v){
              const n = parseInt(v,10);
              return isNaN(n) || n < 0 ? 0 : Math.floor(n);
            }

            function byId(id){ return document.getElementById(id); }

            function srRenderSuitesRows(){
              const root = byId('sr_suites_rows');
              if (!root) return;
              if (!srState.suites.length){
                root.innerHTML = '';
                return;
              }
              root.innerHTML = `
                <div style="margin-bottom:12px;">
                  <h4 style="margin:0 0 8px 0; color:#1f2937;">Added Suite Types</h4>
                  <p style="margin:0; color:#6b7280; font-size:0.9rem;">Review and manage your suite types below.</p>
                </div>
                ${srState.suites.map((it, idx) => `
                  <div class="row" data-sr-suite-row="${idx}" style="align-items:center; padding:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:8px;">
                    <div class="col-2">
                      <label style="font-weight:600; color:#374151;">Suite Type</label>
                      <div style="padding:8px; background:#f9fafb; border-radius:4px; font-weight:500;">${it.type}</div>
                    </div>
                    <div class="col-2">
                      <label style="font-weight:600; color:#374151;">Room Size</label>
                      <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.room_size || '-'}</div>
                    </div>
                    <div class="col-1">
                      <label style="font-weight:600; color:#374151;">Rooms</label>
                      <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.rooms}</div>
                    </div>
                    <div class="col-1">
                      <label style="font-weight:600; color:#374151;">Real Beds</label>
                      <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.real_beds}</div>
                    </div>
                    <div class="col-2">
                      <label style="font-weight:600; color:#374151;">Bed Type</label>
                      <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.bed_type || '-'}</div>
                    </div>
                    <div class="col-2">
                      <label style="font-weight:600; color:#374151;">Sofa Bed</label>
                      <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.sofa_beds || '0'}</div>
                    </div>
                    <div class="col-2" style="text-align:right;">
                      <button type="button" class="btn" data-sr-remove-suite="${idx}" style="margin-top:20px; background:#dc2626; color:white;">Remove</button>
                    </div>
                    ${it.notes ? `
                      <div class="col-12" style="margin-top:8px;">
                        <label style="font-weight:600; color:#374151;">Notes</label>
                        <div style="padding:8px; background:#f9fafb; border-radius:4px; font-style:italic; color:#6b7280;">${it.notes}</div>
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              `;
              root.querySelectorAll('[data-sr-remove-suite]').forEach(btn => {
                btn.onclick = () => {
                  const i = srClampInt(btn.getAttribute('data-sr-remove-suite'));
                  if (i >= 0 && i < srState.suites.length){
                    srState.suites.splice(i,1);
                    srRenderSuitesRows();
                    srUpdateTotals();
                    srSerializeIntoHidden();
                  }
                };
              });
            }

            function srBuildSummaryTable(){
              // aggregate singles
              let single = srClampInt((byId('sr_single_count')||{}).value || 0);
              let sBeds = srClampInt((byId('sr_single_beds')||{}).value || 0);
              let sSofa = (byId('sr_single_sofa')||{}).value || '0';
              srState.singles.forEach(it => {
                single += srClampInt(it.rooms);
                sBeds = Math.max(sBeds, srClampInt(it.real_beds));
                if (parseInt(it.sofa_bed) > 0) sSofa = Math.max(parseInt(sSofa), parseInt(it.sofa_bed)).toString();
              });
              // aggregate doubles
              let dbl = srClampInt((byId('sr_double_count')||{}).value || 0);
              let dBeds = srClampInt((byId('sr_double_beds')||{}).value || 0);
              let dSofa = (byId('sr_double_sofa')||{}).value || '0';
              srState.doubles.forEach(it => {
                dbl += srClampInt(it.rooms);
                dBeds = Math.max(dBeds, srClampInt(it.real_beds));
                if (parseInt(it.sofa_bed) > 0) dSofa = Math.max(parseInt(dSofa), parseInt(it.sofa_bed)).toString();
              });
              // aggregate ADA
              let ada = srClampInt((byId('sr_ada_count')||{}).value || 0);
              let aBeds = srClampInt((byId('sr_ada_beds')||{}).value || 0);
              let aSofa = (byId('sr_ada_sofa')||{}).value || '0';
              srState.adas.forEach(it => {
                ada += srClampInt(it.rooms);
                aBeds = Math.max(aBeds, srClampInt(it.real_beds));
                if (parseInt(it.sofa_bed) > 0) aSofa = Math.max(parseInt(aSofa), parseInt(it.sofa_bed)).toString();
              });

              const suiteTotalsByType = {};
              srState.suites.forEach(it => {
                const key = it.type || '';
                if (!key) return;
                if (!suiteTotalsByType[key]) suiteTotalsByType[key] = { rooms:0, beds:0, sofaCount:0 };
                suiteTotalsByType[key].rooms += srClampInt(it.rooms);
                suiteTotalsByType[key].beds  += srClampInt(it.real_beds);
                if (parseInt(it.sofa_beds) > 0) suiteTotalsByType[key].sofaCount = Math.max(suiteTotalsByType[key].sofaCount, parseInt(it.sofa_beds));
              });

              const total = single + dbl + ada + Object.values(suiteTotalsByType).reduce((s, t) => s + t.rooms, 0);

              function row(label, r, b, s){
                return `
                  <div class="row" style="padding:4px 0;">
                    <div class="col-3">${label}</div>
                    <div class="col-3" style="text-align:right;">${r}</div>
                    <div class="col-3" style="text-align:right;">${b}</div>
                    <div class="col-3" style="text-align:right;">${s}</div>
                  </div>`;
              }

              let html = '';
              html += '<div style="font-weight:600; padding:6px 0; border-bottom:1px solid #e5e7eb; display:grid; grid-template-columns:1fr 1fr 1fr 1fr;">\
                <div>Category</div><div style="text-align:right;">Room Count</div><div style="text-align:right;">Real Beds</div><div style="text-align:right;">Sofa Bed</div></div>';
              html += row('Single Occupancy', single, sBeds, sSofa);
              html += row('Double Occupancy', dbl, dBeds, dSofa);
              html += row('ADA Accessible', ada, aBeds, aSofa);
              Object.keys(suiteTotalsByType).forEach(k => {
                const t = suiteTotalsByType[k];
                html += row(k, t.rooms, t.beds, t.sofaCount);
              });
              html += `<div style="margin-top:8px; text-align:right; font-weight:700;">Total Rooms: ${total}</div>`;
              html += `<div style="margin-top:12px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb;">
                <label style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="sr_total_confirm" name="sr_total_confirm" required />
                  <span>Do you confirm your property has a total of <strong>${total}</strong> rooms?</span>
                </label>
                <div class="hint" style="margin-top:6px; color:#6b7280;">Confirmation is required before continuing.</div>
              </div>`;
              html += `<div style="margin-top:8px;"><button type="button" class="btn subtle" id="sr_edit_sleeping">Edit Sleeping Rooms</button></div>`;
              return html;
            }

            function srSerializeIntoHidden(){
              const sleepingJson = byId('sr_sleeping_json');
              if (!sleepingJson) return;
              try {
                const payload = {
                  singles: srState.singles || [],
                  doubles: srState.doubles || [],
                  adas: srState.adas || [],
                  base: {
                    single: { rooms: srClampInt((byId('sr_single_count')||{}).value || 0), beds: srClampInt((byId('sr_single_beds')||{}).value || 0), sofa: (byId('sr_single_sofa')||{}).value || '0', bed_type: (byId('sr_single_bed_type')||{}).value || '' },
                    double: { rooms: srClampInt((byId('sr_double_count')||{}).value || 0), beds: srClampInt((byId('sr_double_beds')||{}).value || 0), sofa: (byId('sr_double_sofa')||{}).value || '0', bed_type: (byId('sr_double_bed_type')||{}).value || '' },
                    ada:    { rooms: srClampInt((byId('sr_ada_count')||{}).value || 0), beds: srClampInt((byId('sr_ada_beds')||{}).value || 0), sofa: (byId('sr_ada_sofa')||{}).value || '0', bed_type: (byId('sr_ada_bed_type')||{}).value || '' }
                  },
                  suites: srState.suites || [],
                  totals: { total: srClampInt((byId('sr_total_rooms')||{}).value || 0) }
                };
                console.log('üíæ Serializing sleeping data:', payload);
                console.log('üíæ Suites being saved:', payload.suites);
                console.log('üíæ Suites count being saved:', payload.suites ? payload.suites.length : 0);
                console.log('üíæ srState.suites before serialization:', srState.suites);
                sleepingJson.value = JSON.stringify(payload);
                console.log('üíæ Hidden field value after serialization:', sleepingJson.value);
                
                // VERIFY IT WAS ACTUALLY SAVED
                setTimeout(() => {
                  const saved = document.getElementById('sr_sleeping_json');
                  if (saved && saved.value) {
                    try {
                      const parsed = JSON.parse(saved.value);
                      console.log('üíæ VERIFICATION: Hidden field contains', parsed.suites ? parsed.suites.length : 0, 'suites');
                    } catch(e) {
                      console.log('üíæ VERIFICATION: Could not parse saved data');
                    }
                  }
                }, 50);
              } catch(_) {}
            }

            function srUpdateLegacyHidden(){
              let single = srClampInt((byId('sr_single_count')||{}).value || 0);
              srState.singles.forEach(it => { single += srClampInt(it.rooms); });
              let dbl = srClampInt((byId('sr_double_count')||{}).value || 0);
              srState.doubles.forEach(it => { dbl += srClampInt(it.rooms); });
              let ada = srClampInt((byId('sr_ada_count')||{}).value || 0);
              srState.adas.forEach(it => { ada += srClampInt(it.rooms); });
              const suites = srState.suites.reduce((s, it) => s + srClampInt(it.rooms), 0);
              const total = single + dbl + ada + suites;
              const totalRoomsInput = byId('total_rooms');
              const kingRoomsInput = byId('king_rooms');
              const doubleRoomsInput = byId('double_rooms');
              if (totalRoomsInput) totalRoomsInput.value = total;
              if (kingRoomsInput) kingRoomsInput.value = single;
              if (doubleRoomsInput) doubleRoomsInput.value = dbl;
              srSerializeIntoHidden();
            }

            function srUpdateTotals(){
              let single = 0;
              srState.singles.forEach(it => { single += srClampInt(it.rooms); });
              let dbl = 0;
              srState.doubles.forEach(it => { dbl += srClampInt(it.rooms); });
              let ada = 0;
              srState.adas.forEach(it => { ada += srClampInt(it.rooms); });
              const suites = srState.suites.reduce((s, it) => s + srClampInt(it.rooms), 0);
              const total = single + dbl + ada + suites;
              const totalEl = byId('sr_total_rooms');
              if (totalEl) totalEl.value = total;
              srUpdateLegacyHidden();
            }
            function srRenderSingles(){
              const root = byId('sr_single_rows');
              console.log('üîÑ srRenderSingles called, root:', !!root, 'singles count:', srState.singles.length);
              if (!root) {
                console.log('‚ùå sr_single_rows container not found!');
                return;
              }
              if (!srState.singles.length) {
                console.log('‚ö†Ô∏è No singles to render, clearing container');
                root.innerHTML = '';
                return;
              }
              console.log('‚úÖ Rendering', srState.singles.length, 'singles');
              root.innerHTML = srState.singles.map((it, idx) => `
                <div class="row" data-sr-single-row="${idx}" style="align-items:center; padding:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:8px;">
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Room Count</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.rooms}</div>
                  </div>
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Real Beds</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.real_beds}</div>
                  </div>
                  <div class="col-3">
                    <label style="font-weight:600; color:#374151;">Bed Type</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; font-weight:500;">${it.bed_type}</div>
                  </div>
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Sofa Bed</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.sofa_bed}</div>
                  </div>
                  <div class="col-3" style="text-align:right;">
                    <button type="button" class="btn" style="background:#dc2626; color:white; margin-top:20px;" data-sr-remove-single="${idx}">Remove</button>
                  </div>
                </div>
              `).join('');
              root.querySelectorAll('[data-sr-remove-single]').forEach(btn => { btn.onclick = () => { const i = srClampInt(btn.getAttribute('data-sr-remove-single')); srState.singles.splice(i,1); srRenderSingles(); srUpdateTotals(); srSerializeIntoHidden(); }; });
            }

            function srRenderDoubles(){
              const root = byId('sr_double_rows');
              console.log('üîÑ srRenderDoubles called, root:', !!root, 'doubles count:', srState.doubles.length);
              if (!root) {
                console.log('‚ùå sr_double_rows container not found!');
                return;
              }
              if (!srState.doubles.length) {
                console.log('‚ö†Ô∏è No doubles to render, clearing container');
                root.innerHTML = '';
                return;
              }
              console.log('‚úÖ Rendering', srState.doubles.length, 'doubles');
              root.innerHTML = srState.doubles.map((it, idx) => `
                <div class="row" data-sr-double-row="${idx}" style="align-items:center; padding:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:8px;">
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Room Count</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.rooms}</div>
                  </div>
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Real Beds</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.real_beds}</div>
                  </div>
                  <div class="col-3">
                    <label style="font-weight:600; color:#374151;">Bed Type</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; font-weight:500;">${it.bed_type}</div>
                  </div>
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Sofa Bed</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.sofa_bed}</div>
                  </div>
                  <div class="col-3" style="text-align:right;">
                    <button type="button" class="btn" style="background:#dc2626; color:white; margin-top:20px;" data-sr-remove-double="${idx}">Remove</button>
                  </div>
                </div>
              `).join('');
              root.querySelectorAll('[data-sr-remove-double]').forEach(btn => { btn.onclick = () => { const i = srClampInt(btn.getAttribute('data-sr-remove-double')); srState.doubles.splice(i,1); srRenderDoubles(); srUpdateTotals(); srSerializeIntoHidden(); }; });
            }

            function srRenderAdas(){
              const root = byId('sr_ada_rows');
              if (!root) return;
              if (!srState.adas.length) {
                root.innerHTML = '';
                return;
              }
              root.innerHTML = srState.adas.map((it, idx) => `
                <div class="row" data-sr-ada-row="${idx}" style="align-items:center; padding:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:8px;">
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Room Count</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.rooms}</div>
                  </div>
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Real Beds</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.real_beds}</div>
                  </div>
                  <div class="col-3">
                    <label style="font-weight:600; color:#374151;">Bed Type</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; font-weight:500;">${it.bed_type}</div>
                  </div>
                  <div class="col-2">
                    <label style="font-weight:600; color:#374151;">Sofa Bed</label>
                    <div style="padding:8px; background:#f9fafb; border-radius:4px; text-align:center; font-weight:500;">${it.sofa_bed}</div>
                  </div>
                  <div class="col-3" style="text-align:right;">
                    <button type="button" class="btn" style="background:#dc2626; color:white; margin-top:20px;" data-sr-remove-ada="${idx}">Remove</button>
                  </div>
                </div>
              `).join('');
              root.querySelectorAll('[data-sr-remove-ada]').forEach(btn => { btn.onclick = () => { const i = srClampInt(btn.getAttribute('data-sr-remove-ada')); srState.adas.splice(i,1); srRenderAdas(); srUpdateTotals(); srSerializeIntoHidden(); }; });
            }

            function srEnsureNumericNonNegative(inp){
              if (!inp) return;
              const v = srClampInt(inp.value);
              if (String(v) !== String(inp.value)) inp.value = String(v);
            }

            document.addEventListener('DOMContentLoaded', function(){
              const totalEl = byId('sr_total_rooms');
              const suiteToggle = byId('sr_has_suites');
              const suiteSection = byId('sr_suites_section');
              const addSuiteBtn = byId('sr_add_suite');
              const addSingleBtn = byId('sr_add_single');
              const addDoubleBtn = byId('sr_add_double');
              const addAdaBtn = byId('sr_add_ada');
              const saveSleepingBtn = byId('sr_save_sleeping');
              const sleepingSavedMsg = byId('sr_sleeping_saved_msg');
              const sleepingForm = byId('sr_sleeping_form');
              const sleepingSummary = byId('sr_sleeping_summary');

              if (suiteToggle){
                suiteToggle.addEventListener('change', () => {
                  const has = suiteToggle.value === 'Yes';
                  console.log('üîÑ Suite toggle changed to:', suiteToggle.value, 'showing section:', has);
                  if (suiteSection) suiteSection.style.display = has ? '' : 'none';
                  if (!has){
                    srState.suites = [];
                    srRenderSuitesRows();
                    if (summary){ summary.style.display = 'none'; summary.innerHTML = ''; }
                  }
                  srUpdateTotals();
                  srSerializeIntoHidden();
                });
              }

              // Single Room Form Toggle
              if (addSingleBtn){
                addSingleBtn.onclick = () => {
                  const form = byId('sr_single_form');
                  if (form) form.style.display = form.style.display === 'none' ? '' : 'none';
                };
              }
              
              const cancelSingleBtn = byId('sr_cancel_single');
              if (cancelSingleBtn) {
                cancelSingleBtn.onclick = () => {
                  const form = byId('sr_single_form');
                  if (form) form.style.display = 'none';
                  // Clear form
                  const fields = ['sr_single_count_new', 'sr_single_beds_new', 'sr_single_bed_type_new', 'sr_single_sofa_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? '' : '';
                  });
                };
              }
              
              const saveSingleBtn = byId('sr_save_single');
              if (saveSingleBtn) {
                saveSingleBtn.onclick = () => {
                  const rooms = srClampInt((byId('sr_single_count_new')||{}).value || 0);
                  const beds = srClampInt((byId('sr_single_beds_new')||{}).value || 0);
                  const bedType = (byId('sr_single_bed_type_new')||{}).value || '';
                  const sofa = (byId('sr_single_sofa_new')||{}).value || '0';
                  
                  if (rooms <= 0 || beds <= 0 || !bedType) {
                    alert('Please complete all required fields.');
                    return;
                  }
                  
                  srState.singles.push({ rooms, real_beds: beds, bed_type: bedType, sofa_bed: sofa });
                  srRenderSingles();
                  srUpdateTotals();
                  srSerializeIntoHidden();
                  
                  // Hide form and clear
                  const form = byId('sr_single_form');
                  if (form) form.style.display = 'none';
                  const fields = ['sr_single_count_new', 'sr_single_beds_new', 'sr_single_bed_type_new', 'sr_single_sofa_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? (id === 'sr_single_sofa_new' ? '0' : '') : '';
                  });
                };
              }
              
              // Double Room Form Toggle
              if (addDoubleBtn){
                addDoubleBtn.onclick = () => {
                  const form = byId('sr_double_form');
                  if (form) form.style.display = form.style.display === 'none' ? '' : 'none';
                };
              }
              
              const cancelDoubleBtn = byId('sr_cancel_double');
              if (cancelDoubleBtn) {
                cancelDoubleBtn.onclick = () => {
                  const form = byId('sr_double_form');
                  if (form) form.style.display = 'none';
                  const fields = ['sr_double_count_new', 'sr_double_beds_new', 'sr_double_bed_type_new', 'sr_double_sofa_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? '' : '';
                  });
                };
              }
              
              const saveDoubleBtn = byId('sr_save_double');
              if (saveDoubleBtn) {
                saveDoubleBtn.onclick = () => {
                  const rooms = srClampInt((byId('sr_double_count_new')||{}).value || 0);
                  const beds = srClampInt((byId('sr_double_beds_new')||{}).value || 0);
                  const bedType = (byId('sr_double_bed_type_new')||{}).value || '';
                  const sofa = (byId('sr_double_sofa_new')||{}).value || '0';
                  
                  if (rooms <= 0 || beds <= 0 || !bedType) {
                    alert('Please complete all required fields.');
                    return;
                  }
                  
                  srState.doubles.push({ rooms, real_beds: beds, bed_type: bedType, sofa_bed: sofa });
                  srRenderDoubles();
                  srUpdateTotals();
                  srSerializeIntoHidden();
                  
                  const form = byId('sr_double_form');
                  if (form) form.style.display = 'none';
                  const fields = ['sr_double_count_new', 'sr_double_beds_new', 'sr_double_bed_type_new', 'sr_double_sofa_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? (id === 'sr_double_sofa_new' ? '0' : '') : '';
                  });
                };
              }
              
              // ADA Room Form Toggle
              if (addAdaBtn){
                addAdaBtn.onclick = () => {
                  const form = byId('sr_ada_form');
                  const noAdaContainer = byId('sr_no_ada_container');
                  const noAdaCheckbox = byId('sr_no_ada');
                  
                  if (form) {
                    const isOpening = form.style.display === 'none';
                    form.style.display = isOpening ? '' : 'none';
                    
                    // Hide "No ADA Available" checkbox when opening form
                    if (isOpening) {
                      if (noAdaContainer) noAdaContainer.style.display = 'none';
                      if (noAdaCheckbox) noAdaCheckbox.checked = false;
                    }
                  }
                };
              }
              
              const cancelAdaBtn = byId('sr_cancel_ada');
              if (cancelAdaBtn) {
                cancelAdaBtn.onclick = () => {
                  const form = byId('sr_ada_form');
                  const noAdaContainer = byId('sr_no_ada_container');
                  
                  if (form) form.style.display = 'none';
                  
                  // Show "No ADA Available" checkbox when canceling (only if no ADA rooms added)
                  if (!srState.adas || srState.adas.length === 0) {
                    if (noAdaContainer) noAdaContainer.style.display = '';
                  }
                  const fields = ['sr_ada_count_new', 'sr_ada_beds_new', 'sr_ada_bed_type_new', 'sr_ada_sofa_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? '' : '';
                  });
                };
              }
              
              // No ADA Rooms Available Checkbox Handler
              const noAdaCheckbox = byId('sr_no_ada');
              if (noAdaCheckbox) {
                noAdaCheckbox.addEventListener('change', () => {
                  const isChecked = noAdaCheckbox.checked;
                  const adaForm = byId('sr_ada_form');
                  const addAdaBtn = byId('sr_add_ada');
                  const adaRows = byId('sr_ada_rows');
                  
                  if (isChecked) {
                    // Hide ADA form and button
                    if (adaForm) adaForm.style.display = 'none';
                    if (addAdaBtn) addAdaBtn.style.display = 'none';
                    
                    // Clear existing ADA rooms
                    srState.adas = [];
                    srRenderAdas();
                    srUpdateTotals();
                    srSerializeIntoHidden();
                    
                    console.log('‚úÖ No ADA Rooms Available - ADA requirement bypassed');
                  } else {
                    // Show add ADA button
                    if (addAdaBtn) addAdaBtn.style.display = '';
                    
                    console.log('üîÑ No ADA Rooms Available unchecked - user can add ADA rooms');
                  }
                });
                
                // Initial state: hide add ADA button if "No ADA Rooms Available" is checked
                if (noAdaCheckbox.checked) {
                  const adaForm = byId('sr_ada_form');
                  const addAdaBtn = byId('sr_add_ada');
                  if (adaForm) adaForm.style.display = 'none';
                  if (addAdaBtn) addAdaBtn.style.display = 'none';
                }
              }
              
              const saveAdaBtn = byId('sr_save_ada');
              if (saveAdaBtn) {
                saveAdaBtn.onclick = () => {
                  const rooms = srClampInt((byId('sr_ada_count_new')||{}).value || 0);
                  const beds = srClampInt((byId('sr_ada_beds_new')||{}).value || 0);
                  const bedType = (byId('sr_ada_bed_type_new')||{}).value || '';
                  const sofa = (byId('sr_ada_sofa_new')||{}).value || '0';
                  
                  if (rooms <= 0 || beds <= 0 || !bedType) {
                    alert('Please complete all required fields.');
                    return;
                  }
                  
                  srState.adas.push({ rooms, real_beds: beds, bed_type: bedType, sofa_bed: sofa });
                  srRenderAdas();
                  srUpdateTotals();
                  srSerializeIntoHidden();
                  
                  const form = byId('sr_ada_form');
                  if (form) form.style.display = 'none';
                  const fields = ['sr_ada_count_new', 'sr_ada_beds_new', 'sr_ada_bed_type_new', 'sr_ada_sofa_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? (id === 'sr_ada_sofa_new' ? '0' : '') : '';
                  });
                };
              }

              if (saveSleepingBtn){
                saveSleepingBtn.onclick = () => {
                  // Suite validation: if user says they have suites, they must add at least one
                  const hasSuites = (byId('sr_has_suites')||{}).value === 'Yes';
                  
                  // Check both srState.suites and hidden JSON field for saved suite data
                  let totalSuiteCount = 0;
                  let savedSuiteData = null;
                  
                  // Check srState.suites
                  const currentSuiteCount = srState.suites ? srState.suites.length : 0;
                  
                  // Check hidden JSON field for saved suites
                  try {
                    const sleepingJson = document.getElementById('sr_sleeping_json');
                    if (sleepingJson && sleepingJson.value) {
                      savedSuiteData = JSON.parse(sleepingJson.value);
                      const savedSuiteCount = savedSuiteData.suites ? savedSuiteData.suites.length : 0;
                      totalSuiteCount = Math.max(currentSuiteCount, savedSuiteCount);
                      console.log('üîç Found saved suite data:', savedSuiteCount, 'suites in hidden field');
                      
                      // If we found saved suite data but srState.suites is empty, restore it
                      if (savedSuiteCount > 0 && currentSuiteCount === 0) {
                        console.log('üîç Restoring suite data to srState from hidden field');
                        srState.suites = savedSuiteData.suites;
                        srRenderSuitesRows();
                        srUpdateTotals();
                      }
                    }
                  } catch (e) {
                    console.log('üîç Could not parse saved suite data:', e);
                  }
                  
                  // Use the higher count (current or saved)
                  if (totalSuiteCount === 0) {
                    totalSuiteCount = currentSuiteCount;
                  }
                  
                  // Update currentSuiteCount after potential restoration
                  const finalSuiteCount = srState.suites ? srState.suites.length : 0;
                  const tempSuiteCount = (srState.suites || []).filter(s => s.temp).length;
                  const regularSuiteCount = (srState.suites || []).filter(s => !s.temp).length;
                  
                  console.log('üîç Suite validation check:', { 
                    hasSuites, 
                    currentSuiteCount, 
                    finalSuiteCount,
                    totalSuiteCount, 
                    tempSuiteCount, 
                    regularSuiteCount, 
                    suites: srState.suites,
                    savedSuiteData: savedSuiteData ? savedSuiteData.suites : null
                  });
                  
                  if (hasSuites && totalSuiteCount === 0){
                    console.log('‚ùå Suite validation failed - no suites found in current state or saved data');
                    alert('Please add at least one suite type before saving.');
                    return;
                  }
                  
                  console.log('‚úÖ Suite validation passed');
                  
                  // FORCE RELOAD SUITE DATA FROM HIDDEN FIELD BEFORE SAVING
                  const sleepingJson = document.getElementById('sr_sleeping_json');
                  console.log('üîç Hidden JSON field exists:', !!sleepingJson);
                  console.log('üîç Hidden JSON value:', sleepingJson ? sleepingJson.value : 'N/A');
                  
                  if (sleepingJson && sleepingJson.value) {
                    try {
                      const data = JSON.parse(sleepingJson.value);
                      console.log('üîç Parsed JSON data:', data);
                      console.log('üîç Data.suites exists:', !!data.suites);
                      console.log('üîç Data.suites is array:', Array.isArray(data.suites));
                      console.log('üîç Data.suites length:', data.suites ? data.suites.length : 'N/A');
                      
                      if (data.suites && Array.isArray(data.suites)) {
                        srState.suites = data.suites;
                        console.log('üîÑ Reloaded suites from hidden field:', srState.suites.length, 'suites');
                        console.log('üîÑ Reloaded suite data:', srState.suites);
                      } else {
                        console.log('‚ùå No valid suite data in hidden field');
                      }
                    } catch(e) {
                      console.log('‚ö†Ô∏è Could not reload suites from hidden field:', e);
                    }
                  } else {
                    console.log('‚ùå No hidden JSON field or value');
                  }
                  
                  // basic validation: ensure numbers are non-negative (already enforced) and totals computed
                  srUpdateTotals();
                  srSerializeIntoHidden(); // Make sure data is saved to hidden field
                  
                  // DEBUG: Log current state
                  console.log('üíæ Save Sleeping Rooms clicked');
                  console.log('üíæ srState.singles:', srState.singles.length, 'entries');
                  console.log('üíæ srState.doubles:', srState.doubles.length, 'entries');
                  console.log('üíæ srState.adas:', srState.adas.length, 'entries');
                  console.log('üíæ srState.suites:', srState.suites.length, 'entries');
                  console.log('üíæ Singles data:', srState.singles);
                  console.log('üíæ Doubles data:', srState.doubles);
                  
                  // Re-render all sections to ensure display is up to date
                  console.log('üíæ Calling srRenderSingles...');
                  srRenderSingles();
                  console.log('üíæ Calling srRenderDoubles...');
                  srRenderDoubles();
                  console.log('üíæ Calling srRenderAdas...');
                  srRenderAdas();
                  console.log('üíæ Calling srRenderSuitesRows...');
                  srRenderSuitesRows();
                  
                  if (sleepingSavedMsg){
                    sleepingSavedMsg.style.display = '';
                    setTimeout(()=>{ sleepingSavedMsg.style.display = 'none'; }, 1500);
                  }
                  // Build summary table and toggle UI
                  if (sleepingSummary && sleepingForm){
                    sleepingSummary.innerHTML = (function(){
                      function cell(v){ return `<div style="text-align:right;">${v}</div>`; }
                      function row(c, r, bt, s){
                        return `<div style="display:grid; grid-template-columns:1fr 100px 100px 100px; gap:8px; padding:6px 0; border-bottom:1px solid #f3f4f6;">
                          <div>${c}</div>${cell(r)}${cell(bt)}${cell(s)}
                        </div>`;
                      }
                      // Base values
                      const baseSingleRooms = srClampInt((byId('sr_single_count')||{}).value || 0);
                      const baseSingleSofaCount = parseInt((byId('sr_single_sofa')||{}).value || '0');
                      const baseSingleBedType = (byId('sr_single_bed_type')||{}).value || 'KING';
                      const baseDoubleRooms = srClampInt((byId('sr_double_count')||{}).value || 0);
                      const baseDoubleSofaCount = parseInt((byId('sr_double_sofa')||{}).value || '0');
                      const baseDoubleBedType = (byId('sr_double_bed_type')||{}).value || 'QUEEN';
                      const baseAdaRooms = srClampInt((byId('sr_ada_count')||{}).value || 0);
                      const baseAdaSofaCount = parseInt((byId('sr_ada_sofa')||{}).value || '0');
                      const baseAdaBedType = (byId('sr_ada_bed_type')||{}).value || 'KING';

                      // Aggregate by category and sofa bed count
                      let singleSofaCount = baseSingleSofaCount;
                      let doubleSofaCount = baseDoubleSofaCount;
                      let adaSofaCount = baseAdaSofaCount;
                      
                      srState.singles.forEach(it => { 
                        singleSofaCount += parseInt(it.sofa_bed) || 0;
                      });
                      srState.doubles.forEach(it => { 
                        doubleSofaCount += parseInt(it.sofa_bed) || 0;
                      });
                      srState.adas.forEach(it => { 
                        adaSofaCount += parseInt(it.sofa_bed) || 0;
                      });

                      const header = `<div style="display:grid; grid-template-columns:1fr 100px 100px 100px; gap:8px; padding:6px 0; border-bottom:1px solid #e5e7eb; font-weight:600;">
                        <div>Category</div><div style="text-align:right;">Room Count</div><div style="text-align:right;">Bed Type</div><div style="text-align:right;">Sofa Bed</div>
                      </div>`;
                      let html = header;
                      if (baseSingleRooms > 0) html += row('Single Occupancy', baseSingleRooms, baseSingleBedType, singleSofaCount.toString());
                      if (baseDoubleRooms > 0) html += row('Double Occupancy', baseDoubleRooms, baseDoubleBedType, doubleSofaCount.toString());
                      if (baseAdaRooms > 0) html += row('ADA Accessible', baseAdaRooms, baseAdaBedType, adaSofaCount.toString());

                      // Add suites to summary
                      if (srState.suites.length > 0) {
                        const suiteTotalsByType = {};
                        srState.suites.forEach(it => {
                          const key = it.type || '';
                          if (!key) return;
                          if (!suiteTotalsByType[key]) suiteTotalsByType[key] = { rooms:0, sofaCount:0, bedType: it.bed_type || 'Unknown' };
                          suiteTotalsByType[key].rooms += srClampInt(it.rooms);
                          suiteTotalsByType[key].sofaCount += parseInt(it.sofa_beds) || 0;
                        });
                        Object.entries(suiteTotalsByType).forEach(([type, data]) => {
                          html += row(`${type}`, data.rooms, data.bedType, data.sofaCount.toString());
                        });
                      }

                      const totalRoomsVal = srClampInt((byId('sr_total_rooms')||{}).value || 0);
                      html += `<div style="margin-top:8px; text-align:right; font-weight:700;">Total Rooms: ${totalRoomsVal}</div>`;
                      html += `<div style="margin-top:12px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb;">
                        <label style="display:flex; align-items:center; gap:8px;">
                          <input type="checkbox" id="sr_total_confirm" name="sr_total_confirm" required />
                          <span>Do you confirm your property has a total of <strong>${totalRoomsVal}</strong> rooms?</span>
                        </label>
                        <div class="hint" style="margin-top:6px; color:#6b7280;">Confirmation is required before continuing.</div>
                      </div>`;
                      html += `<div style="margin-top:8px;"><button type="button" class="btn subtle" id="sr_edit_sleeping">Edit</button></div>`;
                      return html;
                    })();
                    // Hide the individual room input forms, show summary table
                    sleepingForm.style.display = 'none'; // Hide the input forms
                    sleepingSummary.style.display = 'block'; // Show summary table
                    
                    // Scroll to summary so user sees it
                    setTimeout(() => {
                      if (sleepingSummary) {
                        sleepingSummary.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                      }
                    }, 100);
                    
                    console.log('üìã Form display:', sleepingForm.style.display);
                    console.log('üìã Summary display:', sleepingSummary.style.display);
                    console.log('üìã Form children count:', sleepingForm.children.length);
                    console.log('üìã Singles container exists:', !!document.getElementById('sr_single_rows'));
                    console.log('üìã Doubles container exists:', !!document.getElementById('sr_double_rows'));
                    console.log('üìã Summary table content length:', sleepingSummary.innerHTML.length);
                    console.log('üìã Total rooms calculated:', srState.singles.length + srState.doubles.length + srState.adas.length + srState.suites.length);
                    
                    // Update the summary table to show all room types
                    if (sleepingSummary) {
                      sleepingSummary.innerHTML = srBuildSummaryTable();
                      console.log('üìã Updated summary table with all room types');
                    }
                    // Set up the Edit button to show forms when clicked
                    const editBtn = byId('sr_edit_sleeping');
                    if (editBtn){
                      editBtn.onclick = () => {
                        // Show forms, hide summary
                        sleepingForm.style.display = 'block';
                        sleepingSummary.style.display = 'none';
                        console.log('üìù Edit button clicked - showing forms, hiding summary');
                      };
                    }
                  }
                };
              }

              // Suite Room Form Toggle
              if (addSuiteBtn){
                addSuiteBtn.onclick = () => {
                  const form = byId('sr_suite_form');
                  const noSuitesContainer = byId('sr_no_suites_container');
                  const noSuitesCheckbox = byId('sr_no_suites');
                  
                  if (form) {
                    const isOpening = form.style.display === 'none';
                    form.style.display = isOpening ? '' : 'none';
                    
                    // Hide "No Suites Available" checkbox when opening form
                    if (isOpening) {
                      if (noSuitesContainer) noSuitesContainer.style.display = 'none';
                      if (noSuitesCheckbox) noSuitesCheckbox.checked = false;
                    }
                  }
                };
              }
              
              // No Suites Available Checkbox Handler
              const noSuitesCheckbox = byId('sr_no_suites');
              if (noSuitesCheckbox) {
                noSuitesCheckbox.addEventListener('change', () => {
                  const isChecked = noSuitesCheckbox.checked;
                  const suiteForm = byId('sr_suite_form');
                  const addSuiteBtn = byId('sr_add_suite');
                  const suitesRows = byId('sr_suites_rows');
                  
                  if (isChecked) {
                    // Hide suite form and button
                    if (suiteForm) suiteForm.style.display = 'none';
                    if (addSuiteBtn) addSuiteBtn.style.display = 'none';
                    
                    // Clear existing suites
                    srState.suites = [];
                    srRenderSuitesRows();
                    srUpdateTotals();
                    srSerializeIntoHidden();
                    
                    console.log('‚úÖ No Suites Available - suite requirement bypassed');
                  } else {
                    // Show add suite button
                    if (addSuiteBtn) addSuiteBtn.style.display = '';
                    
                    console.log('üîÑ No Suites Available unchecked - user can add suites');
                  }
                });
                
                // Initial state: hide add suite button if "No Suites Available" is checked
                if (noSuitesCheckbox.checked) {
                  const suiteForm = byId('sr_suite_form');
                  const addSuiteBtn = byId('sr_add_suite');
                  if (suiteForm) suiteForm.style.display = 'none';
                  if (addSuiteBtn) addSuiteBtn.style.display = 'none';
                }
              }

              // Save suite button (saves current form data without adding to list)
              const saveSuiteBtn = byId('sr_save_suite');
              if (saveSuiteBtn) {
                saveSuiteBtn.onclick = () => {
                  const t = (byId('sr_suite_type_new')||{}).value || '';
                  const roomSize = (byId('sr_suite_room_size_new')||{}).value || '';
                  const r = srClampInt((byId('sr_suite_rooms_new')||{}).value || 0);
                  const b = srClampInt((byId('sr_suite_beds_new')||{}).value || 0);
                  const bedType = (byId('sr_suite_bed_type_new')||{}).value || '';
                  const s = (byId('sr_suite_sofa_new')||{}).value || '0';
                  const notes = (byId('sr_suite_notes_new')||{}).value || '';
                  
                  if (!t || t.trim() === '' || !roomSize || r <= 0 || !bedType) {
                    alert('Please complete all required fields.');
                    return;
                  }
                  
                  srState.suites.push({ type: t, room_size: roomSize, rooms: r, real_beds: b, bed_type: bedType, sofa_beds: s, notes });
                  srRenderSuitesRows();
                  srUpdateTotals();
                  srSerializeIntoHidden();
                  
                  // Hide form and clear
                  const form = byId('sr_suite_form');
                  if (form) form.style.display = 'none';
                  const fields = ['sr_suite_type_new', 'sr_suite_room_size_new', 'sr_suite_rooms_new', 'sr_suite_beds_new', 'sr_suite_bed_type_new', 'sr_suite_sofa_new', 'sr_suite_notes_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? (id === 'sr_suite_sofa_new' ? '0' : '') : '';
                  });
                };
              }
              
              const cancelSuiteBtn = byId('sr_cancel_suite');
              if (cancelSuiteBtn) {
                cancelSuiteBtn.onclick = () => {
                  const form = byId('sr_suite_form');
                  const noSuitesContainer = byId('sr_no_suites_container');
                  
                  if (form) form.style.display = 'none';
                  
                  // Show "No Suites Available" checkbox when canceling (only if no suites added)
                  if (!srState.suites || srState.suites.length === 0) {
                    if (noSuitesContainer) noSuitesContainer.style.display = '';
                  }
                  
                  const fields = ['sr_suite_type_new', 'sr_suite_room_size_new', 'sr_suite_rooms_new', 'sr_suite_beds_new', 'sr_suite_bed_type_new', 'sr_suite_sofa_new', 'sr_suite_notes_new'];
                  fields.forEach(id => {
                    const el = byId(id);
                    if (el) el.value = el.tagName === 'SELECT' ? (id === 'sr_suite_sofa_new' ? '0' : '') : '';
                  });
                };
              }

              // Suite form fields - no auto-save, only save when user clicks Save button

              // Initial compute
              srUpdateTotals();
              
              // CRITICAL: Restore room data from hidden field if present
              const sleepingJson = byId('sr_sleeping_json');
              if (sleepingJson && sleepingJson.value) {
                try {
                  const savedData = JSON.parse(sleepingJson.value);
                  console.log('üîÑ Restoring room data from hidden field:', savedData);
                  
                  // Restore singles
                  if (savedData.singles && Array.isArray(savedData.singles)) {
                    srState.singles = savedData.singles;
                  }
                  
                  // Restore doubles  
                  if (savedData.doubles && Array.isArray(savedData.doubles)) {
                    srState.doubles = savedData.doubles;
                  }
                  
                  // Restore ADAs
                  if (savedData.adas && Array.isArray(savedData.adas)) {
                    srState.adas = savedData.adas;
                  }
                  
                  // Restore suites
                  if (savedData.suites && Array.isArray(savedData.suites)) {
                    srState.suites = savedData.suites;
                  }
                  
                  console.log('üîÑ Room data restored - singles:', srState.singles.length, 'doubles:', srState.doubles.length, 'adas:', srState.adas.length, 'suites:', srState.suites.length);
                } catch (e) {
                  console.error('üîÑ Failed to restore room data from hidden field:', e);
                }
              }
              
              srRenderSingles();
              srRenderDoubles();
              srRenderAdas();
              srRenderSuitesRows();
              // Ensure hidden JSON reflects initial values
              srSerializeIntoHidden();
              
              // ADDITIONAL: Re-render after auto-save completes (in case auto-save restored data)
              setTimeout(() => {
                const sleepingJsonDelayed = byId('sr_sleeping_json');
                if (sleepingJsonDelayed && sleepingJsonDelayed.value) {
                  try {
                    const savedDataDelayed = JSON.parse(sleepingJsonDelayed.value);
                    console.log('üîÑ DELAYED: Re-checking room data from hidden field:', savedDataDelayed);
                    
                    // Restore singles
                    if (savedDataDelayed.singles && Array.isArray(savedDataDelayed.singles) && savedDataDelayed.singles.length > 0) {
                      srState.singles = savedDataDelayed.singles;
                      console.log('üîÑ DELAYED: Restored', savedDataDelayed.singles.length, 'singles');
                    }
                    
                    // Restore doubles  
                    if (savedDataDelayed.doubles && Array.isArray(savedDataDelayed.doubles) && savedDataDelayed.doubles.length > 0) {
                      srState.doubles = savedDataDelayed.doubles;
                      console.log('üîÑ DELAYED: Restored', savedDataDelayed.doubles.length, 'doubles');
                    }
                    
                    // Restore ADAs
                    if (savedDataDelayed.adas && Array.isArray(savedDataDelayed.adas) && savedDataDelayed.adas.length > 0) {
                      srState.adas = savedDataDelayed.adas;
                      console.log('üîÑ DELAYED: Restored', savedDataDelayed.adas.length, 'ADAs');
                    }
                    
                    // Restore suites
                    if (savedDataDelayed.suites && Array.isArray(savedDataDelayed.suites) && savedDataDelayed.suites.length > 0) {
                      srState.suites = savedDataDelayed.suites;
                      console.log('üîÑ DELAYED: Restored', savedDataDelayed.suites.length, 'suites');
                    }
                    
                    console.log('üîÑ DELAYED: Room data restored - singles:', srState.singles.length, 'doubles:', srState.doubles.length, 'adas:', srState.adas.length, 'suites:', srState.suites.length);
                    
                    // Re-render all sections
                    srRenderSingles();
                    srRenderDoubles();
                    srRenderAdas();
                    srRenderSuitesRows();
                    srUpdateTotals();
                  } catch (e) {
                    console.error('üîÑ DELAYED: Failed to restore room data:', e);
                  }
                }
              }, 1000); // Wait 1 second for auto-save to complete
            });
          })();
        </script>

        <!-- Hotel Main Photo moved to Uploads (Page 5) -->

        <fieldset>
          <legend>2) Management/Franchise Company Information</legend>
          <div class="item">
            <label>Is the hotel managed by a management company or franchise operator?</label>
            <select id="is_management_company_managed" name="is_management_company_managed">
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
            <div class="hint">Select "Yes" to provide management/franchise company details.</div>
          </div>
          <div id="managementCompanyFields" style="display:none; margin-top:8px;">
            <div class="row">
              <div class="col-6"><label>Management/Franchise Company Name</label><input name="management_company" autocomplete="section-management organization" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-6"><label>Company Street Address</label><input name="management_company_street" autocomplete="section-management address-line1" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company City</label><input name="management_company_city" autocomplete="section-management address-level2" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company State/Province</label><input name="management_company_state" autocomplete="section-management address-level1" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company Postal Code</label><input name="management_company_zip" autocomplete="section-management postal-code" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company Country</label><input name="management_company_country" autocomplete="section-management country-name" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-6"><label>Company Website</label><input type="url" name="management_company_website" placeholder="https://" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <input type="hidden" id="management_company_place_id" name="management_company_place_id" />
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>3) Primary Contact</legend>
          <div class="hint" style="margin-top:6px">This information will be used for your user profile and hotel contact.</div>
          <div class="row" style="margin-top:8px">
            <div class="col-6">
              <label>Name <span class="required">*</span></label><input type="text" name="primary_contact_name" required autocomplete="name" />
              <label>Title <span class="required">*</span></label>
              <select name="primary_contact_title" required>
                <option value="">Select a title</option>
                <option value="Owner">Owner</option>
                <option value="General Manager">General Manager</option>
                <option value="Director of Sales">Director of Sales</option>
                <option value="Sales Manager">Sales Manager</option>
                <option value="Sales Coordinator">Sales Coordinator</option>
                <option value="Area Director of Sales">Area Director of Sales</option>
                <option value="Regional Director of Sales">Regional Director of Sales</option>
                <option value="Director of National Accounts">Director of National Accounts</option>
              </select>
            </div>
            <div class="col-6">
              <label>Email <span class="required">*</span></label><input type="email" name="primary_contact_email" required autocomplete="email" />
              <label>Phone</label><input type="tel" name="primary_contact_phone" autocomplete="tel" />
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>3) AAA Rating</legend>
          <div class="row">
            <div class="col-6">
              <label>Are you an AAA rated hotel? <span class="required">*</span></label>
              <select name="is_aaa_rated" id="is_aaa_rated" required>
                <option value="">Select‚Ä¶</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-6" id="aaa_diamond_section" style="display:none;">
              <label>How many diamond rating do you have? <span class="required">*</span></label>
              <select name="aaa_diamond_rating" id="aaa_diamond_rating">
                <option value="">Select‚Ä¶</option>
                <option value="2 Diamond (APPROVED)">2 Diamond (APPROVED)</option>
                <option value="3 Diamond">3 Diamond</option>
                <option value="4 Diamond">4 Diamond</option>
                <option value="5 Diamond">5 Diamond</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>4) Bank Account Information</legend>
          <p class="muted" style="margin-bottom:16px;">Please provide banking information for payment processing. Choose the appropriate section based on your hotel's location.</p>
          
          <div class="row">
            <div class="col-12">
              <label>Hotel Location <span class="required">*</span></label>
              <select name="hotel_location_type" id="hotel_location_type" required>
                <option value="">Select hotel location (required)‚Ä¶</option>
                <option value="US">United States (US-based hotel)</option>
                <option value="International">International hotel</option>
                <option value="skip">Skip - I'll provide banking information later</option>
              </select>
              <div class="hint">Please select an option to continue. You can choose to skip banking information and provide it later if needed.</div>
            </div>
          </div>

          <!-- ACH Section for US Hotels -->
          <div id="ach_section" style="display:none; margin-top:16px;">
            <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:16px; margin-bottom:16px;">
              <h4 style="margin:0 0 12px 0; color:var(--accent); font-size:1rem;">üè¶ ACH Bank Account Information (US Hotels)</h4>
              <div class="hint" style="margin-bottom:12px;">For US-based hotels - Electronic fund transfers via ACH</div>
              
              <div class="row">
                <div class="col-12">
                  <label>Bank Account Name <span class="required">*</span></label>
                  <input name="ach_bank_account_name" id="ach_bank_account_name" placeholder="e.g., ABC Hotel Management LLC" />
                  <button type="button" class="btn subtle" id="copyCompanyToAchName" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from Hotel Name</button>
                </div>
                <div class="col-3">
                  <label>Bank Routing Number <span class="required">*</span></label>
                  <input name="ach_routing_number" id="ach_routing_number" placeholder="9-digit routing number" maxlength="9" pattern="[0-9]{9}" />
                  <div class="hint">9-digit ABA routing number ‚Ä¢ Bank name will auto-populate when you enter a valid routing number</div>
                </div>
                <div class="col-3">
                  <label>Bank Account Number <span class="required">*</span></label>
                  <input name="ach_account_number" id="ach_account_number" placeholder="Enter account number" />
                </div>
                <div class="col-3">
                  <label>Confirm Bank Account Number</label>
                  <input name="ach_account_number_confirm" id="ach_account_number_confirm" placeholder="Re-enter account number" />
                  <div id="ach_account_match" style="display:none; font-size:0.85rem; margin-top:4px;"></div>
                </div>
                <div class="col-3">
                  <label>Bank Name <span class="required">*</span></label>
                  <input name="ach_bank_name" id="ach_bank_name" placeholder="e.g., Bank of America, Wells Fargo" />
                </div>
                <div class="col-6">
                  <label>Accounts Receivable Contact Email <span class="required">*</span></label>
                  <input type="email" name="ach_ar_email" id="ach_ar_email" placeholder="ar@hotel.com" />
                  <button type="button" class="btn subtle" id="copyArEmailToAch" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from A/R Email</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Wire Transfer Section for International Hotels -->
          <div id="wire_section" style="display:none; margin-top:16px;">
            <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:16px; margin-bottom:16px;">
              <h4 style="margin:0 0 12px 0; color:var(--accent); font-size:1rem;">üåç Wire Transfer Information (International Hotels)</h4>
              <div class="hint" style="margin-bottom:12px;">For international hotels - International wire transfers</div>
              
              <div class="row">
                <div class="col-12">
                  <label>Bank Account Name <span class="required">*</span></label>
                  <input name="wire_bank_account_name" id="wire_bank_account_name" placeholder="e.g., ABC Hotel Management LLC" />
                  <button type="button" class="btn subtle" id="copyCompanyToWireName" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from Hotel Name</button>
                </div>
                <div class="col-3">
                  <label>Bank Name <span class="required">*</span></label>
                  <input name="wire_bank_name" id="wire_bank_name" placeholder="e.g., HSBC, Deutsche Bank" />
                </div>
                <div class="col-3">
                  <label>SWIFT Code <span class="required">*</span></label>
                  <input name="wire_swift_code" id="wire_swift_code" placeholder="e.g., HSBCGB2L" style="text-transform:uppercase;" />
                  <div class="hint">8-11 character SWIFT/BIC code</div>
                </div>
                <div class="col-3">
                  <label>Bank Account Number <span class="required">*</span></label>
                  <input name="wire_account_number" id="wire_account_number" placeholder="Enter account number" />
                </div>
                <div class="col-3">
                  <label>Confirm Bank Account Number</label>
                  <input name="wire_account_number_confirm" id="wire_account_number_confirm" placeholder="Re-enter account number" />
                  <div id="wire_account_match" style="display:none; font-size:0.85rem; margin-top:4px;"></div>
                </div>
                <div class="col-6">
                  <label>Bank Address</label>
                  <input name="wire_bank_address" id="wire_bank_address" placeholder="Bank street address" />
                </div>
                <div class="col-3">
                  <label>Bank City</label>
                  <input name="wire_bank_city" id="wire_bank_city" placeholder="City" />
                </div>
                <div class="col-3">
                  <label>Bank Country</label>
                  <input name="wire_bank_country" id="wire_bank_country" placeholder="Country" />
                </div>
                <div class="col-6">
                  <label>Accounts Receivable Contact Email <span class="required">*</span></label>
                  <input type="email" name="wire_ar_email" id="wire_ar_email" placeholder="ar@hotel.com" />
                  <button type="button" class="btn subtle" id="copyArEmailToWire" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from A/R Email</button>
                </div>
                <div class="col-6">
                  <label>Additional Wire Instructions</label>
                  <textarea name="wire_instructions" id="wire_instructions" placeholder="Any special instructions for wire transfers" style="min-height:60px;"></textarea>
                </div>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Payment & Compliance moved to Terms & Uploads step -->
      </div>
      <!-- PAGE 2 (Sleeping Room Details) -->
      <div class="page" data-page="2">
        <fieldset id="rooms_suites_section">
          <legend>Sleeping Room Information</legend>
          
          <!-- Important Information Message -->
          <div style="margin:16px 0; padding:16px; background:#dbeafe; border-left:4px solid #3b82f6; border-radius:8px;">
            <div style="display:flex; align-items:start; gap:12px;">
              <div style="font-size:24px; line-height:1;">‚ÑπÔ∏è</div>
              <div>
                <h4 style="margin:0 0 12px 0; color:#1e40af; font-size:1.1rem;">Important: How to Add Room Information</h4>
                
                <div style="margin-bottom:16px; padding:12px; background:#ffffff; border-radius:6px; border:1px solid #bfdbfe;">
                  <h5 style="margin:0 0 8px 0; color:#1e40af; font-size:0.95rem;">üìã Understanding the Fields:</h5>
                  <ul style="margin:0; padding-left:20px; color:#1e3a8a; line-height:1.7; font-size:0.95rem;">
                    <li style="margin-bottom:6px;"><strong>Room Count:</strong> Total number of rooms in this configuration</li>
                    <li style="margin-bottom:6px;"><strong>Real Beds in Room:</strong> How many actual beds are in each room (1 or 2 beds per room)</li>
                    <li style="margin-bottom:6px;"><strong>Bed Type:</strong> Size of the bed (King, Queen, or Double) with dimensions</li>
                    <li style="margin-bottom:0;"><strong>Rooms with Sofa:</strong> How many rooms in your hotel have a sofa bed (enter the count, not per room)</li>
                  </ul>
                </div>
                
                <div style="margin-bottom:0;">
                  <h5 style="margin:0 0 8px 0; color:#1e40af; font-size:0.95rem;">‚úÖ How to Add Your Rooms:</h5>
                  <ul style="margin:0; padding-left:20px; color:#1e3a8a; line-height:1.7; font-size:0.95rem;">
                    <li style="margin-bottom:6px;"><strong>Add multiple entries</strong> if your rooms have different bed configurations (e.g., some rooms with 1 bed, others with 2 beds)</li>
                    <li style="margin-bottom:6px;"><strong>Create separate entries</strong> for rooms with different sofa bed counts</li>
                    <li style="margin-bottom:6px;"><strong>Total room count must match</strong> your hotel's total room quantity</li>
                    <li style="margin-bottom:0;"><strong>Example:</strong> If you have 50 double rooms (30 with 1 King bed, 20 with 2 Queen beds, and 15 rooms have sofa beds), create two entries: Entry 1: 30 rooms/1 bed/King/15 sofa beds, Entry 2: 20 rooms/2 beds/Queen/0 sofa beds</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row" style="margin-top:8px">
            <div class="col-3"><label>Total Rooms (auto-calculated)</label><input type="number" id="sr_total_rooms" name="total_rooms" readonly style="background:#f9fafb;" /></div>
            <input type="hidden" id="sr_sleeping_json" name="sr_sleeping_json" />
          </div>

          <div id="sr_sleeping_form">
          <!-- Single Occupancy Rooms Section -->
          <div style="margin-top:8px; font-weight:600;">Single Occupancy Rooms</div>
          <div id="sr_single_rows"></div>
          <div id="sr_single_form" style="display:none; margin-top:12px; padding:16px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px;">
            <h4 style="margin:0 0 12px 0; color:#1f2937;">Add Single Occupancy Room</h4>
            <div class="row">
              <div class="col-3">
                <label>Room Count <span class="required">*</span></label>
                <input type="number" id="sr_single_count_new" min="0" placeholder="Number of rooms" />
              </div>
              <div class="col-3">
                <label>Real Beds in Room <span class="required">*</span></label>
                <select id="sr_single_beds_new">
                  <option value="">Select...</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
              <div class="col-3">
                <label>Bed Type <span class="required">*</span></label>
                <select id="sr_single_bed_type_new">
                  <option value="">Select...</option>
                  <option value="King">KING 72 in (183 cm) wide</option>
                  <option value="Queen">QUEEN 60 in (152 cm) wide</option>
                  <option value="Double">DOUBLE 54 in (137 cm) wide</option>
                </select>
              </div>
              <div class="col-3">
                <label>Rooms with Sofa <span class="required">*</span></label>
                <select id="sr_single_sofa_new">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                  <option value="25">25</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                  <option value="50">50</option>
                  <option value="75">75</option>
                  <option value="100">100</option>
                  <option value="150">150</option>
                  <option value="200">200</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn" id="sr_cancel_single" style="background:#dc2626; color:white;">Cancel</button>
                <button type="button" class="btn" id="sr_save_single">Save Single Room</button>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <div class="col-12">
              <button type="button" class="btn subtle" id="sr_add_single" style="width:100%;">+ Add Single Occupancy Room</button>
            </div>
          </div>

          <hr style="margin:24px 0; border:none; border-top:2px solid #9ca3af;" />

          <!-- Double Occupancy Rooms Section -->
          <div style="margin-top:8px; font-weight:600;">Double Occupancy Rooms</div>
          <div id="sr_double_rows"></div>
          <div id="sr_double_form" style="display:none; margin-top:12px; padding:16px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px;">
            <h4 style="margin:0 0 12px 0; color:#1f2937;">Add Double Occupancy Room</h4>
            <div class="row">
              <div class="col-3">
                <label>Room Count <span class="required">*</span></label>
                <input type="number" id="sr_double_count_new" min="0" placeholder="Number of rooms" />
              </div>
              <div class="col-3">
                <label>Real Beds in Room <span class="required">*</span></label>
                <select id="sr_double_beds_new">
                  <option value="">Select...</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
              <div class="col-3">
                <label>Bed Type <span class="required">*</span></label>
                <select id="sr_double_bed_type_new">
                  <option value="">Select...</option>
                  <option value="King">KING 72 in (183 cm) wide</option>
                  <option value="Queen">QUEEN 60 in (152 cm) wide</option>
                  <option value="Double">DOUBLE 54 in (137 cm) wide</option>
                </select>
              </div>
              <div class="col-3">
                <label>Rooms with Sofa <span class="required">*</span></label>
                <select id="sr_double_sofa_new">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                  <option value="25">25</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                  <option value="50">50</option>
                  <option value="75">75</option>
                  <option value="100">100</option>
                  <option value="150">150</option>
                  <option value="200">200</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn" id="sr_cancel_double" style="background:#dc2626; color:white;">Cancel</button>
                <button type="button" class="btn" id="sr_save_double">Save Double Room</button>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <div class="col-12">
              <button type="button" class="btn subtle" id="sr_add_double" style="width:100%;">+ Add Double Occupancy Room</button>
            </div>
          </div>

          <hr style="margin:24px 0; border:none; border-top:2px solid #9ca3af;" />

          <!-- ADA Accessible Rooms Section -->
          <div style="margin-top:8px; font-weight:600;">ADA Accessible Rooms <span class="required">*</span></div>
          
          <div style="margin-top:12px; padding:12px; background:#fef3c7; border:1px solid #fbbf24; border-radius:8px;" id="sr_no_ada_container">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:500;">
              <input type="checkbox" id="sr_no_ada" name="sr_no_ada" style="width:18px; height:18px; cursor:pointer;" />
              <span>No ADA Rooms Available - My property does not have ADA accessible rooms</span>
            </label>
          </div>
          
          <div id="sr_ada_rows"></div>
          <div id="sr_ada_form" style="display:none; margin-top:12px; padding:16px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px;">
            <h4 style="margin:0 0 12px 0; color:#1f2937;">Add ADA Accessible Room</h4>
            <div class="row">
              <div class="col-3">
                <label>Room Count <span class="required">*</span></label>
                <input type="number" id="sr_ada_count_new" min="0" placeholder="Number of rooms" />
              </div>
              <div class="col-3">
                <label>Real Beds in Room <span class="required">*</span></label>
                <select id="sr_ada_beds_new">
                  <option value="">Select...</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
              <div class="col-3">
                <label>Bed Type <span class="required">*</span></label>
                <select id="sr_ada_bed_type_new">
                  <option value="">Select...</option>
                  <option value="King">KING 72 in (183 cm) wide</option>
                  <option value="Queen">QUEEN 60 in (152 cm) wide</option>
                  <option value="Double">DOUBLE 54 in (137 cm) wide</option>
                </select>
              </div>
              <div class="col-3">
                <label>Rooms with Sofa <span class="required">*</span></label>
                <select id="sr_ada_sofa_new">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                  <option value="25">25</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                  <option value="50">50</option>
                  <option value="75">75</option>
                  <option value="100">100</option>
                  <option value="150">150</option>
                  <option value="200">200</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn" id="sr_cancel_ada" style="background:#dc2626; color:white;">Cancel</button>
                <button type="button" class="btn" id="sr_save_ada">Save ADA Room</button>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <div class="col-12">
              <button type="button" class="btn subtle" id="sr_add_ada" style="width:100%;">+ Add ADA Accessible Room</button>
            </div>
          </div>

          <hr style="margin:24px 0; border:none; border-top:2px solid #9ca3af;" />
          <div style="margin-top:12px; font-weight:600;">Suites <span class="required">*</span></div>
          
          <div style="margin-top:12px; padding:12px; background:#fef3c7; border:1px solid #fbbf24; border-radius:8px;" id="sr_no_suites_container">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:500;">
              <input type="checkbox" id="sr_no_suites" name="sr_no_suites" style="width:18px; height:18px; cursor:pointer;" />
              <span>No Suites Available - My property does not have suites</span>
            </label>
          </div>
          
          <div id="sr_suites_rows"></div>
          
          <div id="sr_suite_form" style="display:none; margin-top:12px; padding:16px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px;">
            <h4 style="margin:0 0 12px 0; color:#1f2937;">Add New Suite Type</h4>
              <div class="row">
                <div class="col-3">
                  <label>Suite Type <span class="required">*</span></label>
                  <select id="sr_suite_type_new" name="sr_suite_type_new">
                    <option value="">Select suite type...</option>
                    <option value="Presidential Suite">Presidential Suite</option>
                    <option value="Executive Suite">Executive Suite</option>
                    <option value="Junior Suite">Junior Suite</option>
                    <option value="Master Suite">Master Suite</option>
                    <option value="Family Suite">Family Suite</option>
                    <option value="Honeymoon Suite">Honeymoon Suite</option>
                    <option value="Bridal Suite">Bridal Suite</option>
                    <option value="Governor Suite">Governor Suite</option>
                    <option value="Royal Suite">Royal Suite</option>
                    <option value="Deluxe Suite">Deluxe Suite</option>
                    <option value="Penthouse Suite">Penthouse Suite</option>
                    <option value="Spa Suite">Spa Suite</option>
                    <option value="Business Suite">Business Suite</option>
                    <option value="Other">Other (specify in notes)</option>
                  </select>
                </div>
                <div class="col-3">
                  <label>Room Size <span class="required">*</span></label>
                  <select id="sr_suite_room_size_new" name="sr_suite_room_size_new">
                    <option value="">Select...</option>
                    <option value="Studio Room">Studio Room</option>
                    <option value="1 Bedroom">1 Bedroom</option>
                    <option value="2 Bedroom">2 Bedroom</option>
                  </select>
                </div>
                <div class="col-3">
                  <label>Number of Rooms <span class="required">*</span></label>
                  <input id="sr_suite_rooms_new" name="sr_suite_rooms_new" type="number" min="0" placeholder="e.g., 5" />
                </div>
                <div class="col-3">
                  <label>Real Beds in Room <span class="required">*</span></label>
                  <select id="sr_suite_beds_new" name="sr_suite_beds_new">
                    <option value="">Select...</option>
                    <option value="1">1 Bed</option>
                    <option value="2">2 Beds</option>
                    <option value="3">3 Beds</option>
                    <option value="4">4 Beds</option>
                    <option value="5">5 Beds</option>
                    <option value="6">6 Beds</option>
                    <option value="7">7 Beds</option>
                    <option value="8">8 Beds</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-3">
                  <label>Bed Type <span class="required">*</span></label>
                  <select id="sr_suite_bed_type_new" name="sr_suite_bed_type_new">
                    <option value="">Select...</option>
                    <option value="King">KING 72 in (183 cm) wide</option>
                    <option value="Queen">QUEEN 60 in (152 cm) wide</option>
                    <option value="Double">DOUBLE 54 in (137 cm) wide</option>
                  </select>
                </div>
                <div class="col-3">
                  <label>Rooms with Sofa</label>
                  <select id="sr_suite_sofa_new" name="sr_suite_sofa_new">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="50">50</option>
                    <option value="75">75</option>
                    <option value="100">100</option>
                    <option value="150">150</option>
                    <option value="200">200</option>
                  </select>
                </div>
              </div>
                <div class="row" style="margin-top:8px;">
                  <div class="col-12">
                    <label>Notes (Optional)</label>
                    <textarea id="sr_suite_notes_new" name="sr_suite_notes_new" placeholder="Any additional details about this suite type..."></textarea>
                  </div>
                </div>
                <div class="row" style="margin-top:12px;">
                  <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="button" class="btn" id="sr_cancel_suite" style="background:#dc2626; color:white;">Cancel</button>
                    <button type="button" class="btn" id="sr_save_suite">Save Suite</button>
                  </div>
                </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col-12">
              <button type="button" class="btn subtle" id="sr_add_suite" style="width:100%;">+ Add Suite Type</button>
            </div>
          </div>

          <div class="row" style="margin-top:8px; align-items:center;">
            <div class="col-3"><button type="button" class="btn" id="sr_save_sleeping">Save Sleeping Rooms</button></div>
            <div class="col-9"><span id="sr_sleeping_saved_msg" style="display:none; color:#065f46;">Saved.</span></div>
          </div>
          </div>
          <div id="sr_sleeping_summary" style="display:none; margin-top:12px;"></div>
        </fieldset>
        <fieldset style="display:none;">
          <legend>Sleeping Rooms Inventory</legend>
          <div class="row">
            <div class="col-3"><label>Total Guest Rooms <span class="required">*</span></label><input type="number" name="total_rooms" id="total_rooms" min="0" required readonly style="background:#f9fafb;" /></div>
            <div class="col-3"><label>Single Occupancy <span class="required">*</span></label><input type="number" name="king_rooms" id="king_rooms" class="room-count" min="0" required /></div>
            <div class="col-3"><label>Double Occupancy <span class="required">*</span></label><input type="number" name="double_rooms" id="double_rooms" class="room-count" min="0" required /></div>
            <div class="col-12">
              <div class="hint" style="margin-top:8px; font-style:italic; color:#6b7280;">
                <strong>Note:</strong> Sofa beds and rollaways are not considered as real beds.
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset style="display:none;">
          <legend>Suites</legend>
          <div class="row">
            <div class="col-12">
              <label>Does your property have suites? <span class="required">*</span></label>
              <select name="has_suites" id="has_suites" required>
                <option value="">Select‚Ä¶</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          
          <div id="suites_section" style="display:none; margin-top:16px;">
            <h4 style="margin-bottom:12px;">Suite Information</h4>
            <div id="suites_container">
              <!-- Suite rows will be added here -->
            </div>
            <button type="button" id="addSuiteBtn" class="btn ghost" style="margin-top:12px;">+ Add Suite Type</button>
            <div id="suites_total" style="margin-top:12px; font-weight:600; display:none;">
              Total Suites: <span id="suites_total_count">0</span>
            </div>
          </div>
        </fieldset>

        

        <fieldset>
          <legend>Extended Stay</legend>
          <div class="row">
            <div class="col-12">
              <label>Is your property an Extended Stay hotel? <span class="required">*</span></label>
              <select name="is_extended_stay" id="is_extended_stay" required><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select>
              <div class="hint">If Yes, more questions appear below.</div>
            </div>
          </div>
        </fieldset>

        <fieldset id="extendedStaySection" style="display:none;">
          <legend>Extended Stay Amenities</legend>
          <div class="row">
            <div class="col-4"><label>In-Room Kitchen <span class="required">*</span></label><select name="ext_kitchen" data-es-required="1"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Fully Equipped? <span class="required">*</span></label><select name="ext_kitchen_equipped" data-es-required="1"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Washer / Dryer <span class="required">*</span></label><select name="ext_washer_dryer" data-es-required="1"><option value="">Select‚Ä¶</option><option>In-room</option><option>On-site ‚Äì self-service</option><option>On-site ‚Äì valet</option><option>None</option></select></div>
            
            <div class="col-6">
              <label>Cooktop / Burner Type <span class="required">*</span></label>
              <select name="ext_cooktop_type" id="ext_cooktop_type" data-es-required="1">
                <option value="">Select‚Ä¶</option>
                <option value="None">None (No cooking facility)</option>
                <option value="Electric Cooktop (2-Burner)">Electric Cooktop (2-Burner)</option>
                <option value="Electric Cooktop (4-Burner)">Electric Cooktop (4-Burner)</option>
                <option value="Induction Cooktop (2-Burner)">Induction Cooktop (2-Burner)</option>
                <option value="Induction Cooktop (4-Burner)">Induction Cooktop (4-Burner)</option>
                <option value="Gas Cooktop (2-Burner)">Gas Cooktop (2-Burner)</option>
                <option value="Gas Cooktop (4-Burner)">Gas Cooktop (4-Burner)</option>
                <option value="Ceramic Glass Cooktop">Ceramic Glass Cooktop</option>
                <option value="Portable Single Burner (Electric)">Portable Single Burner (Electric)</option>
                <option value="Portable Induction Burner">Portable Induction Burner</option>
                <option value="Built-in Range (Cooktop + Oven)">Built-in Range (Cooktop + Oven)</option>
                <option value="Compact Range (Cooktop + Oven Combo)">Compact Range (Cooktop + Oven Combo)</option>
                <option value="Hot Plate (Single or Dual)">Hot Plate (Single or Dual)</option>
                <option value="Infrared Burner">Infrared Burner</option>
                <option value="Convection Cooktop (Countertop)">Convection Cooktop (Countertop)</option>
                <option value="Microwave with Grill Function">Microwave with Grill Function</option>
                <option value="Microwave Only (No Burners)">Microwave Only (No Burners)</option>
              </select>
            </div>
            
            <div class="col-6" id="ext_burner_count_section" style="display:none;">
              <label>Confirm Burner Count <span class="required">*</span></label>
              <select name="ext_burner_count" id="ext_burner_count">
                <option value="">Select‚Ä¶</option>
                <option value="0">0 (No burners)</option>
                <option value="1">1 Burner</option>
                <option value="2">2 Burners</option>
                <option value="3">3 Burners</option>
                <option value="4">4 Burners</option>
              </select>
              <div class="hint">Please confirm the number of burners</div>
            </div>
            
            <div class="col-4"><label>Microwave</label><select name="ext_equipment_microwave"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Refrigerator</label><select name="ext_equipment_fridge"><option value="">Select‚Ä¶</option><option>Full-size</option><option>Mid-size</option><option>Mini</option></select></div>
            <div class="col-4"><label>Dishwasher</label><select name="ext_equipment_dishwasher"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Cookware & Utensils</label><select name="ext_equipment_cookware"><option value="">Select‚Ä¶</option><option>Yes ‚Äì Full set</option><option>Yes ‚Äì Basic</option><option>No</option></select></div>
            <div class="col-4"><label>Fire Suppression at Cooktop</label><select name="ext_fire_suppression"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Cooking Restrictions</label><input name="ext_cooking_restrictions" /></div>
            <div class="col-12"><label>Notes (Extended Stay)</label><textarea name="ext_extended_stay_notes"></textarea></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Lodging Taxes</legend>
          <div class="row">
            <div class="col-12">
              <label>Tax Breakdown Method <span class="required">*</span></label>
              <select name="tax_method" id="tax_method" required>
                <option value="">Select‚Ä¶</option>
                <option value="breakdown">Break down by jurisdiction</option>
                <option value="total">Enter total tax percentage only</option>
              </select>
              <div class="hint">Choose how you want to enter your lodging tax information.</div>
            </div>
          </div>
          
          <div id="tax_breakdown_section" style="display:none;">
            <div class="row">
              <div class="col-3"><label>State Tax (%)</label><input type="number" name="tax_state" id="tax_state" min="0" max="100" step="0.01" placeholder="0.00" /></div>
              <div class="col-3"><label>County Tax (%)</label><input type="number" name="tax_county" id="tax_county" min="0" max="100" step="0.01" placeholder="0.00" /></div>
              <div class="col-3"><label>City Tax (%)</label><input type="number" name="tax_city" id="tax_city" min="0" max="100" step="0.01" placeholder="0.00" /></div>
              <div class="col-3"><label>Total Taxes (%)</label><input type="number" name="tax_total_breakdown" id="tax_total_breakdown" min="0" max="100" step="0.01" placeholder="0.00" readonly style="background:#f9fafb;" /></div>
            </div>
          </div>
          
          <div id="tax_total_section" style="display:none;">
            <div class="row">
              <div class="col-6"><label>Total Lodging Tax (%) <span class="required">*</span></label><input type="number" name="tax_total_only" id="tax_total_only" min="0" max="100" step="0.01" placeholder="0.00" /></div>
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col-12">
              <label>Tax Comments</label>
              <textarea name="tax_comments" id="tax_comments" placeholder="Any additional information about your lodging taxes, exemptions, or special circumstances..."></textarea>
            </div>
          </div>
        </fieldset>

        <script>
          // Lodging Taxes functionality
          document.addEventListener('DOMContentLoaded', function() {
            const taxMethodSelect = document.getElementById('tax_method');
            const breakdownSection = document.getElementById('tax_breakdown_section');
            const totalSection = document.getElementById('tax_total_section');
            const stateTaxInput = document.getElementById('tax_state');
            const countyTaxInput = document.getElementById('tax_county');
            const cityTaxInput = document.getElementById('tax_city');
            const totalBreakdownInput = document.getElementById('tax_total_breakdown');

            if (taxMethodSelect) {
              taxMethodSelect.addEventListener('change', function() {
                const method = this.value;
                if (method === 'breakdown') {
                  breakdownSection.style.display = '';
                  totalSection.style.display = 'none';
                } else if (method === 'total') {
                  breakdownSection.style.display = 'none';
                  totalSection.style.display = '';
                } else {
                  breakdownSection.style.display = 'none';
                  totalSection.style.display = 'none';
                }
              });
            }

            // Auto-calculate total from breakdown
            function calculateTotalTax() {
              if (!stateTaxInput || !countyTaxInput || !cityTaxInput || !totalBreakdownInput) return;
              
              const state = parseFloat(stateTaxInput.value) || 0;
              const county = parseFloat(countyTaxInput.value) || 0;
              const city = parseFloat(cityTaxInput.value) || 0;
              const total = state + county + city;
              
              totalBreakdownInput.value = total.toFixed(2);
            }

            if (stateTaxInput) stateTaxInput.addEventListener('input', calculateTotalTax);
            if (countyTaxInput) countyTaxInput.addEventListener('input', calculateTotalTax);
            if (cityTaxInput) cityTaxInput.addEventListener('input', calculateTotalTax);
          });
        </script>

        <fieldset style="display:none;">
          <legend>Breakfast</legend>
          <div class="row">
            <div class="col-12">
              <label>Breakfast Included? <span class="required">*</span></label>
              <select name="breakfast_included" id="breakfast_included" required><option value="">Select‚Ä¶</option><option>Yes ‚Äì Full</option><option>Yes ‚Äì Continental</option><option>No</option></select>
            </div>
            <div class="col-12" id="breakfast_cost_section" style="display:none;">
              <label>Breakfast Buffet Cost (per person) <span class="required">*</span></label>
              <input type="number" name="breakfast_buffet_cost" id="breakfast_buffet_cost" min="0" step="0.01" placeholder="Enter cost per person" />
              <div class="hint">Please enter the cost per person for the breakfast buffet service.</div>
            </div>
          </div>
        </fieldset>
        <fieldset style="display:none;">
          <legend>Accessible (ADA) Rooms</legend>
          <div class="row">
            <div class="col-12">
              <label>Does your property have ADA accessible rooms? <span class="required">*</span></label>
              <select name="has_ada_rooms" id="has_ada_rooms" required>
                <option value="">Select‚Ä¶</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          
          <div id="ada_rooms_section" style="display:none; margin-top:16px;">
            <h4 style="margin-bottom:12px;">ADA Room Information</h4>
            <div id="ada_rooms_container">
              <!-- ADA room rows will be added here -->
            </div>
            <button type="button" id="addAdaRoomBtn" class="btn ghost" style="margin-top:12px;">+ Add ADA Room Type</button>
            <div id="ada_rooms_total" style="margin-top:12px; font-weight:600; display:none;">
              Total ADA Rooms: <span id="ada_rooms_total_count">0</span>
            </div>
          </div>
        </fieldset>




        <!-- Meeting and amenities moved to separate pages -->
      </div>

      <!-- PAGE 3 (Meeting Space Details) -->
      <div class="page" data-page="3">
        <fieldset>
          <legend>Meeting Spaces</legend>
          <div class="row">
            <div class="col-4">
              <label>Do you have meeting space available? <span class="required">*</span></label>
              <select id="has_meeting_space" name="has_meeting_space" required>
                <option value="">Select‚Ä¶</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          <div id="meeting_tools" style="display:none; margin-top:8px;">
            <div class="inline">
              <button class="btn subtle" type="button" id="addRoomBtn">+ Add Meeting Space</button>
              <span class="hint">Add each room with dimensions and capacities.</span>
            </div>
            
            <!-- OCR-based Fact Sheet Upload -->
            <div style="margin-top:16px; padding:16px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px;">
              <h4 style="margin:0 0 12px 0; color:#0c4a6e;">üìÑ OCR Fact Sheet Extraction</h4>
              <p style="margin:0 0 12px 0; color:#475569; font-size:0.9rem;">Upload a meeting space fact sheet (PDF or image) for automatic extraction.</p>
              
              <div id="meeting-space-list" style="margin-bottom:12px;">
                <!-- Dynamic rows for meeting rooms will be appended here -->
              </div>
              
              <!-- Upload Fact Sheet PDF -->
              <div class="row">
                <div class="col-12">
                  <label for="factSheet" class="block text-sm font-medium" style="color:#374151; font-weight:500;">Upload Meeting Space Fact Sheet (PDF/Image)</label>
                  <input 
                    type="file" 
                    id="factSheet" 
                    name="factSheet" 
                    accept=".pdf,.png,.jpg,.jpeg" 
                    style="margin-top:8px; padding:8px; border:1px solid #d1d5db; border-radius:6px; width:100%;"
                  >
                  <div class="hint">Supported: PDF, PNG, JPG, JPEG ‚Ä¢ Maximum file size: 10MB</div>
                </div>
              </div>
              
              <!-- AI OCR Extraction Button -->
              <div class="row" style="margin-top:12px;">
                <div class="col-12">
                  <button type="button" id="processFactSheetHybrid" class="btn" style="background:#10b981; color:white; width:100%;">
                    ü§ñ Extract Meeting Rooms with AI
                  </button>
                  <div class="hint" style="margin-top:4px; font-size:0.8rem; text-align:center;">AI will automatically extract room names, dimensions, and capacities from your document</div>
                </div>
              </div>
              
              <!-- Processing Status -->
              <div id="ocr-processing-status" style="display:none; margin-top:12px; padding:12px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div class="spinner" style="width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid #0b2545; border-radius:50%; animation:spin 1s linear infinite;"></div>
                  <span id="ocr-status-text" style="color:#856404; font-weight:600;">Processing...</span>
                </div>
              </div>
            </div>
            
            <div id="rooms"></div>
            <div style="margin-top:16px;">
              <button type="button" class="btn" id="save_meeting_spaces">Save Meeting Spaces</button>
            </div>
          </div>
          <div id="meeting_none_hint" class="hint" style="display:none; margin-top:8px;">You indicated there is no meeting space. You can still continue and edit any step at any time.</div>
          
          <!-- Hidden field for meeting room data serialization -->
          <input type="hidden" id="meeting_rooms_json" name="meeting_rooms_json" />
          
          <!-- Meeting Spaces Summary -->
          <div id="meeting_spaces_summary" style="margin-top:16px; display:none;">
            <h4 style="color:#1f2937; margin-bottom:12px;">Meeting Spaces Summary</h4>
            <div id="meeting_spaces_table"></div>
            <div style="margin-top:12px;">
              <button type="button" class="btn subtle" id="edit_meeting_spaces">Edit Meeting Spaces</button>
            </div>
          </div>
        </fieldset>
        
        <fieldset>
          <legend>A/V Services</legend>
          <div class="row">
            <div class="col-6">
              <label>In-house A/V Services? <span class="required">*</span></label>
              <select name="av_in_house" id="av_in_house" required>
                <option value="">Select‚Ä¶</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-6" id="av_provider_section" style="display:none;">
              <label>Name of A/V Service Provider <span class="required">*</span></label>
              <input name="av_provider_name" id="av_provider_name" placeholder="e.g., ABC Audio Visual Services" />
            </div>
            <div class="col-6">
              <label>Allow Outside A/V Services? <span class="required">*</span></label>
              <select name="av_outside_allowed" id="av_outside_allowed" required>
                <option value="">Select‚Ä¶</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-6" id="av_outside_fees_section" style="display:none;">
              <label>Outside A/V Service Fees <span class="required">*</span></label>
              <input name="av_outside_fees" id="av_outside_fees" placeholder="e.g., $500 setup fee, $200/day" />
            </div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 4 (Amenities) -->
      <div class="page" data-page="4">
        <fieldset>
          <legend>Hotel Amenities</legend>
          <div class="hint">Select all amenities that apply. Use each category to expand and choose options.</div>
          
          <div class="amenities">
            <!-- A. Property Amenities -->
            <details class="amenity-section" open>
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üè¢ Property Amenities</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_property[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_property[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_property[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="24-Hour Front Desk"> 24-Hour Front Desk</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Concierge Service"> Concierge Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Business Center"> Business Center</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Fitness Center / Gym"> Fitness Center / Gym</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Swimming Pool - Indoor"> Swimming Pool (Indoor)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Swimming Pool - Outdoor"> Swimming Pool (Outdoor)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Spa / Wellness Center"> Spa / Wellness Center</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="On-Site Restaurant"> On-Site Restaurant</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Bar / Lounge"> Bar / Lounge</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Coffee Shop / Caf√©"> Coffee Shop / Caf√©</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Breakfast - Complimentary"> Breakfast Available (Complimentary)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Breakfast - Paid"> Breakfast Available (Paid)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Room Service"> Room Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Gift Shop"> Gift Shop</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Laundry / Dry Cleaning Service"> Laundry / Dry Cleaning Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Self-Service Laundry"> Self-Service Laundry</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Elevator / Lift"> Elevator / Lift</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Designated Smoking Area"> Designated Smoking Area</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Non-Smoking Property"> Non-Smoking Property</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Free Parking"> Free Parking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Valet Parking"> Valet Parking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="EV Charging Stations"> Electric Vehicle Charging Stations</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Shuttle - Airport"> Shuttle Service (Airport)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Shuttle - Local"> Shuttle Service (Local)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="24-Hour Security"> 24-Hour Security</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Fire Sprinkler System"> Fire Sprinkler System</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Security Cameras"> Security Cameras</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Key Card Access"> Key Card Access</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="On-Site Maintenance"> On-Site Maintenance</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="ATM / Banking"> ATM / Banking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Vending Machines"> Vending Machines</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Luggage Storage"> Luggage Storage</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Ice Machine"> Ice Machine</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Outdoor Patio / Garden Area"> Outdoor Patio / Garden Area</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_property[]" value="Business Lounge / Meeting Hub"> Business Lounge / Meeting Hub</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_property_other" class="amenities-other" placeholder="Describe additional property amenities."></textarea>
                </div>
              </div>
            </details>

            <!-- B. Accessibility (ADA) Features -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üß© Accessibility (ADA) Features</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_accessibility[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_accessibility[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_accessibility[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="ADA Accessible Entrances"> ADA Accessible Entrances</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Step-Free Access to All Areas"> Step-Free Access to All Areas</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="ADA Parking Spaces"> ADA Parking Spaces</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Accessible Elevators"> Accessible Elevators</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Wheelchair-Accessible Restrooms"> Wheelchair-Accessible Restrooms</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Braille Signage"> Braille Signage</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Assistive Listening Devices"> Assistive Listening Devices</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Roll-In Showers"> Roll-In Showers</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Grab Bars in Bathrooms"> Grab Bars in Bathrooms</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Lowered Counters"> Lowered Counters</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Accessible Pool Lift"> Accessible Pool Lift</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_accessibility[]" value="Service Animal-Friendly"> Service Animal-Friendly</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_accessibility_other" class="amenities-other" placeholder="Describe additional accessibility features."></textarea>
                </div>
              </div>
            </details>

            <!-- C. Guest Services -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üè® Guest Services</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_guest_services[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_guest_services[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_guest_services[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="24-Hour Check-In"> 24-Hour Check-In</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Express Check-In / Check-Out"> Express Check-In / Check-Out</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Multilingual Staff"> Multilingual Staff</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Daily Housekeeping"> Daily Housekeeping</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Long-Term Stay Options"> Long-Term Stay Options</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Wake-Up Call Service"> Wake-Up Call Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Baggage Handling"> Baggage Handling</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Airport Pickup / Dropoff"> Airport Pickup / Dropoff</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Pet-Friendly"> Pet-Friendly</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="On-Site Manager"> On-Site Manager</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_guest_services[]" value="Childcare / Babysitting Service"> Childcare / Babysitting Service</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_guest_services_other" class="amenities-other" placeholder="Describe additional guest services."></textarea>
                </div>
              </div>
            </details>

            <!-- D. Laundry Facilities -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üß∫ Laundry Facilities</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_laundry[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_laundry[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_laundry[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_laundry[]" value="Guest Self-Service Laundry (Coin Operated)"> Guest Self-Service Laundry (Coin Operated)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_laundry[]" value="On-Site Laundry Service"> On-Site Laundry Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_laundry[]" value="Off-Site / Outsourced Laundry (Pick-Up)"> Off-Site / Outsourced Laundry (Pick-Up)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_laundry[]" value="Dry Cleaning Service"> Dry Cleaning Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_laundry[]" value="Ironing Service"> Ironing Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_laundry[]" value="Laundry Trailer (Mobile Laundry Setup)"> Laundry Trailer (Mobile Laundry Setup)</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_laundry_other" class="amenities-other" placeholder="Describe additional laundry facilities."></textarea>
                </div>
              </div>
            </details>

            <!-- E. Room Amenities -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üõèÔ∏è Room Amenities</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_room[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_room[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_room[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Air Conditioning / Heating"> Air Conditioning / Heating</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Private Bathroom"> Private Bathroom</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Bathtub / Shower Combo"> Bathtub / Shower Combo</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Hair Dryer"> Hair Dryer</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Iron & Ironing Board"> Iron & Ironing Board</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Coffee Maker / Kettle"> Coffee Maker / Kettle</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Microwave"> Microwave</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Mini Refrigerator"> Mini Refrigerator</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Kitchenette / Full Kitchen"> Kitchenette / Full Kitchen</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Cookware / Dining Utensils"> Cookware / Dining Utensils</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Television (Cable / Smart TV)"> Television (Cable / Smart TV)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Telephone"> Telephone</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Alarm Clock"> Alarm Clock</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Safe (In-Room)"> Safe (In-Room)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Desk / Workstation"> Desk / Workstation</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Wi-Fi Access (Free)"> Wi-Fi Access (Free)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Wi-Fi Access (Paid)"> Wi-Fi Access (Paid)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Power Outlets near Desk"> Power Outlets near Desk</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Closet / Wardrobe"> Closet / Wardrobe</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Luggage Rack"> Luggage Rack</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Balcony / Terrace"> Balcony / Terrace</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Blackout Curtains"> Blackout Curtains</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Soundproof Windows"> Soundproof Windows</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Housekeeping Service"> Housekeeping Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Smoke Detector / Sprinklers"> Smoke Detector / Sprinklers</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="Key Card Access"> Key Card Access</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_room[]" value="USB Charging Ports"> USB Charging Ports</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_room_other" class="amenities-other" placeholder="Describe additional in-room amenities."></textarea>
                </div>
              </div>
            </details>

            <!-- F. Internet & Technology -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üåê Internet & Technology</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_tech[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_tech[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_tech[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Complimentary Wi-Fi in Rooms"> Complimentary Wi-Fi in Rooms</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Complimentary Wi-Fi in Public Areas"> Complimentary Wi-Fi in Public Areas</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Wired Internet Available"> Wired Internet Available</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="High-Speed Fiber Internet"> High-Speed Fiber Internet</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Business Center Computers"> Business Center Computers</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Printing / Copy Services"> Printing / Copy Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Video Conferencing Room"> Video Conferencing Room</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_tech[]" value="Dedicated Bandwidth for Events"> Dedicated Bandwidth for Events</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_tech_other" class="amenities-other" placeholder="Describe additional internet/technology features."></textarea>
                </div>
              </div>
            </details>

            <!-- G. Food & Beverage -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üçΩÔ∏è Food & Beverage</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_fnb[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_fnb[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_fnb[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Complimentary Breakfast"> Complimentary Breakfast</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Buffet Breakfast"> Buffet Breakfast</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Grab-and-Go Breakfast"> Grab-and-Go Breakfast</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Restaurant (Lunch / Dinner Service)"> Restaurant (Lunch / Dinner Service)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Bar / Lounge"> Bar / Lounge</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Coffee Bar / Espresso Service"> Coffee Bar / Espresso Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Room Service (Limited Hours)"> Room Service (Limited Hours)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Room Service (24-Hour)"> Room Service (24-Hour)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Catering Available for Events"> Catering Available for Events</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Vending Machines (Snacks / Beverages)"> Vending Machines (Snacks / Beverages)</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="In-Room Dining"> In-Room Dining</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_fnb[]" value="Outdoor Grill / BBQ Area"> Outdoor Grill / BBQ Area</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_fnb_other" class="amenities-other" placeholder="Describe additional food & beverage offerings."></textarea>
                </div>
              </div>
            </details>

            <!-- H. Parking & Transportation -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üöó Parking & Transportation</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_parking[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_parking[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_parking[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Free Self Parking"> Free Self Parking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Valet Parking"> Valet Parking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Oversized Vehicle / Bus Parking"> Oversized Vehicle / Bus Parking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="EV Charging Stations"> EV Charging Stations</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Covered Garage Parking"> Covered Garage Parking</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Airport Shuttle"> Airport Shuttle</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Local Shuttle / Van Service"> Local Shuttle / Van Service</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Accessible Parking Spots"> Accessible Parking Spots</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_parking[]" value="Loading / Drop-off Zone"> Loading / Drop-off Zone</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_parking_other" class="amenities-other" placeholder="Describe additional parking/transportation options."></textarea>
                </div>
              </div>
            </details>

            <!-- I. Recreation & Leisure -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üßò Recreation & Leisure</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_recreation[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_recreation[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_recreation[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Indoor Pool"> Indoor Pool</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Outdoor Pool"> Outdoor Pool</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Hot Tub / Whirlpool"> Hot Tub / Whirlpool</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Sauna / Steam Room"> Sauna / Steam Room</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Fitness Center / Gym"> Fitness Center / Gym</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Yoga / Stretch Room"> Yoga / Stretch Room</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Walking / Jogging Paths"> Walking / Jogging Paths</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Outdoor Games / Courtyard Area"> Outdoor Games / Courtyard Area</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Bike Rentals"> Bike Rentals</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_recreation[]" value="Tennis / Sports Court"> Tennis / Sports Court</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_recreation_other" class="amenities-other" placeholder="Describe additional recreation & leisure options."></textarea>
                </div>
              </div>
            </details>

            <!-- J. Business Services -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üíº Business Services</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_business[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_business[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_business[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Business Center"> Business Center</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="24-Hour Business Center"> 24-Hour Business Center</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Computer Workstations"> Computer Workstations</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="High-Speed Internet Access"> High-Speed Internet Access</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Printing Services"> Printing Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Copying Services"> Copying Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Scanning Services"> Scanning Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Fax Services"> Fax Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Shipping Services"> Shipping Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Notary Services"> Notary Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Translation Services"> Translation Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Secretarial Services"> Secretarial Services</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Executive Lounge"> Executive Lounge</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Private Office Rentals"> Private Office Rentals</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Video Conferencing"> Video Conferencing</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Mail/Package Handling"> Mail/Package Handling</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Office Supplies"> Office Supplies</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_business[]" value="Courier Services"> Courier Services</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Business Services (not listed above)</label>
                  <textarea name="amenities_business_other" class="amenities-other" placeholder="Describe additional business services offered."></textarea>
                </div>
              </div>
            </details>

            <!-- K. Safety & Security -->
            <details class="amenity-section">
              <summary style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>üß≥ Safety & Security</span>
              </summary>
              <div class="right" style="margin:8px 0;">
                <button type="button" class="btn subtle amenity-select-all" data-target="amenities_security[]" style="font-size:0.9rem;">Select All</button>
                <button type="button" class="btn subtle amenity-clear-all" data-target="amenities_security[]" style="font-size:0.9rem; color:#dc2626;">Clear All</button>
              </div>
              <div class="row amenity-group" data-name="amenities_security[]">
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="24-Hour Security"> 24-Hour Security</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Fire Alarm System"> Fire Alarm System</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Fire Extinguishers"> Fire Extinguishers</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Smoke Detectors"> Smoke Detectors</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Sprinkler System"> Sprinkler System</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Emergency Lighting"> Emergency Lighting</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Safe Deposit Boxes"> Safe Deposit Boxes</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Security Patrols"> Security Patrols</label></div>
                <div class="col-4"><label class="inline"><input type="checkbox" name="amenities_security[]" value="Controlled Entry Doors"> Controlled Entry Doors</label></div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div class="col-12">
                  <label>Other Amenities (not listed above)</label>
                  <textarea name="amenities_security_other" class="amenities-other" placeholder="Describe additional safety & security features."></textarea>
                </div>
              </div>
            </details>

            <div class="row" style="margin-top:12px;">
              <div class="col-12 right">
                <button type="button" class="btn" id="saveAmenitiesBtn">Save Amenities</button>
              </div>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 5 (Terms & Uploads) -->
      <div class="page" data-page="5">
        <fieldset>
          <legend>Group Block & Policies</legend>
          <div class="row">
            <div class="col-3"><label>Max Group Block (rooms) <span class="required">*</span></label><input type="number" name="max_group_block" min="0" required /></div>
            <div class="col-3"><label>Cutoff (days) <span class="required">*</span></label><input type="number" name="cutoff_days" min="0" required /></div>
          </div>
          
          <!-- Emergency Lodging Support -->
          <div style="margin-top:20px; padding:16px; background:#fee2e2; border:2px solid #dc2626; border-radius:8px;">
            <div style="display:flex; align-items:start; gap:12px; margin-bottom:12px;">
              <div style="font-size:24px; line-height:1;">üö®</div>
              <div>
                <h4 style="margin:0 0 8px 0; color:#991b1b; font-size:1.1rem;">Emergency Lodging Support</h4>
                <p style="margin:0 0 12px 0; color:#7f1d1d; line-height:1.6; font-size:0.95rem;">
                  <strong>Emergency lodging support</strong> means your property can accommodate urgent government lodging requests that may require:
                </p>
                <ul style="margin:0 0 12px 0; padding-left:20px; color:#7f1d1d; line-height:1.7; font-size:0.95rem;">
                  <li style="margin-bottom:6px;"><strong>Weekend or after-hours communications</strong> - Responding to urgent requests outside normal business hours</li>
                  <li style="margin-bottom:6px;"><strong>Short notice bookings</strong> - As close as 4 hours notice for group lodging needs</li>
                  <li style="margin-bottom:6px;"><strong>State emergency situations</strong> - Natural disasters, federal operations, or other urgent government needs</li>
                  <li style="margin-bottom:0;"><strong>Immediate availability</strong> - Quick room turnover and rapid response capabilities</li>
                </ul>
                <p style="margin:0; color:#7f1d1d; font-size:0.9rem; font-style:italic;">
                  Hotels that accept emergency lodging support requests receive priority consideration for urgent government contracts.
                </p>
              </div>
            </div>
            
            <div class="row">
              <div class="col-6">
                <label style="color:#991b1b; font-weight:700; font-size:1rem;">Emergency Lodging Support <span class="required">*</span></label>
                <select name="emergency_lodging_support" id="emergency_lodging_support" required style="border:2px solid #dc2626;">
                  <option value="">Select...</option>
                  <option value="Acceptable">‚úÖ Acceptable - We can support emergency lodging requests</option>
                  <option value="Unacceptable">‚ùå Unacceptable - We cannot support emergency lodging requests</option>
                </select>
                <div class="hint" style="color:#7f1d1d; font-weight:500; margin-top:6px;">
                  This field is required. Please indicate whether your property can accommodate emergency lodging requests.
                </div>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Concessions</legend>
          <div class="row">
            <div class="col-6"><label>Comp Room Ratio <span class="required">*</span></label><input name="comp_ratio" placeholder="e.g., 1:30" required /></div>
            <div class="col-6"><label>2 Reward Points Per 1$ Spent</label><select name="double_reward_points_per_dollar"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Payment & Compliance</legend>
          <div class="row">
            <div class="col-4">
              <label>Accepts NET30 (CREATA prime)? <span class="required">*</span></label>
              <select name="accepts_net30" id="accepts_net30" required><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select>
            </div>
            <div class="col-4">
              <label>Government Backed PO <span class="required">*</span></label>
              <select name="accepts_po" id="accepts_po" required>
                <option value="">Select...</option>
                <option value="Acceptable">Acceptable</option>
                <option value="Unacceptable">Unacceptable</option>
              </select>
            </div>
          </div>
          
          <!-- Government Backed PO Information -->
          <div style="margin-top:16px; padding:16px; background:#dbeafe; border-left:4px solid #3b82f6; border-radius:8px;">
            <div style="display:flex; align-items:start; gap:12px;">
              <div style="font-size:24px; line-height:1;">‚ÑπÔ∏è</div>
              <div>
                <h4 style="margin:0 0 12px 0; color:#1e40af; font-size:1.1rem;">Government Backed Purchase Order (PO)</h4>
                <p style="margin:0 0 12px 0; color:#1e3a8a; line-height:1.6; font-size:0.95rem;">
                  <strong>By selecting "Acceptable"</strong>, the hotel agrees <strong>not to request a direct bill application process</strong>. 
                  Government-backed purchase orders provide guaranteed payment through the federal government, eliminating the need for traditional credit applications.
                </p>
                <p style="margin:0; color:#1e3a8a; line-height:1.6; font-size:0.95rem;">
                  There are multiple reasons for this policy. Please review the <strong>FAQ</strong> for more details or ask the <strong>FEDEVENT AI Assistant</strong> for clarification.
                </p>
              </div>
            </div>
          </div>
          
          <div class="row" style="margin-top:16px;">
            <div class="col-6"><label>Attrition Policy</label><input name="attrition_policy" /><div class="hint"><strong>Decision Note:</strong> No attrition is prioritized.</div></div>
            <div class="col-6"><label>Cancellation Policy</label><input name="cancellation_policy" /><div class="hint"><strong>Decision Note:</strong> No cancellation penalties are favored.</div></div>
            <div class="col-12">
              <div class="inline"><input id="terms_ack" type="checkbox" required />
                <label for="terms_ack" style="font-weight:500">I acknowledge that <strong>NET30</strong> is required and that the Government Purchase Order (<strong>PO</strong>) is issued to <strong>Creata Global Event Agency LLC</strong> as the <strong>prime contractor</strong>; the hotel acts as a <strong>subcontractor</strong>. The hotel name will <strong>not</strong> appear on the PO.</label>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Logistics, Security & Accessibility</legend>
          <div class="row">
            <div class="col-4"><label>On-Site Kitchen</label><select name="onsite_kitchen"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Outside Catering Allowed</label><select name="outside_catering"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Special Diets</label><input name="special_diets" placeholder="Halal, Kosher, Vegan, etc." /></div>
            <div class="col-6"><label>F&amp;B Minimums</label><input name="fb_minimums" placeholder="e.g., $15,000/day in ballroom" /></div>
            <div class="col-6"><label>Liquor License</label><select name="liquor_license"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Bus / Motorcoach Parking</label><input name="bus_parking" /></div>
            <div class="col-4"><label>Loading Dock / Freight Elevator</label><input name="freight" /></div>
            <div class="col-4"><label>Security</label><input name="security" /></div>
            <div class="col-4"><label>ADA Features</label><input name="ada_features" /></div>
            <div class="col-4"><label>EV Chargers (qty/type)</label><input name="ev_chargers" /></div>
            <div class="col-4">
              <label>Childcare via Third-Party? <span class="required">*</span></label>
              <select name="childcare_third_party" required><option value="">Select‚Ä¶</option><option>Yes ‚Äì Hotel arranges</option><option>Yes ‚Äì Referral list only</option><option>No</option></select>
            </div>
            <div class="col-12"><label>Childcare Provider Details</label><input name="childcare_notes" placeholder="Providers, certifications, hours, ratios" /></div>
            <div class="col-4"><label>Union Status</label><select name="union_status"><option value="">Select‚Ä¶</option><option>Union</option><option>Non-Union</option><option>Hybrid</option></select></div>
            <div class="col-12"><label>Blackout Dates</label><textarea name="blackout_dates" placeholder="List known blackout dates or citywides. "></textarea></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Uploads</legend>
          <div class="row">
            <div class="col-12">
              <label>Hotel Exterior Photo <span class="required">*</span></label>
              <input type="file" name="hotel_main_photo" id="hotel_main_photo" accept="image/jpeg,image/jpg,image/png" required />
              <div class="hint" style="margin-top:6px;">
                <strong>üì∑ Photo Requirements:</strong><br>
                ‚Ä¢ <strong>Exterior view only:</strong> Take the photo as if you're standing across from the hotel looking directly at the main entrance/facade<br>
                ‚Ä¢ <strong>One photo only:</strong> Upload your best exterior shot<br>
                ‚Ä¢ <strong>File size:</strong> Maximum 2MB (auto-optimized for quality - images over 2MB will be compressed automatically)<br>
                ‚Ä¢ <strong>Format:</strong> JPG, JPEG, or PNG<br>
                ‚Ä¢ <strong>Quality:</strong> Clear, well-lit photo showing the hotel's exterior architecture and signage
              </div>
              <div id="photo_preview" style="margin-top:10px; display:none;">
                <img id="preview_image" style="max-width:200px; max-height:150px; border-radius:8px; border:1px solid #e6ecf2;" />
                <div style="font-size:0.85rem; color:#5b6b7b; margin-top:4px;" id="photo_info"></div>
              </div>
              <input type="hidden" id="hotel_main_photo_data" name="hotel_main_photo_data" />
              <input type="hidden" id="hotel_main_photo_name" name="hotel_main_photo_name" />
              <input type="hidden" id="hotel_main_photo_size" name="hotel_main_photo_size" />
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="col-6"><label>Hotel Fact Sheet (PDF)</label><input type="file" name="fact_sheet" accept="application/pdf" /></div>
            <div class="col-6"><label>Floor Plans / Diagrams (PDF, multiple)</label><input type="file" name="floor_plans" accept="application/pdf" multiple /></div>
            <div class="col-6"><label>AV Rate Card (PDF)</label><input type="file" name="av_rate_card" accept="application/pdf" /></div>
            <div class="col-6"><label>Banquet Menus (PDF)</label><input type="file" name="banquet_menus" accept="application/pdf" /></div>
            <div class="col-6"><label>Fire/Life Safety Certificate (PDF)</label><input type="file" name="fls_certificate" accept="application/pdf" /></div>
            <div class="col-6"><label>Insurance COI (PDF)</label><input type="file" name="coi" accept="application/pdf" /></div>
            <div class="col-12"><label>Photos (JPG/PNG, multiple)</label><input type="file" name="photos" accept="image/*" multiple /></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Notes (Optional)</legend>
          <textarea name="notes" placeholder="Anything else we should know about your hotel. "></textarea>
        </fieldset>
      </div>

      <!-- PAGE 6 (Review) -->
      <div class="page" data-page="6">
        <fieldset>
          <legend>Review</legend>
          <p class="muted">Review your hotel profile information below. Use Edit to jump back to any section.</p>
          
          <div id="completionSummary" style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin:20px 0;">
            <h3 style="color:#1f2937; margin-top:0; margin-bottom:16px;">üìã Profile Summary</h3>
            <div id="summaryContent">
              <!-- Summary will be populated by JavaScript -->
            </div>
            <div style="margin-top:16px;">
              <button type="button" class="btn subtle" onclick="generateCompletionSummary()">üîÑ Refresh Summary</button>
            </div>
          </div>
          
          <div style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:12px; padding:16px; margin:20px 0;">
            <h4 style="color:#0369a1; margin-top:0; margin-bottom:12px;">‚ö†Ô∏è Important Reminders</h4>
            <ul style="color:#0369a1; margin:0; padding-left:20px;">
              <li><strong>NET30 payment terms</strong> are required for all government contracts</li>
              <li><strong>Purchase Order acceptance</strong> is mandatory</li>
              <li>Your profile will be reviewed before approval</li>
              <li>You'll receive email confirmation once submitted</li>
            </ul>
          </div>

          <!-- Account Upgrade Options -->
          <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin:20px 0;">
            <h3 style="color:#1f2937; margin-top:0; margin-bottom:16px;">üöÄ Account Upgrade Options</h3>
            <p style="color:#6b7280; margin-bottom:20px;">Start with our free Basic account. Upgrade later for enhanced features!</p>
            
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
              <!-- Basic Account -->
              <div style="background:#fff; border:2px solid #10b981; border-radius:12px; padding:20px; position:relative;">
                <div style="background:#10b981; color:#fff; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; position:absolute; top:-10px; left:20px;">CURRENT</div>
                <h4 style="color:#1f2937; margin-top:8px; margin-bottom:12px;">Basic Account</h4>
                <div style="font-size:1.5rem; font-weight:700; color:#10b981; margin-bottom:16px;">FREE</div>
                <ul style="color:#6b7280; margin:0; padding-left:20px; font-size:0.9rem;">
                  <li>Hotel profile listing</li>
                  <li>Government event matching</li>
                  <li>Standard support</li>
                  <li>Basic analytics</li>
                </ul>
              </div>

              <!-- Professional Account -->
              <div style="background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:20px; position:relative;">
                <div style="background:#f59e0b; color:#fff; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; position:absolute; top:-10px; left:20px;">COMING SOON</div>
                <h4 style="color:#1f2937; margin-top:8px; margin-bottom:12px;">Professional</h4>
                <div style="font-size:1.5rem; font-weight:700; color:#f59e0b; margin-bottom:16px;">$199/month</div>
                <div style="color:#6b7280; font-size:0.9rem; margin-bottom:16px;">
                  <p style="margin:0; font-style:italic;">Features coming soon...</p>
                </div>
                <button type="button" class="btn subtle" style="width:100%; margin-top:16px;" onclick="preOrderAccount('professional')">Pre-Order (Coming Soon)</button>
              </div>

              <!-- Enterprise Account -->
              <div style="background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:20px; position:relative;">
                <div style="background:#8b5cf6; color:#fff; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; position:absolute; top:-10px; left:20px;">COMING SOON</div>
                <h4 style="color:#1f2937; margin-top:8px; margin-bottom:12px;">Enterprise</h4>
                <div style="font-size:1.5rem; font-weight:700; color:#8b5cf6; margin-bottom:16px;">$399/month</div>
                <div style="color:#6b7280; font-size:0.9rem; margin-bottom:16px;">
                  <p style="margin:0; font-style:italic;">Features coming soon...</p>
                </div>
                <button type="button" class="btn subtle" style="width:100%; margin-top:16px;" onclick="preOrderAccount('enterprise')">Pre-Order (Coming Soon)</button>
              </div>
            </div>
            
            <div style="background:#e0f2fe; border:1px solid #b3e5fc; border-radius:8px; padding:12px; margin-top:16px;">
              <p style="color:#0277bd; margin:0; font-size:0.9rem;">
                <strong>üí° Pre-order benefits:</strong> Get early access and special pricing when these features launch!
              </p>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 7 (Submit) -->
      <div class="page" data-page="7">
        <fieldset>
          <legend>Submit</legend>
          <p class="muted">Everything looks good. Submit your profile below.</p>
        </fieldset>
      </div>

      <!-- Room template -->
      <template id="room-template">
        <div class="item room">
          <div class="row">
            <div class="col-4"><label>Room Name <span class="required">*</span></label><input name="room_name[]" required /></div>
            <div class="col-2"><label>Level</label><input name="room_level[]" /></div>
            <div class="col-3"><label>Area (sq ft)</label><input type="number" name="room_area_sqft[]" min="0" /></div>
            <div class="col-3"><label>Area (m¬≤)</label><input type="number" step="0.1" name="room_area_sqm[]" min="0" /></div>
            <div class="col-2"><label>Length (ft)</label><input type="number" step="0.1" name="room_length_ft[]" min="0" placeholder="e.g., 40" /></div>
            <div class="col-2"><label>Width (ft)</label><input type="number" step="0.1" name="room_width_ft[]" min="0" placeholder="e.g., 30" /></div>
            <div class="col-3"><label>Ceiling (ft)</label><input type="number" step="0.1" name="room_ceiling_ft[]" min="0" /></div>
            <div class="col-2"><label>Pillar-Free</label><select name="room_pillar_free[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-2"><label>Natural Light</label><select name="room_natural_light[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-2"><label>Divisible</label><select name="room_divisible[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-12" style="margin-top: 12px;">
              <h4 style="color: #374151; margin: 0 0 8px 0; font-size: 0.95rem; font-weight: 600;">Seating Capacity (Optional - Enter only what applies)</h4>
            </div>
            <div class="col-3"><label>Banquet Rounds</label><input type="number" name="cap_banquet_rounds[]" min="0" placeholder="e.g., 120" /></div>
            <div class="col-3"><label>Theater</label><input type="number" name="cap_theater[]" min="0" placeholder="e.g., 200" /></div>
            <div class="col-3"><label>Classroom</label><input type="number" name="cap_classroom[]" min="0" placeholder="e.g., 80" /></div>
            <div class="col-3"><label>U-Shape</label><input type="number" name="cap_ushape[]" min="0" placeholder="e.g., 24" /></div>
            <div class="col-3"><label>Cocktail Rounds</label><input type="number" name="cap_cocktail_rounds[]" min="0" placeholder="e.g., 150" /></div>
            <div class="col-3"><label>Crescent Rounds</label><input type="number" name="cap_crescent_rounds[]" min="0" placeholder="e.g., 100" /></div>
            <div class="col-3"><label>Hollow Square</label><input type="number" name="cap_hollow_square[]" min="0" placeholder="e.g., 32" /></div>
            <div class="col-3"><label></label><div style="height: 40px;"></div></div>
            <div class="col-4"><label>Built-in A/V</label><input name="room_built_in_av[]" /></div>
            <div class="col-4"><label>Power (closest)</label><input name="room_power[]" /></div>
            <div class="col-4"><label>Load-in Door</label><input name="room_loadin[]" /></div>
            <div class="col-12 right"><button class="btn danger remove-room" type="button">Remove Room</button></div>
          </div>
        </div>
      </template>

      <!-- Wizard nav -->
      <div class="hr"></div>
      <div class="nav" id="wizardNav">
        <button type="button" class="btn subtle" id="backBtn">‚Üê Back</button>
        <div class="hint" id="navHint">Submit is enabled only when NET30 and PO acceptance are set to Yes.</div>
        <div class="hint" id="guestHint" style="display:none; color:#059669; font-weight:500;">Guest Mode: You can navigate freely between pages without filling required fields.</div>
        <div class="inline">
          <button type="button" class="btn subtle" id="saveDraftBtn" onclick="simpleSave();" style="display:inline-block;">üíæ Save Draft</button>
          <button type="button" class="btn" id="nextBtn" onclick="handleNextClick()">Next ‚Üí</button>
          <button class="btn" id="submitBtn" type="submit" disabled>
            <span class="btn-label">Submit Profile</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- overlays -->
<div class="submitting" id="submitting"><div class="panel"><div class="loader"></div><div><div style="font-weight:700;color:#0b2545">Working‚Ä¶</div><div class="hint">Please wait. Don't close this page.</div></div></div></div>
<div class="toast" id="toast"></div>
<div class="submitting" id="thanks"><div class="panel" style="flex-direction:column;align-items:flex-start">
  <div style="font-size:1.1rem;font-weight:700;color:#0b2545;margin-bottom:6px">Thank you ‚Äî profile submitted!</div>
  <div id="thanksId" class="hint" style="margin-bottom:10px"></div>
  <div><button class="btn" id="submitAnother">Submit Another Hotel</button></div>
</div></div>
<script>
  // Route prefix for your localRouter
  const API_BASE = '';

  let form, pages, backBtn, nextBtn, submitBtn, navHint;

  let addRoomBtn, rooms, isExtendedStay, acceptsNet30, hasOutdoorFacility, isAaaRated, hotelLocationType;
  // Rooms & Suites state
  let rsState = {
    sleeping: {
      items: [] // { type: 'Single Occupancy'|'Double Occupancy', rooms, real_beds: 1|2, sofa_bed: '0'|'1'|'2'...'200' }
    },
    ada: {
      primary: { rooms: 0, real_beds: 0, sofa_beds: 0 },
      backup: { rooms: 0, real_beds: 0, sofa_beds: 0 }
    },
    suites: {
      has_suites: false,
      items: [] // { type, rooms, real_beds, sofa_beds }
    },
    totals: { sleeping_rooms: 0, ada_rooms: 0, suites_rooms: 0, all_rooms: 0 },
    editMode: { sleeping: true, ada: true, suites: true }
  };

  function rsClampInt(val) {
    const n = parseInt(val, 10);
    if (isNaN(n) || n < 0) return 0;
    return Math.floor(n);
  }

  function rsComputeTotals() {
    const sleepingTotal = (rsState.sleeping.items || []).reduce((s, it) => s + rsClampInt(it.rooms), 0);
    const adaTotal = rsClampInt(rsState.ada.primary.rooms) + rsClampInt(rsState.ada.backup.rooms);
    const suitesTotal = rsState.suites.has_suites ? rsState.suites.items.reduce((s, it) => s + rsClampInt(it.rooms), 0) : 0;
    rsState.totals.sleeping_rooms = sleepingTotal;
    rsState.totals.ada_rooms = adaTotal;
    rsState.totals.suites_rooms = suitesTotal;
    rsState.totals.all_rooms = sleepingTotal + adaTotal + suitesTotal;
  }

  function rsSyncLegacyInputs() {
    // Map to existing inputs so backend stays compatible
    const totalRoomsInput = document.getElementById('total_rooms');
    const kingRoomsInput = document.getElementById('king_rooms');
    const doubleRoomsInput = document.getElementById('double_rooms');
    const hasSuitesSelect = document.getElementById('has_suites');
    if (totalRoomsInput) totalRoomsInput.value = rsState.totals.all_rooms;
    // Map sleeping items to legacy single/double quantities
    const singleQty = (rsState.sleeping.items || []).filter(it => it.type === 'Single Occupancy').reduce((s, it) => s + rsClampInt(it.rooms), 0);
    const doubleQty = (rsState.sleeping.items || []).filter(it => it.type === 'Double Occupancy').reduce((s, it) => s + rsClampInt(it.rooms), 0);
    if (kingRoomsInput) kingRoomsInput.value = singleQty;
    if (doubleRoomsInput) doubleRoomsInput.value = doubleQty;
    if (hasSuitesSelect) hasSuitesSelect.value = rsState.suites.has_suites ? 'Yes' : 'No';

    // Also keep ADA and suites dynamic sections consistent if backend reads them
    const suitesContainer = document.getElementById('suites_container');
    const adaRoomsContainer = document.getElementById('ada_rooms_container');
    if (suitesContainer) {
      suitesContainer.innerHTML = '';
      if (rsState.suites.has_suites) {
        rsState.suites.items.forEach((it, idx) => {
          const row = document.createElement('div');
          row.className = 'suite-entry-row';
          row.innerHTML = `
            <input type="hidden" name="suite_type_${idx}" value="${it.type}" />
            <input type="hidden" name="suite_quantity_${idx}" value="${rsClampInt(it.rooms)}" />
            <input type="hidden" name="suite_beds_${idx}" value="${rsClampInt(it.real_beds)}" />
            <input type="hidden" name="suite_sofa_bed_${idx}" value="${it.sofa_beds || '0'}" />
            <input type="hidden" name="suite_notes_${idx}" value="${(it.notes || '').replace(/"/g,'&quot;')}" />`;
          suitesContainer.appendChild(row);
        });
      }
    }
    if (adaRoomsContainer) {
      adaRoomsContainer.innerHTML = '';
      const rows = [
        { type: 'Primary', data: rsState.ada.primary },
        { type: 'Backup', data: rsState.ada.backup }
      ];
      rows.forEach((rowData, idx) => {
        if (rsClampInt(rowData.data.rooms) === 0 && rsClampInt(rowData.data.real_beds) === 0 && rsClampInt(rowData.data.sofa_beds) === 0) return;
        const row = document.createElement('div');
        row.innerHTML = `
          <input type="hidden" name="ada_room_type_${idx}" value="${rowData.type}" />
          <input type="hidden" name="ada_room_quantity_${idx}" value="${rsClampInt(rowData.data.rooms)}" />
          <input type="hidden" name="ada_room_beds_${idx}" value="${rsClampInt(rowData.data.real_beds)}" />
          <input type="hidden" name="ada_room_sofa_bed_${idx}" value="${rsClampInt(rowData.data.sofa_beds)}" />`;
        adaRoomsContainer.appendChild(row);
      });
      const adaRoomsTotalCount = document.getElementById('ada_rooms_total_count');
      if (adaRoomsTotalCount) adaRoomsTotalCount.textContent = String(rsState.totals.ada_rooms);
    }
  }

  function rsRender() {
    rsComputeTotals();
    // Labels
    const sleepingTotalEl = document.getElementById('rs-sleeping-total');
    const adaTotalEl = document.getElementById('rs-ada-total');
    const suitesTotalEl = document.getElementById('rs-suites-total');
    const grandEl = document.getElementById('rs-grand-total');
    const hasSuitesLabel = document.getElementById('rs-has-suites-label');
    if (sleepingTotalEl) sleepingTotalEl.textContent = String(rsState.totals.sleeping_rooms);
    if (adaTotalEl) adaTotalEl.textContent = String(rsState.totals.ada_rooms);
    if (suitesTotalEl) suitesTotalEl.textContent = String(rsState.totals.suites_rooms);
    if (grandEl) grandEl.textContent = String(rsState.totals.all_rooms);
    if (hasSuitesLabel) hasSuitesLabel.textContent = rsState.suites.has_suites ? 'Yes' : 'No';

    // Sleeping table
    const sleepingRoot = document.getElementById('rs-sleeping-table');
    if (sleepingRoot) sleepingRoot.innerHTML = rsRenderSleeping();
    // ADA table
    const adaRoot = document.getElementById('rs-ada-table');
    if (adaRoot) adaRoot.innerHTML = rsRenderAda();
    // Suites table
    const suitesRoot = document.getElementById('rs-suites-table');
    if (suitesRoot) suitesRoot.innerHTML = rsRenderSuites();

    rsSyncLegacyInputs();
    const aria = document.getElementById('rs-aria');
    if (aria) aria.textContent = `Totals updated. Sleeping ${rsState.totals.sleeping_rooms}, ADA ${rsState.totals.ada_rooms}, Suites ${rsState.totals.suites_rooms}, All ${rsState.totals.all_rooms}.`;

    rsBindInteractiveHandlers();
  }

  function rsRenderHeader(columns) {
    return `
      <div style="display:grid; grid-template-columns:${columns}; gap:8px; padding:6px 0; border-bottom:1px solid #e5e7eb; font-weight:600;">
        <div style="text-align:left;">Category</div>
        <div style="text-align:right;">Quantity</div>
        <div style="text-align:right;">Real Beds</div>
        <div style="text-align:right;">Sofa Beds</div>
      </div>`;
  }

  function rsNumericCell(value, path) {
    if (!path) return `<div style="text-align:right;">${value}</div>`;
    return `
      <div style="text-align:right;">
        <input type="number" min="0" step="1" value="${value}" data-rs-path="${path}" style="width:100%; text-align:right;" />
        <div class="rs-error" style="display:none; color:#dc2626; font-size:0.8rem; margin-top:2px;"></div>
      </div>`;
  }

  function rsBedsCell(value, path) {
    // Real beds: integer 0..2
    const v = Math.max(0, Math.min(2, rsClampInt(value)));
    if (!path) return `<div style="text-align:right;">${v}</div>`;
    return `
      <div style="text-align:right;">
        <input type="number" min="0" max="2" step="1" value="${v}" data-rs-path="${path}" style="width:100%; text-align:right;" />
        <div class="rs-error" style="display:none; color:#dc2626; font-size:0.8rem; margin-top:2px;"></div>
      </div>`;
  }

  function rsSofaCell(value, path) {
    // Sofa bed: count from 0-200
    const count = rsClampInt(value) || 0;
    if (!path) return `<div style="text-align:right;">${count}</div>`;
    
    // Generate options from 0 to 200
    let options = '<option value="0">0</option>';
    for (let i = 1; i <= 200; i++) {
      options += `<option value="${i}" ${count === i ? 'selected' : ''}>${i}</option>`;
    }
    
    return `
      <div style="text-align:right;">
        <select data-rs-path="${path}" style="width:100%; text-align:right;">
          ${options}
        </select>
        <div class="rs-error" style="display:none; color:#dc2626; font-size:0.8rem; margin-top:2px;"></div>
      </div>`;
  }

  function rsRenderSleeping() {
    const editing = true; // force open
    const cols = '1fr 140px 140px 140px 40px';
    const header = `
      <div style="display:grid; grid-template-columns:${cols}; gap:8px; padding:6px 0; border-bottom:1px solid #e5e7eb; font-weight:600;">
        <div style="text-align:left;">Category</div>
        <div style="text-align:right;">Quantity</div>
        <div style="text-align:right;">Real Beds</div>
        <div style="text-align:right;">Sofa Bed</div>
        <div></div>
      </div>`;
    if (!editing) {
      const rows = (rsState.sleeping.items || []).map(it => [it.type, it.rooms, it.real_beds, it.sofa_bed || '0']);
      return header + (rows.length ? rsRenderBasicTable(rows) : '<div style="padding:8px 0; color:#6b7280;">No sleeping rooms declared</div>');
    }
    const options = ['Single Occupancy','Double Occupancy'];
    const rows = (rsState.sleeping.items || []).map((it, idx) => `
      <div data-rs-sleep-row="${idx}" style="display:grid; grid-template-columns:${cols}; gap:8px; padding:8px 0; border-bottom:1px solid #f3f4f6; align-items:center;">
        <div>
          <select data-rs-path="sleeping.items.${idx}.type" style="width:100%;">
            ${options.map(o => `<option ${o===it.type?'selected':''}>${o}</option>`).join('')}
          </select>
        </div>
        <div>${rsNumericCell(it.rooms, `sleeping.items.${idx}.rooms`)}</div>
        <div>
          <select data-rs-path="sleeping.items.${idx}.real_beds" style="width:100%; text-align:right;">
            <option ${String(it.real_beds)==='1'?'selected':''}>1</option>
            <option ${String(it.real_beds)==='2'?'selected':''}>2</option>
          </select>
        </div>
        <div>
          <select data-rs-path="sleeping.items.${idx}.sofa_bed" style="width:100%;">
            <option ${it.sofa_bed==='No'?'selected':''}>No</option>
            <option ${it.sofa_bed==='Yes'?'selected':''}>Yes</option>
          </select>
        </div>
        <div style="text-align:right;"><button type="button" class="btn subtle" data-rs-remove-sleep="${idx}">‚úï</button></div>
      </div>`).join('');
    const addRow = `
      <div style="display:flex; gap:8px; margin-top:8px;">
        <select id="rs-sleep-type-new" style="flex:1;">
          <option value="">Select type‚Ä¶</option>
          ${options.map(o => `<option>${o}</option>`).join('')}
        </select>
        <input id="rs-sleep-qty-new" type="number" min="0" step="1" placeholder="Quantity" style="width:120px; text-align:right;" />
        <select id="rs-sleep-beds-new" style="width:120px;">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
        <select id="rs-sleep-sofa-new" style="width:120px;">
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>
        <button type="button" class="btn subtle" id="rs-add-sleep-row">Add Row</button>
      </div>`;
    const buttons = `
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button type="button" class="btn" id="rs-save-sleeping">Save</button>
        <button type="button" class="btn subtle" id="rs-cancel-sleeping">Cancel</button>
      </div>`;
    return header + rows + addRow + buttons;
  }

  function rsRenderAda() {
    const editing = true; // force open
    const cols = '1fr 140px 140px 140px';
    const header = rsRenderHeader(cols);
    const row = (label, key) => `
      <div style="display:grid; grid-template-columns:${cols}; gap:8px; padding:8px 0; border-bottom:1px solid #f3f4f6; align-items:center;">
        <div style="text-align:left;">${label}</div>
        ${rsNumericCell(rsState.ada[key].rooms, editing ? `ada.${key}.rooms` : null)}
        ${rsBedsCell(rsState.ada[key].real_beds, editing ? `ada.${key}.real_beds` : null)}
        ${rsSofaCell(rsState.ada[key].sofa_beds, editing ? `ada.${key}.sofa_beds` : null)}
      </div>`;
    const body = row('Single Occupancy', 'primary') + row('Double Occupancy', 'backup');
    const buttons = editing ? `
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button type="button" class="btn" id="rs-save-ada">Save</button>
        <button type="button" class="btn subtle" id="rs-cancel-ada">Cancel</button>
      </div>` : rsRenderBasicTable([
        ['ADA Primary', rsState.ada.primary.rooms, rsState.ada.primary.real_beds, rsState.ada.primary.sofa_beds],
        ['ADA Backup', rsState.ada.backup.rooms, rsState.ada.backup.real_beds, rsState.ada.backup.sofa_beds]
      ]);
    return header + body + buttons;
  }

  function rsRenderSuites() {
    const editing = true; // force open
    const cols = '1fr 140px 140px 140px';
    const header = `
      <div style="display:grid; grid-template-columns:${cols}; gap:8px; padding:6px 0; border-bottom:1px solid #e5e7eb; font-weight:600;">
        <div style="text-align:left;">Suite Type</div>
        <div style="text-align:right;">Room Count</div>
        <div style="text-align:right;">Real Beds</div>
        <div style="text-align:right;">Sofa Beds</div>
      </div>`;
    if (!editing) {
      if (!rsState.suites.has_suites || rsState.suites.items.length === 0) {
        return header + `<div style="padding:8px 0; color:#6b7280;">No suites declared</div>`;
      }
      return header + rsRenderBasicTable(rsState.suites.items.map(it => [it.type, it.rooms, it.real_beds, it.sofa_beds]));
    }

    const options = ['Studio Suite','One-Bedroom Suite','Two-Bedroom Suite'];
    const rows = rsState.suites.items.map((it, idx) => rsRenderSuiteEditRow(it, idx, options)).join('');
    const addRow = `
      <div style="display:flex; gap:8px; margin-top:8px;">
        <select id="rs-suite-type-new" style="flex:1;">
          <option value="">Select type‚Ä¶</option>
          ${options.map(o => `<option>${o}</option>`).join('')}
        </select>
        <input id="rs-suite-rooms-new" type="number" min="0" step="1" placeholder="Rooms" style="width:120px; text-align:right;" />
        <input id="rs-suite-beds-new" type="number" min="0" step="1" placeholder="Real Beds" style="width:120px; text-align:right;" />
        <input id="rs-suite-sofa-new" type="number" min="0" step="1" placeholder="Sofa Beds" style="width:120px; text-align:right;" />
        <button type="button" class="btn subtle" id="rs-add-suite-row">Add Row</button>
      </div>`;
    const toggle = `
      <div style="margin:8px 0;">
        <label style="margin-right:8px;">Has Suites?</label>
        <select id="rs-has-suites" style="width:140px;">
          <option value="No" ${!rsState.suites.has_suites ? 'selected' : ''}>No</option>
          <option value="Yes" ${rsState.suites.has_suites ? 'selected' : ''}>Yes</option>
        </select>
      </div>`;
    const buttons = `
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button type="button" class="btn" id="rs-save-suites">Save</button>
        <button type="button" class="btn subtle" id="rs-cancel-suites">Cancel</button>
      </div>`;
    return header + toggle + (rsState.suites.has_suites ? rows + addRow : '') + buttons;
  }

  function rsRenderBasicTable(rows) {
    const head = `
      <table style="width:100%; border-collapse:collapse; margin-top:6px;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #e5e7eb; padding:6px 4px;">Category</th>
            <th style="text-align:right; border-bottom:1px solid #e5e7eb; padding:6px 4px;">Quantity</th>
            <th style="text-align:right; border-bottom:1px solid #e5e7eb; padding:6px 4px;">Real Beds</th>
            <th style="text-align:right; border-bottom:1px solid #e5e7eb; padding:6px 4px;">Sofa Beds</th>
          </tr>
        </thead>
        <tbody>`;
    const body = rows.map(r => `
          <tr>
            <td style="text-align:left; border-bottom:1px solid #f3f4f6; padding:6px 4px;">${r[0]}</td>
            <td style="text-align:right; border-bottom:1px solid #f3f4f6; padding:6px 4px;">${r[1]}</td>
            <td style="text-align:right; border-bottom:1px solid #f3f4f6; padding:6px 4px;">${r[2]}</td>
            <td style="text-align:right; border-bottom:1px solid #f3f4f6; padding:6px 4px;">${r[3]}</td>
          </tr>`).join('');
    const tail = `
        </tbody>
      </table>`;
    return head + body + tail;
  }

  function rsRenderSuiteEditRow(it, idx, options) {
    return `
      <div data-rs-suite-row="${idx}" style="display:grid; grid-template-columns:1fr 140px 140px 140px 40px; gap:8px; padding:8px 0; border-bottom:1px solid #f3f4f6; align-items:center;">
        <div>
          <select data-rs-path="suites.items.${idx}.type" style="width:100%;">
            ${options.map(o => `<option ${o===it.type?'selected':''}>${o}</option>`).join('')}
          </select>
        </div>
        <div>${rsNumericCell(it.rooms, `suites.items.${idx}.rooms`)}</div>
        <div>${rsBedsCell(it.real_beds, `suites.items.${idx}.real_beds`)}</div>
        <div>${rsSofaCell(it.sofa_beds, `suites.items.${idx}.sofa_beds`)}</div>
        <div style="text-align:right;"><button type="button" class="btn subtle" data-rs-remove-suite="${idx}">‚úï</button></div>
      </div>`;
  }

  function rsBindInteractiveHandlers() {
    // Edit toggles
    const editSleeping = document.getElementById('rs-edit-sleeping');
    const editAda = document.getElementById('rs-edit-ada');
    const editSuites = document.getElementById('rs-edit-suites');
    if (editSleeping) editSleeping.onclick = () => { if (!rsAnyEditing() || rsState.editMode.sleeping) { rsState.editMode.sleeping = !rsState.editMode.sleeping; rsRender(); } };
    if (editAda) editAda.onclick = () => { if (!rsAnyEditing() || rsState.editMode.ada) { rsState.editMode.ada = !rsState.editMode.ada; rsRender(); } };
    if (editSuites) editSuites.onclick = () => { if (!rsAnyEditing() || rsState.editMode.suites) { rsState.editMode.suites = !rsState.editMode.suites; rsRender(); } };

    // Save/Cancel handlers
    const saveSleeping = document.getElementById('rs-save-sleeping');
    const cancelSleeping = document.getElementById('rs-cancel-sleeping');
    if (saveSleeping) saveSleeping.onclick = () => rsHandleSave('sleeping');
    if (cancelSleeping) cancelSleeping.onclick = () => rsHandleCancel('sleeping');

    const saveAda = document.getElementById('rs-save-ada');
    const cancelAda = document.getElementById('rs-cancel-ada');
    if (saveAda) saveAda.onclick = () => rsHandleSave('ada');
    if (cancelAda) cancelAda.onclick = () => rsHandleCancel('ada');

    const saveSuites = document.getElementById('rs-save-suites');
    const cancelSuites = document.getElementById('rs-cancel-suites');
    if (saveSuites) saveSuites.onclick = () => rsHandleSave('suites');
    if (cancelSuites) cancelSuites.onclick = () => rsHandleCancel('suites');

    const hasToggle = document.getElementById('rs-has-suites');
    if (hasToggle) hasToggle.onchange = (e) => {
      rsState.suites.has_suites = e.target.value === 'Yes';
      if (!rsState.suites.has_suites) rsState.suites.items = [];
      rsRender();
    };

    const addSuiteRowBtn = document.getElementById('rs-add-suite-row');
    if (addSuiteRowBtn) addSuiteRowBtn.onclick = () => {
      const t = document.getElementById('rs-suite-type-new').value;
      const r = rsClampInt(document.getElementById('rs-suite-rooms-new').value);
      const b = rsClampInt(document.getElementById('rs-suite-beds-new').value);
      const s = rsClampInt(document.getElementById('rs-suite-sofa-new').value);
      if (!t) return;
      rsState.suites.items.push({ type: t, rooms: r, real_beds: b, sofa_beds: s });
      rsRender();
    };

    // Inputs change updates
    document.querySelectorAll('[data-rs-path]').forEach(inp => {
      inp.oninput = () => {
        const path = inp.getAttribute('data-rs-path');
        const value = inp.type === 'number' ? rsClampInt(inp.value) : inp.value;
        rsSet(path, value);
      };
    });

    // Remove suite rows
    document.querySelectorAll('[data-rs-remove-suite]').forEach(btn => {
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute('data-rs-remove-suite'), 10);
        rsState.suites.items.splice(idx, 1);
        rsRender();
      };
    });

    // Add/remove sleeping rows
    const addSleepBtn = document.getElementById('rs-add-sleep-row');
    if (addSleepBtn) addSleepBtn.onclick = () => {
      const t = document.getElementById('rs-sleep-type-new').value;
      const q = rsClampInt(document.getElementById('rs-sleep-qty-new').value);
      const b = rsClampInt(document.getElementById('rs-sleep-beds-new').value || 1);
      const s = document.getElementById('rs-sleep-sofa-new').value || 'No';
      if (!t) return;
      rsState.sleeping.items.push({ type: t, rooms: q, real_beds: b, sofa_bed: s });
      rsRender();
    };
    document.querySelectorAll('[data-rs-remove-sleep]').forEach(btn => {
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute('data-rs-remove-sleep'), 10);
        rsState.sleeping.items.splice(idx, 1);
        rsRender();
      };
    });
  }

  function rsAnyEditing() {
    return rsState.editMode.sleeping || rsState.editMode.ada || rsState.editMode.suites;
  }

  function rsClone(obj) { return JSON.parse(JSON.stringify(obj)); }

  let rsSnapshots = { sleeping: null, ada: null, suites: null };

  function rsHandleSave(section) {
    // Validate integers >= 0
    const errors = rsValidate(section);
    if (errors.length) return;
    // Soft check: real_beds + sofa_beds >= rooms (warn only)
    if (section === 'sleeping') {
      ['single','double'].forEach(k => {
        const r = rsClampInt(rsState.sleeping[k].rooms);
        const b = rsClampInt(rsState.sleeping[k].real_beds) + rsClampInt(rsState.sleeping[k].sofa_beds);
        if (b < r) {
          // non-blocking warning beneath the last edited cell; fall back to alert
          try { showToast && showToast(`Warning: ${k} beds fewer than rooms`); } catch(e) {}
        }
      });
    } else if (section === 'ada') {
      ['primary','backup'].forEach(k => {
        const r = rsClampInt(rsState.ada[k].rooms);
        const b = rsClampInt(rsState.ada[k].real_beds) + rsClampInt(rsState.ada[k].sofa_beds);
        if (b < r) {
          try { showToast && showToast(`Warning: ADA ${k} beds fewer than rooms`); } catch(e) {}
        }
      });
    } else if (section === 'suites' && rsState.suites.has_suites) {
      rsState.suites.items.forEach(it => {
        const r = rsClampInt(it.rooms);
        const b = rsClampInt(it.real_beds) + rsClampInt(it.sofa_beds);
        if (b < r) {
          try { showToast && showToast(`Warning: ${it.type} beds fewer than rooms`); } catch(e) {}
        }
      });
    }
    rsSnapshots[section] = rsClone(rsState[section]);
    rsState.editMode[section] = false;
    rsRender();
  }

  function rsHandleCancel(section) {
    if (rsSnapshots[section]) {
      rsState[section] = rsClone(rsSnapshots[section]);
    }
    rsState.editMode[section] = false;
    rsRender();
  }

  function rsValidate(section) {
    const invalids = [];
    const sectionRoot = section === 'sleeping' ? document.getElementById('rs-sleeping-table') : section === 'ada' ? document.getElementById('rs-ada-table') : document.getElementById('rs-suites-table');
    sectionRoot?.querySelectorAll('input[type="number"]').forEach(inp => {
      const n = Number(inp.value);
      const err = inp.nextElementSibling;
      let message = '';
      if (!Number.isInteger(n) || n < 0) message = 'Enter an integer ‚â• 0';
      if (message) {
        if (err) { err.textContent = message; err.style.display = 'block'; }
        invalids.push(inp);
      } else if (err) {
        err.textContent = ''; err.style.display = 'none';
      }
    });
    return invalids;
  }

  function rsSet(path, value) {
    const parts = path.split('.');
    let ref = rsState;
    for (let i = 0; i < parts.length - 1; i++) {
      const k = parts[i];
      ref = ref[k];
    }
    ref[parts[parts.length - 1]] = typeof value === 'number' ? rsClampInt(value) : value;
    rsComputeTotals();
    rsSyncLegacyInputs();
    const grandEl = document.getElementById('rs-grand-total');
    if (grandEl) grandEl.textContent = String(rsState.totals.all_rooms);
  }

  function rsBootstrapFromLegacy() {
    // Ensure rsState exists (hard guard against race conditions)
    if (!window.rsState) {
      window.rsState = {
        sleeping: { items: [], single: { rooms: 0, real_beds: 0, sofa_bed: 'No' }, double: { rooms: 0, real_beds: 0, sofa_bed: 'No' } },
        ada: { primary: { rooms: 0, real_beds: 0, sofa_beds: 0 }, backup: { rooms: 0, real_beds: 0, sofa_beds: 0 } },
        suites: { has_suites: false, items: [] },
        totals: { sleeping_rooms: 0, ada_rooms: 0, suites_rooms: 0, all_rooms: 0 },
        editMode: { sleeping: true, ada: true, suites: true }
      };
    }
    // Ensure nested structures exist even if rsState was created elsewhere
    if (!rsState.sleeping) rsState.sleeping = { items: [] };
    if (!rsState.sleeping.single) rsState.sleeping.single = { rooms: 0, real_beds: 0, sofa_bed: 'No' };
    if (!rsState.sleeping.double) rsState.sleeping.double = { rooms: 0, real_beds: 0, sofa_bed: 'No' };
    const king = rsClampInt(document.getElementById('king_rooms')?.value || 0);
    const dbl = rsClampInt(document.getElementById('double_rooms')?.value || 0);
    const hasSuitesVal = (document.getElementById('has_suites')?.value || '').toLowerCase();
    rsState.sleeping.single.rooms = king;
    rsState.sleeping.double.rooms = dbl;
    rsState.sleeping.single.real_beds = king; // assume one real bed per single by default
    rsState.sleeping.double.real_beds = dbl * 2; // assume two real beds per double by default
    rsState.suites.has_suites = hasSuitesVal === 'yes';
    rsComputeTotals();
    rsSnapshots.sleeping = rsClone(rsState.sleeping);
    rsSnapshots.ada = rsClone(rsState.ada);
    rsSnapshots.suites = rsClone(rsState.suites);
  }
  // Initialize RS UI when Page 2 becomes visible
  document.addEventListener('DOMContentLoaded', () => {
    const page2 = document.querySelector('.page[data-page="2"]');
    if (page2) {
      rsBootstrapFromLegacy();
      // Force all editors open on initial render
      try {
        rsState.editMode.sleeping = true;
        rsState.editMode.ada = true;
        rsState.editMode.suites = true;
      } catch(_) {}
      rsRender();
      // Bootstrap sleeping section from saved JSON if present (retry to wait for autosave restore)
      (function rsBootstrapSleepingWithRetry(attempt){
        try {
          const sleepingJson = document.getElementById('sr_sleeping_json');
          console.log('üîÑ Sleeping bootstrap attempt', attempt, 'JSON value:', sleepingJson ? sleepingJson.value : 'no element');
          if (sleepingJson && sleepingJson.value){
            // Bootstrap flag removed - no longer blocking suite toggle
            const data = JSON.parse(sleepingJson.value);
            console.log('üîÑ Sleeping bootstrap data:', data);
            const setVal = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined && v !== null) el.value = v; };
            if (data.base){
              setVal('sr_single_count', data.base.single && data.base.single.rooms);
              setVal('sr_single_beds', data.base.single && data.base.single.beds);
              setVal('sr_single_sofa', data.base.single && data.base.single.sofa);
              setVal('sr_single_bed_type', data.base.single && data.base.single.bed_type);
              setVal('sr_double_count', data.base.double && data.base.double.rooms);
              setVal('sr_double_beds', data.base.double && data.base.double.beds);
              setVal('sr_double_sofa', data.base.double && data.base.double.sofa);
              setVal('sr_double_bed_type', data.base.double && data.base.double.bed_type);
              setVal('sr_ada_count', data.base.ada && data.base.ada.rooms);
              setVal('sr_ada_beds', data.base.ada && data.base.ada.beds);
              setVal('sr_ada_sofa', data.base.ada && data.base.ada.sofa);
              setVal('sr_ada_bed_type', data.base.ada && data.base.ada.bed_type);
            }
            if (Array.isArray(data.singles)) srState.singles = data.singles;
            if (Array.isArray(data.doubles)) srState.doubles = data.doubles;
            if (Array.isArray(data.adas)) srState.adas = data.adas;
            if (data.suites && Array.isArray(data.suites)) {
              console.log('üîÑ Restoring suites:', data.suites);
              srState.suites = data.suites;
              if (data.suites.length > 0) {
                const suiteToggle = byId('sr_has_suites');
                const suiteSection = byId('sr_suites_section');
                if (suiteToggle) {
                  suiteToggle.value = 'Yes';
                  console.log('üîÑ Set suite toggle to Yes');
                }
                if (suiteSection) {
                  suiteSection.style.display = '';
                  console.log('üîÑ Suite section displayed');
                }
                console.log('üîÑ Suites count:', data.suites.length);
              }
            }
            srRenderSingles();
            srRenderDoubles();
            srRenderAdas();
            srRenderSuitesRows();
            rsRender();
            srUpdateTotals();
            srSerializeIntoHidden();
            console.log('üîÑ Bootstrap completed, suite data restored');
            return;
          }
        } catch(_) {}
        if (attempt < 20) setTimeout(() => rsBootstrapSleepingWithRetry(attempt+1), 250);
      })(0);

      // Additional fallback: re-run sleeping bootstrap after autosave likely finishes restoring fields
      setTimeout(() => {
        try {
          const sleepingJson = document.getElementById('sr_sleeping_json');
          console.log('üîÑ Fallback bootstrap - JSON value:', sleepingJson ? sleepingJson.value : 'no element');
          if (!sleepingJson || !sleepingJson.value) return;
          // Bootstrap flag removed - no longer blocking suite toggle
          const data = JSON.parse(sleepingJson.value);
          console.log('üîÑ Fallback bootstrap data:', data);
          const setVal = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined && v !== null) el.value = v; };
          if (data.base){
            setVal('sr_single_count', data.base.single && data.base.single.rooms);
            setVal('sr_single_beds', data.base.single && data.base.single.beds);
            setVal('sr_single_sofa', data.base.single && data.base.single.sofa);
            setVal('sr_single_bed_type', data.base.single && data.base.single.bed_type);
            setVal('sr_double_count', data.base.double && data.base.double.rooms);
            setVal('sr_double_beds', data.base.double && data.base.double.beds);
            setVal('sr_double_sofa', data.base.double && data.base.double.sofa);
            setVal('sr_double_bed_type', data.base.double && data.base.double.bed_type);
            setVal('sr_ada_count', data.base.ada && data.base.ada.rooms);
            setVal('sr_ada_beds', data.base.ada && data.base.ada.beds);
            setVal('sr_ada_sofa', data.base.ada && data.base.ada.sofa);
            setVal('sr_ada_bed_type', data.base.ada && data.base.ada.bed_type);
          }
          if (Array.isArray(data.singles)) srState.singles = data.singles;
          if (Array.isArray(data.doubles)) srState.doubles = data.doubles;
          if (Array.isArray(data.adas)) srState.adas = data.adas;
          if (data.suites && Array.isArray(data.suites)) {
            console.log('üîÑ Fallback restoring suites:', data.suites);
            srState.suites = data.suites;
            if (data.suites.length > 0) {
              const suiteToggle = byId('sr_has_suites');
              const suiteSection = byId('sr_suites_section');
              if (suiteToggle) {
                suiteToggle.value = 'Yes';
                console.log('üîÑ Fallback set suite toggle to Yes');
              }
              if (suiteSection) {
                suiteSection.style.display = '';
                console.log('üîÑ Fallback suite section displayed');
              }
              console.log('üîÑ Fallback suites count:', data.suites.length);
            }
          }
          srRenderSingles();
          srRenderDoubles();
          srRenderAdas();
          srRenderSuitesRows();
          rsRender();
          srUpdateTotals();
          srSerializeIntoHidden();
          console.log('üîÑ Fallback bootstrap completed, suite data restored');
        } catch(_) {}
      }, 1800);

      // Bootstrap flag mechanism removed - no longer needed

      // IMMEDIATE FIX: Show suite section if suites exist
      const immediateSuiteFix = () => {
        const suiteToggle = document.getElementById('sr_has_suites');
        const suiteSection = document.getElementById('sr_suites_section');
        if (suiteToggle && suiteToggle.value === 'Yes' && suiteSection) {
          suiteSection.style.display = '';
          console.log('üîÑ IMMEDIATE: Suite section shown');
        }
      };
      
      // Run immediately and multiple times to ensure it works
      immediateSuiteFix();
      setTimeout(immediateSuiteFix, 100);
      setTimeout(immediateSuiteFix, 500);
      setTimeout(immediateSuiteFix, 1000);
      setTimeout(immediateSuiteFix, 2000);
      
      // Also run on any form change to ensure suite section stays visible
      const form = document.getElementById('hotel-form');
      if (form) {
        form.addEventListener('change', (e) => {
          if (e.target && e.target.id === 'sr_has_suites') {
            setTimeout(immediateSuiteFix, 50);
          }
        });
      }

      // Debug function for suite toggle
      window.debugSuiteToggle = () => {
        const suiteToggle = document.getElementById('sr_has_suites');
        const suiteSection = document.getElementById('sr_suites_section');
        console.log('üîç Suite Toggle Debug:', {
          toggleExists: !!suiteToggle,
          toggleValue: suiteToggle ? suiteToggle.value : 'N/A',
          sectionExists: !!suiteSection,
          sectionDisplay: suiteSection ? suiteSection.style.display : 'N/A',
          suiteCount: srState.suites ? srState.suites.length : 0
        });
        if (suiteToggle && suiteToggle.value === 'Yes' && suiteSection) {
          suiteSection.style.display = '';
          console.log('üîç Manually showing suite section');
        }
      };

      // Robust event delegation to ensure Edit/Save/Cancel remain clickable after re-renders
      const rsApp = document.getElementById('roomsSuitesApp');
      if (rsApp && !rsApp.__rsDelegated) {
        rsApp.addEventListener('click', (e) => {
          // Toggle when clicking header areas
          const header = e.target && (e.target.closest ? e.target.closest('[data-rs-toggle]') : null);
          if (header && header.getAttribute) {
            const section = header.getAttribute('data-rs-toggle');
            if (section === 'sleeping' || section === 'ada' || section === 'suites') {
              e.preventDefault();
              e.stopPropagation();
              if (!rsAnyEditing() || rsState.editMode[section]) {
                rsState.editMode[section] = !rsState.editMode[section];
                rsRender();
              }
              return;
            }
          }

          const el = e.target && (e.target.closest ? e.target.closest('button, [data-rs-remove-sleep], [data-rs-remove-suite]') : e.target);
          if (!el) return;
          const id = el.id || '';
          // Prevent accidental form submit
          e.preventDefault();
          e.stopPropagation();
          try { console.debug('[RS] Container click', id); } catch(_) {}

          if (id === 'rs-edit-sleeping') { if (!rsAnyEditing() || rsState.editMode.sleeping) { rsState.editMode.sleeping = !rsState.editMode.sleeping; rsRender(); } return; }
          if (id === 'rs-edit-ada') { if (!rsAnyEditing() || rsState.editMode.ada) { rsState.editMode.ada = !rsState.editMode.ada; rsRender(); } return; }
          if (id === 'rs-edit-suites') { if (!rsAnyEditing() || rsState.editMode.suites) { rsState.editMode.suites = !rsState.editMode.suites; rsRender(); } return; }

          if (id === 'rs-save-sleeping') { rsHandleSave('sleeping'); return; }
          if (id === 'rs-cancel-sleeping') { rsHandleCancel('sleeping'); return; }
          if (id === 'rs-save-ada') { rsHandleSave('ada'); return; }
          if (id === 'rs-cancel-ada') { rsHandleCancel('ada'); return; }
          if (id === 'rs-save-suites') { rsHandleSave('suites'); return; }
          if (id === 'rs-cancel-suites') { rsHandleCancel('suites'); return; }

          if (id === 'rs-add-sleep-row') {
            const t = (document.getElementById('rs-sleep-type-new') || {}).value;
            const q = rsClampInt((document.getElementById('rs-sleep-qty-new') || {}).value || 0);
            const b = rsClampInt((document.getElementById('rs-sleep-beds-new') || {}).value || 1);
            const s = (document.getElementById('rs-sleep-sofa-new') || {}).value || 'No';
            if (t) { rsState.sleeping.items.push({ type: t, rooms: q, real_beds: b, sofa_bed: s }); rsRender(); }
            return;
          }
          if (id === 'rs-add-suite-row') {
            const t = (document.getElementById('rs-suite-type-new') || {}).value;
            const r = rsClampInt((document.getElementById('rs-suite-rooms-new') || {}).value || 0);
            const b = rsClampInt((document.getElementById('rs-suite-beds-new') || {}).value || 0);
            const s = rsClampInt((document.getElementById('rs-suite-sofa-new') || {}).value || 0);
            if (t) { rsState.suites.items.push({ type: t, rooms: r, real_beds: b, sofa_beds: s }); rsRender(); }
            return;
          }

          if (el.hasAttribute && el.hasAttribute('data-rs-remove-sleep')) {
            const idx = parseInt(el.getAttribute('data-rs-remove-sleep') || '-1', 10);
            if (idx >= 0) { rsState.sleeping.items.splice(idx, 1); rsRender(); }
            return;
          }
          if (el.hasAttribute && el.hasAttribute('data-rs-remove-suite')) {
            const idx = parseInt(el.getAttribute('data-rs-remove-suite') || '-1', 10);
            if (idx >= 0) { rsState.suites.items.splice(idx, 1); rsRender(); }
            return;
          }
        }, true);
        // Mark delegation installed to avoid duplicate bindings
        rsApp.__rsDelegated = true;
      }

      // Failsafe global delegation in case container delegation is bypassed by reflows/replacements
      if (!window.__rsGlobalDelegated) {
        const handler = (evt) => {
          const target = evt.target;
          if (!(target instanceof HTMLElement)) return;
          const id = target.id;
          if (id === 'rs-edit-sleeping' || id === 'rs-edit-ada' || id === 'rs-edit-suites' ||
              id === 'rs-save-sleeping' || id === 'rs-cancel-sleeping' ||
              id === 'rs-save-ada' || id === 'rs-cancel-ada' ||
              id === 'rs-save-suites' || id === 'rs-cancel-suites' ||
              id === 'rs-add-sleep-row' || id === 'rs-add-suite-row' ||
              target.hasAttribute('data-rs-remove-sleep') || target.hasAttribute('data-rs-remove-suite')) {
            // Delegate to the container handler by re-dispatching a click on the container
            const app = document.getElementById('roomsSuitesApp');
            if (app) {
              // Provide debug signal
              try { console.debug('[RS] Global delegate click:', id || (target.getAttribute('data-rs-remove-sleep') ? 'remove-sleep' : 'remove-suite')); } catch(e) {}
              // Call the same logic inline
              if (id === 'rs-edit-sleeping') { if (!rsAnyEditing() || rsState.editMode.sleeping) { rsState.editMode.sleeping = !rsState.editMode.sleeping; rsRender(); } }
              if (id === 'rs-edit-ada') { if (!rsAnyEditing() || rsState.editMode.ada) { rsState.editMode.ada = !rsState.editMode.ada; rsRender(); } }
              if (id === 'rs-edit-suites') { if (!rsAnyEditing() || rsState.editMode.suites) { rsState.editMode.suites = !rsState.editMode.suites; rsRender(); } }
              if (id === 'rs-save-sleeping') rsHandleSave('sleeping');
              if (id === 'rs-cancel-sleeping') rsHandleCancel('sleeping');
              if (id === 'rs-save-ada') rsHandleSave('ada');
              if (id === 'rs-cancel-ada') rsHandleCancel('ada');
              if (id === 'rs-save-suites') rsHandleSave('suites');
              if (id === 'rs-cancel-suites') rsHandleCancel('suites');
              if (id === 'rs-add-sleep-row') {
                const t = (document.getElementById('rs-sleep-type-new') || {}).value;
                const q = rsClampInt((document.getElementById('rs-sleep-qty-new') || {}).value || 0);
                const b = rsClampInt((document.getElementById('rs-sleep-beds-new') || {}).value || 1);
                const s = (document.getElementById('rs-sleep-sofa-new') || {}).value || 'No';
                if (t) { rsState.sleeping.items.push({ type: t, rooms: q, real_beds: b, sofa_bed: s }); rsRender(); }
              }
              if (id === 'rs-add-suite-row') {
                const t = (document.getElementById('rs-suite-type-new') || {}).value;
                const r = rsClampInt((document.getElementById('rs-suite-rooms-new') || {}).value || 0);
                const b = rsClampInt((document.getElementById('rs-suite-beds-new') || {}).value || 0);
                const s = rsClampInt((document.getElementById('rs-suite-sofa-new') || {}).value || 0);
                if (t) { rsState.suites.items.push({ type: t, rooms: r, real_beds: b, sofa_beds: s }); rsRender(); }
              }
              if (target.hasAttribute('data-rs-remove-sleep')) {
                const idx = parseInt(target.getAttribute('data-rs-remove-sleep') || '-1', 10);
                if (idx >= 0) { rsState.sleeping.items.splice(idx, 1); rsRender(); }
              }
              if (target.hasAttribute('data-rs-remove-suite')) {
                const idx = parseInt(target.getAttribute('data-rs-remove-suite') || '-1', 10);
                if (idx >= 0) { rsState.suites.items.splice(idx, 1); rsRender(); }
              }
            }
          }
        };
        document.addEventListener('click', handler, true);
        window.__rsGlobalDelegated = true;
      }
    }

    // Meeting space Yes/No toggle behavior (Page 3)
    const hasMeetingSel = document.getElementById('has_meeting_space');
    const meetingTools = document.getElementById('meeting_tools');
    const meetingNoneHint = document.getElementById('meeting_none_hint');
    console.log('üè¢ Meeting space dropdown found:', !!hasMeetingSel);
    console.log('üè¢ Meeting tools div found:', !!meetingTools);
    if (hasMeetingSel) {
      const applyMeetingVisibility = () => {
        const yes = hasMeetingSel.value === 'Yes';
        console.log('üè¢ Meeting space visibility:', yes ? 'SHOWING' : 'HIDING');
        if (meetingTools) meetingTools.style.display = yes ? '' : 'none';
        if (meetingNoneHint) meetingNoneHint.style.display = yes ? 'none' : '';
      };
      hasMeetingSel.addEventListener('change', applyMeetingVisibility);
      // Apply initial state
      applyMeetingVisibility();
    }
  });
  let saveDraftBtn, loadDraftBtn, discardDraftBtn, draftStatus, draftInfo;

  const submitting = document.getElementById('submitting');
  const thanks = document.getElementById('thanks');
  const thanksId = document.getElementById('thanksId');
  const submitAnother = document.getElementById('submitAnother');
  const toast = document.getElementById('toast');

  

  const startRadios = Array.from(document.querySelectorAll('input[name="start_mode"]'));
  const signupBox = document.getElementById('signupBox');
  const btnSignup = document.getElementById('btnSignup');

  let current = 0, submittingFlag = false, signedIn = false, currentUserId = null, hasDraft = false, autoSaveTimeout = null, autoRestoreCompleted = false;

  // Role validation removed - no longer needed
  // ENHANCED NEXT BUTTON HANDLER WITH FIELD NAVIGATION
  window.handleNextClick = function() {
    console.log('INLINE: Next button clicked, current page:', current);
    
    // Enhanced validation - find and navigate to missing required fields
    const currentPage = document.querySelector('.page.active');
    if (!currentPage) {
      console.error('INLINE: No active page found!');
      return;
    }
    
    
    // If on Amenities page (data-page="4"), enforce per-section minimums
    try {
      const active = document.querySelector('.page.active');
      const isAmenities = active && active.getAttribute('data-page') === '4';
      if (isAmenities) {
        const validation = validateAmenitiesSections(true);
        if (!validation.ok) {
          const errMsg = 'Please meet the minimum selections per section before proceeding:\n‚Ä¢ ' + validation.errors.map(e => `${e.title}: select at least ${e.minRequired} (you selected ${e.selected})`).join('\n‚Ä¢ ');
          showToast('‚ùå ' + errMsg);
          return;
        }
      }
    } catch (_e) {}

    // Check for unfilled required fields
    if (!validateRequiredFields()) {
      return; // Stop if required fields are missing
    }
    
    // All validations passed - proceed
    console.log('INLINE: All validations passed, proceeding...');
    
    // Auto-save before moving to next page
    if (signedIn || window.signedIn) {
      handleSaveDraft('auto-next');
    }
    
    // Move to next page
    const totalPages = document.querySelectorAll('.page').length;
    if (current < totalPages - 1) {
      current++;
      console.log('INLINE: Moving to page', current);
      
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none';
      });
      
      // Show target page
      const targetPage = document.querySelector(`[data-page="${current}"]`);
      if (targetPage) {
        targetPage.classList.add('active');
        targetPage.style.display = 'block';
        console.log('INLINE: Page', current, 'is now active');
      }
      
      // Update navigation
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const backBtn = document.getElementById('backBtn');
      
      if (nextBtn) nextBtn.style.display = (current < totalPages - 1) ? 'inline-block' : 'none';
      if (submitBtn) submitBtn.style.display = (current === totalPages - 1) ? 'inline-block' : 'none';
      if (backBtn) backBtn.disabled = (current === 0);
      
      window.scrollTo(0, 0);
    }
  };

  // Signer role validation removed - no longer needed

  // UNFILLED FIELD VALIDATION FUNCTION
  window.validateRequiredFields = function() {
    console.log('Validating required fields...');
    
    const currentPage = document.querySelector('.page.active');
    if (!currentPage) {
      console.error('No active page found for validation!');
      return false;
    }
    
    const requiredFields = currentPage.querySelectorAll('[required]');
    const missingFields = [];
    
    requiredFields.forEach(field => {
      if (!field.value || !field.value.trim()) {
        // Get field label
        let fieldLabel = field.name || field.id || 'Unknown field';
        const label = document.querySelector(`label[for="${field.id}"]`) || 
                     field.closest('.form-group')?.querySelector('label');
        if (label) {
          fieldLabel = label.textContent.replace('*', '').trim();
        }
        
        missingFields.push({
          element: field,
          label: fieldLabel
        });
      }
    });
    
    if (missingFields.length > 0) {
      console.log('Missing required fields:', missingFields.map(f => f.label));
      
      // Show unfilled field notice
      showUnfilledFieldNotice(missingFields);
      return false;
    }
    
    // Custom validation for ADA rooms and suites (only on page 2 - Sleeping Rooms)
    const pageNumber = currentPage.getAttribute('data-page');
    if (pageNumber === '2') {
      // Validate ADA Rooms
      const noAdaCheckbox = document.getElementById('sr_no_ada');
      const hasAda = window.srState && window.srState.adas && window.srState.adas.length > 0;
      const noAdaChecked = noAdaCheckbox && noAdaCheckbox.checked;
      
      if (!noAdaChecked && !hasAda) {
        console.log('ADA validation failed: No ADA rooms added and "No ADA Rooms Available" not checked');
        
        // Create custom error for ADA rooms
        const adaSection = document.getElementById('sr_ada_rows')?.parentElement;
        
        if (adaSection) {
          adaSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Show error modal
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        modal.innerHTML = `
          <div style="background: white; padding: 24px; border-radius: 12px; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 16px 0; color: #dc2626;">‚ö†Ô∏è ADA Room Information Required</h3>
            <p style="margin: 0 0 16px 0; color: #374151;">
              Please either:
            </p>
            <ul style="margin: 0 0 16px 0; padding-left: 24px; color: #374151;">
              <li style="margin-bottom: 8px;"><strong>Add at least one ADA accessible room</strong> by clicking the "Add ADA Accessible Room" button, OR</li>
              <li><strong>Check "No ADA Rooms Available"</strong> if your property does not have ADA accessible rooms</li>
            </ul>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
              OK, I understand
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Highlight the ADA section
        if (noAdaCheckbox) {
          const checkboxContainer = noAdaCheckbox.closest('div[style*="background:#fef3c7"]');
          if (checkboxContainer) {
            checkboxContainer.style.border = '2px solid #dc2626';
            checkboxContainer.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
            
            setTimeout(() => {
              checkboxContainer.style.border = '1px solid #fbbf24';
              checkboxContainer.style.boxShadow = '';
            }, 3000);
          }
        }
        
        return false;
      }
      
      // Validate Suites
      const noSuitesCheckbox = document.getElementById('sr_no_suites');
      const hasSuites = window.srState && window.srState.suites && window.srState.suites.length > 0;
      const noSuitesChecked = noSuitesCheckbox && noSuitesCheckbox.checked;
      
      if (!noSuitesChecked && !hasSuites) {
        console.log('Suite validation failed: No suites added and "No Suites Available" not checked');
        
        // Create custom error for suites
        const suiteSection = document.getElementById('sr_suites_rows')?.parentElement;
        
        if (suiteSection) {
          suiteSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Show error modal
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        modal.innerHTML = `
          <div style="background: white; padding: 24px; border-radius: 12px; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 16px 0; color: #dc2626;">‚ö†Ô∏è Suite Information Required</h3>
            <p style="margin: 0 0 16px 0; color: #374151;">
              Please either:
            </p>
            <ul style="margin: 0 0 16px 0; padding-left: 24px; color: #374151;">
              <li style="margin-bottom: 8px;"><strong>Add at least one suite type</strong> by clicking the "Add Suite Type" button, OR</li>
              <li><strong>Check "No Suites Available"</strong> if your property does not have suites</li>
            </ul>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
              OK, I understand
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Highlight the suite section
        if (noSuitesCheckbox) {
          const checkboxContainer = noSuitesCheckbox.closest('div[style*="background:#fef3c7"]');
          if (checkboxContainer) {
            checkboxContainer.style.border = '2px solid #dc2626';
            checkboxContainer.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
            
            setTimeout(() => {
              checkboxContainer.style.border = '1px solid #fbbf24';
              checkboxContainer.style.boxShadow = '';
            }, 3000);
          }
        }
        
        return false;
      }
    }
    
    console.log('All required fields validation passed');
    return true;
  };

  // UNFILLED FIELD NOTICE FUNCTION
  window.showUnfilledFieldNotice = function(missingFields) {
    console.log('Showing unfilled field notice for:', missingFields.length, 'fields');
    
    // Remove any existing modal first
    const existingModal = document.getElementById('unfilledFieldModal');
    if (existingModal) existingModal.remove();
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'unfilledFieldModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;
    
    const fieldsList = missingFields.map(f => `<li>${f.label}</li>`).join('');
    
    modal.innerHTML = `
      <div style="
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        text-align: center;
      ">
        <div style="font-size: 3rem; margin-bottom: 15px;">üìù</div>
        <h3 style="color: #dc2626; margin-bottom: 15px;">UNFILLED FIELD NOTICE</h3>
        <p style="margin-bottom: 20px; line-height: 1.5;">
          <strong>Please complete the following required fields:</strong>
        </p>
        <ul style="text-align: left; margin: 15px 0; padding-left: 20px; color: #dc2626; font-weight: 600;">
          ${fieldsList}
        </ul>
        <p style="margin-top: 20px; font-size: 0.9rem; color: #666;">
          All required fields must be completed before proceeding to the next page.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <button id="goToFirstFieldBtn" style="
            background: #059669;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">Go to First Field</button>
          <button id="closeUnfilledModalBtn" style="
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">Close</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add proper event listeners
    const closeBtn = document.getElementById('closeUnfilledModalBtn');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        console.log('Closing unfilled field modal...');
        const modalToRemove = document.getElementById('unfilledFieldModal');
        if (modalToRemove) {
          modalToRemove.remove();
          console.log('Unfilled field modal removed successfully');
        }
      });
    }
    
    const goToBtn = document.getElementById('goToFirstFieldBtn');
    if (goToBtn) {
      goToBtn.addEventListener('click', function() {
        window.goToFirstMissingField();
      });
    }
    
    // Store missing fields for navigation
    window.currentMissingFields = missingFields;
  };

  // GO TO FIRST MISSING FIELD FUNCTION
  window.goToFirstMissingField = function() {
    if (window.currentMissingFields && window.currentMissingFields.length > 0) {
      const firstField = window.currentMissingFields[0].element;
      
      // Close modal properly by ID
      console.log('Closing unfilled field modal from goToFirstMissingField...');
      const modal = document.getElementById('unfilledFieldModal');
      if (modal) {
        modal.remove();
        console.log('Modal removed successfully');
      }
      
      // Scroll to and focus field
      firstField.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      setTimeout(() => {
        firstField.focus();
        
        // Highlight field
        firstField.style.border = '2px solid #dc2626';
        firstField.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
        
        // Remove highlight when user starts typing
        const removeHighlight = () => {
          firstField.style.border = '';
          firstField.style.boxShadow = '';
          firstField.removeEventListener('input', removeHighlight);
        };
        firstField.addEventListener('input', removeHighlight);
      }, 500);
    }
  };

  // ENHANCED SAVE DRAFT HANDLER - ALWAYS WORKS
  window.handleSaveDraft = function(type = 'manual') {
    console.log('üî¥ ENHANCED: Save draft called, type:', type);
    console.log('üî¥ Current user ID:', currentUserId);
    console.log('üî¥ Signed in status:', signedIn, window.signedIn);
    
    try {
      // Serialize meeting rooms data before collecting form data
      if (typeof serializeMeetingRooms === 'function') {
        serializeMeetingRooms();
        console.log('üî¥ Meeting rooms data serialized');
      }
      
      // Get all form data
      const form = document.getElementById('hotel-form');
      if (!form) {
        console.error('üî¥ ENHANCED: Form not found!');
        return false;
      }
      
      console.log('üî¥ Form found, collecting data...');
      
      const formData = new FormData(form);
      const data = {};
      
      // Convert FormData to object - capture ALL fields including empty ones
      for (const [key, value] of formData.entries()) {
        if (data[key]) {
          if (Array.isArray(data[key])) {
            data[key].push(value);
          } else {
            data[key] = [data[key], value];
          }
        } else {
          data[key] = value;
        }
      }
      
      // ALSO capture all input fields manually to ensure nothing is missed
      const allInputs = form.querySelectorAll('input, select, textarea');
      allInputs.forEach(input => {
        const name = input.name || input.id;
        if (name && !data[name]) {
          if (input.type === 'checkbox') {
            data[name] = input.checked ? input.value : '';
          } else if (input.type === 'radio') {
            if (input.checked) {
              data[name] = input.value;
            }
          } else {
            data[name] = input.value || '';
          }
        }
      });
      
      console.log('üî¥ Total fields captured:', Object.keys(data).length);
      console.log('üî¥ Form fields captured:', Object.keys(data).slice(0, 20));
      
      const draftData = {
        formData: data,
        currentStep: current,
        timestamp: new Date().toISOString(),
        userId: currentUserId || 'anonymous'
      };
      
      console.log('üî¥ Saving to localStorage...');
      console.log('üî¥ Draft data keys:', Object.keys(draftData.formData).length);
      
      // Always save to localStorage first (most reliable)
      localStorage.setItem('hotel_registration_draft', JSON.stringify(draftData));
      console.log('üî¥ Saved to hotel_registration_draft');
      
      // ALSO save with user-specific key for better reliability
      const userSpecificKey = `hotel_registration_draft_${currentUserId || 'anonymous'}`;
      localStorage.setItem(userSpecificKey, JSON.stringify(draftData));
      console.log('üî¥ Saved to user-specific key:', userSpecificKey);
      
      // ALSO save current page location
      localStorage.setItem('hotel_registration_current_page', current.toString());
      console.log('üî¥ Saved current page:', current);
      
      // ALSO save with timestamp for debugging
      localStorage.setItem('hotel_registration_last_save', new Date().toISOString());
      console.log('üî¥ Saved timestamp');
      
      // ALSO save a backup with current timestamp
      const timestampKey = `hotel_registration_backup_${Date.now()}`;
      localStorage.setItem(timestampKey, JSON.stringify(draftData));
      console.log('üî¥ Saved backup with key:', timestampKey);
      
      // Clean up old backups (keep only last 3)
      const allKeys = Object.keys(localStorage).filter(key => key.startsWith('hotel_registration_backup_'));
      if (allKeys.length > 3) {
        allKeys.sort().slice(0, -3).forEach(key => localStorage.removeItem(key));
      }
      
      console.log('ENHANCED: Draft saved to localStorage, fields:', Object.keys(data).length, 'page:', current);
      
      // Update auto-save status indicator
      updateAutoSaveStatus(type);
      
      // Update draft status display
      if (typeof updateDraftStatus === 'function') {
        updateDraftStatus();
      }
      
      // Try to save to server if user is signed in
      if ((signedIn || window.signedIn) && currentUserId) {
        console.log('üî¥ Attempting server save - userId:', currentUserId, 'fields:', Object.keys(data).length);
        saveDraftToServer(data, current).catch(err => {
          console.warn('Server save failed but localStorage succeeded:', err);
        });
      } else {
        console.log('üî¥ Skipping server save - signedIn:', signedIn || window.signedIn, 'userId:', currentUserId);
      }
      
      // Only show success toast for manual saves
      if (type === 'manual') {
        console.log('üî¥ Showing success toast for manual save');
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
        toast.textContent = '‚úÖ Draft saved successfully!';
        document.body.appendChild(toast);
        console.log('üî¥ Toast added to DOM');
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      } else {
        console.log('ENHANCED: Auto-save completed silently at', new Date().toLocaleTimeString());
        // Show brief visual feedback for auto-saves
        if (type.startsWith('auto')) {
          const miniToast = document.createElement('div');
          miniToast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-size:0.8rem; opacity:0.9;';
          miniToast.textContent = '‚úì Auto-saved';
          document.body.appendChild(miniToast);
          
          setTimeout(() => {
            if (miniToast.parentNode) miniToast.remove();
          }, 2000);
        }
      }
      
      return true;
      
    } catch (error) {
      console.error('üî¥ ENHANCED: Save draft error:', error);
      console.error('üî¥ Error details:', error.message, error.stack);
      
      if (type === 'manual') {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#dc2626; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
        toast.textContent = '‚ùå Failed to save draft';
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      return false;
    }
  };
  
  // Update auto-save status indicator
  function updateAutoSaveStatus(type) {
    const autoSaveStatus = document.getElementById('autoSaveStatus');
    const autoSaveIcon = document.getElementById('autoSaveIcon');
    
    if (autoSaveStatus) {
      const now = new Date();
      const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
      
      if (type.startsWith('auto')) {
        autoSaveStatus.textContent = `Auto-saved at ${timeString}`;
        if (autoSaveIcon) {
          autoSaveIcon.textContent = 'üîÑ'; // spinning icon
          setTimeout(() => {
            if (autoSaveIcon) autoSaveIcon.textContent = 'üíæ';
          }, 1000);
        }
      } else {
        autoSaveStatus.textContent = `Manually saved at ${timeString}`;
        if (autoSaveIcon) {
          autoSaveIcon.textContent = '‚úÖ'; // checkmark
          setTimeout(() => {
            if (autoSaveIcon) autoSaveIcon.textContent = 'üíæ';
          }, 2000);
        }
      }
    }
  }
  // AUTO-SAVE SETUP - UNIFIED COMPREHENSIVE APPROACH
  window.setupAutoSave = function() {
    console.log('üîÑ Setting up unified auto-save system');
    
    const form = document.getElementById('hotel-form');
    if (!form) {
      console.error('‚ùå Form not found for auto-save!');
      return;
    }
    
    // Prevent duplicate setup
    if (window.autoSaveInitialized) {
      console.log('‚ö†Ô∏è Auto-save already initialized, skipping duplicate setup');
      return;
    }
    window.autoSaveInitialized = true;
    
    let autoSaveTimer;
    let isAutoSaveActive = true;
    
    // Add listeners to all form inputs
    const inputs = form.querySelectorAll('input, select, textarea');
    console.log('‚úÖ Found', inputs.length, 'inputs for auto-save');
    console.log('‚úÖ Signed-in status:', signedIn || window.signedIn);
    
    // Clear any existing auto-save timers
    if (window.autoSaveTimer) clearTimeout(window.autoSaveTimer);
    if (window.inputChangeTimeout) clearTimeout(window.inputChangeTimeout);
    if (window.periodicAutoSaveInterval) clearInterval(window.periodicAutoSaveInterval);
    
    // Single unified handler for all input changes
    const unifiedAutoSaveHandler = function(e) {
      if (!isAutoSaveActive) return;
      if (!signedIn && !window.signedIn) return;
      
      // CRITICAL: Skip auto-save if form is being populated to prevent conflicts
      if (window.isPopulatingForm) {
        console.log('‚è∏Ô∏è Auto-save skipped - form is being populated');
        return;
      }
      
      const fieldName = e.target.name || e.target.id || 'unknown';
      console.log('üíæ Input changed:', fieldName, '- scheduling auto-save');
      
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        // Double-check the flag isn't stuck
        if (window.isPopulatingForm) {
          console.log('‚ö†Ô∏è isPopulatingForm still true - forcing to false');
          window.isPopulatingForm = false;
        }
        console.log('üíæ Auto-save triggered by:', fieldName);
        handleSaveDraft('auto-input');
      }, 2000); // Save 2 seconds after typing stops
    };
    
    // Attach unified handler to all inputs
    inputs.forEach((input) => {
      input.addEventListener('input', unifiedAutoSaveHandler);
      input.addEventListener('change', unifiedAutoSaveHandler);
    });
    
    // Set up periodic auto-save (every 2 minutes)
    window.periodicAutoSaveInterval = setInterval(() => {
      if ((signedIn || window.signedIn) && isAutoSaveActive) {
        console.log('‚è∞ Periodic auto-save triggered (2 min interval)');
        handleSaveDraft('auto-periodic');
      }
    }, 120000); // 2 minutes
    
    // Store reference for cleanup
    window.cleanupAutoSave = function() {
      isAutoSaveActive = false;
      clearTimeout(autoSaveTimer);
      if (window.periodicAutoSaveInterval) clearInterval(window.periodicAutoSaveInterval);
      window.autoSaveInitialized = false;
    };
    
    console.log('‚úÖ Unified auto-save system active (2s debounce + 2min periodic)');
    
    // Safeguard: Reset isPopulatingForm flag after 3 seconds if it gets stuck
    setTimeout(() => {
      if (window.isPopulatingForm) {
        console.log('‚ö†Ô∏è Safeguard: Resetting stuck isPopulatingForm flag');
        window.isPopulatingForm = false;
      }
    }, 3000);
  };

  // Enhanced auto-save that works in all scenarios
  window.ensureAutoSaveActive = function() {
    console.log('üîÑ Ensuring auto-save is active...');
    
    // Single delayed initialization (prevents duplicate setup due to flag check)
    setTimeout(() => {
      if (!window.autoSaveInitialized) {
        console.log('üîÑ Initializing auto-save system');
        setupAutoSave();
      } else {
        console.log('‚úÖ Auto-save already initialized');
      }
    }, 1000);
  };

  // Amenities helpers: select/clear all within a category and save summary
  document.addEventListener('click', function(e){
    const target = e.target;
    if (!target) return;
    if (target.classList && target.classList.contains('amenity-select-all')) {
      const name = target.getAttribute('data-target');
      if (name) {
        document.querySelectorAll('.amenity-group[data-name="' + name + '"] input[type="checkbox"]').forEach(cb => cb.checked = true);
        if (typeof handleSaveDraft === 'function') handleSaveDraft('auto-input');
      }
    }
    if (target.classList && target.classList.contains('amenity-clear-all')) {
      const name = target.getAttribute('data-target');
      if (name) {
        document.querySelectorAll('.amenity-group[data-name="' + name + '"] input[type="checkbox"]').forEach(cb => cb.checked = false);
        if (typeof handleSaveDraft === 'function') handleSaveDraft('auto-input');
      }
    }
    if (target.id === 'saveAmenitiesBtn') {
      try {
        const validation = validateAmenitiesSections(true);
        if (!validation.ok) {
          const errMsg = 'Please meet the minimum selections per section:\n‚Ä¢ ' + validation.errors.map(e => `${e.title}: select at least ${e.minRequired} (you selected ${e.selected})`).join('\n‚Ä¢ ');
          showToast('‚ùå ' + errMsg);
          return;
        }
        const selections = [];
        const groups = document.querySelectorAll('.amenity-group');
        groups.forEach(group => {
          const labelEls = group.querySelectorAll('input[type="checkbox"]:checked');
          labelEls.forEach(cb => selections.push(cb.value));
        });
        // Include per-section other notes in total count
        const otherNotes = Array.from(document.querySelectorAll('.amenities-other'))
          .map(t => (t.value || '').trim())
          .filter(v => v);
        const total = selections.length + otherNotes.length;
        const summary = selections.slice(0, 8).join(', ') + (selections.length > 8 ? ', ‚Ä¶' : '') + (otherNotes.length ? (selections.length ? '; ' : '') + 'Other: ' + otherNotes.slice(0,2).join(' | ') + (otherNotes.length > 2 ? ' ‚Ä¶' : '') : '');
        const msg = 'Amenities saved successfully' + (total ? ' (' + total + ' selected)' : '') + (summary ? "\n" + summary : '');
        showToast('‚úÖ ' + msg);
        if (typeof handleSaveDraft === 'function') handleSaveDraft('manual');
      } catch (err) {
        showToast('‚ùå Failed to save amenities');
      }
    }
  });

  // Validate amenities per section with dynamic minimums
  function validateAmenitiesSections(openFirstInvalid) {
    const sections = Array.from(document.querySelectorAll('.amenity-section'));
    const errors = [];
    sections.forEach(section => {
      const group = section.querySelector('.amenity-group');
      if (!group) return;
      const totalOptions = group.querySelectorAll('input[type="checkbox"]').length;
      const selected = group.querySelectorAll('input[type="checkbox"]:checked').length;
      let minRequired = 0;
      if (totalOptions >= 21) minRequired = 4;
      else if (totalOptions >= 14) minRequired = 3;
      else if (totalOptions >= 2) minRequired = 2; // only enforce when there are at least 2 choices

      if (minRequired > 0 && selected < minRequired) {
        const title = (section.querySelector('summary span') || {}).textContent || 'Amenities Section';
        errors.push({ section, title: title.trim(), minRequired, selected, totalOptions });
      }
    });

    if (errors.length && openFirstInvalid) {
      const first = errors[0].section;
      if (first && typeof first.open !== 'undefined') first.open = true;
      first.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    return { ok: errors.length === 0, errors };
  }

  // Initialize auto-save immediately and with delays
  ensureAutoSaveActive();
  
  // DEBUG: Add global test functions for manual testing
  window.testAutoSave = function() {
    console.log('üß™ Testing auto-save manually...');
    console.log('üß™ signedIn:', signedIn, 'window.signedIn:', window.signedIn);
    console.log('üß™ currentUserId:', currentUserId);
    console.log('üß™ sessionId:', !!localStorage.getItem('fedevent_session'));
    
    // Fill a test field
    const hotelName = document.querySelector('[name="hotel_name"]');
    if (hotelName) {
      hotelName.value = 'Test Hotel ' + Date.now();
      console.log('üß™ Set hotel name to:', hotelName.value);
      
      // Trigger auto-save
      if (typeof handleSaveDraft === 'function') {
        handleSaveDraft('manual-test');
        console.log('üß™ Called handleSaveDraft');
      } else {
        console.error('üß™ handleSaveDraft function not found!');
      }
    } else {
      console.error('üß™ Hotel name field not found!');
    }
  };
  
  window.testDraftLoad = function() {
    console.log('üß™ Testing draft load manually...');
    if (typeof loadExistingDraft === 'function') {
      loadExistingDraft();
      console.log('üß™ Called loadExistingDraft');
    } else {
      console.error('üß™ loadExistingDraft function not found!');
    }
  };
  
  window.checkLocalStorage = function() {
    console.log('üß™ Checking localStorage...');
    const keys = Object.keys(localStorage);
    console.log('üß™ All keys:', keys);
    keys.forEach(key => {
      if (key.includes('hotel') || key.includes('draft')) {
        console.log('üß™', key, ':', localStorage.getItem(key));
      }
    });
  };
  
  // Function to populate Primary Contact from user data
  function populatePrimaryContactFromUser(user) {
    if (!user) {
      console.log('‚ùå No user data to populate Primary Contact');
      return;
    }
    
    const contactName = document.querySelector('[name="primary_contact_name"]');
    const contactEmail = document.querySelector('[name="primary_contact_email"]');
    
    console.log('üîç Attempting to populate Primary Contact:', {
      nameFieldExists: !!contactName,
      emailFieldExists: !!contactEmail,
      currentNameValue: contactName?.value,
      currentEmailValue: contactEmail?.value,
      userName: user.first_name,
      userEmail: user.email
    });
    
    // Always populate if field exists, even if it has a value (to override any cleared values)
    if (contactName) {
      const fullName = user.first_name && user.last_name 
        ? `${user.first_name} ${user.last_name}` 
        : (user.first_name || user.username || '');
      if (fullName && (!contactName.value || contactName.value.trim() === '')) {
        contactName.value = fullName;
        // Mark field as user-populated to prevent clearing
        contactName.setAttribute('data-user-populated', 'true');
        console.log('‚úÖ Pre-populated Primary Contact name:', fullName);
      }
    }
    
    if (contactEmail && user.email) {
      if (!contactEmail.value || contactEmail.value.trim() === '') {
        contactEmail.value = user.email;
        // Mark field as user-populated to prevent clearing
        contactEmail.setAttribute('data-user-populated', 'true');
        console.log('‚úÖ Pre-populated Primary Contact email:', user.email);
      }
    }
  }
  // Retry population after delays to ensure fields are loaded
  function retryPopulatePrimaryContact() {
    const userData = localStorage.getItem('fedevent_user');
    if (!userData) return;
    
    try {
      const user = JSON.parse(userData);
      
      // Try immediately
      populatePrimaryContactFromUser(user);
      
      // Retry after 1000ms (after form restoration)
      setTimeout(() => {
        console.log('üîÑ Retry 1: Populating Primary Contact...');
        populatePrimaryContactFromUser(user);
      }, 1000);
      
      // Retry after 2000ms
      setTimeout(() => {
        console.log('üîÑ Retry 2: Populating Primary Contact...');
        populatePrimaryContactFromUser(user);
      }, 2000);
      
      // Retry after 4000ms
      setTimeout(() => {
        console.log('üîÑ Retry 3: Populating Primary Contact...');
        populatePrimaryContactFromUser(user);
      }, 4000);
      
      // Final retry after 6000ms
      setTimeout(() => {
        console.log('üîÑ Final retry: Populating Primary Contact...');
        populatePrimaryContactFromUser(user);
      }, 6000);
    } catch (e) {
      console.error('Error in retryPopulatePrimaryContact:', e);
    }
  }
  
  // SIMPLE TEST FUNCTIONS
  window.testSave = function() {
    console.log('üß™ Testing save...');
    simpleSave();
  };
  
  window.testPrimaryContact = function() {
    console.log('üß™ Testing Primary Contact population...');
    const userData = localStorage.getItem('fedevent_user');
    console.log('üß™ User data:', userData);
    if (userData) {
      const user = JSON.parse(userData);
      console.log('üß™ Parsed user:', user);
      populatePrimaryContactFromUser(user);
    } else {
      console.log('‚ùå No user data in localStorage');
    }
  };
  
  window.checkSavedData = function() {
    console.log('üß™ Checking what data is saved...');
    const draft = localStorage.getItem('hotel_registration_draft');
    if (draft) {
      const parsed = JSON.parse(draft);
      console.log('üß™ Total fields saved:', Object.keys(parsed.formData || {}).length);
      console.log('üß™ Field names:', Object.keys(parsed.formData || {}));
      console.log('üß™ Form data preview (first 10 fields):');
      Object.entries(parsed.formData || {}).slice(0, 10).forEach(([key, value]) => {
        console.log(`  ${key}: ${value}`);
      });
    } else {
      console.log('‚ùå No draft found in localStorage');
    }
  };
  
  window.testRestore = function() {
    console.log('üß™ Testing restore...');
    simpleRestore();
  };
  
  window.testInput = function() {
    console.log('üß™ Testing input...');
    const hotelName = document.querySelector('[name="hotel_name"]');
    if (hotelName) {
      hotelName.value = 'Test Hotel ' + Date.now();
      console.log('üß™ Set hotel name to:', hotelName.value);
    } else {
      console.error('üß™ Hotel name field not found!');
    }
  };

  // Check if user is continuing from dashboard (approved user) or editing
  async function checkContinueMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const continueMode = urlParams.get('continue');
    const editMode = urlParams.get('mode');
    const signedInParam = urlParams.get('signedIn');
    const sessionId = localStorage.getItem('fedevent_session');
    
    console.log('checkContinueMode - continueMode:', continueMode, 'editMode:', editMode, 'signedInParam:', signedInParam, 'sessionId:', !!sessionId);
    
    if ((continueMode === 'true' || editMode === 'edit' || signedInParam === 'true') && sessionId) {
      // User is approved and continuing registration - skip to page 2
      signedIn = true;
      
      // Get actual user ID from stored user data
      const userData = localStorage.getItem('fedevent_user');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          currentUserId = user.id || user.userId || user.fedevent_account_number;
          console.log('Found user ID for continue mode:', currentUserId);
        } catch (e) {
          console.error('Error parsing user data:', e);
          currentUserId = null;
        }
      } else {
        currentUserId = null;
      }
      
      // Don't set step here - let loadExistingDraft handle it
      
      // Pre-populate user info if available
      const hotelData = localStorage.getItem('fedevent_hotel');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          console.log('Pre-populating user info from stored data:', user);
          
          // Pre-populate email if available
          const emailField = document.querySelector('[name="sales_director_email"]');
          if (emailField && user.email && !emailField.value) {
            emailField.value = user.email;
            console.log('Pre-populated email:', user.email);
          }
          
          // Auto-populate first Primary Contact with user info
          populatePrimaryContactFromUser(user);
        } catch (e) {
          console.error('Error parsing user data:', e);
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) userDisplayName.textContent = 'User';
          if (userInfoDiv) userInfoDiv.style.display = 'block';
        }
      } else if (hotelData) {
        try {
          const hotel = JSON.parse(hotelData);
          const userInfoDiv = document.getElementById('userInfo');
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) {
            userDisplayName.textContent = `${hotel.name || ''} (${hotel.fedevent_account_number || 'TBD'})`;
          }
          if (userInfoDiv) {
            userInfoDiv.style.display = 'block';
          }
        } catch (e) {
          console.error('Error parsing hotel data:', e);
          const userInfoDiv = document.getElementById('userInfo');
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) userDisplayName.textContent = '';
          if (userInfoDiv) userInfoDiv.style.display = 'block';
        }
      } else {
        const userInfoDiv = document.getElementById('userInfo');
        const userDisplayName = document.getElementById('userDisplayName');
        if (userDisplayName) userDisplayName.textContent = 'Continue Registration';
        if (userInfoDiv) userInfoDiv.style.display = 'block';
      }
      
      // Removed Start step UI (account/guest and policy acceptance)
      const signupBox = document.getElementById('signupBox');
      if (signupBox) signupBox.style.display = 'none';
      const policyAcceptance = document.getElementById('policyAcceptance');
      if (policyAcceptance) policyAcceptance.style.display = 'none';
      
      // Show auto-save info (ALWAYS show for signed-in users)
      const autoSaveInfo = document.getElementById('autoSaveInfo');
      if (autoSaveInfo) {
        autoSaveInfo.style.display = 'block';
        // Update status immediately
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        if (autoSaveStatus) {
          autoSaveStatus.textContent = 'Auto-save active';
        }
      }
      
      // Show loading message
      showToast('üîÑ Loading your saved progress...');

      const draftLoaded = await loadExistingDraft();
      if (!draftLoaded) {
        console.log('No existing draft was applied by loadExistingDraft.');
      }

      const savedPage = localStorage.getItem('hotel_registration_current_page');
      if (savedPage) {
        try {
          const pageNum = parseInt(savedPage);
          if (!isNaN(pageNum) && pageNum >= 0) {
            current = pageNum;
            setActiveStep(current);
            console.log('Restored page from localStorage:', pageNum);
          }
        } catch (e) {
          console.error('Error restoring page:', e);
        }
      }
      
      // If in edit mode, load existing hotel data
      if (editMode === 'edit') {
        await loadExistingHotelData();
      }
      
      // Update navigation
      updateWizardNav();
      return true;
    }
    return false;
  }
  
  // Load existing hotel data for edit mode
  async function loadExistingHotelData() {
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) return;
      
      const response = await fetch('/api/hotel/profile', {
        headers: {
          'Authorization': `Bearer ${sessionId}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const result = await response.json();
        if (result.ok && result.hotel) {
          // Pre-populate form fields with existing hotel data
          populateHotelForm(result.hotel);
        }
      }
    } catch (error) {
      console.error('Error loading hotel data:', error);
    }
  }
  
  // Populate hotel form with existing data
  function populateHotelForm(hotel) {
    console.log('üîÑ Populating hotel form with data:', hotel);
    
    // CRITICAL: Disable auto-save during form population
    window.isPopulatingForm = true;
    
    // Hotel basic information - use name attribute selectors
    if (hotel.name) {
      const field = document.querySelector('[name="hotel_name"]');
      if (field) field.value = hotel.name;
    }
    if (hotel.email) {
      const field = document.querySelector('[name="sales_director_email"]');
      if (field) field.value = hotel.email;
    }
    if (hotel.phone) {
      const field = document.querySelector('[name="hotel_phone"]');
      if (field) field.value = hotel.phone;
    }
    if (hotel.website) {
      const field = document.querySelector('[name="website"]');
      if (field) field.value = hotel.website;
    }
    if (hotel.address) {
      const field = document.querySelector('[name="address"]');
      if (field) field.value = hotel.address;
    }
    if (hotel.city) {
      const field = document.querySelector('[name="city"]');
      if (field) field.value = hotel.city;
    }
    if (hotel.state) {
      const field = document.querySelector('[name="state"]');
      if (field) field.value = hotel.state;
    }
    if (hotel.zip) {
      const field = document.querySelector('[name="zip"]');
      if (field) field.value = hotel.zip;
    }
    if (hotel.country) {
      const field = document.querySelector('[name="country"]');
      if (field) field.value = hotel.country;
    }
    
    console.log('‚úÖ Hotel form populated successfully');
    
    // Update the page title to indicate edit mode
    const titleElement = document.querySelector('h1');
    if (titleElement) {
      titleElement.textContent = 'Update Hotel Registration';
    }
    
    // CRITICAL: Re-enable auto-save after population
    setTimeout(() => {
      window.isPopulatingForm = false;
      console.log('‚úÖ Hotel form population complete - auto-save re-enabled');
    }, 500);
  }

  function toDraftTimestamp(value) {
    if (!value) return 0;
    const parsed = Date.parse(value);
    return Number.isNaN(parsed) ? 0 : parsed;
  }

  function resolveDraftUserIds() {
    const ids = new Set();
    if (typeof currentUserId !== 'undefined' && currentUserId) {
      ids.add(currentUserId);
    }
    try {
      const storedUser = localStorage.getItem('fedevent_user');
      if (storedUser) {
        const user = JSON.parse(storedUser);
        const possibleId = user?.id || user?.userId || user?.fedevent_account_number;
        if (possibleId) {
          ids.add(possibleId);
        }
      }
    } catch (err) {
      console.warn('Failed to resolve draft user IDs:', err);
    }
    ids.add('anonymous');
    return Array.from(ids);
  }

  function getLatestLocalDraft() {
    try {
      const candidateKeys = new Set(['hotel_registration_draft']);
      resolveDraftUserIds().forEach(id => {
        candidateKeys.add(`hotel_registration_draft_${id || 'anonymous'}`);
      });
      Object.keys(localStorage).forEach((key) => {
        if (key.startsWith('hotel_registration_backup_')) {
          candidateKeys.add(key);
        }
      });

      const fallbackTimestamp = localStorage.getItem('hotel_registration_last_save');
      let latest = null;

      candidateKeys.forEach(key => {
        const raw = localStorage.getItem(key);
        if (!raw) return;
        try {
          const parsed = JSON.parse(raw);
          if (!parsed.formData || Object.keys(parsed.formData).length === 0) return;
          const timestamp = toDraftTimestamp(parsed.timestamp || parsed.updatedAt || fallbackTimestamp);
          if (!latest || timestamp > latest.timestamp) {
            latest = { key, timestamp, draft: parsed };
          }
        } catch (error) {
          console.warn('Failed to parse draft from', key, error);
        }
      });

      return latest;
    } catch (error) {
      console.error('getLatestLocalDraft error:', error);
      return null;
    }
  }

  function applyDraftToForm(draft, toastMessage) {
    if (!draft || !draft.formData || Object.keys(draft.formData).length === 0) {
      return false;
    }

    if (!currentUserId && draft.userId) {
      currentUserId = draft.userId;
    }

    setFormData(draft.formData);

    if (draft.currentStep !== undefined && draft.currentStep >= 0) {
      current = draft.currentStep;
      setActiveStep(current);
    }

    hasDraft = true;
    updateDraftStatus();

    if (toastMessage && typeof showToast === 'function') {
      try {
        showToast(toastMessage);
      } catch (toastError) {
        console.warn('Toast display failed:', toastError);
      }
    }

    autoRestoreCompleted = true;

    return true;
  }

  function persistDraftLocally(draft) {
    if (!draft || !draft.formData) return;
    const payload = {
      formData: draft.formData,
      currentStep: draft.currentStep !== undefined ? draft.currentStep : current,
      timestamp: draft.timestamp || new Date().toISOString(),
      userId: draft.userId || currentUserId || 'anonymous'
    };
    const userKey = `hotel_registration_draft_${payload.userId || 'anonymous'}`;
    localStorage.setItem('hotel_registration_draft', JSON.stringify(payload));
    localStorage.setItem(userKey, JSON.stringify(payload));
    localStorage.setItem('hotel_registration_current_page', String(payload.currentStep || current || 1));
    localStorage.setItem('hotel_registration_last_save', payload.timestamp);
  }

  function ensureCurrentUserIdFromStorage() {
    if (currentUserId) return currentUserId;
    try {
      const storedUser = localStorage.getItem('fedevent_user');
      if (storedUser) {
        const user = JSON.parse(storedUser);
        const possibleId = user?.id || user?.userId || user?.fedevent_account_number;
        if (possibleId) {
          currentUserId = possibleId;
        }
      }
    } catch (error) {
      console.warn('Failed to ensure currentUserId from storage:', error);
    }
    return currentUserId;
  }
  // Load existing draft for continuing users
  async function loadExistingDraft() {
    const latestLocal = getLatestLocalDraft();
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.log('üîÑ No session available for draft loading, trying localStorage fallback');
        return await loadFromLocalStorage(latestLocal);
      }

      const url = currentUserId ? `/api/draft/load/${currentUserId}` : '/api/draft/load';
      console.log('üîÑ Attempting to load draft from server:', url);

      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      });
      
      console.log('üîÑ Server draft response status:', response.status, response.statusText);
      
      if (!response.ok) {
        console.log('üîÑ Server returned error status:', response.status);
        return await loadFromLocalStorage(latestLocal);
      }
      
      const result = await response.json();
      console.log('üîÑ Server draft response:', result);

      if (result.ok && result.draft && result.draft.formData) {
        const localDraftUserId = latestLocal && latestLocal.draft ? (latestLocal.draft.userId || null) : null;
        const serverDraft = {
          formData: result.draft.formData,
          currentStep: result.draft.currentPage,
          timestamp: result.draft.updatedAt,
          userId: currentUserId || localDraftUserId || 'anonymous'
        };

        const serverTimestamp = toDraftTimestamp(serverDraft.timestamp);
        const localTimestamp = latestLocal ? latestLocal.timestamp : 0;

        if (latestLocal && localTimestamp > serverTimestamp) {
          console.log('‚¨ÜÔ∏è Local draft newer than server copy, using local draft.');
          applyDraftToForm(latestLocal.draft, '‚úÖ Loaded your latest local changes');
          if ((signedIn || window.signedIn) && currentUserId) {
            try {
              const localStep = latestLocal.draft.currentStep !== undefined ? latestLocal.draft.currentStep : current;
              await saveDraftToServer(latestLocal.draft.formData, localStep);
            } catch (syncError) {
              console.warn('Failed to sync newer local draft to server:', syncError);
            }
          }
          return true;
        }

        console.log('‚¨áÔ∏è Using server draft data (same or newer timestamp).');
        applyDraftToForm(serverDraft, '‚úÖ Previous draft loaded successfully');
        persistDraftLocally(serverDraft);
        return true;
      }

      console.log('‚ùå No server draft found, falling back to local storage');
      console.log('üîÑ Server response details:', {
        ok: result.ok,
        hasDraft: !!result.draft,
        hasFormData: !!(result.draft && result.draft.formData),
        responseKeys: Object.keys(result)
      });
      return await loadFromLocalStorage(latestLocal);
    } catch (error) {
      console.error('Error loading existing draft:', error);
      return await loadFromLocalStorage(latestLocal);
    }
  }
  
  // Helper function to load from localStorage
  async function loadFromLocalStorage(precomputedDraft) {
    try {
      console.log('üîÑ Attempting localStorage fallback...');
      const latest = precomputedDraft || getLatestLocalDraft();

      if (latest && applyDraftToForm(latest.draft, '‚úÖ Previous draft loaded from local storage')) {
        console.log('‚úÖ Loaded draft from local key:', latest.key, 'timestamp:', latest.timestamp);
        return true;
      }

      console.log('‚ùå No valid draft found in localStorage');
      current = 0;
      setActiveStep(0);
      console.log('loadFromLocalStorage: Set page to 0, current:', current);
      return false;
    } catch (error) {
      console.error('Error loading from localStorage:', error);
      return false;
    }
  }
  
  // Logout function
  function logout() {
    localStorage.removeItem('fedevent_session');
    localStorage.removeItem('fedevent_user');
    localStorage.removeItem('fedevent_hotel');
    window.location.href = 'hotel-login.html';
  }
  
  // Handle Hotel Portal navigation
  function handleHotelPortalClick() {
    const sessionId = localStorage.getItem('fedevent_session');
    if (sessionId) {
      // User is signed in, go to dashboard
      window.location.href = '/hotel-dashboard.html';
    } else {
      // User is not signed in, go to login
      window.location.href = '/hotel-login.html';
    }
    trackNavigationClick('Hotel Portal');
  }
  
  // Enhanced save draft with auto-save
  function saveDraft(triggerType = 'manual') {
    console.log('saveDraft called with trigger:', triggerType, 'signedIn:', signedIn, 'window.signedIn:', window.signedIn, 'current:', current);
    
    // Use either global signedIn or window.signedIn
    const isSignedIn = signedIn || window.signedIn;
    if (!isSignedIn) {
      console.log('Auto-save skipped: user not signed in');
      return;
    }
    
    try {
      const formData = getFormData();
      console.log('Form data collected:', Object.keys(formData).length, 'fields');
      
      const draftData = {
        formData: formData,
        currentStep: current,
        timestamp: new Date().toISOString(),
        userId: currentUserId
      };
      
      // Save to localStorage first (always works)
      localStorage.setItem('hotel_registration_draft', JSON.stringify(draftData));
      hasDraft = true;
      updateDraftStatus();
      
      console.log('Draft saved to localStorage successfully');
      
      // Try to save to server if user is authenticated
      if (isSignedIn && currentUserId) {
        saveDraftToServer(formData, current);
      }
      
      // Only show success toast for manual saves, not auto-saves
      if (triggerType === 'manual') {
        showToast('‚úÖ Draft saved successfully');
      } else {
        console.log('Auto-save completed silently at', new Date().toLocaleTimeString());
        // Update auto-save text to show last save time
        const autoSaveText = document.getElementById('autoSaveText');
        if (autoSaveText) {
          autoSaveText.textContent = `Last auto-saved: ${new Date().toLocaleTimeString()}`;
        }
      }
      
      console.log('Draft saved successfully at', new Date().toLocaleTimeString());
    } catch (error) {
      console.error('Draft save error:', error);
      if (triggerType === 'manual') {
        showToast('‚ùå Failed to save draft: ' + error.message);
      }
    }
  }
  
  // Save draft to server
  async function saveDraftToServer(formData, currentPage) {
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('‚ùå No session ID available for draft save');
        return;
      }
      
      console.log('üì§ Saving draft to server - userId:', currentUserId, 'page:', currentPage, 'fields:', Object.keys(formData).length);
      
      const response = await fetch('/api/draft/save', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionId}`
        },
        body: JSON.stringify({
          userId: currentUserId || null,
          formData: formData,
          currentPage: currentPage
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.warn('‚ùå Server draft save failed:', response.status, errorText);
      } else {
        const result = await response.json();
        console.log('‚úÖ Draft saved to server successfully:', result);
      }
    } catch (error) {
      console.warn('‚ùå Server draft save error:', error);
    }
  }
  
  // Auto-save every 2 minutes
  function startAutoSave() {
    if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
      if (signedIn && current > 0) {
        try {
          saveDraft('auto');
        } catch (error) {
          console.error('Auto-save error:', error);
          // Don't show toast for auto-save errors to avoid spam
        }
        startAutoSave(); // Schedule next auto-save
      }
    }, 120000); // 2 minutes (120 seconds)
  }
  // Auto-save on form input changes (debounced)
  let inputChangeTimeout = null;
  function setupAutoSaveOnInput() {
    const form = document.getElementById('hotel-form');
    if (!form) {
      console.error('Form element not found for auto-save setup! Expected ID: hotel-form');
      return;
    }
    
    console.log('Setting up auto-save on input changes for form:', form.id);
    
    // Add event listeners to all form inputs
    const inputs = form.querySelectorAll('input, select, textarea');
    console.log('Found', inputs.length, 'form inputs for auto-save');
    
    inputs.forEach((input, index) => {
      // Remove existing listeners to avoid duplicates
      input.removeEventListener('input', handleInputChange);
      input.removeEventListener('change', handleInputChange);
      
      input.addEventListener('input', handleInputChange);
      input.addEventListener('change', handleInputChange);
    });
    
    function handleInputChange(e) {
      const isSignedIn = signedIn || window.signedIn;
      console.log('ENHANCED: Input change detected:', {
        field: e.target.name || e.target.id || 'unnamed',
        value: e.target.value?.substring(0, 20) + '...',
        isSignedIn: isSignedIn
      });
      
      if (isSignedIn) {
        console.log('ENHANCED: Auto-save conditions met, scheduling save...');
        // Debounce auto-save to avoid too many saves
        if (inputChangeTimeout) clearTimeout(inputChangeTimeout);
        inputChangeTimeout = setTimeout(() => {
          console.log('ENHANCED: Executing debounced auto-save');
          saveDraft('input-change');
        }, 3000); // Save 3 seconds after user stops typing
      } else {
        console.log('ENHANCED: Auto-save skipped - not signed in');
      }
    }
    
    console.log('Auto-save input listeners set up successfully');
  }
  
  // Update draft status display
  function updateDraftStatus() {
    if (!draftStatus || !draftInfo) return;
    
    if (hasDraft) {
      try {
        const draftData = JSON.parse(localStorage.getItem('hotel_registration_draft') || '{}');
        if (draftData.timestamp) {
          const savedTime = new Date(draftData.timestamp).toLocaleString();
          draftInfo.textContent = `Last saved: ${savedTime}`;
          draftStatus.style.display = 'block';
        }
      } catch (e) {
        console.error('Error reading draft data:', e);
      }
    } else {
      draftStatus.style.display = 'none';
    }
  }
  
  // Load draft
  function loadDraft() {
    try {
      const draftData = JSON.parse(localStorage.getItem('hotel_registration_draft') || '{}');
      if (draftData.formData) {
        setFormData(draftData.formData);
        if (draftData.currentStep !== undefined) {
          current = draftData.currentStep;
          setActiveStep(current);
        }
        showToast('‚úÖ Draft loaded successfully');
        updateDraftStatus();
      }
    } catch (error) {
      showToast('‚ùå Failed to load draft: ' + error.message);
      console.error('Draft load error:', error);
    }
  }

  function showToast(msg){ 
    // Don't scroll for auto-population messages
    if (!msg.includes('auto-populat') && !msg.includes('Draft saved') && !msg.includes('Auto-save')) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    toast.textContent = msg; 
    toast.style.display = 'block'; 
    setTimeout(()=>toast.style.display='none', 2600); 
  }
  function localLogout(){
    try{
      localStorage.removeItem('fedevent_session');
      localStorage.removeItem('fedevent_user');
      localStorage.removeItem('fedevent_hotel');
    }catch(e){}
    window.location.href = '/hotel-login.html';
  }

  // Pre-order account upgrade function
  function preOrderAccount(accountType) {
    const hotelName = document.querySelector('[name="hotel_name"]')?.value || 'Your Hotel';
    const email = document.querySelector('[name="sign_contacts[0][email"]')?.value || '';
    
    const subject = `Pre-Order Interest: ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} Account`;
    const body = `Hello FEDEVENT Team,
I'm interested in pre-ordering the ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} account upgrade for my hotel.
Hotel Name: ${hotelName}
Email: ${email}
Account Type: ${accountType.charAt(0).toUpperCase() + accountType.slice(1)}

Please contact me when this feature becomes available.

Thank you!`;

    const mailtoLink = `mailto:support@fedevent.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink);
    
    // Show confirmation
    showToast(`Pre-order email opened! We'll contact you when ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} accounts are available.`);
  }
  // Add Meeting Room Function
  function addMeetingRoom() {
    console.log('üü¢ Adding new meeting room');
    
    const template = document.getElementById('room-template');
    const rooms = document.getElementById('rooms');
    
    if (!template) {
      console.error('üü¢ Room template not found!');
      return;
    }
    
    if (!rooms) {
      console.error('üü¢ Rooms container not found!');
      return;
    }
    
    const clone = template.content.cloneNode(true);
    const roomDiv = clone.querySelector('.room');
    
    // Add remove button functionality
    const removeBtn = clone.querySelector('.remove-room');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        console.log('üü¢ Removing meeting room');
        roomDiv.remove();
        
        // Serialize meeting rooms before saving
        if (typeof serializeMeetingRooms === 'function') {
          serializeMeetingRooms();
        }
        
        // Auto-save after removing room
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('room-removed');
          }, 500);
        }
      });
    }
    
    // Add auto-save listeners to room inputs
    const inputs = clone.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.addEventListener('change', function() {
        // Serialize meeting rooms before saving
        if (typeof serializeMeetingRooms === 'function') {
          serializeMeetingRooms();
        }
        
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('room-data-change');
          }, 1000);
        }
      });
    });
    
    rooms.appendChild(clone);
    
    // Focus on the room name field
    const nameInput = roomDiv.querySelector('input[name="room_name[]"]');
    if (nameInput) {
      setTimeout(() => {
        nameInput.focus();
      }, 100);
    }
    
    console.log('üü¢ Meeting room added successfully');
    
    // Setup area conversion for the new room
    setTimeout(() => {
      setupAreaConversion();
    }, 100);
    
    // Serialize meeting rooms before saving
    if (typeof serializeMeetingRooms === 'function') {
      serializeMeetingRooms();
    }
    
    // Auto-save after adding room
    if (signedIn || window.signedIn) {
      setTimeout(() => {
        handleSaveDraft('room-added');
      }, 500);
    }
  }
  
  // Area conversion function for meeting rooms
  function setupAreaConversion() {
    // Apply to existing rooms
    const existingRooms = document.querySelectorAll('.room');
    existingRooms.forEach(room => {
      const areaSqftInput = room.querySelector('input[name="room_area_sqft[]"]');
      const areaSqmInput = room.querySelector('input[name="room_area_sqm[]"]');
      
      if (areaSqftInput && areaSqmInput && !areaSqftInput.hasAttribute('data-conversion-setup')) {
        // Mark as setup to avoid duplicate listeners
        areaSqftInput.setAttribute('data-conversion-setup', 'true');
        areaSqmInput.setAttribute('data-conversion-setup', 'true');
        
        // Convert sq ft to sq m when sq ft changes
        areaSqftInput.addEventListener('input', function() {
          const sqft = parseFloat(this.value);
          if (!isNaN(sqft) && sqft > 0) {
            const sqm = sqft / 10.76;
            areaSqmInput.value = sqm.toFixed(1);
          } else if (this.value === '') {
            areaSqmInput.value = '';
          }
        });
        
        // Convert sq m to sq ft when sq m changes
        areaSqmInput.addEventListener('input', function() {
          const sqm = parseFloat(this.value);
          if (!isNaN(sqm) && sqm > 0) {
            const sqft = sqm * 10.76;
            areaSqftInput.value = Math.round(sqft);
          } else if (this.value === '') {
            areaSqftInput.value = '';
          }
        });
      }
    });
  }
  
  function updateWizardNav(){
    const last = pages.length - 1;
    nextBtn.style.display   = (current < last) ? 'inline-block' : 'none';
    // Only show submit button on final Submit page (page 7, index 7)
    submitBtn.style.display = (current === 7) ? 'inline-block' : 'none';
    backBtn.disabled        = (current === 0);
    navHint.style.visibility= (current === 7) ? 'visible' : 'hidden';
    
    // Guest mode removed
    const guestHint = document.getElementById('guestHint');
    if (guestHint) guestHint.style.display = 'none';
    
    // Show save draft button for signed-in users (except on first page)
    if (saveDraftBtn) {
      saveDraftBtn.style.display = (signedIn && current > 0) ? 'inline-block' : 'none';
    }
    
    nextBtn.disabled = false;
    
    // Update progress indicator
    updateProgressIndicator();
  }
  
  // Update step indicators
  function updateStepIndicators() {
    steps = Array.from(document.querySelectorAll('.step'));
    
    steps.forEach((step, index) => {
      // Steps are 0-indexed, but they map to pages 1-7 (skip page 0)
      const stepPageNumber = index + 1;
      const isCompleted = stepPageNumber < current;
      const isCurrent = stepPageNumber === current;

      step.classList.toggle('completed', isCompleted);
      step.classList.toggle('active', isCurrent);

      const dot = step.querySelector('.dot');
      if (!dot) return;

      if (isCompleted) {
        // Show green check for completed sections
        dot.textContent = '‚úì';
        dot.style.background = '#10b981';
        dot.style.color = '#fff';
      } else {
        // Show step number for pending sections
        dot.textContent = String(index + 1);
        dot.style.background = isCurrent ? '#0a58ca' : '#eef4ff';
        dot.style.color = isCurrent ? '#fff' : '#0a58ca';
      }
    });
  }

  function updateProgressIndicator() {
    updateStepIndicators();
  }
  function setActiveStep(i){
    console.log('üéØ setActiveStep called with i =', i, 'pages available:', pages ? pages.length : 'undefined');
    
    // Initialize pages and steps if not already done
    if (!pages || !steps) {
      console.log('üéØ Initializing pages and steps...');
      pages = Array.from(document.querySelectorAll('.page'));
      steps = Array.from(document.querySelectorAll('.step'));
      console.log('üéØ Found pages:', pages.length, 'steps:', steps.length);
    }
    
    if (!pages || !steps || pages.length === 0) {
      console.error('üéØ Pages or steps not initialized properly!', {pages: pages?.length, steps: steps?.length});
      return;
    }
    
    // Ensure i is within valid range (pages are 0-indexed: 0,1,2,3,4,5,6,7)
    if (i < 0 || i >= pages.length) {
      console.error('Invalid page index:', i, 'Valid range: 0 to', pages.length - 1);
      return;
    }
    
    current = i;
    console.log('üéØ Current page set to:', current);
    console.log('üéØ Pages array:', pages.map((p, idx) => ({ index: idx, id: p.id, classes: p.className })));
    console.log('üéØ Steps array:', steps.map((s, idx) => ({ index: idx, classes: s.className })));
    
    // Pages are 0-indexed (0,1,2,3,4,5,6,7)
    pages.forEach((p,idx)=> {
      const isActive = idx === current;
      p.classList.toggle('active', isActive);
      console.log('üéØ Page', idx, 'isActive:', isActive, 'current:', current);
      if (isActive) {
        const pageName = idx === 0 ? 'Hidden Page' : idx === 1 ? 'Company Information' : idx === 2 ? 'Sleeping Room Details' : idx === 3 ? 'Meeting Space Details' : idx === 4 ? 'Amenities' : idx === 5 ? 'Terms & Uploads' : idx === 6 ? 'Review' : idx === 7 ? 'Submit' : 'Unknown';
        console.log('üéØ Page', idx, '(' + pageName + ') set to ACTIVE');
      }
    });
    
    steps.forEach((s,idx)=> {
      const stepPageNumber = idx + 1; // Convert step index to page number (skip page 0)
      const isActive = stepPageNumber === current;
      s.classList.toggle('active', isActive);
      // Mark all previous steps as completed (green check) and make them clickable
      s.classList.toggle('completed', stepPageNumber < current);
      if (isActive) console.log('üéØ Step', idx, '(page', stepPageNumber, ') set to ACTIVE');
    });
    
    updateStepIndicators();
    updateWizardNav(); 
    
    // Generate completion summary when reaching the Review page (page 6)
    if (i === 6) {
      // Add a small delay to ensure the page is fully rendered
      setTimeout(() => {
        generateCompletionSummary();
      }, 100);
    }
    
    // Ensure Rooms & Suites editors render when arriving at Sleeping Rooms (page 2)
    if (i === 2) {
      try {
        if (!window.__rsBootstrapped && typeof rsBootstrapFromLegacy === 'function') {
          rsBootstrapFromLegacy();
          window.__rsBootstrapped = true;
        }
        if (typeof rsRender === 'function') {
          rsRender();
        }
        
        // CRITICAL: Re-render all room sections when navigating to page 2
        // This ensures that saved room data is displayed
        if (typeof srRenderSingles === 'function') {
          console.log('üîÑ Page 2: Re-rendering singles, current count:', window.srState ? window.srState.singles.length : 'N/A');
          srRenderSingles();
        }
        if (typeof srRenderDoubles === 'function') {
          console.log('üîÑ Page 2: Re-rendering doubles, current count:', window.srState ? window.srState.doubles.length : 'N/A');
          srRenderDoubles();
        }
        if (typeof srRenderAdas === 'function') {
          console.log('üîÑ Page 2: Re-rendering ADAs, current count:', window.srState ? window.srState.adas.length : 'N/A');
          srRenderAdas();
        }
        if (typeof srRenderSuitesRows === 'function') {
          console.log('üîÑ Page 2: Re-rendering suites, current count:', window.srState ? window.srState.suites.length : 'N/A');
          srRenderSuitesRows();
        }
        if (typeof srUpdateTotals === 'function') {
          srUpdateTotals();
        }
      } catch (e) {
        try { console.warn('RS init on step change failed:', e); } catch(_) {}
      }
    }
    
    window.scrollTo(0,0);
    console.log('üéØ Final state - current:', current, 'Active pages:', document.querySelectorAll('.page.active').length, 'Active steps:', document.querySelectorAll('.step.active').length);
  }
  
  function generateCompletionSummary() {
    const summaryContent = document.getElementById('summaryContent');
    if (!summaryContent) {
      console.error('Review section: summaryContent element not found');
      return;
    }
    
    const data = getFormData();
    console.log('Review section: Form data retrieved:', Object.keys(data).length, 'fields');
    
    // If no data, show a message
    if (!data || Object.keys(data).length === 0) {
      summaryContent.innerHTML = `
        <div style="text-align:center; padding:40px; color:#6b7280;">
          <h4>No data available for review</h4>
          <p>Please fill out the form sections above to see your information here.</p>
        </div>
      `;
      return;
    }
    
    // Validate all required fields and collect missing sections
    const missingFields = validateAllRequiredFields();
    
    // Display missing fields warning if any
    let missingFieldsHTML = '';
    if (missingFields.length > 0) {
      missingFieldsHTML = `
        <div style="background:#fee2e2; border:2px solid #dc2626; border-radius:12px; padding:20px; margin-bottom:20px;">
          <div style="display:flex; align-items:start; gap:12px;">
            <div style="font-size:32px; line-height:1;">‚ùå</div>
            <div style="flex:1;">
              <h3 style="color:#991b1b; margin:0 0 12px 0; font-size:1.3rem;">‚ö†Ô∏è Required Fields Missing</h3>
              <p style="color:#7f1d1d; margin:0 0 16px 0; font-size:1rem; font-weight:500;">
                Your profile is incomplete. Please complete the following required sections before submitting:
              </p>
              <div style="display:grid; gap:12px;">
                ${missingFields.map(section => `
                  <div style="background:#fff; border:1px solid #dc2626; border-radius:8px; padding:12px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                      <div style="color:#991b1b; font-weight:700; font-size:1rem; margin-bottom:4px;">
                        ${section.icon} ${section.section}
                      </div>
                      <div style="color:#7f1d1d; font-size:0.9rem;">
                        ${section.missing.join(', ')}
                      </div>
                    </div>
                    <button type="button" class="btn" onclick="console.log('üîò Edit Section clicked - navigating to page ${section.page}'); setActiveStep(${section.page}); window.scrollTo(0, 0); return false;" style="background:#dc2626; white-space:nowrap;">
                      Edit Section
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    } else {
      missingFieldsHTML = `
        <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border:3px solid #10b981; border-radius:16px; padding:32px; margin-bottom:32px; box-shadow:0 8px 24px rgba(16, 185, 129, 0.2);">
          <div style="display:flex; align-items:center; justify-content:center; gap:16px;">
            <div style="font-size:64px; line-height:1;">‚úÖ</div>
            <div style="text-align:center;">
              <h2 style="color:#065f46; margin:0 0 12px 0; font-size:2.5rem; font-weight:800;">LOOKS GOOD!</h2>
              <p style="color:#047857; margin:0; font-size:1.3rem; font-weight:600;">
                Your hotel profile is complete and ready to submit!
              </p>
              <p style="color:#059669; margin:8px 0 0 0; font-size:1rem; font-weight:500;">
                Review the details below to ensure everything is correct.
              </p>
            </div>
          </div>
        </div>
      `;
    }
    
    summaryContent.innerHTML = missingFieldsHTML;
    
    // Get sleeping room data from hidden JSON
    let sleepingData = null;
    try {
      const sleepingJson = document.getElementById('sr_sleeping_json');
      if (sleepingJson && sleepingJson.value) {
        sleepingData = JSON.parse(sleepingJson.value);
      }
    } catch (e) {
      console.log('Could not parse sleeping room data:', e);
    }
    
    // Check which sections are incomplete
    const incompleteSections = new Set(missingFields.map(s => s.section));
    
    // Add detailed summary sections
    const summary = `
      <div style="display:grid; grid-template-columns:1fr; gap:20px;">
        
        <!-- Company Information Section -->
        <div style="border:1px solid ${incompleteSections.has('Company Information') ? '#dc2626' : '#e5e7eb'}; border-radius:8px; padding:16px; background:${incompleteSections.has('Company Information') ? '#fee2e2' : '#f9fafb'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="color:#1f2937; margin:0; font-size:1.1rem;">${incompleteSections.has('Company Information') ? '‚ùå' : '‚úÖ'} üè® Company Information</h4>
            <button type="button" class="btn subtle" onclick="setActiveStep(1)" style="font-size:0.9rem;">Edit</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <p style="margin:4px 0; color:#374151;"><strong>Hotel Name:</strong> ${data.hotel_name || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Address:</strong> ${data.address || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>City:</strong> ${data.city || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>State:</strong> ${data.state || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>ZIP:</strong> ${data.zip || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Country:</strong> ${data.country || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Phone:</strong> ${data.hotel_phone || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Website:</strong> ${data.website || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Chain:</strong> ${data.chain || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Brand:</strong> ${data.brand || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Year Built:</strong> ${data.year_built || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Last Renovation:</strong> ${data.last_renovation || 'Not provided'}</p>
          </div>
        </div>
        
        <!-- Sleeping Room Details Section -->
        <div style="border:1px solid ${incompleteSections.has('Sleeping Room Details') ? '#dc2626' : '#e5e7eb'}; border-radius:8px; padding:16px; background:${incompleteSections.has('Sleeping Room Details') ? '#fee2e2' : '#f9fafb'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="color:#1f2937; margin:0; font-size:1.1rem;">${incompleteSections.has('Sleeping Room Details') ? '‚ùå' : '‚úÖ'} üõèÔ∏è Sleeping Room Details</h4>
            <button type="button" class="btn subtle" onclick="setActiveStep(2)" style="font-size:0.9rem;">Edit</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <p style="margin:4px 0; color:#374151;"><strong>Total Rooms:</strong> ${data.total_rooms || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>King Rooms:</strong> ${data.king_rooms || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Double/Queen Rooms:</strong> ${data.double_rooms || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Has Suites:</strong> ${data.has_suites || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Extended Stay:</strong> ${data.is_extended_stay || 'Not specified'}</p>
            ${sleepingData ? `
              <p style="margin:4px 0; color:#374151;"><strong>Additional Singles:</strong> ${sleepingData.singles ? sleepingData.singles.length : 0}</p>
              <p style="margin:4px 0; color:#374151;"><strong>Additional Doubles:</strong> ${sleepingData.doubles ? sleepingData.doubles.length : 0}</p>
              <p style="margin:4px 0; color:#374151;"><strong>Additional ADA:</strong> ${sleepingData.adas ? sleepingData.adas.length : 0}</p>
              <p style="margin:4px 0; color:#374151;"><strong>Suites:</strong> ${sleepingData.suites ? sleepingData.suites.length : 0}</p>
            ` : ''}
          </div>
        </div>
        
        <!-- Meeting Space Details Section -->
        <div style="border:1px solid ${incompleteSections.has('Meeting Space Details') ? '#dc2626' : '#e5e7eb'}; border-radius:8px; padding:16px; background:${incompleteSections.has('Meeting Space Details') ? '#fee2e2' : '#f9fafb'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="color:#1f2937; margin:0; font-size:1.1rem;">${incompleteSections.has('Meeting Space Details') ? '‚ùå' : '‚úÖ'} üè¢ Meeting Space Details</h4>
            <button type="button" class="btn subtle" onclick="setActiveStep(3)" style="font-size:0.9rem;">Edit</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <p style="margin:4px 0; color:#374151;"><strong>Has Meeting Space:</strong> ${data.has_meeting_space || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Meeting Rooms:</strong> ${document.querySelectorAll('.room').length}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Largest Room Capacity:</strong> ${data.largest_room_capacity || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Total Meeting Space:</strong> ${data.total_meeting_space || 'Not specified'}</p>
          </div>
        </div>
        
        <!-- Amenities Section -->
        <div style="border:1px solid ${incompleteSections.has('Amenities') ? '#dc2626' : '#e5e7eb'}; border-radius:8px; padding:16px; background:${incompleteSections.has('Amenities') ? '#fee2e2' : '#f9fafb'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="color:#1f2937; margin:0; font-size:1.1rem;">${incompleteSections.has('Amenities') ? '‚ùå' : '‚úÖ'} ‚≠ê Amenities</h4>
            <button type="button" class="btn subtle" onclick="setActiveStep(4)" style="font-size:0.9rem;">Edit</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <p style="margin:4px 0; color:#374151;"><strong>A/V In-House:</strong> ${data.av_in_house || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Pet Friendly:</strong> ${data.ext_pet_friendly || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Market/Pantry:</strong> ${data.ext_market_pantry || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Grocery Delivery:</strong> ${data.ext_grocery_delivery || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Laundry Details:</strong> ${data.ext_laundry_cost_notes || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Housekeeping Frequency:</strong> ${data.ext_housekeeping_frequency || 'Not provided'}</p>
          </div>
        </div>
        
        <!-- Terms & Uploads Section -->
        <div style="border:1px solid ${incompleteSections.has('Terms & Uploads') ? '#dc2626' : '#e5e7eb'}; border-radius:8px; padding:16px; background:${incompleteSections.has('Terms & Uploads') ? '#fee2e2' : '#f9fafb'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="color:#1f2937; margin:0; font-size:1.1rem;">${incompleteSections.has('Terms & Uploads') ? '‚ùå' : '‚úÖ'} üìã Terms & Uploads</h4>
            <button type="button" class="btn subtle" onclick="setActiveStep(5)" style="font-size:0.9rem;">Edit</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <p style="margin:4px 0; color:#374151;"><strong>Accepts NET30:</strong> ${data.accepts_net30 || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Government Backed PO:</strong> ${data.accepts_po || 'Not specified'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>AAA Rated:</strong> ${data.is_aaa_rated || 'Not specified'}</p>
            ${data.is_aaa_rated === 'Yes' ? `<p style="margin:4px 0; color:#374151;"><strong>AAA Rating:</strong> ${data.aaa_diamond_rating || 'Not specified'}</p>` : ''}
            <p style="margin:4px 0; color:#374151;"><strong>Files Uploaded:</strong> ${getFileCount()} files</p>
            <p style="margin:4px 0; color:#374151;"><strong>Terms Accepted:</strong> ${data.terms_ack ? 'Yes' : 'No'}</p>
          </div>
        </div>
        
        <!-- Key Contacts Section -->
        <div style="border:1px solid ${incompleteSections.has('Company Information') ? '#dc2626' : '#e5e7eb'}; border-radius:8px; padding:16px; background:${incompleteSections.has('Company Information') ? '#fee2e2' : '#f9fafb'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="color:#1f2937; margin:0; font-size:1.1rem;">${incompleteSections.has('Company Information') ? '‚ùå' : '‚úÖ'} üë• Key Contacts</h4>
            <button type="button" class="btn subtle" onclick="setActiveStep(1)" style="font-size:0.9rem;">Edit</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <p style="margin:4px 0; color:#374151;"><strong>Primary Contact:</strong> ${data.primary_contact_name || 'Not provided'}</p>
            <p style="margin:4px 0; color:#374151;"><strong>Primary Email:</strong> ${data.primary_contact_email || 'Not provided'}</p>
            ${data.csm_name ? `<p style="margin:4px 0; color:#374151;"><strong>CSM:</strong> ${data.csm_name}</p>` : ''}
            ${data.csm_email ? `<p style="margin:4px 0; color:#374151;"><strong>CSM Email:</strong> ${data.csm_email}</p>` : ''}
          </div>
        </div>
        
      </div>
    `;
    
    summaryContent.innerHTML += summary;
  }
  
  // Validate all required fields and return missing sections
  function validateAllRequiredFields() {
    const missingSections = [];
    const data = getFormData();
    
    // Page 1: Company Information
    const companyMissing = [];
    if (!data.hotel_name || data.hotel_name.trim() === '') companyMissing.push('Hotel Name');
    if (!data.address || data.address.trim() === '') companyMissing.push('Address');
    if (!data.city || data.city.trim() === '') companyMissing.push('City');
    if (!data.state || data.state.trim() === '') companyMissing.push('State');
    if (!data.zip || data.zip.trim() === '') companyMissing.push('ZIP Code');
    if (!data.country || data.country.trim() === '') companyMissing.push('Country');
    if (!data.hotel_phone || data.hotel_phone.trim() === '') companyMissing.push('Hotel Phone');
    if (!data.primary_contact_name || data.primary_contact_name.trim() === '') companyMissing.push('Primary Contact Name');
    if (!data.primary_contact_email || data.primary_contact_email.trim() === '') companyMissing.push('Primary Contact Email');
    
    if (companyMissing.length > 0) {
      missingSections.push({
        page: 1,
        section: 'Company Information',
        icon: 'üè®',
        missing: companyMissing
      });
    }
    
    // Page 2: Sleeping Room Details
    const sleepingMissing = [];
    if (!data.total_rooms || data.total_rooms === '' || data.total_rooms === '0') sleepingMissing.push('Total Rooms');
    
    // Check if sleeping room types are added
    try {
      const sleepingJson = document.getElementById('sr_sleeping_json');
      let hasRooms = false;
      if (sleepingJson && sleepingJson.value) {
        const sleepingData = JSON.parse(sleepingJson.value);
        const hasSingles = sleepingData.singles && sleepingData.singles.length > 0;
        const hasDoubles = sleepingData.doubles && sleepingData.doubles.length > 0;
        const hasAdas = sleepingData.adas && sleepingData.adas.length > 0;
        const hasSuites = sleepingData.suites && sleepingData.suites.length > 0;
        const noAdaChecked = document.getElementById('sr_no_ada') && document.getElementById('sr_no_ada').checked;
        const noSuitesChecked = document.getElementById('sr_no_suites') && document.getElementById('sr_no_suites').checked;
        
        if (!hasSingles) sleepingMissing.push('Single Occupancy Rooms');
        if (!hasDoubles) sleepingMissing.push('Double Occupancy Rooms');
        if (!hasAdas && !noAdaChecked) sleepingMissing.push('ADA Accessible Rooms (or check "No ADA Rooms Available")');
        if (!hasSuites && !noSuitesChecked) sleepingMissing.push('Suites (or check "No Suites Available")');
      } else {
        sleepingMissing.push('Single Occupancy Rooms', 'Double Occupancy Rooms', 'ADA Accessible Rooms', 'Suites');
      }
    } catch (e) {
      console.error('Error checking sleeping rooms:', e);
      sleepingMissing.push('Sleeping Room Information');
    }
    
    if (sleepingMissing.length > 0) {
      missingSections.push({
        page: 2,
        section: 'Sleeping Room Details',
        icon: 'üõèÔ∏è',
        missing: sleepingMissing
      });
    }
    
    // Page 3: Meeting Space Details (only if they have meeting space)
    const meetingMissing = [];
    if (data.has_meeting_space === 'Yes') {
      const meetingRooms = document.querySelectorAll('.room');
      if (meetingRooms.length === 0) {
        meetingMissing.push('At least one meeting room must be added');
      }
    }
    
    if (meetingMissing.length > 0) {
      missingSections.push({
        page: 3,
        section: 'Meeting Space Details',
        icon: 'üè¢',
        missing: meetingMissing
      });
    }
    
    // Page 4: Amenities (no required fields currently)
    
    // Page 5: Terms & Uploads
    const termsMissing = [];
    if (!data.max_group_block || data.max_group_block === '') termsMissing.push('Max Group Block');
    if (!data.cutoff_days || data.cutoff_days === '') termsMissing.push('Cutoff Days');
    if (!data.emergency_lodging_support || data.emergency_lodging_support === '') termsMissing.push('Emergency Lodging Support');
    if (!data.comp_ratio || data.comp_ratio.trim() === '') termsMissing.push('Comp Room Ratio');
    if (!data.accepts_net30 || data.accepts_net30 === '') termsMissing.push('Accepts NET30');
    if (!data.accepts_po || data.accepts_po === '') termsMissing.push('Government Backed PO');
    
    // Check for hotel main photo
    const hotelPhotoData = document.getElementById('hotel_main_photo_data');
    const hotelPhotoInput = document.getElementById('hotel_main_photo');
    const hasPhoto = (hotelPhotoData && hotelPhotoData.value) || (hotelPhotoInput && hotelPhotoInput.files && hotelPhotoInput.files.length > 0);
    if (!hasPhoto) termsMissing.push('Hotel Exterior Photo');
    
    if (termsMissing.length > 0) {
      missingSections.push({
        page: 5,
        section: 'Terms & Uploads',
        icon: 'üìã',
        missing: termsMissing
      });
    }
    
    return missingSections;
  }
  function getFileCount() {
    let count = 0;
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      if (input.files && input.files.length > 0) {
        count += input.files.length;
      }
    });
    return count;
  }

  function updateSummary() {
    const summaryContent = document.querySelector('.summary-content');
    if (!summaryContent) return;
    
    const summary = `
      <div class="summary">
        <div class="summary-files">
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">üìé File Uploads</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Files Attached:</strong> ${getFileCount()} files</p>
        </div>
      </div>
    `;
    
    summaryContent.innerHTML = summary;
  }

  function validateCurrentPage(){
    console.log('üîç Validating current page:', current);
    
    try {
      // Enhanced validation with field navigation - only validate visible required fields
      const req = pages[current].querySelectorAll('[required]');
      let firstMissingField = null;
      
      console.log('üîç Found required fields:', req.length);
      
      // Check hotel location type to determine if bank fields should be skipped
      const hotelLocationSelect = document.getElementById('hotel_location_type');
      const locationType = hotelLocationSelect ? hotelLocationSelect.value : '';
      const skipBankValidation = (locationType === 'skip' || locationType === '');
      
      for (let i=0;i<req.length;i++){ 
        const field = req[i];
        // Skip validation for fields that are in hidden sections
        const isHidden = field.closest('[style*="display: none"]') || field.closest('[style*="display:none"]');
        
        // Skip bank fields if user chose skip or no location
        const isBankField = field.name && (field.name.includes('ach_') || field.name.includes('wire_'));
        const shouldSkipField = isHidden || (isBankField && skipBankValidation);
        
        if (!shouldSkipField && !field.checkValidity()){ 
          if (!firstMissingField) {
            firstMissingField = field;
          }
        } 
      }
    
      // If there's a missing required field, navigate to it
      if (firstMissingField) {
        console.log('üîç Validation failed - navigating to field:', firstMissingField.name || firstMissingField.id);
      
      // Scroll to the missing field
      firstMissingField.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // Focus and highlight the field
      setTimeout(() => {
        firstMissingField.focus();
        
        // Add visual highlight
        firstMissingField.style.border = '2px solid #ef4444';
        firstMissingField.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        // Get field label for better guidance
        let fieldLabel = 'This field';
        const label = document.querySelector(`label[for="${firstMissingField.id}"]`);
        if (label) {
          fieldLabel = label.textContent.replace('*', '').trim();
        } else {
          const closestLabel = firstMissingField.closest('.form-group')?.querySelector('label');
          if (closestLabel) {
            fieldLabel = closestLabel.textContent.replace('*', '').trim();
          }
        }
        
        // Show validation message with field guidance
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          font-size: 1rem;
          text-align: center;
          max-width: 400px;
          border: 2px solid #fca5a5;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">‚ö†Ô∏è Required Field Missing</div>
          <div style="font-weight: 500; opacity: 0.9;">Please complete: <strong>${fieldLabel}</strong></div>
          <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.8;">Field has been highlighted below</div>
        `;
        document.body.appendChild(toast);
        
        // Remove highlight when user starts typing
        const removeHighlight = () => {
          firstMissingField.style.border = '';
          firstMissingField.style.boxShadow = '';
          if (toast.parentNode) {
            toast.remove();
          }
          firstMissingField.removeEventListener('input', removeHighlight);
          firstMissingField.removeEventListener('change', removeHighlight);
        };
        
        firstMissingField.addEventListener('input', removeHighlight);
        firstMissingField.addEventListener('change', removeHighlight);
        
        // Auto-remove toast after 5 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 5000);
        
      }, 500);
      
      return false;
    }
    
    // Step 0 removed (pre-qualification/policies handled during signup)
    
      // Enhanced validation for page 1 (Company Information)
      if (current === 1) {
        if (!validateCompanyInfo()) return false;
      }
      
      // Enhanced validation for page 2 (Sleeping Room Details)
      if (current === 2) {
        if (!validateRoomsAndSpaces()) return false;
      }
      
      // Enhanced validation for page 5 (Terms & Uploads)
      if (current === 5) {
        if (!validateTermsAndUploads()) return false;
      }
      
      console.log('üîç Validation passed for page:', current);
      return true;
      
    } catch (error) {
      console.error('üîç Validation error:', error);
      // If validation fails due to error, allow navigation to prevent page freeze
      return true;
    }
  }
  
  function validateCompanyInfo() {
    const hotelName = document.querySelector('[name="hotel_name"]');
    const address = document.querySelector('[name="address"]');
    const city = document.querySelector('[name="city"]');
    const country = document.querySelector('[name="country"]');
    const salesEmail = document.querySelector('[name="sales_director_email"]');
    const arEmail = document.querySelector('[name="ar_email"]');
    const hotelPlaceId = document.getElementById('hotel_place_id');
    
    // Helper function to navigate to field with error
    const navigateToFieldError = (field, message) => {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        field.focus();
        field.style.border = '2px solid #ef4444';
        field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 400px;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">‚ö†Ô∏è Validation Error</div>
          <div style="font-weight: 500; opacity: 0.9;">${message}</div>
        `;
        document.body.appendChild(toast);
        
        const removeHighlight = () => {
          field.style.border = '';
          field.style.boxShadow = '';
          if (toast.parentNode) toast.remove();
          field.removeEventListener('input', removeHighlight);
        };
        
        field.addEventListener('input', removeHighlight);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
      }, 500);
    };
    
    // Check for valid email formats
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (salesEmail && salesEmail.value && !emailRegex.test(salesEmail.value)) {
      navigateToFieldError(salesEmail, 'Please enter a valid sales director email address.');
      return false;
    }
    
    if (arEmail && arEmail.value && !emailRegex.test(arEmail.value)) {
      navigateToFieldError(arEmail, 'Please enter a valid A/R contact email address.');
      return false;
    }
    
    // Google Places selection is optional - only warn if hotel name is filled but no place ID
    if (hotelName && hotelName.value.trim() !== '' && hotelPlaceId && (!hotelPlaceId.value || hotelPlaceId.value.trim() === '')) {
      // Just warn, don't block progression
      console.log('Hotel name filled but no Google Places ID - this is optional');
    }
    
    // Check website format if provided
    const website = document.querySelector('[name="website"]');
    if (website && website.value && website.value.trim() !== '') {
      const urlRegex = /^https?:\/\/.+/;
      if (!urlRegex.test(website.value)) {
        navigateToFieldError(website, 'Please enter a valid website URL starting with http:// or https://');
        return false;
      }
    }
    
    
    return true;
  }
  
  // Primary contacts role validation removed - no longer needed
  function validatePrimaryContacts() {
    return true; // Always pass - role validation removed
  }
  function validateRoomsAndSpaces() {
    // Helper function to navigate to field with error
    const navigateToFieldError = (field, message) => {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        field.focus();
        field.style.border = '2px solid #ef4444';
        field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 400px;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">‚ö†Ô∏è Validation Error</div>
          <div style="font-weight: 500; opacity: 0.9;">${message}</div>
        `;
        document.body.appendChild(toast);
        
        const removeHighlight = () => {
          field.style.border = '';
          field.style.boxShadow = '';
          if (toast.parentNode) toast.remove();
          field.removeEventListener('input', removeHighlight);
        };
        
        field.addEventListener('input', removeHighlight);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
      }, 500);
    };
    
    // Validate room numbers are positive integers
    const roomFields = ['total_rooms', 'king_rooms', 'double_rooms', 'suites', 'ada_rooms', 'max_group_block'];
    
    for (const fieldName of roomFields) {
      const field = document.querySelector(`[name="${fieldName}"]`);
      if (field && field.value && (isNaN(field.value) || parseInt(field.value) < 0)) {
        const fieldLabel = fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        navigateToFieldError(field, `Please enter a valid number for ${fieldLabel}.`);
        return false;
      }
    }
    
    // Meeting room is optional during progression; encourage but do not block
    
    return true;
  }
  function validateTermsAndUploads() {
    // Helper function to navigate to field with error
    const navigateToFieldError = (field, message) => {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        field.focus();
        if (field.type !== 'checkbox') {
          field.style.border = '2px solid #ef4444';
          field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        } else {
          // For checkboxes, highlight the label
          const label = field.closest('label') || document.querySelector(`label[for="${field.id}"]`);
          if (label) {
            label.style.border = '2px solid #ef4444';
            label.style.borderRadius = '4px';
            label.style.padding = '4px';
          }
        }
        
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 400px;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">‚ö†Ô∏è Validation Error</div>
          <div style="font-weight: 500; opacity: 0.9;">${message}</div>
        `;
        document.body.appendChild(toast);
        
        const removeHighlight = () => {
          if (field.type !== 'checkbox') {
            field.style.border = '';
            field.style.boxShadow = '';
          } else {
            const label = field.closest('label') || document.querySelector(`label[for="${field.id}"]`);
            if (label) {
              label.style.border = '';
              label.style.borderRadius = '';
              label.style.padding = '';
            }
          }
          if (toast.parentNode) toast.remove();
          field.removeEventListener('change', removeHighlight);
          field.removeEventListener('input', removeHighlight);
        };
        
        field.addEventListener('change', removeHighlight);
        field.addEventListener('input', removeHighlight);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
      }, 500);
    };
    
    // Check if terms are acknowledged
    const termsAck = document.getElementById('terms_ack');
    if (!termsAck.checked) {
      navigateToFieldError(termsAck, 'You must acknowledge the NET30 and PO requirements to proceed.');
      return false;
    }
    
    // Check hotel location type to determine if bank validation should apply
    const hotelLocationSelect = document.getElementById('hotel_location_type');
    const locationType = hotelLocationSelect ? hotelLocationSelect.value : '';
    
    // Skip bank validation if user chose 'skip' or left location empty
    if (locationType === 'skip' || locationType === '') {
      console.log('üè¶ Skipping bank validation - user chose skip or no selection:', locationType);
      // User chose to skip banking or left it empty - no bank validation needed
    } else {
      // Only validate bank sections if user chose a location and sections are visible
      
      // Bank account confirmation checks
      const ach = document.getElementById('ach_section');
      if (ach && ach.style.display !== 'none') {
        const a1 = (document.getElementById('ach_account_number')||{}).value?.trim() || '';
        const a2 = (document.getElementById('ach_account_number_confirm')||{}).value?.trim() || '';
        const achMatchMsg = document.getElementById('ach_account_match');
        if (a1 || a2) {
          if (!a1 || !a2 || a1 !== a2) {
            if (achMatchMsg) { achMatchMsg.style.display='block'; achMatchMsg.style.color='#b91c1c'; achMatchMsg.textContent='Account numbers do not match.'; }
            const firstEmptyField = !a1 ? document.getElementById('ach_account_number') : document.getElementById('ach_account_number_confirm');
            navigateToFieldError(firstEmptyField, 'ACH account numbers do not match. Please re-enter both fields.');
            return false;
          } else {
            if (achMatchMsg) { achMatchMsg.style.display='block'; achMatchMsg.style.color='#065f46'; achMatchMsg.textContent='Account numbers match.'; }
          }
        }
      }
      const wire = document.getElementById('wire_section');
      if (wire && wire.style.display !== 'none') {
        const w1 = (document.getElementById('wire_account_number')||{}).value?.trim() || '';
        const w2 = (document.getElementById('wire_account_number_confirm')||{}).value?.trim() || '';
        const wireMatchMsg = document.getElementById('wire_account_match');
        if (w1 || w2) {
          if (!w1 || !w2 || w1 !== w2) {
            if (wireMatchMsg) { wireMatchMsg.style.display='block'; wireMatchMsg.style.color='#b91c1c'; wireMatchMsg.textContent='Account numbers do not match.'; }
            const firstEmptyField = !w1 ? document.getElementById('wire_account_number') : document.getElementById('wire_account_number_confirm');
            navigateToFieldError(firstEmptyField, 'Wire account numbers do not match. Please re-enter both fields.');
            return false;
          } else {
            if (wireMatchMsg) { wireMatchMsg.style.display='block'; wireMatchMsg.style.color='#065f46'; wireMatchMsg.textContent='Account numbers match.'; }
          }
        }
      }
    }
    
    // Validate file uploads (optional but check formats if provided)
    const fileInputs = pages[current].querySelectorAll('input[type="file"]');
    for (const input of fileInputs) {
      if (input.files && input.files.length > 0) {
        for (const file of input.files) {
          // Check file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            navigateToFieldError(input, `File "${file.name}" is too large. Maximum file size is 10MB.`);
            return false;
          }
        }
      }
    }
    
    return true;
  }
  function updateSubmitState(){
    const poEl = document.querySelector('[name="accepts_po"]');
    const net30Ok = !acceptsNet30 || acceptsNet30.value === 'Yes';
    const poOk = !poEl || poEl.value === 'Acceptable';
    submitBtn.disabled = !(net30Ok && poOk);
  }
  function toggleES(){
    const sec = document.getElementById('extendedStaySection');
    const isExtendedStaySelect = document.getElementById('is_extended_stay');
    const on = (isExtendedStaySelect && isExtendedStaySelect.value === 'Yes');
    
    console.log('üè® toggleES called:', {
      section: !!sec,
      select: !!isExtendedStaySelect,
      value: isExtendedStaySelect?.value,
      shouldShow: on
    });
    
    if (sec) {
      sec.style.display = on ? 'block' : 'none';
      console.log('üè® Extended Stay section display set to:', sec.style.display);
      
      // Set required fields
      sec.querySelectorAll('[data-es-required]').forEach(el => {
        el.required = on;
        console.log('üè® Field', el.name, 'required set to:', on);
      });
    } else {
      console.error('üè® Extended Stay section not found!');
    }
  }
  function toggleBreakfastCost(){
    const sec = document.getElementById('breakfast_cost_section');
    const breakfastSelect = document.getElementById('breakfast_included');
    const costInput = document.getElementById('breakfast_buffet_cost');
    // Show cost section when "No" is selected (breakfast NOT included)
    const on = (breakfastSelect && breakfastSelect.value === 'No');
    
    console.log('üç≥ toggleBreakfastCost called:', {
      section: !!sec,
      select: !!breakfastSelect,
      value: breakfastSelect?.value,
      shouldShow: on
    });
    
    if (sec) {
      sec.style.display = on ? 'block' : 'none';
      console.log('üç≥ Breakfast cost section display set to:', sec.style.display);
      
      // Set required field
      if (costInput) {
        costInput.required = on;
        console.log('üç≥ Breakfast cost field required set to:', on);
      }
    } else {
      console.error('üç≥ Breakfast cost section not found!');
    }
  }
  function toggleAaaDiamond(){
    console.log('toggleAaaDiamond called');
    const sec = document.getElementById('aaa_diamond_section');
    const ratingSelect = document.getElementById('aaa_diamond_rating');
    const aaaSelect = document.getElementById('is_aaa_rated'); // Get fresh reference
    const aaaRatedValue = aaaSelect ? aaaSelect.value : '';
    
    console.log('AAA diamond toggle:', {
      section: !!sec,
      ratingSelect: !!ratingSelect,
      aaaSelect: !!aaaSelect,
      aaaRatedValue: aaaRatedValue
    });
    
    const on = (aaaSelect && aaaSelect.value === 'Yes');
    console.log('Should show diamond section:', on);
    
    if (sec) {
      sec.style.display = on ? 'block' : 'none';
      console.log('Diamond section display set to:', sec.style.display);
      // If turning off AAA requirement, clear any existing diamond selection to avoid stale value
      if (!on && ratingSelect) {
        ratingSelect.value = '';
      }
    } else {
      console.error('AAA diamond section element not found!');
    }
    
    if (ratingSelect) {
      ratingSelect.required = on;
      console.log('Diamond rating required set to:', on);
    } else {
      console.error('AAA diamond rating select element not found!');
    }
  }
  
  function toggleBankSections(){
    const achSection = document.getElementById('ach_section');
    const wireSection = document.getElementById('wire_section');
    const locationType = hotelLocationType ? hotelLocationType.value : '';
    
    console.log('üè¶ toggleBankSections called with locationType:', locationType);
    console.log('üè¶ Elements found - ACH:', !!achSection, 'Wire:', !!wireSection, 'LocationSelect:', !!hotelLocationType);
    
    // Hide both sections initially and clear any values
    if (achSection) {
      achSection.style.display = 'none';
      console.log('üè¶ ACH section hidden');
    }
    if (wireSection) {
      wireSection.style.display = 'none';
      console.log('üè¶ Wire section hidden');
    }
    
    // Remove required from all bank fields first
    const allBankFields = ['ach_bank_account_name', 'ach_routing_number', 'ach_account_number', 'ach_account_number_confirm', 'ach_bank_name', 'ach_ar_email', 
                          'wire_bank_account_name', 'wire_swift_code', 'wire_account_number', 'wire_account_number_confirm', 'wire_bank_name', 'wire_ar_email'];
    allBankFields.forEach(fieldName => {
      const field = document.querySelector(`[name="${fieldName}"]`);
      if (field) {
        field.required = false;
        console.log('üè¶ Removed required from:', fieldName);
      }
    });
    
    // Show appropriate section based on selection
    if (locationType === 'US') {
      if (achSection) {
        achSection.style.display = 'block';
        console.log('üè¶ ACH section shown (US selected)');
        
        // Make fields conditionally required based on whether user starts typing
        const achRequiredFields = ['ach_bank_account_name', 'ach_routing_number', 'ach_account_number', 'ach_bank_name', 'ach_ar_email'];
        
        // Remove existing listeners to prevent duplicates
        achRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            // Clone to remove all event listeners
            const newField = field.cloneNode(true);
            field.parentNode.replaceChild(newField, field);
          }
        });
        
        // Add fresh listeners - NOTE: confirmation field is NOT required by default
        achRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            const makeFieldsRequired = () => {
              const hasAnyAchData = achRequiredFields.some(fname => {
                const f = document.querySelector(`[name="${fname}"]`);
                return f && f.value.trim() !== '';
              });
              
              if (hasAnyAchData) {
                console.log('üè¶ User started typing in ACH fields - making core fields required (not confirmation)');
                // Only make core fields required, NOT the confirmation field
                const coreFields = ['ach_bank_account_name', 'ach_routing_number', 'ach_account_number', 'ach_bank_name', 'ach_ar_email'];
                coreFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = true;
                });
                // Confirmation field stays optional
                const confirmField = document.querySelector('[name="ach_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              } else {
                console.log('üè¶ No ACH data - removing required');
                achRequiredFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = false;
                });
                const confirmField = document.querySelector('[name="ach_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              }
            };
            
            field.addEventListener('input', makeFieldsRequired);
            field.addEventListener('blur', makeFieldsRequired);
          }
        });
      }
    } else if (locationType === 'International') {
      if (wireSection) {
        wireSection.style.display = 'block';
        console.log('üè¶ Wire section shown (International selected)');
        
        // Make fields conditionally required based on whether user starts typing
        const wireRequiredFields = ['wire_bank_account_name', 'wire_swift_code', 'wire_account_number', 'wire_bank_name', 'wire_ar_email'];
        
        // Remove existing listeners to prevent duplicates
        wireRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            // Clone to remove all event listeners
            const newField = field.cloneNode(true);
            field.parentNode.replaceChild(newField, field);
          }
        });
        
        // Add fresh listeners - NOTE: confirmation field is NOT required by default
        wireRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            const makeFieldsRequired = () => {
              const hasAnyWireData = wireRequiredFields.some(fname => {
                const f = document.querySelector(`[name="${fname}"]`);
                return f && f.value.trim() !== '';
              });
              
              if (hasAnyWireData) {
                console.log('üè¶ User started typing in Wire fields - making core fields required (not confirmation)');
                // Only make core fields required, NOT the confirmation field
                const coreFields = ['wire_bank_account_name', 'wire_swift_code', 'wire_account_number', 'wire_bank_name', 'wire_ar_email'];
                coreFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = true;
                });
                // Confirmation field stays optional
                const confirmField = document.querySelector('[name="wire_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              } else {
                console.log('üè¶ No Wire data - removing required');
                wireRequiredFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = false;
                });
                const confirmField = document.querySelector('[name="wire_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              }
            };
            
            field.addEventListener('input', makeFieldsRequired);
            field.addEventListener('blur', makeFieldsRequired);
          }
        });
      }
    } else if (locationType === 'skip') {
      // User explicitly chose to skip - show confirmation message
      console.log('üè¶ User chose to skip banking information');
      // Both sections remain hidden, no fields are required
    } else {
      // Empty selection or going back to "Select" - hide everything
      console.log('üè¶ No location selected or going back to select');
      // Both sections remain hidden, no fields are required
    }
    
    console.log('üè¶ Final state - ACH display:', achSection?.style.display, 'Wire display:', wireSection?.style.display);
  }
  function checkOutdoorFacility(){
    if (hasOutdoorFacility && hasOutdoorFacility.value === 'Yes') {
      const message = 'We are unable to accept your hotel if you have outdoor facilities without secure gates. If you would like us to review your location, please reach out to us directly.';
      alert(message);
      return false;
    }
    return true;
  }
  
  function validatePolicies(){
    // Removed - policy confirmations are handled on the dedicated signup page
    return true;
  }
  
  function getFormData() {
    const formData = new FormData(form);
    const data = {};
    for (const [key, value] of formData.entries()) {
      if (data[key]) {
        if (Array.isArray(data[key])) {
          data[key].push(value);
        } else {
          data[key] = [data[key], value];
        }
      } else {
        data[key] = value;
      }
    }
    
    // Prefer official values when a Place ID exists
    if (data.hotel_place_id) {
      if (data.hotel_official_name) data.hotel_name = data.hotel_official_name;
      if (data.hotel_official_address) data.address = data.hotel_official_address.split(',')[0] || data.hotel_official_address;
    }
    if (data.management_company_place_id) {
      if (data.management_company_official_name) data.management_company = data.management_company_official_name;
      if (data.management_company_official_address) data.management_company_address = data.management_company_official_address;
    }

    // Normalize hotel main photo persistence: include preview data and presence flag; never include raw File
    try {
      const hiddenData = document.getElementById('hotel_main_photo_data');
      const hiddenName = document.getElementById('hotel_main_photo_name');
      const hiddenSize = document.getElementById('hotel_main_photo_size');
      const fileInput = document.getElementById('hotel_main_photo');
      if (hiddenData && hiddenData.value) {
        data.hotel_main_photo_data = hiddenData.value;
      }
      if (hiddenName && hiddenName.value) {
        data.hotel_main_photo_name = hiddenName.value;
      }
      if (hiddenSize && hiddenSize.value) {
        data.hotel_main_photo_size = hiddenSize.value;
      }
      // Presence flag reflects either hidden data populated or a file currently selected
      const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
      data.hotel_main_photo_present = Boolean((hiddenData && hiddenData.value) || hasFile);
      // Ensure we don't accidentally serialize the File object
      delete data.hotel_main_photo;
    } catch (e) {}

    return data;
  }
  
  // Keep hotel photo required-state in sync with persisted hidden data
  function syncHotelPhotoRequired(){
    try {
      const photoInput = document.getElementById('hotel_main_photo');
      const hiddenData = document.getElementById('hotel_main_photo_data');
      if (!photoInput) return;
      const hasPersisted = Boolean(hiddenData && hiddenData.value);
      photoInput.required = !hasPersisted;
    } catch(_) {}
  }
  function setFormData(data) {
    console.log('üîÑ setFormData called with', Object.keys(data).length, 'fields');
    
    // Ensure form is available
    if (!form) {
      console.error('üîÑ Form not available for setFormData');
      return;
    }
    
    // CRITICAL: Disable auto-save during form population to prevent conflicts
    window.isPopulatingForm = true;
    
    // Clear existing form data
    form.reset();
    
    // Set form values
    for (const [key, value] of Object.entries(data)) {
      if (key === 'form_type') continue; // Skip hidden form type
      
      const elements = form.querySelectorAll(`[name="${key}"]`);
      if (elements.length === 0) {
        console.log('üîÑ No elements found for field:', key);
        continue;
      }
      
      elements.forEach((el, index) => {
        // Skip file inputs - they cannot be set programmatically for security reasons
        if (el.type === 'file') {
          console.log('üîÑ Skipping file input:', key);
          return;
        }
        
        if (Array.isArray(value)) {
          // For checkbox/radio groups, restore by membership (value contains selected values)
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = value.includes(el.value);
          } else {
            // For inputs with [] names that are not checkboxes, set by index when possible
            if (index < value.length) el.value = value[index];
          }
        } else {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = el.value === value;
          } else {
            el.value = value;
          }
        }
      });
    }
    
    // Rebuild meeting rooms if they exist
    if (data.room_name && Array.isArray(data.room_name)) {
      rooms.innerHTML = '';
      data.room_name.forEach((_, index) => {
        if (addRoomBtn) addMeetingRoom(); // Use the proper function
        const block = rooms.lastElementChild;
        if (block) {
          const setVal = (selector, value) => {
            const el = block.querySelector(selector);
            if (el && value != null && value !== '') el.value = String(value);
          };
          setVal('input[name="room_name[]"]', data.room_name[index]);
          setVal('input[name="room_level[]"]', data.room_level && data.room_level[index]);
          setVal('input[name="room_area_sqft[]"]', data.room_area_sqft && data.room_area_sqft[index]);
          setVal('input[name="room_area_sqm[]"]', data.room_area_sqm && data.room_area_sqm[index]);
          setVal('input[name="room_dims_ft[]"]', data.room_dims_ft && data.room_dims_ft[index]);
          setVal('input[name="room_ceiling_ft[]"]', data.room_ceiling_ft && data.room_ceiling_ft[index]);
          setVal('select[name="room_pillar_free[]"]', data.room_pillar_free && data.room_pillar_free[index]);
          setVal('select[name="room_natural_light[]"]', data.room_natural_light && data.room_natural_light[index]);
          setVal('select[name="room_divisible[]"]', data.room_divisible && data.room_divisible[index]);
          setVal('input[name="cap_theater[]"]', data.cap_theater && data.cap_theater[index]);
          setVal('input[name="cap_classroom[]"]', data.cap_classroom && data.cap_classroom[index]);
          setVal('input[name="cap_banquet[]"]', data.cap_banquet && data.cap_banquet[index]);
          setVal('input[name="cap_ushape[]"]', data.cap_ushape && data.cap_ushape[index]);
          setVal('input[name="cap_banquet_rounds[]"]', data.cap_banquet_rounds && data.cap_banquet_rounds[index]);
          setVal('input[name="cap_cocktail_rounds[]"]', data.cap_cocktail_rounds && data.cap_cocktail_rounds[index]);
          setVal('input[name="cap_crescent_rounds[]"]', data.cap_crescent_rounds && data.cap_crescent_rounds[index]);
          setVal('input[name="cap_hollow_square[]"]', data.cap_hollow_square && data.cap_hollow_square[index]);
          setVal('input[name="room_built_in_av[]"]', data.room_built_in_av && data.room_built_in_av[index]);
          setVal('input[name="room_power[]"]', data.room_power && data.room_power[index]);
          setVal('input[name="room_loadin[]"]', data.room_loadin && data.room_loadin[index]);
        }
      });
    }
    
    // Special handling: Chain/Brand must be restored in order so brand options are available
    try {
      const chainSel = document.getElementById('chain_select');
      const chainOther = document.getElementById('chain_other');
      const brandSel = document.getElementById('brand_select');
      const brandOther = document.getElementById('brand_other');
      if (chainSel) {
        const chainValue = data.chain || '';
        // If restored value isn't one of the known chains and not empty, treat as Other
        const knownChains = Object.keys(chainToBrands || {});
        if (chainValue && !knownChains.includes(chainValue) && chainValue !== 'Other') {
          chainSel.value = 'Other';
          if (chainOther) {
            chainOther.style.display = 'block';
            chainOther.value = chainValue;
          }
        } else {
          chainSel.value = chainValue;
          if (chainOther) chainOther.style.display = chainSel.value === 'Other' ? 'block' : 'none';
          if (chainSel.value === 'Other' && chainOther && data.chain_other) {
            chainOther.value = data.chain_other;
          }
        }
        if (typeof updateBrandOptions === 'function') updateBrandOptions();
      }
      if (brandSel) {
        const brandValue = data.brand || '';
        const possible = (chainToBrands && document.getElementById('chain_select')) ? (chainToBrands[document.getElementById('chain_select').value] || []) : [];
        if (brandValue && !possible.includes(brandValue) && brandValue !== 'Other') {
          brandSel.value = 'Other';
          if (brandOther) {
            brandOther.style.display = 'block';
            brandOther.value = brandValue;
          }
        } else {
          brandSel.value = brandValue;
          if (brandOther) brandOther.style.display = brandSel.value === 'Other' ? 'block' : 'none';
          if (brandSel.value === 'Other' && brandOther && data.brand_other) {
            brandOther.value = data.brand_other;
          }
        }
      }
    } catch (_e) {}

    // If draft has hotel_place_id but current inputs were typed, prefer stored official values
    const hotelPlaceId = document.getElementById('hotel_place_id');
    if (hotelPlaceId && data.hotel_place_id) {
      hotelPlaceId.value = data.hotel_place_id;
    }
    const mgmtPlaceId = document.getElementById('management_company_place_id');
    if (mgmtPlaceId && data.management_company_place_id) {
      mgmtPlaceId.value = data.management_company_place_id;
    }
    
    // Restore hotel main photo preview from persisted data (cannot set file inputs programmatically)
    try {
      const photoData = data.hotel_main_photo_data;
      const photoName = data.hotel_main_photo_name;
      const photoSize = data.hotel_main_photo_size;
      const photoPreview = document.getElementById('photo_preview');
      const previewImage = document.getElementById('preview_image');
      const photoInfo = document.getElementById('photo_info');
      const hiddenData = document.getElementById('hotel_main_photo_data');
      const hiddenName = document.getElementById('hotel_main_photo_name');
      const hiddenSize = document.getElementById('hotel_main_photo_size');
      const photoInput = document.getElementById('hotel_main_photo');
      if (photoData && previewImage && photoPreview) {
        previewImage.src = photoData;
        photoPreview.style.display = 'block';
        if (photoInfo) {
          const sizeMb = photoSize ? (Number(photoSize) / (1024 * 1024)).toFixed(2) : '';
          photoInfo.innerHTML = `${photoName ? `<strong>File:</strong> ${photoName}<br>` : ''}${photoSize ? `<strong>Size:</strong> <span style="color:#059669">${sizeMb}MB</span>` : ''}`;
        }
        if (hiddenData) hiddenData.value = photoData;
        if (hiddenName && photoName) hiddenName.value = photoName;
        if (hiddenSize && photoSize) hiddenSize.value = photoSize;
        // If we have a persisted photo, the file input does not need to be required
        if (photoInput) photoInput.required = false;
        syncHotelPhotoRequired();
      } else {
        // No photo persisted; ensure the requirement remains/enabled
        if (photoInput) photoInput.required = true;
        syncHotelPhotoRequired();
      }
    } catch (photoRestoreError) {
      console.warn('Photo preview restore failed:', photoRestoreError);
    }

    // Ensure dependent UI states reflect restored values (AAA diamond section, etc.)
    if (typeof toggleAaaDiamond === 'function') {
      try { toggleAaaDiamond(); } catch(e) {}
    }

    // Fallback: If address sub-fields are empty, try restoring from a formatted address string
    try {
      const setIfEmpty = (el, val) => {
        if (el && (el.value == null || String(el.value).trim() === '') && val != null && String(val).trim() !== '') {
          el.value = String(val).trim();
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
        }
      };

      // Helper to parse a formatted address like: "123 Main St, City, ST 12345, USA"
      const parseFormattedAddress = (formatted) => {
        const parts = String(formatted).split(',').map(p => p.trim()).filter(Boolean);
        const result = { street: '', city: '', state: '', zip: '', country: '' };
        if (parts.length === 0) return result;
        // Street is usually first
        result.street = parts[0] || '';
        // Country is usually last
        if (parts.length >= 2) {
          result.country = parts[parts.length - 1] || '';
        }
        // City and state/zip are typically second to last
        if (parts.length >= 3) {
          const cityPart = parts[parts.length - 3];
          const stateZipPart = parts[parts.length - 2];
          if (cityPart) result.city = cityPart;
          if (stateZipPart) {
            // Expect patterns like "CA 94105" or just "CA"
            const m = stateZipPart.match(/^([A-Za-z\p{L}]{2,})\s*(\d{4,6})?$/u);
            if (m) {
              result.state = m[1] || '';
              result.zip = m[2] || '';
            } else {
              // Try split by space; take first token as state, last numeric as zip
              const tokens = stateZipPart.split(/\s+/).filter(Boolean);
              if (tokens.length > 0) result.state = tokens[0];
              const zipTok = tokens.find(t => /\d{4,6}/.test(t));
              if (zipTok) result.zip = zipTok;
            }
          }
        } else if (parts.length === 2) {
          // e.g., "Street, City ST 12345" (no explicit country)
          const stateZipPart = parts[1];
          const m = stateZipPart.match(/^(.*)\s+([A-Za-z\p{L}]{2,})\s*(\d{4,6})?$/u);
          if (m) {
            result.city = (m[1] || '').trim();
            result.state = (m[2] || '').trim();
            result.zip = (m[3] || '').trim();
          } else {
            result.city = stateZipPart;
          }
        }
        return result;
      };

      // Hotel address restoration
      const hotelAddrEl = form.querySelector('input[name="address"]');
      const cityEl = form.querySelector('input[name="city"]');
      const stateEl = form.querySelector('input[name="state"]');
      const zipEl = form.querySelector('input[name="zip"]');
      const countryEl = form.querySelector('input[name="country"]');

      const allHotelEmpty = [hotelAddrEl, cityEl, stateEl, zipEl, countryEl]
        .every(el => !el || String(el.value || '').trim() === '');

      // Prefer explicitly saved official address if present; otherwise try combining fields
      const hotelFormatted = data.hotel_official_address || data.hotel_full_address || null;
      if (allHotelEmpty && hotelFormatted) {
        const parsed = parseFormattedAddress(hotelFormatted);
        setIfEmpty(hotelAddrEl, parsed.street);
        setIfEmpty(cityEl, parsed.city);
        setIfEmpty(stateEl, parsed.state);
        setIfEmpty(zipEl, parsed.zip);
        setIfEmpty(countryEl, parsed.country);
      }

      // If only street is present as a single comma-separated string, try to derive sub-fields
      if (hotelAddrEl && String(hotelAddrEl.value || '').includes(',') && [cityEl, stateEl, zipEl, countryEl].some(el => el && String(el.value || '').trim() === '')) {
        const parsed = parseFormattedAddress(hotelAddrEl.value);
        setIfEmpty(hotelAddrEl, parsed.street);
        setIfEmpty(cityEl, parsed.city);
        setIfEmpty(stateEl, parsed.state);
        setIfEmpty(zipEl, parsed.zip);
        setIfEmpty(countryEl, parsed.country);
      }

      // Management company address restoration
      const mgmtStreetEl = form.querySelector('input[name="management_company_address"]');
      const mgmtCityEl = form.querySelector('input[name="management_company_city"]');
      const mgmtStateEl = form.querySelector('input[name="management_company_state"]');
      const mgmtZipEl = form.querySelector('input[name="management_company_zip"]');
      const mgmtCountryEl = form.querySelector('input[name="management_company_country"]');

      const allMgmtEmpty = [mgmtStreetEl, mgmtCityEl, mgmtStateEl, mgmtZipEl, mgmtCountryEl]
        .every(el => !el || String(el.value || '').trim() === '');

      const mgmtFormatted = data.management_company_official_address || data.management_company_full_address || null;
      if (allMgmtEmpty && mgmtFormatted) {
        const parsed = parseFormattedAddress(mgmtFormatted);
        setIfEmpty(mgmtStreetEl, parsed.street);
        setIfEmpty(mgmtCityEl, parsed.city);
        setIfEmpty(mgmtStateEl, parsed.state);
        setIfEmpty(mgmtZipEl, parsed.zip);
        setIfEmpty(mgmtCountryEl, parsed.country);
      }

      if (mgmtStreetEl && String(mgmtStreetEl.value || '').includes(',') && [mgmtCityEl, mgmtStateEl, mgmtZipEl, mgmtCountryEl].some(el => el && String(el.value || '').trim() === '')) {
        const parsed = parseFormattedAddress(mgmtStreetEl.value);
        setIfEmpty(mgmtStreetEl, parsed.street);
        setIfEmpty(mgmtCityEl, parsed.city);
        setIfEmpty(mgmtStateEl, parsed.state);
        setIfEmpty(mgmtZipEl, parsed.zip);
        setIfEmpty(mgmtCountryEl, parsed.country);
      }
    } catch (addrRestoreError) {
      console.warn('Address restoration fallback failed:', addrRestoreError);
    }

    // Trigger form data loaded event for other components
    window.dispatchEvent(new CustomEvent('formDataLoaded', { detail: data }));
    
    console.log('üîÑ setFormData completed successfully');
    
    // CRITICAL: Re-enable auto-save and update form state AFTER population is complete
    setTimeout(() => {
      window.isPopulatingForm = false;
      console.log('‚úÖ Form population complete - auto-save re-enabled');
      
      // Update form state AFTER population to ensure visibility is correct
      toggleES();
      toggleBreakfastCost();
      toggleAaaDiamond();
      toggleBankSections();
      updateSubmitState();
      
      // Ensure management company section visibility reflects saved value
      const managementSelect = document.getElementById('is_management_company_managed');
      if (managementSelect) {
        managementSelect.dispatchEvent(new Event('change'));
      }
      
      console.log('‚úÖ Form visibility toggles completed');
    }, 500); // Small delay to ensure all events have settled
  }
  
  // This function is handled by the enhanced saveDraft function above
  
  async function loadDraft() {
    if (!currentUserId) return;
    
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('No session ID available for draft load');
        return;
      }
      
      const response = await fetch(`${API_BASE}/api/draft/load/${currentUserId}`, {
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      });
      const result = await response.json();
      
      if (result.ok && result.draft) {
        setFormData(result.draft.formData);
        setActiveStep(result.draft.currentPage);
        showToast('Draft loaded successfully');
        hasDraft = false;
        draftStatus.style.display = 'none';
      } else {
        showToast('No draft found');
      }
    } catch (error) {
      console.error('Load draft error:', error);
      showToast('Failed to load draft');
    }
  }
  
  async function deleteDraft() {
    if (!currentUserId) return;
    
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('No session ID available for draft delete');
        return;
      }
      
      const response = await fetch(`${API_BASE}/api/draft/delete/${currentUserId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      });
      
      const result = await response.json();
      if (result.ok) {
        showToast('Draft deleted');
        hasDraft = false;
        draftStatus.style.display = 'none';
      } else {
        showToast('Failed to delete draft');
      }
    } catch (error) {
      console.error('Delete draft error:', error);
      showToast('Failed to delete draft');
    }
  }
  
  // Initialize Google Places API
  async function initializeGooglePlaces() {
    try {
      const response = await fetch('/api/google-places-key');
      
      if (!response.ok) {
        console.log('Google Places API endpoint not available:', response.status);
        showToast('‚ÑπÔ∏è Google Places API not available - autocomplete disabled');
        return;
      }
      
      const data = await response.json();
      
      // Handle mock mode
      if (data.mockMode) {
        console.log('Development Mode: Google Places API not configured, using mock data');
        showToast('‚ÑπÔ∏è Development Mode: Google Places API not configured');
        return;
      }
      
      googlePlacesApiKey = data.apiKey;
      
      if (googlePlacesApiKey) {
        console.log('Google Places API key loaded successfully');
        setTimeout(() => {
          initAutocomplete();
        }, 200);
      } else {
        console.log('No Google Places API key available');
        showToast('‚ö†Ô∏è Google Places API not configured');
      }
    } catch (error) {
      console.error('Error loading Google Places API key:', error);
      showToast('‚ÑπÔ∏è Google Places API not available - autocomplete disabled');
    }
  }

  // Chain ‚Üí Brand linkage and Other handling
  const chainToBrands = {
    'Hilton Worldwide': [
      'Hilton Hotels & Resorts','Conrad Hotels & Resorts','Waldorf Astoria','DoubleTree by Hilton','Curio Collection','Tapestry Collection','Embassy Suites','Hilton Garden Inn','Hampton Inn / Hampton Inn & Suites','Homewood Suites','Home2 Suites','Tru by Hilton','Motto by Hilton','Canopy by Hilton','Signia by Hilton'
    ],
    'Marriott International': [
      'Marriott Hotels','JW Marriott','Renaissance Hotels','Sheraton','Westin','Le M√©ridien','Delta Hotels','Four Points by Sheraton','Aloft','AC Hotels','Moxy','Courtyard by Marriott','SpringHill Suites','Fairfield Inn & Suites','Residence Inn','TownePlace Suites','Element','The Ritz-Carlton','St. Regis','W Hotels','Edition Hotels','Autograph Collection','Tribute Portfolio','Gaylord Hotels'
    ],
    'IHG Hotels & Resorts': [
      'InterContinental','Kimpton Hotels','Hotel Indigo','Crowne Plaza','voco Hotels','Holiday Inn','Holiday Inn Express','Holiday Inn Club Vacations','EVEN Hotels','Avid Hotels','Staybridge Suites','Candlewood Suites','Regent Hotels'
    ],
    'Hyatt Hotels Corporation': [
      'Park Hyatt','Grand Hyatt','Hyatt Regency','Hyatt Centric','Hyatt Place','Hyatt House','Hyatt Ziva / Zilara (All-Inclusive)','Andaz','Alila','Thompson Hotels','Destination by Hyatt','Caption by Hyatt','Miraval','Unbound Collection'
    ],
    'Wyndham Hotels & Resorts': [
      'Wyndham Grand','Wyndham','Dolce Hotels','TRYP by Wyndham','Wingate by Wyndham','La Quinta','Ramada','Days Inn','Super 8','Microtel Inn & Suites','Baymont Inn & Suites','Travelodge','Howard Johnson','AmericInn'
    ],
    'Choice Hotels International': [
      'Ascend Hotel Collection','Cambria Hotels','Comfort Inn / Comfort Suites','Quality Inn','Clarion','Sleep Inn','MainStay Suites','Suburban Extended Stay','Econo Lodge','Rodeway Inn','WoodSpring Suites'
    ],
    'Best Western Hotels & Resorts': [
      'Best Western','Best Western Plus','Best Western Premier','BW Signature Collection','BW Premier Collection','SureStay Hotel Group (SureStay, SureStay Plus, SureStay Collection, SureStay Studio)','Sadie Hotels','Aiden by Best Western'
    ],
    'Radisson Hotel Group': [
      'Radisson Blu','Radisson RED','Radisson Collection','Park Inn by Radisson','Park Plaza','Country Inn & Suites'
    ],
    'Accor Hotels': [
      'Sofitel (Luxury)','Fairmont','Raffles','Pullman','Swiss√¥tel','M√∂venpick','Novotel','Mercure','ibis / ibis Styles / ibis Budget','Adagio (aparthotel concept)','Handwritten Collection','Art Series','Peppers','The Sebel'
    ]
  };

  function updateBrandOptions() {
    const chainSel = document.getElementById('chain_select');
    const brandSel = document.getElementById('brand_select');
    const brandOther = document.getElementById('brand_other');
    if (!chainSel || !brandSel) return;
    const chain = chainSel.value;
    const brands = chainToBrands[chain] || [];
    const currentBrand = brandSel.value;
    brandSel.innerHTML = '<option value="">Select brand‚Ä¶</option>' +
      brands.map(b => `<option>${b}</option>`).join('') +
      '<option>Other</option>';
    // Preserve selection if still valid
    if (brands.includes(currentBrand)) {
      brandSel.value = currentBrand;
    } else if (currentBrand === 'Other') {
      brandSel.value = 'Other';
    } else {
      brandSel.value = '';
    }
    if (brandOther) brandOther.style.display = brandSel.value === 'Other' ? 'block' : 'none';
  }

  // Wire up chain/brand selects once DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const chainSel = document.getElementById('chain_select');
    const chainOther = document.getElementById('chain_other');
    const brandSel = document.getElementById('brand_select');
    const brandOther = document.getElementById('brand_other');
    if (chainSel) {
      chainSel.addEventListener('change', () => {
        const showOther = chainSel.value === 'Other';
        if (chainOther) chainOther.style.display = showOther ? 'block' : 'none';
        updateBrandOptions();
        // If user switches chain, clear brand unless same exists
        if (brandSel && !chainToBrands[chainSel.value]?.includes(brandSel.value)) {
          brandSel.value = '';
          if (brandOther) brandOther.style.display = 'none';
        }
      });
    }
    if (brandSel) {
      brandSel.addEventListener('change', () => {
        if (brandOther) brandOther.style.display = brandSel.value === 'Other' ? 'block' : 'none';
      });
    }
    updateBrandOptions();
  });

  // Include chain/brand "Other" values when saving
  const originalGetFormData = getFormData;
  getFormData = function() {
    const data = originalGetFormData();
    try {
      const chainSel = document.getElementById('chain_select');
      const chainOther = document.getElementById('chain_other');
      const brandSel = document.getElementById('brand_select');
      const brandOther = document.getElementById('brand_other');
      if (chainSel && chainSel.value === 'Other' && chainOther && chainOther.value) {
        data.chain = chainOther.value;
        data.chain_other = chainOther.value;
      }
      if (brandSel && brandSel.value === 'Other' && brandOther && brandOther.value) {
        data.brand = brandOther.value;
        data.brand_other = brandOther.value;
      }
    } catch (_) {}
    return data;
  };

  async function checkForDraft() {
    if (!currentUserId) return;
    
    try {
      // Initialize Google Places API
      await initializeGooglePlaces();
    } catch (error) {
      console.error('Check draft error:', error);
      showToast('Failed to check for draft');
    }
  }
  
  // SIMPLE AUTO-SAVE - WORKS IMMEDIATELY
  function simpleSave() {
    console.log('üö® simpleSave called - delegating to handleSaveDraft');
    
    // Delegate to the proper save function that handles both localStorage AND server
    if (typeof window.handleSaveDraft === 'function') {
      console.log('üö® handleSaveDraft exists, calling it...');
      window.handleSaveDraft('manual');
    } else {
      console.error('üö® handleSaveDraft not available yet');
    }
  }
  
  // Trigger visibility for all conditional sections based on current form values
  function triggerConditionalVisibility() {
    console.log('üîÑ Triggering conditional visibility for all sections...');
    
    // Trigger suite section visibility
    const suiteToggle = document.getElementById('sr_has_suites');
    const suiteSection = document.getElementById('sr_suites_section');
    if (suiteToggle && suiteSection) {
      const hasSuites = suiteToggle.value === 'Yes';
      suiteSection.style.display = hasSuites ? '' : 'none';
      console.log('üîÑ Suite section visibility:', hasSuites ? 'shown' : 'hidden');
    }
    
    // Trigger legacy suite section visibility (if exists)
    const legacySuiteToggle = document.getElementById('has_suites');
    const legacySuiteSection = document.getElementById('suites_section');
    if (legacySuiteToggle && legacySuiteSection) {
      const hasLegacySuites = legacySuiteToggle.value === 'Yes';
      legacySuiteSection.style.display = hasLegacySuites ? '' : 'none';
      console.log('üîÑ Legacy suite section visibility:', hasLegacySuites ? 'shown' : 'hidden');
    }
    
    // Trigger AAA diamond rating section visibility
    const aaaRatedSelect = document.getElementById('is_aaa_rated');
    const aaaDiamondSection = document.getElementById('aaa_diamond_section');
    const aaaDiamondRating = document.getElementById('aaa_diamond_rating');
    if (aaaRatedSelect && aaaDiamondSection) {
      const isAaaRated = aaaRatedSelect.value === 'Yes';
      aaaDiamondSection.style.display = isAaaRated ? '' : 'none';
      if (aaaDiamondRating) {
        aaaDiamondRating.required = isAaaRated;
      }
      console.log('üîÑ AAA diamond section visibility:', isAaaRated ? 'shown' : 'hidden');
    }
    
    // Trigger breakfast cost section visibility
    if (typeof toggleBreakfastCost === 'function') {
      toggleBreakfastCost();
      console.log('üîÑ Breakfast cost section toggled');
    }
    
    // Trigger bank sections visibility
    if (typeof toggleBankSections === 'function') {
      toggleBankSections();
      console.log('üîÑ Bank sections toggled');
    }
    
    // Trigger cooktop burner count section visibility
    if (typeof toggleBurnerCountSection === 'function') {
      toggleBurnerCountSection();
      console.log('üîÑ Cooktop burner count section toggled');
    }
    
    // Trigger tax breakdown method sections visibility
    const taxMethodSelect = document.getElementById('tax_method');
    const taxBreakdownSection = document.getElementById('tax_breakdown_section');
    const taxTotalSection = document.getElementById('tax_total_section');
    const taxTotalOnlyInput = document.getElementById('tax_total_only');
    
    if (taxMethodSelect && taxBreakdownSection && taxTotalSection) {
      const taxMethod = taxMethodSelect.value;
      const showBreakdown = (taxMethod === 'breakdown');
      const showTotal = (taxMethod === 'total');
      
      taxBreakdownSection.style.display = showBreakdown ? '' : 'none';
      taxTotalSection.style.display = showTotal ? '' : 'none';
      
      if (taxTotalOnlyInput) {
        taxTotalOnlyInput.required = showTotal;
      }
      
      console.log('üîÑ Tax breakdown sections visibility - Breakdown:', showBreakdown ? 'shown' : 'hidden', 'Total:', showTotal ? 'shown' : 'hidden');
    }
    
    console.log('‚úÖ Conditional visibility triggered');
  }
  
  // SIMPLE RESTORE - WORKS IMMEDIATELY
  function simpleRestore() {
    try {
      // Avoid conflicting with the main restoration flow
      if (window.isPopulatingForm || window.autoRestoreCompleted) {
        return;
      }

      const savedEnhanced = localStorage.getItem('hotel_registration_draft');
      if (savedEnhanced) {
        try {
          const draft = JSON.parse(savedEnhanced);
          if (draft && draft.formData && Object.keys(draft.formData).length) {
            console.log('üö® RESTORING (enhanced):', Object.keys(draft.formData).length, 'fields from localStorage');
            setFormData(draft.formData);
            if (draft.currentStep && draft.currentStep >= 0) {
              current = draft.currentStep;
              setActiveStep(current);
            }
            // Trigger conditional visibility after restoration
            setTimeout(() => triggerConditionalVisibility(), 100);
            // Show notification
            const toast1 = document.createElement('div');
            toast1.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#3b82f6; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
            toast1.textContent = '‚úÖ Data restored!';
            document.body.appendChild(toast1);
            setTimeout(() => toast1.remove(), 3000);
            return;
          }
        } catch (e1) {
          console.warn('simpleRestore enhanced parse failed:', e1);
        }
      }

      // Legacy fallback (older key)
      const saved = localStorage.getItem('hotel_draft');
      if (!saved) {
        console.log('üö® No saved data found');
        return;
      }
      const legacy = JSON.parse(saved);
      const form = document.getElementById('hotel-form');
      if (!form || !legacy || typeof legacy !== 'object') {
        console.log('üö® Legacy restore skipped');
        return;
      }
      console.log('üö® RESTORING (legacy):', Object.keys(legacy).length, 'fields from localStorage');
      setFormData(legacy);
      // Trigger conditional visibility after restoration
      setTimeout(() => triggerConditionalVisibility(), 100);
      // Notification
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#3b82f6; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
      toast.textContent = '‚úÖ Data restored!';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    } catch (e) {
      console.error('üö® Restore error:', (e && e.message) ? e.message : e);
    }
  }
  
  // GLOBAL TEST FUNCTIONS - Available immediately
  window.testSave = function() {
    console.log('üß™ Testing save...');
    console.log('üß™ handleSaveDraft exists:', typeof window.handleSaveDraft);
    console.log('üß™ simpleSave exists:', typeof simpleSave);
    console.log('üß™ currentUserId:', currentUserId);
    console.log('üß™ signedIn:', signedIn, 'window.signedIn:', window.signedIn);
    
    if (typeof window.handleSaveDraft === 'function') {
      console.log('üß™ Calling handleSaveDraft directly...');
      window.handleSaveDraft('manual');
    } else {
      console.log('üß™ Calling simpleSave...');
      simpleSave();
    }
  };
  
  window.testRestore = function() {
    console.log('üß™ Testing restore...');
    simpleRestore();
  };
  
  window.testInput = function() {
    console.log('üß™ Testing input...');
    const hotelName = document.querySelector('[name="hotel_name"]');
    if (hotelName) {
      hotelName.value = 'Test Hotel ' + Date.now();
      console.log('üß™ Set hotel name to:', hotelName.value);
      simpleSave(); // Auto-save after setting
    } else {
      console.error('üß™ Hotel name field not found!');
    }
  };
  // Emergency navigation function - can be called from console if page gets stuck
  window.emergencyNavigation = function(pageNumber) {
    console.log('üö® Emergency navigation to page:', pageNumber);
    try {
      // Force initialize pages and steps
      if (!pages || !steps) {
        console.log('üö® Force initializing pages and steps...');
        pages = Array.from(document.querySelectorAll('.page'));
        steps = Array.from(document.querySelectorAll('.step'));
        console.log('üö® Found pages:', pages.length, 'steps:', steps.length);
      }
      
      if (pages && pages.length > 0) {
        current = Math.max(0, Math.min(pageNumber, pages.length - 1));
        setActiveStep(current);
        console.log('üö® Emergency navigation successful to page:', current);
      } else {
        console.error('üö® Pages not initialized - found:', pages?.length || 0);
      }
    } catch (error) {
      console.error('üö® Emergency navigation failed:', error);
    }
  };

  document.addEventListener('DOMContentLoaded', async function() {
    // IMMEDIATE: Clean up any lingering overlays from previous sessions
    console.log('üßπ Initial cleanup: Removing any existing overlays...');
    const existingSubmitting = document.getElementById('submitting');
    
    // Setup area conversion for existing meeting rooms
    setTimeout(() => {
      setupAreaConversion();
    }, 1000);
    
    // Restore meeting room data from saved data
    setTimeout(() => {
      deserializeMeetingRooms();
    }, 1500);
    
    // Start retry process for Primary Contact population
    console.log('üîÑ Starting Primary Contact auto-population...');
    retryPopulatePrimaryContact();
    const existingThanks = document.getElementById('thanks');
    if (existingSubmitting) existingSubmitting.classList.remove('show');
    if (existingThanks) existingThanks.classList.remove('show');
    
    // IMMEDIATE DEBUG: Check localStorage and session status
    console.log('üîç DEBUG: Checking localStorage and session status...');
    console.log('üîç Session ID exists:', !!localStorage.getItem('fedevent_session'));
    console.log('üîç User data exists:', !!localStorage.getItem('fedevent_user'));
    console.log('üîç Hotel data exists:', !!localStorage.getItem('fedevent_hotel'));
    console.log('üîç Draft exists:', !!localStorage.getItem('hotel_registration_draft'));
    console.log('üîç All localStorage keys:', Object.keys(localStorage).filter(k => k.includes('hotel') || k.includes('draft')));
    console.log('üîç URL params:', window.location.search);
    
    // IMMEDIATE FIX: Set up simple auto-save that ALWAYS works
    setTimeout(() => {
      console.log('üöÄ Setting up IMMEDIATE auto-save...');
      const form = document.getElementById('hotel-form');
      if (form) {
        console.log('üöÄ Form found, setting up auto-save...');
        // Add event listeners to ALL form inputs
        const allInputs = form.querySelectorAll('input, select, textarea');
        console.log('üöÄ Found', allInputs.length, 'form inputs');
        
        // Test if we can find the hotel name field specifically
        const hotelName = form.querySelector('[name="hotel_name"]');
        console.log('üöÄ Hotel name field found:', !!hotelName);
        if (hotelName) {
          console.log('üöÄ Hotel name field value:', hotelName.value);
        }
        
        // Define simpleAutoSave ONCE, outside the loop
        if (!window.simpleAutoSave) {
          window.simpleAutoSave = function() {
            console.log('üöÄ SIMPLE AUTO-SAVE triggered - delegating to handleSaveDraft');
            // Delegate to the proper save function
            if (typeof window.handleSaveDraft === 'function') {
              window.handleSaveDraft('auto-input');
            } else {
              console.error('üöÄ handleSaveDraft not available yet - will be called when ready');
            }
          };
        }
        
        allInputs.forEach((input, index) => {
          // Remove any existing listeners
          input.removeEventListener('input', window.simpleAutoSave);
          input.removeEventListener('change', window.simpleAutoSave);
          
          // Add listeners
          input.addEventListener('input', window.simpleAutoSave);
          input.addEventListener('change', window.simpleAutoSave);
        });
        
        console.log('üöÄ IMMEDIATE auto-save setup complete!');
        
        // ADDITIONAL SETUP: Run auto-save setup multiple times to ensure it works
        setTimeout(() => {
          console.log('üöÄ Additional auto-save setup attempt...');
          const form2 = document.getElementById('hotel-form');
          if (form2) {
            const inputs2 = form2.querySelectorAll('input, select, textarea');
            console.log('üöÄ Additional setup found', inputs2.length, 'inputs');
            
            inputs2.forEach((input, index) => {
              if (index < 5) { // Only log first 5 for debugging
                console.log('üöÄ Input', index, ':', input.name || input.id, 'type:', input.type);
              }
              
              // Add a simple test listener (but not for address fields)
              if (!input.name || (!input.name.includes('address') && !input.name.includes('management_company_address'))) {
                input.addEventListener('input', function() {
                  console.log('üöÄ INPUT EVENT on:', this.name || this.id, 'value:', this.value);
                  // Show immediate notification
                  const toast = document.createElement('div');
                  toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#ef4444; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-size:0.8rem; font-weight:600;';
                  toast.textContent = 'üö® INPUT DETECTED';
                  document.body.appendChild(toast);
                  setTimeout(() => toast.remove(), 1000);
                });
              }
            });
          }
        }, 2000);
        
        // IMMEDIATE RESTORATION: Load saved data immediately
        console.log('üöÄ IMMEDIATE RESTORATION: Loading saved data...');
        const savedDraft = localStorage.getItem('hotel_registration_draft');
        if (savedDraft) {
          try {
            const draftData = JSON.parse(savedDraft);
            if (draftData.formData && Object.keys(draftData.formData).length > 0) {
              console.log('üöÄ IMMEDIATE RESTORATION: Found saved data with', Object.keys(draftData.formData).length, 'fields');
              
              // Restore form data
              for (const [key, value] of Object.entries(draftData.formData)) {
                if (key === 'form_type') continue;
                
                const elements = form.querySelectorAll(`[name="${key}"]`);
                elements.forEach((el, index) => {
                  // Skip file inputs - they can only be set to empty string
                  if (el.type === 'file') return;
                  
                  if (Array.isArray(value)) {
                    if (index < value.length) {
                      if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = el.value === value[index];
                      } else {
                        el.value = value[index];
                      }
                    }
                  } else {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                      el.checked = el.value === value;
                    } else {
                      el.value = value;
                    }
                  }
                });
              }
              
              // Restore page location
              if (draftData.currentStep && draftData.currentStep >= 1) {
                current = draftData.currentStep;
                setActiveStep(current);
                console.log('üöÄ IMMEDIATE RESTORATION: Restored to page', current);
              }
              
              console.log('üöÄ IMMEDIATE RESTORATION: Data restored successfully!');
              
      // Ensure dependent UI updates after values are applied
      try { if (typeof updateBrandOptions === 'function') updateBrandOptions(); } catch(_e) {}
      try { if (typeof toggleAaaDiamond === 'function') toggleAaaDiamond(); } catch(_e) {}

              // Show restoration notification
              const toast = document.createElement('div');
              toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#3b82f6; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
              toast.textContent = '‚úÖ Your data has been restored!';
              document.body.appendChild(toast);
              
              setTimeout(() => {
                if (toast.parentNode) toast.remove();
              }, 3000);
              
            } else {
              console.log('üöÄ IMMEDIATE RESTORATION: No valid form data found');
            }
          } catch (e) {
            console.error('üöÄ IMMEDIATE RESTORATION error:', e);
          }
        } else {
          console.log('üöÄ IMMEDIATE RESTORATION: No saved draft found');
        }
        
      } else {
        console.error('üöÄ Form not found for immediate auto-save!');
      }
    }, 1000);
    
    // Initialize DOM elements
    form = document.getElementById('hotel-form');
    pages = Array.from(document.querySelectorAll('.page'));
    steps = Array.from(document.querySelectorAll('.step'));
    updateStepIndicators();
    
    // If we have a saved current page and setActiveStep is now available, restore it
    if (typeof current !== 'undefined' && current >= 0) {
      console.log('üéØ Restoring saved page after initialization:', current);
      setTimeout(() => {
        if (typeof setActiveStep === 'function') {
          setActiveStep(current);
        }
      }, 100);
    }
    
    // SIMPLE AUTO-SAVE SETUP - WORKS IMMEDIATELY
    if (form) {
      console.log('üöÄ Setting up SIMPLE auto-save...');
      
      // Add event listeners to all inputs
      const inputs = form.querySelectorAll('input, select, textarea');
      console.log('üöÄ Found', inputs.length, 'inputs');
      
      inputs.forEach(input => {
        input.addEventListener('input', simpleSave);
        input.addEventListener('change', simpleSave);
      });
      
      // Restore data immediately
      setTimeout(simpleRestore, 500);
      
      // Start 10-second auto-save
      setTimeout(() => {
        if (typeof window.startAutoSave === 'function') {
          window.startAutoSave();
        }
      }, 2000);
      
      console.log('üöÄ SIMPLE auto-save setup complete!');
    }
    backBtn = document.getElementById('backBtn');
    nextBtn = document.getElementById('nextBtn');
    submitBtn = document.getElementById('submitBtn');
    navHint = document.getElementById('navHint');
    
    // Make steps clickable for navigation
    const stepElements = document.querySelectorAll('.step');
    console.log('üîµ Found step elements:', stepElements.length);
    console.log('üîµ Step elements:', Array.from(stepElements).map((el, idx) => ({ index: idx, classes: el.className, text: el.textContent.trim() })));
    stepElements.forEach((stepEl, index) => {
      stepEl.style.cursor = 'pointer';
      stepEl.addEventListener('click', () => {
        // Steps are 0-indexed, pages are also 0-indexed (0,1,2,3,4,5,6,7)
        // Step 0 = Page 1 (Company Info), Step 1 = Page 2 (Sleeping Rooms), etc.
        const targetPage = index + 1; // Convert step index to page number (skip page 0)
        console.log('üîµ Step clicked - Step index:', index, 'Target page:', targetPage, 'Current page:', current);
        console.log('üîµ Step text:', stepEl.textContent.trim());
        console.log('üéØ Navigating to page:', targetPage, 'which should show:', targetPage === 1 ? 'Company Information' : targetPage === 2 ? 'Sleeping Room Details' : targetPage === 3 ? 'Meeting Space Details' : targetPage === 4 ? 'Amenities' : targetPage === 5 ? 'Terms & Uploads' : targetPage === 6 ? 'Review' : targetPage === 7 ? 'Submit' : 'Unknown');
        
        // SIMPLIFIED NAVIGATION - Allow free navigation between all pages
        console.log('üîµ Navigation allowed - calling setActiveStep with:', targetPage);
        if (typeof autoRestoreCompleted !== 'undefined') {
          autoRestoreCompleted = true;
        }
        setActiveStep(targetPage);
      });
    });
    console.log('‚úÖ Steps are now clickable');
    
    // Initialize other DOM elements
    addRoomBtn = document.getElementById('addRoomBtn');
    if (addRoomBtn) {
      console.log('üü¢ Setting up Meeting Spaces button');
      
      // Remove existing listeners to prevent duplicates
      const newAddRoomBtn = addRoomBtn.cloneNode(true);
      addRoomBtn.parentNode.replaceChild(newAddRoomBtn, addRoomBtn);
      addRoomBtn = newAddRoomBtn;
      
      addRoomBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üü¢ Add Room button clicked');
        addMeetingRoom();
      });
      
      console.log('üü¢ Meeting Spaces button listener attached successfully');
    } else {
      console.error('üü¢ Add Room button not found!');
    }
    
    // Meeting Spaces Save and Edit functionality
    const saveMeetingSpacesBtn = document.getElementById('save_meeting_spaces');
    const editMeetingSpacesBtn = document.getElementById('edit_meeting_spaces');
    const meetingSpacesSummary = document.getElementById('meeting_spaces_summary');
    const meetingSpacesTable = document.getElementById('meeting_spaces_table');
    const meetingTools = document.getElementById('meeting_tools');
    
    if (saveMeetingSpacesBtn) {
      saveMeetingSpacesBtn.addEventListener('click', function() {
        console.log('üü¢ Save Meeting Spaces button clicked');
        
        // Get all room data
        const rooms = document.querySelectorAll('.room');
        if (rooms.length === 0) {
          alert('Please add at least one meeting space before saving.');
          return;
        }
        
        // Build summary table
        buildMeetingSpacesSummary();
        
        // Hide the form and show summary
        meetingTools.style.display = 'none';
        meetingSpacesSummary.style.display = 'block';
      });
    }
    
    if (editMeetingSpacesBtn) {
      editMeetingSpacesBtn.addEventListener('click', function() {
        console.log('üü¢ Edit Meeting Spaces button clicked');
        
        // Show the form and hide summary
        meetingTools.style.display = 'block';
        meetingSpacesSummary.style.display = 'none';
      });
    }
    
    function buildMeetingSpacesSummary() {
      const rooms = document.querySelectorAll('.room');
      let tableHTML = `
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; border:1px solid #e5e7eb;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:left; font-weight:600;">Room Name</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">Banquet Rounds</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">Theater</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">Classroom</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">U-Shape</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">Cocktail Rounds</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">Crescent Rounds</th>
                <th style="padding:12px; border:1px solid #e5e7eb; text-align:center; font-weight:600;">Hollow Square</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      rooms.forEach((room, index) => {
        const roomName = room.querySelector('[name="room_name[]"]')?.value || `Room ${index + 1}`;
        const banquetRounds = room.querySelector('[name="cap_banquet_rounds[]"]')?.value || '';
        const theater = room.querySelector('[name="cap_theater[]"]')?.value || '';
        const classroom = room.querySelector('[name="cap_classroom[]"]')?.value || '';
        const ushape = room.querySelector('[name="cap_ushape[]"]')?.value || '';
        const cocktailRounds = room.querySelector('[name="cap_cocktail_rounds[]"]')?.value || '';
        const crescentRounds = room.querySelector('[name="cap_crescent_rounds[]"]')?.value || '';
        const hollowSquare = room.querySelector('[name="cap_hollow_square[]"]')?.value || '';
        
        tableHTML += `
          <tr>
            <td style="padding:12px; border:1px solid #e5e7eb; font-weight:500;">${roomName}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${banquetRounds || '-'}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${theater || '-'}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${classroom || '-'}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${ushape || '-'}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${cocktailRounds || '-'}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${crescentRounds || '-'}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; text-align:center;">${hollowSquare || '-'}</td>
          </tr>
        `;
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      meetingSpacesTable.innerHTML = tableHTML;
    }
    
    // Meeting Space Layout Upload functionality - Two-step process
    const saveLayoutBtn = document.getElementById('save_layout_btn');
    const extractLayoutBtn = document.getElementById('extract_layout_btn');
    const layoutUploadInput = document.getElementById('meeting_layout_upload');
    const layoutFileInfo = document.getElementById('layout_file_info');
    const savedFileName = document.getElementById('saved_file_name');
    const layoutUploadStatus = document.getElementById('layout_upload_status');
    const extractionProgress = document.getElementById('extraction_progress');
    
    let savedLayoutFile = null;
    
    // Step 1: Save the uploaded file
    if (saveLayoutBtn && layoutUploadInput) {
      saveLayoutBtn.addEventListener('click', function() {
        const file = layoutUploadInput.files[0];
        
        if (!file) {
          showUploadStatus('Please select a file to upload.', 'error');
          return;
        }
        
        // Validate file type
        const fileName = file.name.toLowerCase();
        const validTypes = ['.pdf', '.docx', '.png', '.jpg', '.jpeg'];
        const isValid = validTypes.some(ext => fileName.endsWith(ext));
        
        if (!isValid) {
          showUploadStatus('Invalid file type. Please upload PDF, DOCX, PNG, JPG, or JPEG files only.', 'error');
          return;
        }
        
        console.log('üíæ Saving meeting layout file:', file.name, 'Size:', (file.size / 1024).toFixed(2), 'KB');
        
        // Save file reference
        savedLayoutFile = file;
        
        // Show file info and extract button
        if (savedFileName) {
          savedFileName.textContent = file.name;
        }
        if (layoutFileInfo) {
          layoutFileInfo.style.display = 'block';
        }
        
        showUploadStatus('‚úÖ File saved successfully! Click "Extract Data" to process with AI.', 'success');
        
        console.log('‚úÖ File saved, ready for extraction');
      });
    }
    
    // Step 2: Extract data from saved file
    if (extractLayoutBtn) {
      extractLayoutBtn.addEventListener('click', async function() {
        if (!savedLayoutFile) {
          showUploadStatus('No file saved. Please upload and save a file first.', 'error');
          return;
        }
        
        console.log('ü§ñ Starting AI extraction for:', savedLayoutFile.name);
        
        // Show progress indicator
        if (extractionProgress) {
          extractionProgress.style.display = 'block';
        }
        if (layoutUploadStatus) {
          layoutUploadStatus.style.display = 'none';
        }
        
        // Determine file type from extension
        const fileName = savedLayoutFile.name.toLowerCase();
        let fileType = 'pdf';
        if (fileName.endsWith('.docx')) fileType = 'docx';
        else if (fileName.endsWith('.png') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg')) fileType = 'image';
        
        try {
          await extractMeetingRoomData(savedLayoutFile, fileType);
        } finally {
          // Hide progress indicator
          if (extractionProgress) {
            extractionProgress.style.display = 'none';
          }
        }
      });
    }
    
    const editUploadedLayoutBtn = document.getElementById('edit_uploaded_layout_btn');
    if (editUploadedLayoutBtn) {
      editUploadedLayoutBtn.addEventListener('click', function() {
        console.log('üü¢ Edit uploaded layout clicked');
        // Show the rooms section for editing
        const rooms = document.getElementById('rooms');
        if (rooms) {
          rooms.scrollIntoView({ behavior: 'smooth' });
        }
      });
    }
    
    // Helper function to add extracted rooms using the existing form template
    function displayExtractedRooms(rooms, includeNotes = false) {
      console.log('üìã Displaying', rooms.length, 'extracted rooms');
      
      const roomsContainer = document.getElementById('rooms');
      const roomTemplate = document.getElementById('room-template');
      
      if (!roomsContainer || !roomTemplate) {
        console.error('‚ùå Room container or template not found!');
        alert('Error: Room form template not found. Using fallback display.');
        return;
      }
      
      // Clear existing OCR-added rooms (not manually added ones)
      const existingOcrRooms = roomsContainer.querySelectorAll('.room[data-ocr-added="true"]');
      existingOcrRooms.forEach(r => r.remove());
      
      // Show AI notes summary if any
      if (includeNotes) {
        const notesWithContent = rooms.filter(r => r.notes);
        if (notesWithContent.length > 0) {
          const summaryDiv = document.createElement('div');
          summaryDiv.style.cssText = 'margin-bottom:16px; padding:12px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:6px;';
          summaryDiv.innerHTML = `
            <strong style="color:#92400e; display:block; margin-bottom:8px;">ü§ñ AI Processing Notes:</strong>
            ${notesWithContent.map(r => `<div style="margin:4px 0; color:#78350f; font-size:0.9rem;">‚Ä¢ <strong>${r.name}:</strong> ${r.notes}</div>`).join('')}
          `;
          const listDiv = document.getElementById('meeting-space-list');
          if (listDiv) {
            listDiv.innerHTML = '';
            listDiv.appendChild(summaryDiv);
          }
        }
      }
      
      // Add each room using the template
      rooms.forEach((room, index) => {
        const clone = roomTemplate.content.cloneNode(true);
        const roomDiv = clone.querySelector('.room');
        
        if (roomDiv) {
          roomDiv.setAttribute('data-ocr-added', 'true');
          
          // Set room name
          const nameInput = roomDiv.querySelector('[name="room_name[]"]');
          if (nameInput) nameInput.value = room.name || '';
          
          // Set level
          const levelInput = roomDiv.querySelector('[name="room_level[]"]');
          if (levelInput) levelInput.value = room.level || '';
          
          // Set area (sq ft)
          const sqftInput = roomDiv.querySelector('[name="room_area_sqft[]"]');
          if (sqftInput && room.sqFt) sqftInput.value = room.sqFt;
          
          // Set area (m¬≤) - auto-calculated
          const sqmInput = roomDiv.querySelector('[name="room_area_sqm[]"]');
          if (sqmInput && room.sqFt) sqmInput.value = (room.sqFt * 0.092903).toFixed(1);
          
          // Set dimensions
          const lengthInput = roomDiv.querySelector('[name="room_length_ft[]"]');
          if (lengthInput && room.lengthFt) lengthInput.value = room.lengthFt;
          
          const widthInput = roomDiv.querySelector('[name="room_width_ft[]"]');
          if (widthInput && room.widthFt) widthInput.value = room.widthFt;
          
          const ceilingInput = roomDiv.querySelector('[name="room_ceiling_ft[]"]');
          if (ceilingInput && room.ceilingFt) ceilingInput.value = room.ceilingFt;
          
          // Note: Features (pillar-free, natural light, divisible) will be set in separate table below
          
          // Set seating capacities - FIXED MAPPING!
          if (room.seating) {
            // Banquet
            const setBanquet = roomDiv.querySelector('[name="cap_banquet_rounds[]"]');
            if (setBanquet && room.seating.banquet) setBanquet.value = room.seating.banquet;
            
            // Theater - CHECK: was swapped with classroom!
            const setTheater = roomDiv.querySelector('[name="cap_theater[]"]');
            if (setTheater && room.seating.theater) setTheater.value = room.seating.theater;
            
            // Classroom - CHECK: was swapped with theater!
            const setClassroom = roomDiv.querySelector('[name="cap_classroom[]"]');
            if (setClassroom && room.seating.classroom) setClassroom.value = room.seating.classroom;
            
            // U-Shape
            const setUShape = roomDiv.querySelector('[name="cap_ushape[]"]');
            if (setUShape) {
              setUShape.value = room.seating.uShape || room.seating.ushape || '';
            }
            
            // Cocktail/Reception
            const setCocktail = roomDiv.querySelector('[name="cap_cocktail_rounds[]"]');
            if (setCocktail) {
              setCocktail.value = room.seating.cocktail || room.seating.reception || '';
            }
            
            // Crescent Rounds
            const setCrescent = roomDiv.querySelector('[name="cap_crescent_rounds[]"]');
            if (setCrescent && room.seating.crescent) setCrescent.value = room.seating.crescent;
            
            // Hollow Square
            const setHollow = roomDiv.querySelector('[name="cap_hollow_square[]"]');
            if (setHollow) {
              setHollow.value = room.seating.hollowSquare || room.seating.hollow_square || '';
            }
          }
          
          roomsContainer.appendChild(roomDiv);
          console.log(`‚úÖ Added room ${index + 1}: ${room.name}`);
        }
      });
      
      // Setup area conversion for newly added rooms
      if (typeof setupAreaConversion === 'function') {
        setupAreaConversion();
      }
      
      // Create features selection table
      createFeaturesTable(rooms);
      
      // Scroll to the rooms section
      roomsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Create a features selection table for all rooms
    function createFeaturesTable(rooms) {
      const listDiv = document.getElementById('meeting-space-list');
      if (!listDiv) return;
      
      // Remove old table if exists
      const oldTable = document.getElementById('ocr-features-table');
      if (oldTable) oldTable.remove();
      
      const tableDiv = document.createElement('div');
      tableDiv.id = 'ocr-features-table';
      tableDiv.style.cssText = 'margin:20px 0; padding:16px; background:#f9fafb; border:2px solid #e5e7eb; border-radius:8px;';
      
      tableDiv.innerHTML = `
        <h4 style="margin:0 0 12px 0; color:#1f2937; font-weight:600;">‚úì Room Features Selection</h4>
        <p style="margin:0 0 12px 0; color:#6b7280; font-size:0.9rem;">Check the applicable features for each room (leave unchecked if not applicable):</p>
        
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; border:1px solid #d1d5db;">
            <thead>
              <tr style="background:#f3f4f6;">
                <th style="padding:12px; border:1px solid #d1d5db; text-align:left; font-weight:600; min-width:200px;">Room Name</th>
                <th style="padding:12px; border:1px solid #d1d5db; text-align:center; font-weight:600; width:150px;">‚òë Pillar-Free</th>
                <th style="padding:12px; border:1px solid #d1d5db; text-align:center; font-weight:600; width:150px;">‚òë Natural Light</th>
                <th style="padding:12px; border:1px solid #d1d5db; text-align:center; font-weight:600; width:150px;">‚òë Divisible</th>
              </tr>
            </thead>
            <tbody>
              ${rooms.map((room, index) => `
                <tr data-room-index="${index}">
                  <td style="padding:12px; border:1px solid #d1d5db; font-weight:500;">${room.name || 'Room ' + (index + 1)}</td>
                  <td style="padding:12px; border:1px solid #d1d5db; text-align:center;">
                    <input type="checkbox" class="feature-pillar" data-room-index="${index}" 
                      style="width:20px; height:20px; cursor:pointer;">
                  </td>
                  <td style="padding:12px; border:1px solid #d1d5db; text-align:center;">
                    <input type="checkbox" class="feature-light" data-room-index="${index}"
                      style="width:20px; height:20px; cursor:pointer;">
                  </td>
                  <td style="padding:12px; border:1px solid #d1d5db; text-align:center;">
                    <input type="checkbox" class="feature-divisible" data-room-index="${index}"
                      style="width:20px; height:20px; cursor:pointer;">
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <button type="button" class="btn" style="margin-top:12px; background:#10b981; color:white;" onclick="applyFeaturesToRooms()">
          ‚úì Apply Features to Rooms
        </button>
      `;
      
      listDiv.appendChild(tableDiv);
    }
    
    // Apply selected features from table to actual form fields
    function applyFeaturesToRooms() {
      const allRooms = document.querySelectorAll('.room[data-ocr-added="true"]');
      
      allRooms.forEach((roomDiv, index) => {
        const pillarCheckbox = document.querySelector(`.feature-pillar[data-room-index="${index}"]`);
        const lightCheckbox = document.querySelector(`.feature-light[data-room-index="${index}"]`);
        const divisibleCheckbox = document.querySelector(`.feature-divisible[data-room-index="${index}"]`);
        
        // Update the select dropdowns in the actual form
        const pillarSelect = roomDiv.querySelector('[name="room_pillar_free[]"]');
        if (pillarSelect && pillarCheckbox) {
          pillarSelect.value = pillarCheckbox.checked ? 'Yes' : 'No';
        }
        
        const lightSelect = roomDiv.querySelector('[name="room_natural_light[]"]');
        if (lightSelect && lightCheckbox) {
          lightSelect.value = lightCheckbox.checked ? 'Yes' : 'No';
        }
        
        const divisibleSelect = roomDiv.querySelector('[name="room_divisible[]"]');
        if (divisibleSelect && divisibleCheckbox) {
          divisibleSelect.value = divisibleCheckbox.checked ? 'Yes' : 'No';
        }
      });
      
      alert('‚úÖ Features applied to all rooms!');
      
      // Scroll to rooms to show the changes
      const roomsContainer = document.getElementById('rooms');
      if (roomsContainer) {
        roomsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // AI OCR + Extraction
    const processFactSheetHybridBtn = document.getElementById('processFactSheetHybrid');
    console.log('üîç OCR Hybrid button found:', !!processFactSheetHybridBtn);
    if (processFactSheetHybridBtn) {
      console.log('‚úÖ Adding event listener to Hybrid OCR button');
      processFactSheetHybridBtn.addEventListener('click', async () => {
        console.log('üéØ Hybrid OCR button clicked!');
        const fileInput = document.getElementById('factSheet');
        if (!fileInput.files.length) {
          alert('Please upload a PDF or image file first.');
          return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('factSheet', file);

        // Validate file size (10MB limit)
        const maxSizeMB = 10;
        const maxSizeBytes = maxSizeMB * 1024 * 1024;
        if (file.size > maxSizeBytes) {
          alert(`File is too large. Maximum file size is ${maxSizeMB}MB.\n\nYour file: ${(file.size / (1024 * 1024)).toFixed(1)}MB\n\nPlease upload a smaller file or compress the PDF.`);
          return;
        }
        
        // Show loading state
        const statusDiv = document.getElementById('ocr-processing-status');
        const statusText = document.getElementById('ocr-status-text');
        processFactSheetHybridBtn.disabled = true;
        processFactSheetHybridBtn.textContent = '‚è≥ Processing...';
        statusDiv.style.display = 'block';
        statusText.textContent = 'üìÑ Reading your document...';

        try {
          // Simulate progress updates (actual progress comes from server logs)
          setTimeout(() => {
            if (statusDiv.style.display === 'block') {
              statusText.textContent = 'üîç Finding meeting rooms...';
            }
          }, 2000);
          
          setTimeout(() => {
            if (statusDiv.style.display === 'block') {
              statusText.textContent = 'ü§ñ AI is organizing the data...';
            }
          }, 5000);

          const response = await fetch('/uploadFactSheetHybrid', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to process file');
          }

          if (data.meetingRooms && data.meetingRooms.length) {
            displayExtractedRooms(data.meetingRooms, true);
            
            let message = `‚úÖ Successfully extracted ${data.meetingRooms.length} meeting room${data.meetingRooms.length > 1 ? 's' : ''}!\n\n‚ö†Ô∏è Please review the information below:\n‚Ä¢ Room names and square footage\n‚Ä¢ Dimensions and ceiling heights\n‚Ä¢ Seating capacities\n‚Ä¢ Room features (use the Features Table)\n\nScroll down to review and make any corrections.`;
            if (data.warning) {
              message += `\n\n‚ö†Ô∏è ${data.warning}`;
            }
            alert(message);
          } else {
            alert('Could not find meeting room information in this file.\n\nPlease try:\n‚Ä¢ A different file\n‚Ä¢ Or add rooms manually using the form above');
          }
        } catch (err) {
          console.error('üî¥ Error processing fact sheet:', err);
          alert('Unable to process the file.\n\n' + err.message + '\n\nPlease try:\n‚Ä¢ A different file\n‚Ä¢ Refreshing the page\n‚Ä¢ Or contact support if the issue persists');
        } finally {
          // Restore button state
          processFactSheetHybridBtn.disabled = false;
          processFactSheetHybridBtn.textContent = 'ü§ñ Extract Meeting Rooms with AI';
          statusDiv.style.display = 'none';
        }
      });
    }
    
    function showUploadStatus(message, type) {
      if (!layoutUploadStatus) return;
      
      const colors = {
        'info': '#3b82f6',
        'success': '#10b981',
        'error': '#ef4444',
        'warning': '#f59e0b'
      };
      
      layoutUploadStatus.innerHTML = `
        <div style="padding:8px 12px; border-radius:6px; background:${colors[type]}20; color:${colors[type]}; border:1px solid ${colors[type]}40; font-size:0.9rem;">
          ${message}
        </div>
      `;
      layoutUploadStatus.style.display = 'block';
    }
    
    async function extractMeetingRoomData(file, fileType) {
      console.log('üü¢ Processing file:', file.name, 'Size:', file.size, 'Type:', fileType);
      
      try {
        // Convert file to base64 for API processing
        const base64Data = await fileToBase64(file);
        console.log('üü¢ File converted to base64, size:', base64Data.length);
        
        // Call backend API for secure document processing
        const extractedRooms = await processDocumentWithBackend(file, fileType);
        
        if (extractedRooms && extractedRooms.length > 0) {
          // Clear existing rooms
          const roomsContainer = document.getElementById('rooms');
          if (roomsContainer) {
            roomsContainer.innerHTML = '';
          }
          
          // Add extracted rooms
          extractedRooms.forEach(roomData => {
            addMeetingRoomFromData(roomData);
          });
          
          // Show success message
          const roomCount = extractedRooms.length;
          let message = `Successfully extracted ${roomCount} meeting room${roomCount > 1 ? 's' : ''} from your ${fileType.toUpperCase()} file using AI processing!`;
          showUploadStatus(message, 'success');
          editUploadedLayoutBtn.style.display = 'inline-block';
          
          // Auto-save the extracted data
          setTimeout(() => {
            serializeMeetingRooms();
          }, 1000);
        } else {
          showUploadStatus('No meeting room data could be extracted from this document. Please try a different file or add rooms manually.', 'warning');
        }
        
      } catch (error) {
        console.error('üü¢ Error processing document:', error);
        showUploadStatus(`Error processing document: ${error.message}. Please try again or add rooms manually.`, 'error');
      }
    }
    
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // Remove data:type;base64, prefix
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }
    
    async function processDocumentWithBackend(file, fileType) {
      console.log('üü¢ Processing document with secure backend...');
      
      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('fileType', fileType);
        
        console.log('üü¢ Sending file to backend for processing:', file.name);
        
        // Include bearer token like the rest of the app
        const sessionId = (localStorage.getItem('sessionId') || localStorage.getItem('auth_session') || '').trim();
        const response = await fetch('/api/process-meeting-layout', {
          method: 'POST',
          body: formData,
          credentials: 'include', // send cookies/session for auth
          headers: sessionId ? { 'Authorization': `Bearer ${sessionId}` } : {}
        });
        
        if (!response.ok) {
          // Try to read structured error
          const errorData = await response.json().catch(() => ({}));
          if (response.status === 401) {
            // Session expired ‚Äì surface a clear message
            throw new Error('Backend processing error: 401 - Your session has expired. Please log in again.');
          }
          // Image-only legacy server fallback: convert PDF to image and retry
          const msg = (errorData && (errorData.error || errorData.message)) || '';
          if (response.status === 400 && /Only image types are supported/i.test(msg) && fileType === 'pdf') {
            console.warn('üü° Legacy server detected (image-only). Converting PDF to image and retrying...');
            // Convert PAGE 2 (user said data is on second page)
            const imageBlob = await pdfToImagePage(file, 2);
            const imgForm = new FormData();
            imgForm.append('file', imageBlob, (file.name || 'layout') + '.jpg');
            imgForm.append('fileType', 'image');
            const retry = await fetch('/api/process-meeting-layout', {
              method: 'POST',
              body: imgForm,
              credentials: 'include',
              headers: sessionId ? { 'Authorization': `Bearer ${sessionId}` } : {}
            });
            if (!retry.ok) {
              const retryErr = await retry.json().catch(() => ({}));
              throw new Error(`Backend processing error: ${retry.status} - ${retryErr.error || retry.statusText}`);
            }
            const retryData = await retry.json();
            if (retryData.success && Array.isArray(retryData.rooms)) {
              return retryData.rooms;
            }
          }
          throw new Error(`Backend processing error: ${response.status} - ${errorData.error || response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üü¢ Backend processing response:', data);
        
        if (data.success && Array.isArray(data.rooms)) {
          return data.rooms;
        } else {
          throw new Error(data.error || 'Invalid response from backend');
        }
      } catch (error) {
        console.error('üü¢ Backend processing error:', error);
        throw error;
      }
    }

    // Convert specific page of a PDF to JPEG Blob using PDF.js (works entirely client-side)
    async function pdfToImagePage(file, pageNum){
      // Lazy-load PDF.js from CDN if not present
      if (!(window.pdfjsLib && window.pdfjsLib.getDocument)) {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js';
          s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
        });
        // Worker (improves performance; optional)
        if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js';
        }
      }
      const arrayBuf = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: arrayBuf }).promise;
      const total = pdf.numPages || 1;
      const target = Math.min(Math.max(1, pageNum || 1), total);
      const page = await pdf.getPage(target);
      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width; canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      // To JPEG blob
      const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.92));
      return new File([blob], (file.name || 'layout') + '.jpg', { type: 'image/jpeg' });
    }
    
    function addMeetingRoomFromData(roomData) {
      const template = document.getElementById('room-template');
      const rooms = document.getElementById('rooms');
      
      if (!template || !rooms) return;
      
      const clone = template.content.cloneNode(true);
      const roomDiv = clone.querySelector('.room');
      
      // Fill in the room data
      const setValue = (selector, value) => {
        const element = roomDiv.querySelector(selector);
        if (element && value !== undefined) {
          element.value = value;
        }
      };
      
      setValue('[name="room_name[]"]', roomData.name);
      setValue('[name="room_level[]"]', roomData.level);
      setValue('[name="room_area_sqft[]"]', roomData.area_sqft);
      setValue('[name="room_area_sqm[]"]', (roomData.area_sqft / 10.76).toFixed(1));
      setValue('[name="room_length_ft[]"]', roomData.length_ft);
      setValue('[name="room_width_ft[]"]', roomData.width_ft);
      setValue('[name="room_ceiling_ft[]"]', roomData.ceiling_ft);
      setValue('[name="room_pillar_free[]"]', roomData.pillar_free);
      setValue('[name="room_natural_light[]"]', roomData.natural_light);
      setValue('[name="room_divisible[]"]', roomData.divisible);
      setValue('[name="cap_banquet_rounds[]"]', roomData.banquet_rounds);
      setValue('[name="cap_theater[]"]', roomData.theater);
      setValue('[name="cap_classroom[]"]', roomData.classroom);
      setValue('[name="cap_ushape[]"]', roomData.ushape);
      setValue('[name="cap_cocktail_rounds[]"]', roomData.cocktail_rounds);
      setValue('[name="cap_crescent_rounds[]"]', roomData.crescent_rounds);
      setValue('[name="cap_hollow_square[]"]', roomData.hollow_square);
      setValue('[name="room_built_in_av[]"]', roomData.built_in_av);
      setValue('[name="room_power[]"]', roomData.power);
      setValue('[name="room_loadin[]"]', roomData.loadin);
      
      // Add remove button functionality
      const removeBtn = clone.querySelector('.remove-room');
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          roomDiv.remove();
        });
      }
      
      // Setup area conversion
      setTimeout(() => {
        setupAreaConversion();
      }, 100);
      
      rooms.appendChild(clone);
    }
    
    // Meeting room data serialization functions
    function serializeMeetingRooms() {
      const rooms = document.querySelectorAll('.room');
      const roomData = [];
      
      rooms.forEach(room => {
        const data = {
          name: room.querySelector('[name="room_name[]"]')?.value || '',
          level: room.querySelector('[name="room_level[]"]')?.value || '',
          area_sqft: room.querySelector('[name="room_area_sqft[]"]')?.value || '',
          area_sqm: room.querySelector('[name="room_area_sqm[]"]')?.value || '',
          length_ft: room.querySelector('[name="room_length_ft[]"]')?.value || '',
          width_ft: room.querySelector('[name="room_width_ft[]"]')?.value || '',
          ceiling_ft: room.querySelector('[name="room_ceiling_ft[]"]')?.value || '',
          pillar_free: room.querySelector('[name="room_pillar_free[]"]')?.value || '',
          natural_light: room.querySelector('[name="room_natural_light[]"]')?.value || '',
          divisible: room.querySelector('[name="room_divisible[]"]')?.value || '',
          banquet_rounds: room.querySelector('[name="cap_banquet_rounds[]"]')?.value || '',
          theater: room.querySelector('[name="cap_theater[]"]')?.value || '',
          classroom: room.querySelector('[name="cap_classroom[]"]')?.value || '',
          ushape: room.querySelector('[name="cap_ushape[]"]')?.value || '',
          cocktail_rounds: room.querySelector('[name="cap_cocktail_rounds[]"]')?.value || '',
          crescent_rounds: room.querySelector('[name="cap_crescent_rounds[]"]')?.value || '',
          hollow_square: room.querySelector('[name="cap_hollow_square[]"]')?.value || '',
          built_in_av: room.querySelector('[name="room_built_in_av[]"]')?.value || '',
          power: room.querySelector('[name="room_power[]"]')?.value || '',
          loadin: room.querySelector('[name="room_loadin[]"]')?.value || ''
        };
        roomData.push(data);
      });
      
      const hiddenField = document.getElementById('meeting_rooms_json');
      if (hiddenField) {
        hiddenField.value = JSON.stringify(roomData);
        console.log('üíæ Serialized meeting rooms data:', roomData);
      }
    }
    
    function deserializeMeetingRooms() {
      const hiddenField = document.getElementById('meeting_rooms_json');
      if (!hiddenField || !hiddenField.value) return;
      
      try {
        const roomData = JSON.parse(hiddenField.value);
        console.log('üîÑ Deserializing meeting rooms data:', roomData);
        
        // Clear existing rooms
        const roomsContainer = document.getElementById('rooms');
        if (roomsContainer) {
          roomsContainer.innerHTML = '';
        }
        
        // Add rooms from saved data
        roomData.forEach(data => {
          addMeetingRoomFromData(data);
        });
        
        console.log('üîÑ Meeting rooms restored from saved data');
      } catch (e) {
        console.error('Error deserializing meeting rooms:', e);
      }
    }
    
    // Add serialization to room input changes
    function setupMeetingRoomAutosave() {
      const roomsContainer = document.getElementById('rooms');
      if (!roomsContainer) return;
      
      // Use event delegation for dynamic content
      roomsContainer.addEventListener('input', function(e) {
        if (e.target.matches('input, select')) {
          setTimeout(() => {
            serializeMeetingRooms();
          }, 500);
        }
      });
      
      roomsContainer.addEventListener('change', function(e) {
        if (e.target.matches('input, select')) {
          setTimeout(() => {
            serializeMeetingRooms();
          }, 500);
        }
      });
    }
    
    // Initialize meeting room autosave
    setupMeetingRoomAutosave();
    
    // API key management removed - now handled securely on backend
    
    // A/V Services conditional fields
    const avInHouse = document.getElementById('av_in_house');
    const avProviderSection = document.getElementById('av_provider_section');
    const avProviderName = document.getElementById('av_provider_name');
    const avOutsideAllowed = document.getElementById('av_outside_allowed');
    const avOutsideFeesSection = document.getElementById('av_outside_fees_section');
    const avOutsideFees = document.getElementById('av_outside_fees');
    
    if (avInHouse && avProviderSection && avProviderName) {
      avInHouse.addEventListener('change', function() {
        if (this.value === 'Yes') {
          avProviderSection.style.display = 'block';
          avProviderName.setAttribute('required', 'required');
        } else {
          avProviderSection.style.display = 'none';
          avProviderName.removeAttribute('required');
          avProviderName.value = ''; // Clear the field when hidden
        }
      });
      // Trigger on page load if already selected
      if (avInHouse.value === 'Yes') {
        avProviderSection.style.display = 'block';
        avProviderName.setAttribute('required', 'required');
      }
    }
    
    if (avOutsideAllowed && avOutsideFeesSection && avOutsideFees) {
      avOutsideAllowed.addEventListener('change', function() {
        if (this.value === 'Yes') {
          avOutsideFeesSection.style.display = 'block';
          avOutsideFees.setAttribute('required', 'required');
        } else {
          avOutsideFeesSection.style.display = 'none';
          avOutsideFees.removeAttribute('required');
          avOutsideFees.value = ''; // Clear the field when hidden
        }
      });
      // Trigger on page load if already selected
      if (avOutsideAllowed.value === 'Yes') {
        avOutsideFeesSection.style.display = 'block';
        avOutsideFees.setAttribute('required', 'required');
      }
    }
    
    rooms = document.getElementById('rooms');
    isExtendedStay = document.getElementById('is_extended_stay');
    if (isExtendedStay) {
      console.log('üè® Setting up Extended Stay listener');
      
      // Remove existing listeners
      const newExtendedStaySelect = isExtendedStay.cloneNode(true);
      isExtendedStay.parentNode.replaceChild(newExtendedStaySelect, isExtendedStay);
      isExtendedStay = newExtendedStaySelect;
      
      isExtendedStay.addEventListener('change', function() {
        console.log('üè® Extended Stay changed to:', this.value);
        toggleES();
        
        // Auto-save when Extended Stay selection changes
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('extended-stay-change');
          }, 500);
        }
      });
      
      // Initialize Extended Stay section based on current value
      console.log('üè® Initializing Extended Stay with current value:', isExtendedStay.value);
      setTimeout(() => {
        toggleES();
      }, 100);
    } else {
      console.error('üè® Extended Stay select not found!');
    }
    
    // Set up breakfast cost listener
    const breakfastSelect = document.getElementById('breakfast_included');
    if (breakfastSelect) {
      console.log('üç≥ Setting up breakfast cost listener');
      
      // Remove existing listeners
      const newBreakfastSelect = breakfastSelect.cloneNode(true);
      breakfastSelect.parentNode.replaceChild(newBreakfastSelect, breakfastSelect);
      
      newBreakfastSelect.addEventListener('change', function() {
        console.log('üç≥ Breakfast included changed to:', this.value);
        toggleBreakfastCost();
        
        // Auto-save when breakfast selection changes
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('breakfast-change');
          }, 500);
        }
      });
      
      // Initialize breakfast cost section based on current value
      console.log('üç≥ Initializing breakfast cost with current value:', newBreakfastSelect.value);
      setTimeout(() => {
        toggleBreakfastCost();
      }, 100);
    } else {
      console.error('üç≥ Breakfast select not found!');
    }
    
    // Set up suites functionality
    const hasSuitesSelect = document.getElementById('has_suites');
    const suitesSection = document.getElementById('suites_section');
    const suitesContainer = document.getElementById('suites_container');
    const addSuiteBtn = document.getElementById('addSuiteBtn');
    const suitesTotalDiv = document.getElementById('suites_total');
    const suitesTotalCount = document.getElementById('suites_total_count');
    
    let suiteIndex = 0;
    
    function addSuiteRow() {
      const row = document.createElement('div');
      row.className = 'suite-entry-row';
      row.style.marginBottom = '16px';
      row.style.padding = '16px';
      row.style.border = '1px solid #e5e7eb';
      row.style.borderRadius = '8px';
      row.style.backgroundColor = '#f9fafb';
      row.setAttribute('data-suite-index', suiteIndex);
      row.setAttribute('data-suite-status', 'editing');
      
      row.innerHTML = `
        <div class="suite-form-view">
          <div class="row">
            <div class="col-3">
              <label>Suite Type <span class="required">*</span></label>
              <select name="suite_type_${suiteIndex}" class="suite-type-select" required>
                <option value="">Select suite type</option>
                <option value="Studio Suite">Studio Suite</option>
                <option value="1 Bedroom Suite">1 Bedroom Suite</option>
                <option value="2 Bedroom Suite">2 Bedroom Suite</option>
              </select>
            </div>
            <div class="col-2">
              <label>Quantity <span class="required">*</span></label>
              <input type="number" name="suite_quantity_${suiteIndex}" class="suite-quantity" min="1" value="1" required />
            </div>
            <div class="col-2">
              <label>Real Beds <span class="required">*</span></label>
              <input type="number" name="suite_beds_${suiteIndex}" class="suite-beds" min="1" value="1" required />
            </div>
            <div class="col-2">
              <label>Sofa Bed? <span class="required">*</span></label>
              <select name="suite_sofa_bed_${suiteIndex}" class="suite-sofa-bed" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-3" style="display:flex; align-items:flex-end; gap:8px;">
              <button type="button" class="btn done-suite-btn" style="background:#10b981; color:white; padding:10px 16px;">Save</button>
              <button type="button" class="btn ghost remove-suite-btn" style="background:#dc2626; color:white; padding:10px 16px;">Delete</button>
            </div>
          </div>
        </div>
        
        <div class="suite-display-view" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div class="suite-display-summary" style="font-size:0.95rem; color:#1f2937;">
              <strong class="suite-display-type"></strong> ¬∑ 
              <span class="suite-display-quantity"></span> suite(s) ¬∑ 
              <span class="suite-display-beds"></span> bed(s) each ¬∑ 
              Sofa bed: <span class="suite-display-sofa-bed"></span>
            </div>
            <button type="button" class="btn ghost edit-suite-btn" style="padding:8px 12px;">Edit</button>
          </div>
        </div>
      `;
      
      suitesContainer.appendChild(row);
      
      const typeSelect = row.querySelector('.suite-type-select');
      const quantityInput = row.querySelector('.suite-quantity');
      const bedsInput = row.querySelector('.suite-beds');
      const sofaBedSelect = row.querySelector('.suite-sofa-bed');
      const doneBtn = row.querySelector('.done-suite-btn');
      const editBtn = row.querySelector('.edit-suite-btn');
      const removeBtn = row.querySelector('.remove-suite-btn');
      const formView = row.querySelector('.suite-form-view');
      const displayView = row.querySelector('.suite-display-view');
      
      const syncRemoveVisibility = () => {
        const status = row.getAttribute('data-suite-status') || 'editing';
        if (status === 'saved') {
          row.style.padding = '12px 16px';
          row.style.marginBottom = '10px';
          row.style.display = 'block';
        } else {
          row.style.padding = '16px';
          row.style.marginBottom = '16px';
        }
        if (removeBtn) {
          removeBtn.style.display = status === 'saved' ? 'none' : 'inline-block';
        }
      };
      syncRemoveVisibility();
      
      // Handle Done button
      doneBtn.addEventListener('click', function() {
        if (!typeSelect.value || !quantityInput.value || !bedsInput.value || !sofaBedSelect.value) {
          alert('Please fill in all required fields');
          return;
        }
        
        // Update display view
        row.querySelector('.suite-display-type').textContent = typeSelect.value;
        row.querySelector('.suite-display-quantity').textContent = quantityInput.value;
        row.querySelector('.suite-display-beds').textContent = bedsInput.value;
        row.querySelector('.suite-display-sofa-bed').textContent = sofaBedSelect.value;
        
        // Switch to display view
        formView.style.display = 'none';
        displayView.style.display = 'block';
        row.setAttribute('data-suite-status', 'saved');
        row.style.backgroundColor = '#fff';
        syncRemoveVisibility();
        
        updateSuitesTotal();
      });
      
      // Handle Edit button
      editBtn.addEventListener('click', function() {
        formView.style.display = 'block';
        displayView.style.display = 'none';
        row.setAttribute('data-suite-status', 'editing');
        row.style.backgroundColor = '#f9fafb';
        syncRemoveVisibility();
      });
      
      // Handle Remove button (hidden in condensed view but kept for safety)
      if (removeBtn) {
        removeBtn.style.display = 'none';
        removeBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to remove this suite entry?')) {
            row.remove();
            updateSuitesTotal();
          }
        });
      }
      
      // Handle quantity change
      quantityInput.addEventListener('input', function() {
        if (row.getAttribute('data-suite-status') === 'saved') {
          updateSuitesTotal();
        }
      });
      
      suiteIndex++;
    }
    
    function updateSuitesTotal() {
      let total = 0;
      document.querySelectorAll('.suite-quantity').forEach(input => {
        const val = parseInt(input.value) || 0;
        total += val;
      });
      
      suitesTotalCount.textContent = total;
      
      if (total > 0) {
        suitesTotalDiv.style.display = 'block';
      } else {
        suitesTotalDiv.style.display = 'none';
      }
    }
    
    if (hasSuitesSelect) {
      hasSuitesSelect.addEventListener('change', function() {
        if (this.value === 'Yes') {
          suitesSection.style.display = 'block';
          // Add first row if container is empty
          if (suitesContainer.children.length === 0) {
            addSuiteRow();
          }
        } else {
          suitesSection.style.display = 'none';
          // Clear all suite rows
          suitesContainer.innerHTML = '';
          suiteIndex = 0;
        }
      });
    }
    
    if (addSuiteBtn) {
      addSuiteBtn.addEventListener('click', addSuiteRow);
    }
    
    // Set up ADA rooms functionality
    const hasAdaRoomsSelect = document.getElementById('has_ada_rooms');
    const adaRoomsSection = document.getElementById('ada_rooms_section');
    const adaRoomsContainer = document.getElementById('ada_rooms_container');
    const addAdaRoomBtn = document.getElementById('addAdaRoomBtn');
    const adaRoomsTotalDiv = document.getElementById('ada_rooms_total');
    const adaRoomsTotalCount = document.getElementById('ada_rooms_total_count');
    
    let adaRoomIndex = 0;
    
    function addAdaRoomRow() {
      const row = document.createElement('div');
      row.className = 'row';
      row.style.marginBottom = '12px';
      row.style.padding = '12px';
      row.style.border = '1px solid #e5e7eb';
      row.style.borderRadius = '8px';
      row.style.backgroundColor = '#f9fafb';
      row.setAttribute('data-ada-room-index', adaRoomIndex);
      
      row.innerHTML = `
        <div class="col-3">
          <label>ADA Room Type <span class="required">*</span></label>
          <select name="ada_room_type_${adaRoomIndex}" class="ada-room-type-select" required>
            <option value="">Select ADA room type</option>
            <option value="Single Occupancy">Single Occupancy</option>
            <option value="Double Occupancy">Double Occupancy</option>
            <option value="Studio">Studio</option>
            <option value="1 Bedroom Suite">1 Bedroom Suite</option>
            <option value="2 Bedroom Suite">2 Bedroom Suite</option>
          </select>
        </div>
        <div class="col-2">
          <label>Quantity <span class="required">*</span></label>
          <input type="number" name="ada_room_quantity_${adaRoomIndex}" class="ada-room-quantity" min="1" value="1" required />
        </div>
        <div class="col-2">
          <label>Real Beds <span class="required">*</span></label>
          <input type="number" name="ada_room_beds_${adaRoomIndex}" class="ada-room-beds" min="1" value="1" required />
        </div>
        <div class="col-2">
          <label>Sofa Bed? <span class="required">*</span></label>
          <select name="ada_room_sofa_bed_${adaRoomIndex}" class="ada-room-sofa-bed" required>
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="col-3" style="display:flex; align-items:flex-end;">
          <button type="button" class="btn ghost remove-ada-room-btn" style="background:#dc2626; color:white;">Remove</button>
        </div>
      `;
      
      adaRoomsContainer.appendChild(row);
      
      // Handle quantity change
      const quantityInput = row.querySelector('.ada-room-quantity');
      quantityInput.addEventListener('input', function() {
        updateAdaRoomsTotal();
        updateTotalRooms();
      });
      
      // Handle remove button
      const removeBtn = row.querySelector('.remove-ada-room-btn');
      removeBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to remove this ADA room entry?')) {
          row.remove();
          updateAdaRoomsTotal();
          updateTotalRooms();
        }
      });
      
      adaRoomIndex++;
      updateAdaRoomsTotal();
      updateTotalRooms();
    }
    
    function updateAdaRoomsTotal() {
      let total = 0;
      document.querySelectorAll('.ada-room-quantity').forEach(input => {
        const val = parseInt(input.value) || 0;
        total += val;
      });
      
      adaRoomsTotalCount.textContent = total;
      
      if (total > 0) {
        adaRoomsTotalDiv.style.display = 'block';
      } else {
        adaRoomsTotalDiv.style.display = 'none';
      }
      
      return total;
    }
    
    if (hasAdaRoomsSelect) {
      hasAdaRoomsSelect.addEventListener('change', function() {
        if (this.value === 'Yes') {
          adaRoomsSection.style.display = 'block';
          // Add first row if container is empty
          if (adaRoomsContainer.children.length === 0) {
            addAdaRoomRow();
          }
        } else {
          adaRoomsSection.style.display = 'none';
          // Clear all ADA room rows
          adaRoomsContainer.innerHTML = '';
          adaRoomIndex = 0;
          updateTotalRooms();
        }
      });
    }
    
    if (addAdaRoomBtn) {
      addAdaRoomBtn.addEventListener('click', addAdaRoomRow);
    }
    // Function to update total rooms
    function updateTotalRooms() {
      const kingRooms = parseInt(document.getElementById('king_rooms')?.value) || 0;
      const doubleRooms = parseInt(document.getElementById('double_rooms')?.value) || 0;
      
      // Get suite totals
      let suitesTotal = 0;
      document.querySelectorAll('.suite-quantity').forEach(input => {
        suitesTotal += parseInt(input.value) || 0;
      });
      
      // Get ADA room totals
      let adaTotal = 0;
      document.querySelectorAll('.ada-room-quantity').forEach(input => {
        adaTotal += parseInt(input.value) || 0;
      });
      
      const total = kingRooms + doubleRooms + suitesTotal + adaTotal;
      
      const totalRoomsInput = document.getElementById('total_rooms');
      if (totalRoomsInput) {
        totalRoomsInput.value = total;
      }
    }
    
    // Add listeners to room count inputs
    const kingRoomsInput = document.getElementById('king_rooms');
    const doubleRoomsInput = document.getElementById('double_rooms');
    
    if (kingRoomsInput) {
      kingRoomsInput.addEventListener('input', updateTotalRooms);
    }
    if (doubleRoomsInput) {
      doubleRoomsInput.addEventListener('input', updateTotalRooms);
    }
    
    // Update suite total calculation to also update total rooms
    const originalUpdateSuitesTotal = updateSuitesTotal;
    updateSuitesTotal = function() {
      originalUpdateSuitesTotal();
      updateTotalRooms();
    };
    
    acceptsNet30 = document.getElementById('accepts_net30');
    hasOutdoorFacility = document.getElementById('has_outdoor_facility');
    isAaaRated = document.getElementById('is_aaa_rated');
    hotelLocationType = document.getElementById('hotel_location_type');
    if (hotelLocationType) {
      console.log('üè¶ Setting up hotel location type change listener');
      
      // Remove any existing listeners
      const newLocationSelect = hotelLocationType.cloneNode(true);
      hotelLocationType.parentNode.replaceChild(newLocationSelect, hotelLocationType);
      hotelLocationType = newLocationSelect;
      
      hotelLocationType.addEventListener('change', function() {
        console.log('üè¶ Hotel location type changed to:', this.value);
        toggleBankSections();
        
        // Auto-save when user changes location type
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('location-change');
          }, 500);
        }
      });
      
      // Initialize bank sections based on current value
      console.log('üè¶ Initializing bank sections with current value:', hotelLocationType.value);
      setTimeout(() => {
        toggleBankSections();
      }, 100);
    } else {
      console.error('üè¶ Hotel location type select not found!');
    }
    saveDraftBtn = document.getElementById('saveDraftBtn');
    loadDraftBtn = document.getElementById('loadDraftBtn');
    discardDraftBtn = document.getElementById('discardDraftBtn');
    draftStatus = document.getElementById('draftStatus');
    draftInfo = document.getElementById('draftInfo');
    
    console.log('DOM elements initialized:', { 
      pages: pages.length, 
      steps: steps.length, 
      nextBtn: !!nextBtn,
      form: !!form,
      addRoomBtn: !!addRoomBtn
    });
    
    // Check authentication for signed-in users
    const urlParams = new URLSearchParams(window.location.search);
    const signedInParam = urlParams.get('signedIn');
    
    if (signedInParam === 'true') {
      // Prefer signed-in flow if a session exists; otherwise fall back to guest mode on page 1
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('signedIn=true but no session found; falling back to guest mode and showing page 1');
        if (typeof showToast === 'function') {
          try { showToast('Continuing without sign-in ‚Äî showing page 1'); } catch (e) {}
        }
      } else {
        // Verify session is still valid first using /api/auth/me
        try {
          const authResponse = await fetch('/api/auth/me', {
            headers: {
              'Authorization': `Bearer ${sessionId}`
            }
          });
          
          if (!authResponse.ok) {
            // Session is invalid; clear and continue in guest mode
            await authResponse.json().catch(() => ({}));
            console.warn('Session invalid; clearing and continuing in guest mode');
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            localStorage.removeItem('fedevent_hotel');
          } else {
            const authData = await authResponse.json();
            // Check if user has hotel role
            if (!authData.user || authData.user.role !== 'hotel') {
              console.warn('Non-hotel account; continuing in guest mode');
            } else {
              // Store user data if not already present
              const userData = localStorage.getItem('fedevent_user');
              if (!userData) {
                localStorage.setItem('fedevent_user', JSON.stringify(authData.user));
              }
              // Try to get hotel profile data (but don't fail if hotel_id is null)
              if (authData.user.hotel_id) {
                try {
                  const profileResponse = await fetch('/api/hotel/profile', {
                    headers: {
                      'Authorization': `Bearer ${sessionId}`
                    }
                  });
                  if (profileResponse.ok) {
                    await profileResponse.json();
                  }
                } catch (profileError) {
                  console.log('Could not load hotel profile data, continuing without it');
                }
              }
              // Display user info
              const userInfoDiv = document.getElementById('userInfo');
              const userDisplayName = document.getElementById('userDisplayName');
              if (userInfoDiv && userDisplayName) {
                try {
                  const storedUserData = localStorage.getItem('fedevent_user') || JSON.stringify(authData.user);
                  const user = JSON.parse(storedUserData);
                  if (user) {
                    let displayText = user.username || 'User';
                    if (user.fedevent_account_number) {
                      displayText += ` (${user.fedevent_account_number})`;
                    }
                    userDisplayName.textContent = displayText;
                    userInfoDiv.style.display = 'flex';
                    const backToProfileBtn = document.getElementById('backToProfileBtn');
                    if (backToProfileBtn) backToProfileBtn.style.display = 'inline-block';
                  }
                } catch (e) {
                  console.error('Error displaying user info:', e);
                }
              }
            }
          }
        } catch (error) {
          console.error('Authentication verification failed, continuing in guest mode:', error);
        }
      }
    }
    
    // Initialize Google Places API (with error handling) - moved to after page initialization
    // This will be called after the page is properly initialized
    
    // Check if user is continuing from dashboard
    console.log('Checking continue mode...');
    if (await checkContinueMode()) {
      console.log('Continue mode detected, user is signed in');
      // User is approved and continuing - start auto-save
      startAutoSave();
      setupAutoSaveOnInput(); // Set up auto-save on input changes
      updateDraftStatus();
    } else {
      console.log('No continue mode, setting default page to 1');
      // Default initialization - start at page 1
      setActiveStep(1);
    }
    
    console.log('Page initialization complete, current page:', current);
    
    // Ensure page 1 is visible (fallback)
    if (current === 0 || !document.querySelector('.page.active')) {
      console.log('Fallback: Setting page to 1');
      setActiveStep(1);
    }
    
    // DELAYED AUTO-RESTORE FROM LOCALSTORAGE - Wait for all initialization to complete
    console.log('üîÑ Scheduling delayed auto-restore from localStorage...');
    setTimeout(() => {
      console.log('üîÑ Starting delayed auto-restore from localStorage...');
      try {
        // Try multiple localStorage keys for maximum reliability
        const restoreKeys = [
          'hotel_registration_draft',
          `hotel_registration_draft_${currentUserId || 'anonymous'}`,
          ...Object.keys(localStorage).filter(key => key.startsWith('hotel_registration_backup_')).sort().slice(-1)
        ];
        
        let restored = false;
        for (const key of restoreKeys) {
          const savedData = localStorage.getItem(key);
          if (savedData) {
            try {
              const draftData = JSON.parse(savedData);
              if (draftData.formData && Object.keys(draftData.formData).length > 0) {
                console.log('üîÑ Restoring from key:', key, 'with', Object.keys(draftData.formData).length, 'fields');
                setFormData(draftData.formData);
                
                // Restore page location
                if (draftData.currentStep !== undefined && draftData.currentStep >= 1) {
                  current = draftData.currentStep;
                  setActiveStep(current);
                  console.log('üîÑ Restored to page:', current);
                }
                
                restored = true;
              
              // Show success message
              if (signedIn || window.signedIn) {
                showToast('‚úÖ Your previous progress has been restored!');
              }
              
              break; // Stop after first successful restore
            }
          } catch (e) {
            console.warn('Failed to restore from key:', key, e);
          }
        }
      }
      
      // Also restore current page from dedicated storage
      const savedPage = localStorage.getItem('hotel_registration_current_page');
      if (savedPage && !restored) {
        const pageNum = parseInt(savedPage);
        if (!isNaN(pageNum) && pageNum >= 1) {
          current = pageNum;
          setActiveStep(current);
          console.log('üîÑ Restored page location only:', pageNum);
        }
      }
      
      if (restored) {
        // Update status indicators
        const lastSave = localStorage.getItem('hotel_registration_last_save');
        if (lastSave) {
          const autoSaveStatus = document.getElementById('autoSaveStatus');
          if (autoSaveStatus) {
            const saveDate = new Date(lastSave);
            autoSaveStatus.textContent = `Last saved: ${saveDate.toLocaleTimeString()}`;
          }
        }
        
        console.log('üîÑ Auto-restore completed successfully');
      } else {
        console.log('üîÑ No saved data found to restore');
      }
      
      } catch (error) {
        console.error('üîÑ Auto-restore failed:', error);
      }
    }, 2000); // Wait 2 seconds for all initialization to complete
    
    // Additional restoration attempt for server drafts (runs even later)
    setTimeout(() => {
      if (signedIn || window.signedIn) {
        console.log('üîÑ Attempting late server draft restoration...');
        loadExistingDraft().catch(e => console.log('Late draft restoration failed:', e));
      }
    }, 3000);
    
    // Final restoration attempt with even more delay (for edge cases)
    setTimeout(() => {
      if (signedIn || window.signedIn && currentUserId) {
        console.log('üîÑ Final restoration attempt...');
        // Check if form has any data, if not, try to restore again
        const hotelName = document.querySelector('[name="hotel_name"]');
        if (hotelName && !hotelName.value) {
          console.log('üîÑ Form appears empty, attempting final restoration...');
          loadExistingDraft().catch(e => console.log('Final restoration failed:', e));
        }
      }
    }, 5000);
    
    // Final check - force page 1 to be visible
    setTimeout(() => {
      const activePage = document.querySelector('.page.active');
      if (!activePage) {
        console.log('Emergency fallback: No active page found, forcing page 1');
        setActiveStep(1);
      } else {
        console.log('Active page found:', activePage.getAttribute('data-page'));
      }
    }, 200);
    
    // Initialize Google Places API after page is set up
    setTimeout(async () => {
      try {
        console.log('Initializing Google Places API...');
        await initializeGooglePlaces();
        console.log('Google Places API initialized successfully');
      } catch (error) {
        console.error('Google Places API initialization failed:', error);
        // Don't let this prevent the page from loading
      }
    }, 100);
    
    // Add save draft buttons to all pages (except first page)
    pages.forEach((page, index) => {
      if (index > 0) { // Skip first page
        const navSection = page.querySelector('.nav');
        if (navSection && !page.querySelector('.save-draft-btn')) {
          const saveDraftBtn = document.createElement('button');
          saveDraftBtn.type = 'button';
          saveDraftBtn.className = 'btn subtle save-draft-btn';
          saveDraftBtn.textContent = 'üíæ Save Draft';
          saveDraftBtn.style.marginLeft = 'auto';
          saveDraftBtn.onclick = saveDraft;
          navSection.insertBefore(saveDraftBtn, navSection.firstChild);
        }
      }
    });
    
    // Wire Next/Back navigation
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        console.log('üîµ Next button clicked');
        console.log('üîµ Current page:', current);
        console.log('üîµ Total pages:', pages.length);
        console.log('üîµ Pages array:', pages.map((p, i) => `${i}:data-page=${p.getAttribute('data-page')}`));
        console.log('üîµ Validating current page...');
        
        try {
          if (!validateCurrentPage()) {
            console.log('üîµ Validation failed');
            return;
          }
          console.log('üîµ Validation passed');
        } catch (error) {
          console.error('üîµ Validation error, allowing navigation:', error);
          // Allow navigation even if validation fails to prevent page freeze
        }
        
        // Disable conflicting validation from missing-functions-fix.js
        if (window.validateRequiredFields) {
          console.log('üîµ Disabling conflicting validation...');
          window.validateRequiredFields = function() { return true; };
        }
        const last = pages.length - 1;
        const nextPage = current + 1;
        console.log('üîµ Next page will be:', nextPage);
        if (current < last) {
          if (typeof autoRestoreCompleted !== 'undefined') {
            autoRestoreCompleted = true;
          }
          setActiveStep(nextPage);
        } else {
          console.log('üîµ Already at last page');
        }
      });
    }
    
    if (backBtn) {
      // Remove existing listeners to prevent duplicates
      const newBackBtn = backBtn.cloneNode(true);
      backBtn.parentNode.replaceChild(newBackBtn, backBtn);
      backBtn = newBackBtn;
      
      backBtn.addEventListener('click', () => {
        console.log('Back button clicked, current page:', current);
        if (current > 0) { // Allow going back from any page except page 0 (hidden page)
          if (typeof autoRestoreCompleted !== 'undefined') {
            autoRestoreCompleted = true;
          }
          setActiveStep(current - 1);
          console.log('Navigated back to page:', current - 1);
        } else {
          console.log('Already at first page (page 0), cannot go back');
        }
      });
      console.log('‚úÖ Back button initialized');
    }

    const initialStep = current && current >= 0 ? current : 0;
    setActiveStep(initialStep);
    
    // Live validation for Primary Contacts roles to prevent duplicate or invalid combinations
    const roleSel0 = document.querySelector('[name="sign_contacts[0][role]"]');
    const roleSel1 = document.querySelector('[name="sign_contacts[1][role]"]');
    const signErr  = document.getElementById('signContactsError');
    
    console.log('Role validation setup:', {
      roleSel0: !!roleSel0,
      roleSel1: !!roleSel1,
      signErr: !!signErr
    });
    
    if (!roleSel0 || !roleSel1) {
      console.error('Role selectors not found! Cannot set up validation.');
      return;
    }
    
    function checkForDuplicateRoles(changedElement) {
      const role0 = roleSel0.value;
      const role1 = roleSel1.value;
      
      console.log('Checking roles:', { role0, role1, changedElement: changedElement?.name });
      
      // If both roles are selected and they're the same
      if (role0 && role1 && role0 === role1) {
        console.log('DUPLICATE ROLES DETECTED!');
        
        // Show alert immediately
        alert('‚ö†Ô∏è ROLE CONFLICT!\n\nYou cannot assign the same role to both contacts.\n\nPlease choose:\n‚Ä¢ "Signer" for one contact\n‚Ä¢ "Approver" for the other contact\n\nThe conflicting selection will be cleared.');
        
        // Clear the field that was just changed
        if (changedElement) {
          console.log('Clearing changed element:', changedElement.name);
          changedElement.value = '';
          changedElement.focus();
        }
        
        // Show visual error
        if (signErr) {
          signErr.style.display = 'block';
          signErr.style.color = '#dc3545';
          signErr.style.backgroundColor = '#f8d7da';
          signErr.style.border = '1px solid #f5c2c7';
          signErr.style.borderRadius = '8px';
          signErr.style.padding = '12px';
          signErr.style.marginTop = '8px';
          signErr.innerHTML = '<strong>‚ö†Ô∏è Role Conflict:</strong> Each contact must have a different role. Please select one Signer and one Approver.';
        }
        
        return true; // Indicates duplicate found
      }
      
      // Clear error if roles are valid
      if (signErr) {
        signErr.style.display = 'none';
      }
      
      return false; // No duplicates
    }
    
    // Direct event handlers
    function handleRole0Change(e) {
      console.log('Role 0 changed to:', e.target.value);
      checkForDuplicateRoles(e.target);
    }
    
    function handleRole1Change(e) {
      console.log('Role 1 changed to:', e.target.value);
      checkForDuplicateRoles(e.target);
    }
    
    // Remove any existing listeners and add new ones
    roleSel0.removeEventListener('change', handleRole0Change);
    roleSel0.addEventListener('change', handleRole0Change);
    console.log('Role 0 change listener attached');
    
    roleSel1.removeEventListener('change', handleRole1Change);
    roleSel1.addEventListener('change', handleRole1Change);
    console.log('Role 1 change listener attached');
    
    // Test the validation immediately after setup
    setTimeout(() => {
      console.log('Testing role validation setup...');
      console.log('Role 0 current value:', roleSel0.value);
      console.log('Role 1 current value:', roleSel1.value);
      if (roleSel0.value && roleSel1.value) {
        checkForDuplicateRoles(null);
      }
    }, 1000);
    
    // Hotel main photo preview and validation with smart compression
    const hotelPhotoInput = document.getElementById('hotel_main_photo');
    const photoPreview = document.getElementById('photo_preview');
    const previewImage = document.getElementById('preview_image');
    const photoInfo = document.getElementById('photo_info');
    
    // Image compression function
    async function compressImage(file, maxSizeMB = 2, maxWidth = 2400, quality = 0.85) {
      return new Promise((resolve, reject) => {
        // If file is already small enough, return it as-is
        if (file.size <= maxSizeMB * 1024 * 1024) {
          resolve(file);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            // Calculate new dimensions maintaining aspect ratio
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            // Create canvas for compression
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to blob with compression
            canvas.toBlob(
              function(blob) {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                
                // Create new file from blob
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                
                resolve(compressedFile);
              },
              'image/jpeg',
              quality
            );
          };
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }
    
    if (hotelPhotoInput) {
      hotelPhotoInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) {
          photoPreview.style.display = 'none';
          // Clear hidden persisted fields when file is cleared
          const hiddenData = document.getElementById('hotel_main_photo_data');
          const hiddenName = document.getElementById('hotel_main_photo_name');
          const hiddenSize = document.getElementById('hotel_main_photo_size');
          if (hiddenData) hiddenData.value = '';
          if (hiddenName) hiddenName.value = '';
          if (hiddenSize) hiddenSize.value = '';
        // If no file and no persisted data, enforce required
        const hasPersisted = Boolean(hiddenData && hiddenData.value);
        if (!hasPersisted) {
          e.target.required = true;
        }
        syncHotelPhotoRequired();
          return;
        }
        
        // Validate file type first
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          alert('‚ö†Ô∏è Invalid file type!\n\nPlease upload a JPG, JPEG, or PNG image.');
          e.target.value = '';
          photoPreview.style.display = 'none';
          return;
        }
        
        // Check if file is too large (over 10MB is unreasonable even before compression)
        const maxInitialSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxInitialSize) {
          alert('‚ö†Ô∏è File too large!\n\nPlease upload a photo smaller than 10MB.\n\nCurrent file size: ' + (file.size / (1024 * 1024)).toFixed(1) + 'MB');
          e.target.value = '';
          photoPreview.style.display = 'none';
          return;
        }
        
        let processedFile = file;
        const originalSize = file.size;
        
        // Show processing message if compression is needed
        if (file.size > 2 * 1024 * 1024) {
          photoInfo.innerHTML = '<strong>‚è≥ Optimizing image...</strong>';
          photoPreview.style.display = 'block';
          
          try {
            processedFile = await compressImage(file, 2, 2400, 0.85);
          } catch (error) {
            console.error('Compression error:', error);
            alert('‚ö†Ô∏è Failed to optimize image. Please try a different photo.');
            e.target.value = '';
            photoPreview.style.display = 'none';
            return;
          }
        }
        
        // Final size check
        const maxSize = 2 * 1024 * 1024; // 2MB
        if (processedFile.size > maxSize) {
          alert('‚ö†Ô∏è File too large!\n\nEven after optimization, the file is too large.\nPlease upload a smaller photo.\n\nCurrent size: ' + (processedFile.size / (1024 * 1024)).toFixed(1) + 'MB');
          e.target.value = '';
          photoPreview.style.display = 'none';
          return;
        }
        
        // Replace the file input with compressed version
        if (processedFile !== file) {
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(processedFile);
          e.target.files = dataTransfer.files;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          photoPreview.style.display = 'block';
          // Persist preview and metadata for restore
          const hiddenData = document.getElementById('hotel_main_photo_data');
          const hiddenName = document.getElementById('hotel_main_photo_name');
          const hiddenSize = document.getElementById('hotel_main_photo_size');
          if (hiddenData) hiddenData.value = e.target.result;
          if (hiddenName) hiddenName.value = processedFile.name;
          if (hiddenSize) hiddenSize.value = String(processedFile.size);
          // We now have persisted data; relax required on the file input
          e.target.required = false;
          syncHotelPhotoRequired();
          
          // Show file info with compression details
          const finalSizeInMB = (processedFile.size / (1024 * 1024)).toFixed(2);
          const wasCompressed = processedFile !== file;
          const compressionRatio = wasCompressed ? ((1 - processedFile.size / originalSize) * 100).toFixed(0) : 0;
          
          photoInfo.innerHTML = `
            <strong>File:</strong> ${processedFile.name}<br>
            <strong>Size:</strong> <span style="color:#059669">${finalSizeInMB}MB</span> ‚úì Optimized
            ${wasCompressed ? `<br><strong>Saved:</strong> ${compressionRatio}% smaller (was ${(originalSize / (1024 * 1024)).toFixed(1)}MB)` : ''}<br>
            <strong>Type:</strong> JPEG
          `;
        };
        reader.readAsDataURL(processedFile);
      });
    }
    // Back button already initialized above - removed duplicate listener
    
    // AAA diamond toggle wiring
    if (isAaaRated) {
      isAaaRated.addEventListener('change', toggleAaaDiamond);
      // Initialize visibility on load
      toggleAaaDiamond();
    }
    // SAFETY: Global delegation for Rooms/Suites edit buttons so edit view always opens
    document.addEventListener('click', function(e){
      const btn = e.target && (e.target.closest && (e.target.closest('#rs-edit-sleeping') || e.target.closest('#rs-edit-ada') || e.target.closest('#rs-edit-suites')));
      if (!btn) return;
      try {
        const id = btn.id;
        if (id === 'rs-edit-sleeping') { rsState.editMode.sleeping = true; rsRender(); }
        if (id === 'rs-edit-ada') { rsState.editMode.ada = true; rsRender(); }
        if (id === 'rs-edit-suites') { rsState.editMode.suites = true; rsRender(); }
        // Scroll the section into view
        const sec = document.getElementById('rooms_suites_section');
        if (sec) sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch(_) {}
    }, { passive: true });

    // Set up event listeners for draft functionality
    if (saveDraftBtn) saveDraftBtn.addEventListener('click', saveDraft);
    if (loadDraftBtn) loadDraftBtn.addEventListener('click', loadDraft);
    if (discardDraftBtn) discardDraftBtn.addEventListener('click', () => {
      localStorage.removeItem('hotel_registration_draft');
      hasDraft = false;
      updateDraftStatus();
      showToast('Draft discarded');
    });
    
    // Auto-save on form changes (debounced) - REMOVED to avoid duplication
    // The setupAutoSaveOnInput() function handles this more efficiently
    // Submit (to /local/api/submit)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!validateCurrentPage()) return;
      if (submitBtn.disabled){ alert('NET30 acceptance is required to submit.'); return; }
      if (submittingFlag) return;
      
      // Track form submission
      trackFormSubmission('Hotel Registration');
      
      // Check session validity before submission
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        alert('Your session has expired. Please log in again.');
        window.location.href = '/hotel-login.html';
        return;
      }
      
      // Verify session is still valid with server
      try {
        const sessionCheck = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${sessionId}`
          }
        });
        
        if (!sessionCheck.ok) {
          // Check if it's actually a session issue
          const errorData = await sessionCheck.json().catch(() => ({}));
          if (sessionCheck.status === 401 || errorData.error?.includes('expired') || errorData.error?.includes('Invalid')) {
            // Session is invalid, redirect to login
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            localStorage.removeItem('fedevent_hotel');
            alert('Your session has expired. Please log in again.');
            window.location.href = '/hotel-login.html';
          } else {
            alert(`Session validation error: ${errorData.error || 'Unable to verify session.'}`);
            // Don't redirect, let user try to submit
          }
          return;
        }
      } catch (sessionError) {
        console.error('Session validation error:', sessionError);
        alert('Unable to verify session. Please log in again.');
        window.location.href = '/hotel-login.html';
        return;
      }
      
      submittingFlag = true; submitting.classList.add('show');
      try{
        // Serialize meeting rooms data before submission
        if (typeof serializeMeetingRooms === 'function') {
          serializeMeetingRooms();
          console.log('üöÄ Meeting rooms serialized before submission');
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const editMode = urlParams.get('mode');
        const fd = new FormData(form);
        
        // Debug: Log room data before submission
        const sleepingJson = document.getElementById('sr_sleeping_json');
        if (sleepingJson && sleepingJson.value) {
          try {
            const roomData = JSON.parse(sleepingJson.value);
            console.log('üöÄ SUBMITTING ROOM DATA:', roomData);
            console.log('üöÄ Suites data:', roomData.suites);
            if (roomData.suites && roomData.suites.length > 0) {
              console.log('üöÄ First suite bed type:', roomData.suites[0]?.bed_type);
            }
          } catch (e) {
            console.error('üöÄ Error parsing room data:', e);
          }
        }
        
        // Determine the appropriate API endpoint based on mode
        const endpoint = editMode === 'edit' ? '/api/hotel/profile' : '/api/submit';
        const method = editMode === 'edit' ? 'PUT' : 'POST';
        
        const resp = await fetch(`${API_BASE}${endpoint}`, { 
          method, 
          body: fd,
          headers: {
            'Authorization': `Bearer ${sessionId}`
          }
        });
        let json;
        try { json = await resp.json(); } catch(parseErr){
          const text = await resp.text(); throw new Error('Submit parse error: ' + text.slice(0,200));
        }
        if (!json.ok){ 
          // Handle specific error cases with better messaging
          let errorMessage = json.error || 'Submit failed.';
          
          // Check for duplicate hotel name
          if (resp.status === 400 && /hotel.*already exists/i.test(json.error || '')) {
            errorMessage = 'A hotel with this name is already registered by another user. Please contact support if this is an error.';
          }
          // Check for duplicate email
          else if (resp.status === 400 && /email.*already|already registered/i.test(json.error || '')) {
            errorMessage = 'This email is already registered. Please sign in or use a different email address.';
          }
          
          showToast(errorMessage); 
          return; 
        }
        
        // Clear draft after successful submission
        if (currentUserId) {
          try {
            await fetch(`/api/draft/delete/${currentUserId}`, { method: 'DELETE' });
            localStorage.removeItem('hotel_registration_draft');
          } catch (e) {
            console.warn('Failed to clear draft after submission:', e);
          }
        }
        
        if (editMode === 'edit') {
          thanksId.textContent = 'Hotel Profile Updated Successfully!';
          // Redirect back to dashboard after 3 seconds
          setTimeout(() => {
            window.location.href = '/hotel-dashboard.html';
          }, 3000);
        } else {
          thanksId.textContent = 'Hotel ID: ' + (json.hotelId || '');
        }
        submitting.classList.remove('show'); thanks.classList.add('show'); window.scrollTo(0,0);
      }catch(e){ showToast((e && e.message) ? e.message : ('Submit error: ' + e)); }
      finally{ submittingFlag = false; submitting.classList.remove('show'); }
    });

    submitAnother.addEventListener('click', ()=>{
      form.reset(); rooms.innerHTML=''; if (isExtendedStay) isExtendedStay.value='';
      if (hasOutdoorFacility) hasOutdoorFacility.value='';
      if (isAaaRated) isAaaRated.value='';
      document.getElementById('accept_net30').checked = false;
      document.getElementById('accept_no_direct_bill').checked = false;
      document.getElementById('accept_per_diem_discount').checked = false;
      hasDraft = false; draftStatus.style.display = 'none';
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
      
      // Clear any existing drafts
      localStorage.removeItem('hotel_registration_draft');
      if (currentUserId) {
        fetch(`/api/draft/delete/${currentUserId}`, { method: 'DELETE' }).catch(e => console.warn('Failed to clear draft:', e));
      }
      
      toggleES(); toggleBreakfastCost(); updateSubmitState(); toggleAaaDiamond(); toggleBankSections(); setActiveStep(0); thanks.classList.remove('show');
    });
    
    // CRITICAL: Ensure all overlays are hidden after initialization completes
    console.log('üßπ Final cleanup: Removing any stray overlays...');
    setTimeout(() => {
      // Remove submitting overlay if it's somehow stuck
      if (submitting) {
        submitting.classList.remove('show');
        console.log('‚úÖ Submitting overlay cleaned up');
      }
      
      // Remove thanks overlay if it's somehow stuck
      if (thanks) {
        thanks.classList.remove('show');
        console.log('‚úÖ Thanks overlay cleaned up');
      }
      
      // Remove any dynamically created modals that might be stuck
      const strayModals = document.querySelectorAll('div[style*="position: fixed"][style*="rgba(0,0,0,0.5)"]');
      strayModals.forEach(modal => {
        if (!modal.id || (modal.id !== 'submitting' && modal.id !== 'thanks')) {
          modal.remove();
          console.log('‚úÖ Removed stray modal:', modal);
        }
      });
      
      // Ensure the form is visible and not blocked
      if (form) {
        form.style.opacity = '1';
        form.style.pointerEvents = 'auto';
      }
      
      console.log('üéâ Page initialization and cleanup complete!');
    }, 500);
  });
</script>

<footer id="contact">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>FEDEVENT</h3>
                <p>Professional event planning services for U.S. Government agencies.</p>
            </div>
            <div class="footer-section">
                <h3>Services</h3>
                <a href="/hotel-signup.html">Hotel Sourcing</a>
                <a href="/contact.html">Event Planning</a>
                <a href="/government-portal.html">Venue Matching</a>
                <a href="/support-ticket.html">Support Ticket</a>
            </div>
            <div class="footer-section footer-contact">
                <h3>Contact</h3>
                <p>Email: info@fedevent.com</p>
                <p>Phone: (305) 850-7848</p>
                <a href="/admin-login.html" style="color: #d1d5db; text-decoration: none; margin-top: 10px; display: inline-block; padding: 5px 10px; border: 1px solid #374151; border-radius: 4px; font-size: 0.9rem;">
                    üîê Admin Access
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>fedevent.com is a service of CREATA Global Event Agency LLC</p>
            <p>&copy; 2025 FEDEVENT. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <a href="/admin-login.html" style="color: #9ca3af; text-decoration: none; border-bottom: 1px dotted #9ca3af;">
                    üîê Admin Sign In
                </a>
            </p>
        </div>
    </div>
</footer>

<style>
    /* Footer Styles */
    footer {
        background: var(--text, #1f2937);
        color: white;
        padding: 3rem 0 1rem;
        margin-top: auto;
    }

    .footer-content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .footer-section h3 {
        margin-bottom: 1rem;
        color: var(--secondary, #f59e0b);
    }

    .footer-section a {
        display: block;
        color: #d1d5db;
        text-decoration: none;
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }

    .footer-section a:hover {
        color: var(--secondary, #f59e0b);
    }

    .footer-contact {
        text-align: right;
    }

    .footer-bottom {
        border-top: 1px solid #374151;
        padding-top: 2rem;
        text-align: center;
        color: #9ca3af;
    }

    /* Responsive Footer */
    @media (max-width: 768px) {
        .footer-content {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .footer-contact {
            text-align: left;
        }
    }
</style>

<script src="/chat.js"></script>
    <script src="/nav.js"></script>

<!-- Emergency form initialization fix -->
<script>
// Emergency form initialization fix
setTimeout(() => {
  console.log('Emergency form fix running...');
  
  // Check and set signedIn status
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = localStorage.getItem('fedevent_session');
  const signedInParam = urlParams.get('signedIn');
  const continueParam = urlParams.get('continue');
  
  // Force signedIn to true if session exists and URL indicates signed in
  if (sessionId && (signedInParam === 'true' || continueParam === 'true')) {
    window.signedIn = true;
    // Also set the global variable if it exists
    if (typeof signedIn !== 'undefined') {
      signedIn = true;
    }
    console.log('Emergency fix: signedIn status set to true (both window.signedIn and global signedIn)');
  }
  
  // Only initialize a page if none is active and no saved page is available
  const anyActivePage = Array.from(document.querySelectorAll('.page')).some(p => p.classList.contains('active'));
  const savedPageStr = localStorage.getItem('hotel_registration_current_page');
  const savedPageNum = savedPageStr ? parseInt(savedPageStr) : NaN;
  if (!anyActivePage && (isNaN(savedPageNum) || savedPageNum < 0)) {
    console.log('Emergency fallback: No active page found and no saved page; setting page 1');
    current = 1;
    if (typeof setActiveStep === 'function') {
      setActiveStep(1);
    } else {
      console.log('Emergency fallback: setActiveStep not available yet, will be called later');
    }
  } else if (!anyActivePage && !isNaN(savedPageNum)) {
    console.log('Emergency fallback: Restoring saved page', savedPageNum);
    current = savedPageNum;
    if (typeof setActiveStep === 'function') {
      setActiveStep(current);
    } else {
      console.log('Emergency fallback: setActiveStep not available yet, will be called later');
    }
  }
  
  // Ensure navigation buttons are working
  const nextBtn = document.getElementById('nextBtn');
  const backBtn = document.getElementById('backBtn');
  if (nextBtn) {
    nextBtn.style.display = 'inline-block';
    nextBtn.disabled = false;
  }
  if (backBtn) {
    backBtn.disabled = (current === 0); // First page
  }
  
  // Fix management company fields visibility
  const managementSelect = document.getElementById('is_management_company_managed');
  const managementFields = document.getElementById('managementCompanyFields');
  if (managementSelect && managementFields) {
    console.log('Checking management company visibility...');
    console.log('Management select value:', managementSelect.value);
    
    // Check if there's data in management fields
    const hasData = Array.from(managementFields.querySelectorAll('input')).some(input => input.value.trim() !== '');
    console.log('Management fields have data:', hasData);
    
    // If select is "Yes" or there's data, show the fields
    if (managementSelect.value === 'Yes' || hasData) {
      managementFields.style.display = 'block';
      managementSelect.value = 'Yes'; // Ensure consistency
      console.log('Management company fields made visible');
    } else {
      managementFields.style.display = 'none';
      console.log('Management company fields hidden');
    }
  }
  
  // Initialize auto-save if user is signed in
  if (window.signedIn && typeof setupAutoSaveOnInput === 'function') {
    console.log('Emergency fix: Initializing auto-save...');
    setupAutoSaveOnInput();
    
    if (typeof startAutoSave === 'function') {
      startAutoSave();
      console.log('Emergency fix: Started auto-save timer');
    }
  }
  
  // Initialize AAA diamond toggle
  const aaaRatedSelect = document.getElementById('is_aaa_rated');
  if (aaaRatedSelect && typeof toggleAaaDiamond === 'function') {
    console.log('Emergency fix: Initializing AAA diamond toggle');
    // Add event listener for future changes
    aaaRatedSelect.addEventListener('change', function() {
      console.log('AAA rating changed to:', this.value);
      toggleAaaDiamond();
    });
    // Initialize current state
    toggleAaaDiamond();
  } else {
    console.log('Emergency fix: AAA rating select not found or toggleAaaDiamond not available');
  }
  
  // Force AAA diamond section to work immediately
  setTimeout(() => {
    const aaaSelect = document.getElementById('is_aaa_rated');
    const diamondSection = document.getElementById('aaa_diamond_section');
    
    if (aaaSelect && diamondSection) {
      console.log('Force AAA fix: Setting up direct listener');
      
      // Remove any existing listeners
      const newSelect = aaaSelect.cloneNode(true);
      aaaSelect.parentNode.replaceChild(newSelect, aaaSelect);
      
      // Add direct listener
      newSelect.addEventListener('change', function() {
        console.log('Direct AAA listener: Value changed to', this.value);
        const showDiamond = (this.value === 'Yes');
        diamondSection.style.display = showDiamond ? 'block' : 'none';
        
        const ratingSelect = document.getElementById('aaa_diamond_rating');
        if (ratingSelect) {
          ratingSelect.required = showDiamond;
        }
        
        console.log('Direct AAA listener: Diamond section display:', diamondSection.style.display);
      });
      
      // Check initial state
      if (newSelect.value === 'Yes') {
        diamondSection.style.display = 'block';
        const ratingSelect = document.getElementById('aaa_diamond_rating');
        if (ratingSelect) ratingSelect.required = true;
      }
    }
  }, 100);
  
  // Setup cooktop type burner count confirmation
  function toggleBurnerCountSection() {
    const cooktopSelect = document.getElementById('ext_cooktop_type');
    const burnerCountSection = document.getElementById('ext_burner_count_section');
    const burnerCountSelect = document.getElementById('ext_burner_count');
    
    if (!cooktopSelect || !burnerCountSection) return;
    
    const cooktopValue = cooktopSelect.value;
    console.log('üî• Cooktop type changed to:', cooktopValue);
    
    // Show burner count confirmation for all options except "None" and empty
    const shouldShow = cooktopValue && cooktopValue !== '' && cooktopValue !== 'None';
    burnerCountSection.style.display = shouldShow ? '' : 'none';
    
    if (burnerCountSelect) {
      burnerCountSelect.required = shouldShow;
      // Clear selection when hiding
      if (!shouldShow) {
        burnerCountSelect.value = '';
      }
    }
    
    console.log('üî• Burner count section visibility:', shouldShow ? 'shown' : 'hidden');
  }
  
  // Initialize cooktop type toggle
  setTimeout(() => {
    const cooktopSelect = document.getElementById('ext_cooktop_type');
    if (cooktopSelect) {
      console.log('üî• Initializing cooktop type toggle');
      cooktopSelect.addEventListener('change', toggleBurnerCountSection);
      // Check initial state
      toggleBurnerCountSection();
    }
  }, 100);
  
  // Emergency role validation removed - no longer needed
  
  console.log('Emergency form fix completed');
  
  // IMMEDIATE AUTO-RESTORE on page load
  const immediateRestore = () => {
    console.log('üíæ IMMEDIATE: Attempting to restore draft data...');
    
    try {
      // Safely get userId
      let userId = 'anonymous';
      try {
        if (typeof currentUserId !== 'undefined' && currentUserId) {
          userId = currentUserId;
        } else {
          const userData = localStorage.getItem('fedevent_user');
          if (userData) {
            const user = JSON.parse(userData);
            userId = user.id || user.userId || user.fedevent_account_number || 'anonymous';
          }
        }
      } catch (e) {}
      
      // Try multiple sources
      const sources = [
        'hotel_registration_draft',
        `hotel_registration_draft_${userId}`,
        'hotel_registration_draft_temp'
      ];
      
      for (const key of sources) {
        const draftData = localStorage.getItem(key);
        if (draftData) {
          try {
            const parsed = JSON.parse(draftData);
            if (parsed.formData && Object.keys(parsed.formData).length > 0) {
              console.log('üíæ IMMEDIATE: Restoring from', key, 'with', Object.keys(parsed.formData).length, 'fields');
              setFormData(parsed.formData);
              // Do not force page 1; respect saved or current page
              
              // Show confirmation
              const toast = document.createElement('div');
              toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-size:0.8rem;';
              toast.textContent = '‚úì Draft restored';
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 3000);
              
              break;
            }
          } catch (e) {
            console.error('üíæ IMMEDIATE: Error parsing', key, e);
          }
        }
      }
      
      // Also restore page
      const savedPage = localStorage.getItem('hotel_registration_current_page');
      if (savedPage) {
        const pageNum = parseInt(savedPage);
        if (!isNaN(pageNum) && pageNum >= 0) {
          current = pageNum;
          setActiveStep(current);
          console.log('üíæ IMMEDIATE: Restored to page', pageNum);
        }
      }
      
    } catch (error) {
      console.error('üíæ IMMEDIATE: Restore failed:', error);
    }
  };
  
  // MULTIPLE AUTO-RESTORE ATTEMPTS FOR MAXIMUM RELIABILITY
  function attemptAutoRestore() {
    if (typeof autoRestoreCompleted !== 'undefined' && autoRestoreCompleted) {
      console.log('üîÑ Auto-restore skipped ‚Äî already completed for this session');
      return false;
    }

    console.log('üîÑ Attempting auto-restore...');
    ensureCurrentUserIdFromStorage();

    const latest = getLatestLocalDraft();
    if (!latest) {
      console.log('‚ùå No valid draft found in localStorage');
      return false;
    }

    console.log('üîÑ Restoring from key:', latest.key, 'with', Object.keys(latest.draft.formData || {}).length, 'fields');
    const toastMessage = (signedIn || window.signedIn) ? '‚úÖ Previous draft loaded from local storage' : null;
    if (!applyDraftToForm(latest.draft, toastMessage)) {
      return false;
    }

    if (typeof autoRestoreCompleted !== 'undefined') {
      autoRestoreCompleted = true;
    }

    const autoSaveStatus = document.getElementById('autoSaveStatus');
    if (autoSaveStatus && latest.timestamp) {
      const saveDate = new Date(latest.timestamp);
      if (!Number.isNaN(saveDate.getTime())) {
        autoSaveStatus.textContent = `Restored from: ${saveDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      }
    }

    return true;
  }
  
  // Multiple restore attempts
  setTimeout(() => {
    if (typeof autoRestoreCompleted !== 'undefined' && autoRestoreCompleted) return;
    console.log('üîÑ Auto-restore attempt 1...');
    if (attemptAutoRestore()) {
      console.log('üîÑ Auto-restore successful on attempt 1');
      return;
    }

    setTimeout(() => {
      if (typeof autoRestoreCompleted !== 'undefined' && autoRestoreCompleted) return;
      console.log('üîÑ Auto-restore attempt 2...');
      if (attemptAutoRestore()) {
        console.log('üîÑ Auto-restore successful on attempt 2');
        return;
      }

      setTimeout(() => {
        if (typeof autoRestoreCompleted !== 'undefined' && autoRestoreCompleted) return;
        console.log('üîÑ Auto-restore attempt 3 (final)...');
        if (attemptAutoRestore()) {
          console.log('üîÑ Auto-restore successful on attempt 3');
        } else {
          console.log('üîÑ No saved data found to restore after 3 attempts');
        }
      }, 2000);
    }, 1000);
  }, 100);

  // Run immediately if signed in
  if (signedIn || window.signedIn) {
    console.log('üîÑ Running immediate restore for signed-in user...');
    attemptAutoRestore();
    
    // Also run after a short delay in case DOM isn't ready
    setTimeout(() => {
      if (typeof autoRestoreCompleted !== 'undefined' && autoRestoreCompleted) return;
      console.log('üîÑ Running delayed restore...');
      attemptAutoRestore();
    }, 500);
  }
  
  // Add auto-save on page unload as final safety measure
  window.addEventListener('beforeunload', function(e) {
    if ((signedIn || window.signedIn)) {
      console.log('Page unloading - final auto-save attempt');
      try {
        handleSaveDraft('unload-save');
      } catch (error) {
        console.error('Unload save failed:', error);
      }
    }
  });
  
  // Add visibility change auto-save (when user switches tabs)
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && (signedIn || window.signedIn)) {
      console.log('Page hidden - auto-saving');
      handleSaveDraft('visibility-save');
    }
  });
}, 500); // Run after other scripts
// Additional fix that runs later to handle draft loading
setTimeout(() => {
  console.log('Late management company visibility fix running...');
  const managementSelect = document.getElementById('is_management_company_managed');
  const managementFields = document.getElementById('managementCompanyFields');
  
  if (managementSelect && managementFields) {
    const hasData = Array.from(managementFields.querySelectorAll('input')).some(input => input.value.trim() !== '');
    console.log('Late check - Management select value:', managementSelect.value);
    console.log('Late check - Has data:', hasData);
    
    if (managementSelect.value === 'Yes' || hasData) {
      managementFields.style.display = 'block';
      managementSelect.value = 'Yes';
      console.log('Late fix: Management company fields made visible');
    }
  }
  
  // Ensure auto-save is working - late initialization
  if (window.signedIn && typeof setupAutoSaveOnInput === 'function') {
    console.log('Late fix: Re-initializing auto-save...');
    setupAutoSaveOnInput();
  }
  
  // Re-initialize comprehensive auto-save system
  if (window.signedIn || signedIn) {
    console.log('Late fix: Re-initializing comprehensive auto-save...');
    if (typeof ensureAutoSaveActive === 'function') {
      ensureAutoSaveActive();
    }
    
    // Add extra safety auto-save every 30 seconds for signed-in users
    if (window.safetyAutoSaveInterval) clearInterval(window.safetyAutoSaveInterval);
    window.safetyAutoSaveInterval = setInterval(() => {
      if ((signedIn || window.signedIn)) {
        console.log('Safety auto-save triggered');
        handleSaveDraft('safety-periodic');
      }
    }, 30000); // Every 30 seconds as backup
  }
  
  // Late AAA diamond toggle fix
  const lateAaaSelect = document.getElementById('is_aaa_rated');
  if (lateAaaSelect) {
    console.log('Late fix: AAA rating current value:', lateAaaSelect.value);
    if (typeof toggleAaaDiamond === 'function') {
      toggleAaaDiamond();
      console.log('Late fix: AAA diamond toggle executed');
    }
    
    // Ensure event listener is attached
    if (!lateAaaSelect.hasAttribute('data-listener-attached')) {
      lateAaaSelect.addEventListener('change', function() {
        console.log('Late fix: AAA rating changed to:', this.value);
        if (typeof toggleAaaDiamond === 'function') {
          setTimeout(toggleAaaDiamond, 100);
        }
      });
      lateAaaSelect.setAttribute('data-listener-attached', 'true');
      console.log('Late fix: AAA rating change listener attached');
    }
  }
  // Emergency bank sections fix - runs later to ensure everything works
  setTimeout(() => {
    console.log('üè¶ Emergency bank sections fix running...');
    const locationSelect = document.getElementById('hotel_location_type');
    const achSection = document.getElementById('ach_section');
    const wireSection = document.getElementById('wire_section');
    
    if (locationSelect) {
      console.log('üè¶ Emergency fix - found location select, current value:', locationSelect.value);
      
      // Ensure change listener is attached
      locationSelect.addEventListener('change', function(e) {
        console.log('üè¶ Emergency listener - location changed to:', e.target.value);
        
        // Force immediate toggle
        if (typeof toggleBankSections === 'function') {
          toggleBankSections();
        }
        
        // Also try manual toggle as backup
        const achSec = document.getElementById('ach_section');
        const wireSec = document.getElementById('wire_section');
        
        if (achSec) achSec.style.display = 'none';
        if (wireSec) wireSec.style.display = 'none';
        
        if (e.target.value === 'US' && achSec) {
          achSec.style.display = 'block';
          console.log('üè¶ Emergency fix - ACH section shown');
        } else if (e.target.value === 'International' && wireSec) {
          wireSec.style.display = 'block';
          console.log('üè¶ Emergency fix - Wire section shown');
        }
      });
      
      // Trigger initial toggle
      if (locationSelect.value) {
        console.log('üè¶ Emergency fix - triggering initial toggle for:', locationSelect.value);
        locationSelect.dispatchEvent(new Event('change'));
      }
    } else {
      console.error('üè¶ Emergency fix - location select not found!');
    }
  }, 2000);
}, 500); // Run after other scripts

</script>

<!-- Missing Functions Fix Script -->
<script src="/missing-functions-fix.js"></script>

</body>
</html>
</html>
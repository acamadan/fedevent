<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hotel Profile Registration</title>
<!-- BUILD: CREATA-SUITE 2025-08-11 v3 (localhost) -->
<link rel="stylesheet" href="/site.css">
<style>
  :root { --bg:#f4f8fb; --card:#fff; --ink:#0b2545; --muted:#5b6b7b; --accent:#0a58ca; --danger:#dc3545; --ring:rgba(10,88,202,.25); }
  *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto 64px;padding:0 16px} .card{background:var(--card);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
  h1{font-size:1.6rem;margin:0 0 6px} p.lead{margin:0 0 16px;color:var(--muted)}
  fieldset{border:1px solid #e6ecf2;border-radius:12px;padding:14px;margin:16px 0} legend{padding:0 8px;color:var(--muted);font-size:.95rem}
  label{font-weight:600;font-size:.92rem;display:block;margin:8px 0 4px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
  input:not([type=file]):not([type=checkbox]):not([type=radio]):not([type=radio]),select{width:100%;padding:10px 12px;border:1px solid #d7dee6;border-radius:10px;background:#fff;font-size:1rem;line-height:1.2;height:44px;outline:0;transition:box-shadow .15s,border-color .15s}
  textarea{width:100%;padding:10px 12px;border:1px solid #d7dee6;border-radius:10px;background:#fff;font-size:1rem;outline:0;transition:box-shadow .15s,border-color .15s;min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
  .hint{color:var(--muted);font-size:.85rem;margin-top:2px} .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.subtle{background:#eef4ff;color:var(--accent)} .btn.danger{background:#dc3545} .btn:disabled{opacity:.55;cursor:not-allowed}
  .hr{height:1px;background:#e6ecf2;margin:12px 0} .item{border:1px solid #e6ecf2;border-radius:12px;padding:12px;margin-top:8px;background:#fafcff}
  .right{text-align:right} .required{color:var(--danger)}
  .steps{display:flex;gap:10px;align-items:center;margin:8px 0 4px;flex-wrap:wrap}
  .step{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600;transition:all 0.3s ease}
  .dot{width:28px;height:28px;border-radius:50%;display:inline-grid;place-items:center;background:#eef4ff;color:#0a58ca;font-weight:800;transition:all 0.3s ease}
  .step.active{color:var(--ink)} .step.active .dot{background:#0a58ca;color:#fff}
  .step.completed{color:#10b981} .step.completed .dot{background:#10b981;color:#fff}
  .page{display:none} .page.active{display:block} .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
  .submitting{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(2px);z-index:10000}
  .submitting.show{display:flex}
  .panel{background:#fff;border:1px solid #e6ecf2;border-radius:12px;padding:14px 16px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:flex;gap:12px;align-items:center}
  .loader{width:36px;height:36px;border-radius:50%;border:3px solid #c5d6f3;border-top-color:#0a58ca;animation:spin 1s linear infinite} @keyframes spin{to{transform:rotate(360deg)}}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2545;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:10001}
  .muted{color:var(--muted);font-size:.9rem}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 720px){ .grid2{grid-template-columns:1fr} }
  
  /* Navigation styles */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  nav {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 1rem 0;
    gap: 24px;
  }
  
  .logo {
    font-size: 1.75rem;
    font-weight: bold;
    color: var(--accent);
    cursor: pointer;
    position: relative;
    user-select: none;
  }
  
  .logo:hover {
    color: #084298;
  }
  
  .nav-links {
    display: flex;
    list-style: none;
    gap: 1.25rem;
    margin-left: 16px;
  }
  
  .nav-links a {
    text-decoration: none;
    color: var(--ink);
    font-weight: 500;
    transition: color 0.2s ease;
  }
  
  .nav-links a:hover {
    color: var(--accent);
  }
  
  .user-menu { 
    position: relative; 
  }
  
  .user-trigger { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    cursor: pointer; 
    font-weight: 600; 
    color: var(--ink); 
    text-decoration: none; 
  }
  
  .user-avatar { 
    width: 28px; 
    height: 28px; 
    border-radius: 50%; 
    background: #e5e7eb; 
    display: grid; 
    place-items: center; 
    font-size: 0.85rem; 
    color: #374151; 
  }
  
  .user-dropdown { 
    position: absolute; 
    right: 0; 
    top: calc(100% + 8px); 
    background: #fff; 
    border: 1px solid #e5e7eb; 
    box-shadow: 0 8px 24px rgba(0,0,0,.08); 
    border-radius: 10px; 
    min-width: 200px; 
    padding: 6px; 
    display: none; 
    z-index: 1002; 
  }
  
  .user-dropdown a, .user-dropdown button { 
    display: block; 
    width: 100%; 
    text-align: left; 
    padding: 10px 12px; 
    border-radius: 8px; 
    background: transparent; 
    border: 0; 
    font: inherit; 
    color: #111827; 
    cursor: pointer; 
    text-decoration: none; 
  }
  
  .user-dropdown a:hover, .user-dropdown button:hover { 
    background: #f3f4f6; 
  }
  
  /* User info styling */
  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #374151;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .user-info span {
    color: #059669;
  }
  
  .logout-btn:hover {
    background: #b91c1c !important;
  }
  
  /* Autocomplete suggestions styling */
  .autocomplete-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #d7dee6;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    width: 100%;
  }
</style>

    <!-- Google Analytics 4 (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <!-- Add Google Places API - Will be configured with API key from server -->
    <script>
      let googlePlacesApiKey = null;
      
      // Function to load Google Places API key from server
      async function loadGooglePlacesAPI() {
        try {
          console.log('Loading Google Places API key...');
          const response = await fetch('/api/google-places-key');
          
          if (!response.ok) {
            console.log('Google Places API not configured - skipping');
            showToast('ℹ️ Google Places API not configured');
            return;
          }
          
          const data = await response.json();
          console.log('Google Places API response:', data);
          
          // Handle mock mode
          if (data.mockMode) {
            console.log('Development Mode: Google Places API not configured, using mock data');
            showToast('ℹ️ Development Mode: Google Places API not configured');
            return;
          }
          
          if (data && data.apiKey) {
            googlePlacesApiKey = data.apiKey;
            console.log('Google Places API key loaded successfully');
            showToast('✅ Google Places API loaded');
            // Initialize autocomplete functionality
            initAutocomplete();
          } else {
            console.log('Google Places API key not available');
            showToast('⚠️ Google Places API key not available');
          }
        } catch (error) {
          console.error('Error loading Google Places API:', error);
          showToast('❌ Google Places API error: ' + error.message);
        }
      }
      
      // Initialize Google Places Autocomplete using direct HTTP requests
      async function initAutocomplete() {
        console.log('Initializing Google Places Autocomplete...');
        
        if (!googlePlacesApiKey) {
          console.error('Google Places API key not available');
          showToast('❌ Google Places API key not available');
          return;
        }
        
        // Set up autocomplete for hotel name field
        const hotelNameInput = document.querySelector('input[name="hotel_name"]');
        if (hotelNameInput) {
          console.log('Setting up autocomplete for hotel name field');
          setupAutocompleteForField(hotelNameInput, 'hotel');
        } else {
          console.log('Hotel name input not found');
        }
        
        // Set up autocomplete for hotel address field
        const addressInput = document.querySelector('input[name="address"]');
        if (addressInput) {
          console.log('Setting up autocomplete for hotel address field');
          setupAutocompleteForField(addressInput, 'hotel');
        } else {
          console.log('Hotel address input not found');
        }
        
        // Set up autocomplete for management company name field
        const managementCompanyNameInput = document.querySelector('input[name="management_company"]');
        if (managementCompanyNameInput) {
          console.log('Setting up autocomplete for management company name field');
          setupAutocompleteForField(managementCompanyNameInput, 'management');
        } else {
          console.log('Management company name input not found');
        }
        
        // Set up autocomplete for management company address field
        const managementCompanyAddressInput = document.querySelector('input[name="management_company_address"]');
        if (managementCompanyAddressInput) {
          console.log('Setting up autocomplete for management company address field');
          setupAutocompleteForField(managementCompanyAddressInput, 'management');
        } else {
          console.log('Management company address input not found');
        }
      }
      
      // Helper function to set up autocomplete for any field
      function setupAutocompleteForField(inputField, type) {
        // Create a container for autocomplete suggestions
        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.className = 'autocomplete-suggestions';
        suggestionsContainer.style.cssText = `
          position: absolute;
          background: white;
          border: 1px solid #d7dee6;
          border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          z-index: 1000;
          max-height: 300px;
          overflow-y: auto;
          display: none;
          width: 100%;
        `;
        inputField.parentNode.style.position = 'relative';
        inputField.parentNode.appendChild(suggestionsContainer);
        
        let debounceTimer;
        inputField.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          const query = this.value;
          
          if (query.length < 3) {
            suggestionsContainer.style.display = 'none';
            return;
          }
          
          debounceTimer = setTimeout(() => {
            searchPlaces(query, suggestionsContainer, type);
          }, 300);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
          if (!inputField.contains(event.target) && !suggestionsContainer.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
          }
        });
      }
      
      // Search for places using the new Google Places API
      async function searchPlaces(query, suggestionsContainer, type) {
        if (!googlePlacesApiKey) {
          console.error('Google Places API key not available for search');
          return;
        }
        
        try {
          console.log('Searching places for query:', query);
          const response = await fetch(`https://places.googleapis.com/v1/places:searchText`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Goog-Api-Key': googlePlacesApiKey,
              'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.addressComponents,places.internationalPhoneNumber,places.websiteUri'
            },
            body: JSON.stringify({
              textQuery: query,
              maxResultCount: 5
            })
          });
          
          const responseText = await response.text();
          
          if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}: ${responseText}`);
          }
          
          const data = JSON.parse(responseText);
          console.log('Places search results:', data);
          
          if (!data.places || data.places.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
          }
          
          // Display suggestions
          displaySuggestions(data.places, suggestionsContainer, type);
        } catch (error) {
          console.error('Error searching places:', error);
          showToast('❌ Error searching places: ' + error.message);
        }
      }
      
      // Display autocomplete suggestions
      function displaySuggestions(places, suggestionsContainer, type) {
        suggestionsContainer.innerHTML = '';
        
        places.forEach(place => {
          const suggestionItem = document.createElement('div');
          suggestionItem.style.cssText = `
            padding: 10px 12px;
            border-bottom: 1px solid #e6ecf2;
            cursor: pointer;
            font-size: 0.95rem;
          `;
          suggestionItem.innerHTML = `
            <div style="font-weight: 600;">${place.displayName.text}</div>
            <div style="font-size: 0.85rem; color: #5b6b7b;">${place.formattedAddress || ''}</div>
          `;
          
          suggestionItem.addEventListener('click', () => {
            selectPlace(place, type);
            suggestionsContainer.style.display = 'none';
          });
          
          suggestionsContainer.appendChild(suggestionItem);
        });
        
        suggestionsContainer.style.display = 'block';
      }
      
      // Handle place selection
      function selectPlace(place, type) {
        console.log('Selected place:', place, 'Type:', type);
        if (type === 'hotel') {
          populateHotelFields(place);
          const hid = document.getElementById('hotel_place_id');
          if (hid) hid.value = place.id || '';
        } else if (type === 'management') {
          populateManagementCompanyFields(place);
          const mid = document.getElementById('management_company_place_id');
          if (mid) mid.value = place.id || '';
        }
      }
      
      // Populate hotel form fields with place data
      function populateHotelFields(place) {
        showToast('🔄 Auto-populating hotel information...');
        
        // Extract address components
        const addressComponents = {};
        if (place.addressComponents) {
          for (const component of place.addressComponents) {
            const types = component.types;
            for (const type of types) {
              addressComponents[type] = component.longText || component.shortText;
            }
          }
        }
        
        // Populate the hotel form fields
        const addressField = document.querySelector('input[name="address"]');
        const cityField = document.querySelector('input[name="city"]');
        const stateField = document.querySelector('input[name="state"]');
        const zipField = document.querySelector('input[name="zip"]');
        const countryField = document.querySelector('input[name="country"]');
        const phoneField = document.querySelector('input[name="hotel_phone"]');
        const hotelNameField = document.querySelector('input[name="hotel_name"]');
        const websiteField = document.querySelector('input[name="website"]');
        
        // Fill address field
        if (place.formattedAddress && addressField) {
          // Extract just the street address part (first line)
          const addressParts = place.formattedAddress.split(',');
          addressField.value = addressParts[0]; // Just the street address part
        }
        
        // Fill other fields
        if (addressComponents['locality'] && cityField) {
          cityField.value = addressComponents['locality'];
        } else if (addressComponents['sublocality'] && cityField) {
          cityField.value = addressComponents['sublocality'];
        } else if (addressComponents['administrative_area_level_2'] && cityField) {
          cityField.value = addressComponents['administrative_area_level_2'].replace(' County', '');
        }
        
        if (addressComponents['administrative_area_level_1'] && stateField) {
          stateField.value = addressComponents['administrative_area_level_1'];
        }
        
        if (addressComponents['postal_code'] && zipField) {
          zipField.value = addressComponents['postal_code'];
        }
        
        if (addressComponents['country'] && countryField) {
          countryField.value = addressComponents['country'];
        }
        
        // Fill phone number if available
        if (place.internationalPhoneNumber && phoneField) {
          phoneField.value = place.internationalPhoneNumber;
        }
        
        // Always fill/replace hotel name with the selected place's official name
        if (place.displayName && place.displayName.text && hotelNameField) {
          hotelNameField.value = place.displayName.text;
          const offName = document.getElementById('hotel_official_name');
          if (offName) offName.value = place.displayName.text;
        }
        
        // Fill website if available and not already filled
        if (place.websiteUri && websiteField && !websiteField.value) {
          // Clean the website URL - remove parameters and protocol for display
          const cleanUrl = cleanWebsiteUrl(place.websiteUri);
          websiteField.value = cleanUrl;
        }
        const offAddr = document.getElementById('hotel_official_address');
        if (offAddr && place.formattedAddress) offAddr.value = place.formattedAddress;
        const hid = document.getElementById('hotel_place_id');
        if (hid) hid.value = place.id || '';
        
        // Show success message
        showToast('✅ Hotel information auto-populated successfully!');
        console.log('Hotel place details:', place);
        
        // Auto-save after Places API fills the form
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('places-api-auto');
          }, 500); // Small delay to ensure all fields are updated
        }
      }
      
      // Populate management company form fields with place data
      function populateManagementCompanyFields(place) {
        showToast('🔄 Auto-populating management company information...');
        
        // Extract address components
        const addressComponents = {};
        if (place.addressComponents) {
          for (const component of place.addressComponents) {
            const types = component.types;
            for (const type of types) {
              addressComponents[type] = component.longText || component.shortText;
            }
          }
        }
        
        // Populate the management company form fields
        const managementCompanyField = document.querySelector('input[name="management_company"]');
        const managementCompanyAddressField = document.querySelector('input[name="management_company_address"]');
        const managementCompanyStreetField = document.querySelector('input[name="management_company_street"]');
        const managementCompanyCityField = document.querySelector('input[name="management_company_city"]');
        const managementCompanyStateField = document.querySelector('input[name="management_company_state"]');
        const managementCompanyZipField = document.querySelector('input[name="management_company_zip"]');
        const managementCompanyCountryField = document.querySelector('input[name="management_company_country"]');
        const managementCompanyWebsiteField = document.querySelector('input[name="management_company_website"]');
        
        // Always fill/replace management company name with the selected place's official name
        if (place.displayName && place.displayName.text && managementCompanyField) {
          managementCompanyField.value = place.displayName.text;
          const offName = document.getElementById('management_company_official_name');
          if (offName) offName.value = place.displayName.text;
        }
        
        // Fill management company address
        if (place.formattedAddress && managementCompanyAddressField) {
          managementCompanyAddressField.value = place.formattedAddress;
          const offAddr = document.getElementById('management_company_official_address');
          if (offAddr) offAddr.value = place.formattedAddress;
        }
        
        // Fill street address field
        if (place.formattedAddress && managementCompanyStreetField) {
          // Extract just the street address part (first line)
          const addressParts = place.formattedAddress.split(',');
          managementCompanyStreetField.value = addressParts[0]; // Just the street address part
        }
        
        // Fill other fields
        if (addressComponents['locality'] && managementCompanyCityField) {
          managementCompanyCityField.value = addressComponents['locality'];
        } else if (addressComponents['sublocality'] && managementCompanyCityField) {
          managementCompanyCityField.value = addressComponents['sublocality'];
        } else if (addressComponents['administrative_area_level_2'] && managementCompanyCityField) {
          managementCompanyCityField.value = addressComponents['administrative_area_level_2'].replace(' County', '');
        }
        
        if (addressComponents['administrative_area_level_1'] && managementCompanyStateField) {
          managementCompanyStateField.value = addressComponents['administrative_area_level_1'];
        }
        
        if (addressComponents['postal_code'] && managementCompanyZipField) {
          managementCompanyZipField.value = addressComponents['postal_code'];
        }
        
        if (addressComponents['country'] && managementCompanyCountryField) {
          managementCompanyCountryField.value = addressComponents['country'];
        }
        
        // Fill website if available and field exists
        if (place.websiteUri && managementCompanyWebsiteField) {
          // Clean the website URL - remove parameters and protocol for display
          const cleanUrl = cleanWebsiteUrl(place.websiteUri);
          managementCompanyWebsiteField.value = cleanUrl;
          console.log('Management company website populated:', cleanUrl, '(cleaned from:', place.websiteUri, ')');
        } else if (managementCompanyWebsiteField) {
          console.log('No website found for management company place');
        }
        
        const mid = document.getElementById('management_company_place_id');
        if (mid) mid.value = place.id || '';
        
        // Show success message
        showToast('✅ Management company information auto-populated successfully!');
        console.log('Management company place details:', place);
        
        // Auto-save after Places API fills the management company form
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('places-api-auto');
          }, 500); // Small delay to ensure all fields are updated
        }
        
        // Update visibility to show the fields now that they have data
        setTimeout(() => {
          const selectEl = document.getElementById('is_management_company_managed');
          if (selectEl) {
            selectEl.dispatchEvent(new Event('change'));
          }
        }, 100);
      }
      
      // Function to clean website URLs for better display
      function cleanWebsiteUrl(url) {
        if (!url) return '';
        
        try {
          // Create URL object to parse the URL
          let cleanUrl = url;
          
          // Remove duplicate protocols (e.g., "https://aimbridgehospitality.com/https://aimbridgehospitality.com/")
          if (cleanUrl.includes('://') && cleanUrl.lastIndexOf('://') > cleanUrl.indexOf('://')) {
            // Find the second occurrence of protocol and take everything from there
            const secondProtocolIndex = cleanUrl.lastIndexOf('://');
            cleanUrl = cleanUrl.substring(secondProtocolIndex - 5); // Include "https" or "http"
          }
          
          const urlObj = new URL(cleanUrl);
          
          // Get just the protocol and hostname (no path, no parameters)
          const baseUrl = `${urlObj.protocol}//${urlObj.hostname}`;
          
          console.log('Cleaned URL:', url, '->', baseUrl);
          return baseUrl;
          
        } catch (error) {
          console.error('Error cleaning URL:', url, error);
          // Fallback: try to extract domain manually
          try {
            // Remove protocol
            let domain = url.replace(/^https?:\/\//, '');
            
            // Remove duplicate protocols if they exist
            if (domain.includes('://')) {
              domain = domain.substring(domain.lastIndexOf('://') + 3);
            }
            
            // Remove path and parameters
            domain = domain.split('/')[0].split('?')[0].split('#')[0];
            
            // Add back https protocol
            const cleanUrl = `https://${domain}`;
            console.log('Fallback cleaned URL:', url, '->', cleanUrl);
            return cleanUrl;
            
          } catch (fallbackError) {
            console.error('Fallback URL cleaning failed:', fallbackError);
            return url; // Return original if all cleaning fails
          }
        }
      }
      
      // Function to show a toast message
      function showToast(message) {
        // Remove any existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = message;
        document.body.appendChild(toast);
        
        // Show toast
        toast.style.display = 'block';
        
        // Hide toast after 3 seconds
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 500);
        }, 3000);
      }
      
      // Close suggestions when clicking outside
      document.addEventListener('click', function(event) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestions');
        suggestions.forEach(suggestion => {
          if (!suggestion.contains(event.target) && !event.target.closest('input[name="address"], input[name="management_company_address"]')) {
            suggestion.style.display = 'none';
          }
        });
      });
      
      // Load the API when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing Google Places API...');
        loadGooglePlacesAPI();
        
        // Initialize FDIC Bank Lookup
        initializeFDICLookup();
      });
      
      // FDIC Bank Lookup Functionality
      function initializeFDICLookup() {
        console.log('🏦 Initializing FDIC bank lookup...');
        
        // Set up ACH routing number lookup
        const achRoutingInput = document.getElementById('ach_routing_number');
        const achBankNameInput = document.getElementById('ach_bank_name');
        
        if (achRoutingInput && achBankNameInput) {
          achRoutingInput.addEventListener('input', function() {
            const routingNumber = this.value.replace(/\D/g, ''); // Remove non-digits
            
            // Format routing number as user types
            if (routingNumber.length <= 9) {
              this.value = routingNumber;
            }
            
            // Lookup bank name when 9 digits are entered
            if (routingNumber.length === 9) {
              lookupBankByRoutingNumber(routingNumber, achBankNameInput);
            } else {
              // Clear bank name if routing number is incomplete
              achBankNameInput.value = '';
              achBankNameInput.style.backgroundColor = '';
            }
          });
          
          console.log('🏦 ACH routing number lookup initialized');
        }
        
        // Set up Wire routing number lookup (if needed)
        const wireRoutingInput = document.getElementById('wire_routing_number');
        const wireBankNameInput = document.getElementById('wire_bank_name');
        
        if (wireRoutingInput && wireBankNameInput) {
          wireRoutingInput.addEventListener('input', function() {
            const routingNumber = this.value.replace(/\D/g, '');
            
            if (routingNumber.length <= 9) {
              this.value = routingNumber;
            }
            
            if (routingNumber.length === 9) {
              lookupBankByRoutingNumber(routingNumber, wireBankNameInput);
            } else {
              wireBankNameInput.value = '';
              wireBankNameInput.style.backgroundColor = '';
            }
          });
          
          console.log('🏦 Wire routing number lookup initialized');
        }
      }
      
      // FDIC Bank Lookup Function
      async function lookupBankByRoutingNumber(routingNumber, bankNameField) {
        console.log('🏦 Looking up bank for routing number:', routingNumber);
        
        try {
          // Show loading state
          bankNameField.value = 'Looking up bank...';
          bankNameField.style.backgroundColor = '#f0f9ff';
          bankNameField.disabled = true;
          
          // Call FDIC API via our backend
          const response = await fetch(`/api/routing/${routingNumber}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          
          if (response.ok && result.bankName) {
            // Successfully found bank
            bankNameField.value = result.bankName;
            bankNameField.style.backgroundColor = '#dcfce7'; // Light green
            bankNameField.disabled = false;
            
            console.log('🏦 Bank found:', result.bankName);
            showToast(`✅ Bank found: ${result.bankName}`);
            
            // Auto-save after bank lookup
            if (signedIn || window.signedIn) {
              setTimeout(() => {
                handleSaveDraft('bank-lookup');
              }, 500);
            }
            
          } else {
            // Bank not found or invalid routing number
            bankNameField.value = '';
            bankNameField.style.backgroundColor = '#fef2f2'; // Light red
            bankNameField.disabled = false;
            bankNameField.placeholder = 'Bank not found - please enter manually';
            
            console.log('🏦 Bank not found for routing number:', routingNumber);
            showToast('⚠️ Bank not found for this routing number');
          }
          
        } catch (error) {
          console.error('🏦 FDIC lookup error:', error);
          
          // Reset field on error
          bankNameField.value = '';
          bankNameField.style.backgroundColor = '#fef2f2';
          bankNameField.disabled = false;
          bankNameField.placeholder = 'Error looking up bank - please enter manually';
          
          showToast('❌ Error looking up bank name');
        }
      }
    </script>
    
    <script>
      // Show/hide Management/Franchise Company fields based on selection in Section 2
      document.addEventListener('DOMContentLoaded', function(){
        const selectEl = document.getElementById('is_management_company_managed');
        const fieldsEl = document.getElementById('managementCompanyFields');
        
        function updateVisibility() {
          if (!selectEl || !fieldsEl) return;
          
          console.log('Management company visibility check:', {
            selectValue: selectEl.value,
            fieldsElement: !!fieldsEl
          });
          
          // Check if dropdown is set to "Yes"
          const isYes = (selectEl.value === 'Yes');
          
          // Also check if any management company fields have data
          const hasData = Array.from(fieldsEl.querySelectorAll('input')).some(input => input.value.trim() !== '');
          
          console.log('Management company data check:', {
            isYes: isYes,
            hasData: hasData,
            fieldValues: Array.from(fieldsEl.querySelectorAll('input')).map(input => ({name: input.name, value: input.value}))
          });
          
          // Show fields if dropdown is "Yes" OR if there's data in the fields
          const shouldShow = isYes || hasData;
          fieldsEl.style.display = shouldShow ? 'block' : 'none';
          
          console.log('Management company fields visibility:', {
            shouldShow: shouldShow,
            actualDisplay: fieldsEl.style.display
          });
          
          // If there's data but dropdown isn't "Yes", set it to "Yes" to maintain consistency
          if (hasData && !isYes) {
            selectEl.value = 'Yes';
            console.log('Auto-set dropdown to Yes due to existing data');
          }
        }
        
        if (selectEl) {
          selectEl.addEventListener('change', updateVisibility);
          // Initialize on load with delay to ensure all data is loaded
          setTimeout(updateVisibility, 100);
          setTimeout(updateVisibility, 500); // Additional check after draft loading
          setTimeout(updateVisibility, 1000); // Final check
        }

        // Re-run visibility when returning via bfcache/back navigation
        window.addEventListener('pageshow', function(){
          if (selectEl) {
            setTimeout(updateVisibility, 100);
          }
        });
        
        // Also run when form data is populated (for draft loading)
        window.addEventListener('formDataLoaded', function(){
          if (selectEl) {
            setTimeout(updateVisibility, 100);
          }
        });
      });
    </script>
    
    <script>
      window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX', {
            // Enhanced ecommerce and event tracking
            send_page_view: true,
            custom_map: {
                'custom_parameter_1': 'fedevent_website'
            }
        });
        
        // Custom event tracking functions
        function trackNavigationClick(section) {
            gtag('event', 'navigation_click', {
                'event_category': 'Website Navigation',
                'event_label': section,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackButtonClick(buttonName) {
            gtag('event', 'button_click', {
                'event_category': 'Website Interaction',
                'event_label': buttonName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        function trackFormSubmission(formName) {
            gtag('event', 'form_submission', {
                'event_category': 'Website Forms',
                'event_label': formName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
        
        // Dropdown functionality
        function toggleLogoDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('logoDropdown');
            const userDropdown = document.getElementById('userDropdown');
            
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (userDropdown) userDropdown.style.display = 'none';
        }
        
        function toggleUserDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            const logoDropdown = document.getElementById('logoDropdown');
            
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (logoDropdown) logoDropdown.style.display = 'none';
        }

        function logoutUser() {
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            window.location.href = '/hotel-login.html';
        }

        function loadUserMenu() {
            try {
                const sessionId = localStorage.getItem('fedevent_session');
                const userRaw = localStorage.getItem('fedevent_user');
                if (!sessionId || !userRaw) return;
                const user = JSON.parse(userRaw);
                let name = user.first_name && user.last_name ? `${user.first_name} ${user.last_name}` : (user.first_name || user.username || user.email || 'User');
                name = name.replace(/\b(Hotel|User)\b/gi, '').trim();
                const initial = (name || 'U').trim().charAt(0).toUpperCase();
                document.getElementById('userNameLabel').textContent = name;
                document.getElementById('userInitial').textContent = initial;
                document.getElementById('userMenu').style.display = 'list-item';
            } catch (e) { /* noop */ }
        }

        document.addEventListener('DOMContentLoaded', loadUserMenu);
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const logoDropdown = document.getElementById('logoDropdown');
            const userDropdown = document.getElementById('userDropdown');
            const logoMenu = document.querySelector('.logo-menu');
            const userMenu = document.getElementById('userMenu');
            
            if (logoDropdown && logoMenu && !logoMenu.contains(event.target)) {
                logoDropdown.style.display = 'none';
            }
            
            if (userDropdown && userMenu && !userMenu.contains(event.target)) {
                userDropdown.style.display = 'none';
            }
        });
        
        function trackPageView(pageName) {
            gtag('event', 'page_view', {
                'event_category': 'Page Views',
                'event_label': pageName,
                'custom_parameter_1': 'fedevent_website'
            });
        }
    </script>
</head>
<body>
    <header>
      <nav class="container">
        <div class="logo-menu" style="position: relative;">
          <a href="javascript:void(0)" class="logo" onclick="toggleLogoDropdown(event)">FEDEVENT <span style="font-size: 0.7em;">▾</span></a>
          <div class="logo-dropdown" id="logoDropdown" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 200px; display: none; z-index: 1000;">
            <a href="/" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Home</a>
            <a href="/hotel-signup.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Hotel Registration</a>
            <a href="/hotel-login.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Hotel Portal</a>
            <a href="/government-portal.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Government Portal</a>
            <a href="/resources.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Resources</a>
            <a href="/about.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151;">About</a>
          </div>
        </div>
        <ul class="nav-links">
          <li id="userMenu" class="user-menu" style="display:none;">
            <a class="user-trigger" href="javascript:void(0)" onclick="toggleUserDropdown(event)">
              <span class="user-avatar" id="userInitial">U</span>
              <span id="userNameLabel">User</span>
              <span aria-hidden>▾</span>
            </a>
            <div class="user-dropdown" id="userDropdown">
              <a href="/hotel-dashboard.html">Hotel Portal</a>
              <a href="/hotel-profile.html">User Settings</a>
              <button type="button" onclick="logoutUser()">Logout</button>
            </div>
          </li>
        </ul>
      </nav>
    </header>

<div class="wrap">
  <!-- Command Bar -->
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin:12px 0 8px 0;">
    <div style="display:flex; gap:12px; align-items:center;">
      <button onclick="window.location.href='/hotel-dashboard.html'" class="btn" style="background:#065f46; color:#fff; padding:10px 20px; border:none; border-radius:8px; font-weight:600; white-space:nowrap;">
        ← Back to Profile
      </button>
      <button onclick="localLogout()" class="btn" style="background:#dc2626; color:#fff; padding:10px 20px; border:none; border-radius:8px; font-weight:600;">
        Logout
      </button>
    </div>
  </div>
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <div>
        <h1 style="margin: 0;">Hotel Profile Registration</h1>
        <p class="lead" style="margin: 6px 0 0 0;">Complete this profile so we can match your property to U.S. Government group events. <strong>NET30 payment terms and PO acceptance are required.</strong></p>
      </div>
      
    </div>
    
    <!-- Draft Status -->
    <div id="draftStatus" style="display: none; background: #eef4ff; border: 1px solid #c5d6f3; border-radius: 8px; padding: 12px; margin: 16px 0;">
      <div style="display: flex; align-items: center; gap: 8px; color: #0a58ca;">
        <span>💾</span>
        <strong>Draft Saved</strong>
        <span id="draftInfo" style="color: #5b6b7b; font-size: 0.9rem;"></span>
      </div>
    </div>
    
    <!-- Auto-save Status (only visible in continue mode) -->
    <div id="autoSaveInfo" style="display: none; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin: 16px 0; font-size: 0.85rem;">
      <div style="color: #0369a1; display: flex; align-items: center; gap: 8px;">
        <span id="autoSaveIcon">💾</span>
        <strong>Auto-save enabled:</strong> 
        <span id="autoSaveText">Your progress is automatically saved every 2 minutes and when you make changes</span>
        <span id="autoSaveStatus" style="margin-left: auto; font-size: 0.8rem; opacity: 0.8;"></span>
      </div>
    </div>
    

    <div class="steps" id="steps">
      <div class="step" data-step="1"><span class="dot">1</span> Company Information</div>
      <div class="step" data-step="2"><span class="dot">2</span> Rooms & Meeting Space</div>
      <div class="step" data-step="3"><span class="dot">3</span> Terms & Uploads</div>
      <div class="step" data-step="4"><span class="dot">4</span> Completion</div>
    </div>

    <form id="hotel-form" method="POST" enctype="multipart/form-data" autocomplete="off">
      <input type="hidden" name="form_type" value="hotel_profile_v2">

      <!-- PAGE 0 removed: Start/Pre-Qualification & Account Options. Wizard begins at Company Information. -->
      <div class="page" data-page="0" style="display:none"></div>

      <!-- PAGE 1 -->
      <div class="page" data-page="1">
        <fieldset>
          <legend>1) Property Identity</legend>
          <div class="row" style="margin-top:8px">
            <div class="col-6"><label>Hotel Name <span class="required">*</span></label><input name="hotel_name" required /></div>
            <div class="col-3"><label>Brand</label><input name="brand" /></div>
            <div class="col-3"><label>Chain</label><input name="chain" /></div>
            <div class="col-6"><label>Hotel Property Code</label><input name="hotel_property_code" /></div>
            <div class="col-6"><label>Hotel Address <span class="required">*</span></label><input name="address" required /></div>
            <div class="col-3"><label>City <span class="required">*</span></label><input name="city" required /></div>
            <div class="col-3"><label>State / Province</label><input name="state" /></div>
            <div class="col-3"><label>Postal Code</label><input name="zip" /></div>
            <div class="col-3"><label>Country <span class="required">*</span></label><input name="country" required /></div>
            <div class="col-3"><label>Hotel Phone <span class="required">*</span></label><input type="tel" name="hotel_phone" required /></div>
            <div class="col-3"><label>Year Built</label><input type="number" name="year_built" min="1900" max="2100" /></div>
            <div class="col-3"><label>Last Renovation (Year)</label><input type="number" name="last_renovation" min="1900" max="2100" /></div>
            <div class="col-6"><label>Website</label><input type="url" name="website" placeholder="https://"/></div>
            <input type="hidden" id="hotel_place_id" name="hotel_place_id" />
          </div>
        </fieldset>

        <fieldset>
          <legend>1.1) Hotel Main Photo</legend>
          <div class="row">
            <div class="col-12">
              <label>Hotel Exterior Photo <span class="required">*</span></label>
              <input type="file" name="hotel_main_photo" id="hotel_main_photo" accept="image/jpeg,image/jpg,image/png" required />
              <div class="hint" style="margin-top:6px;">
                <strong>📷 Photo Requirements:</strong><br>
                • <strong>Exterior view only:</strong> Take the photo as if you're standing across from the hotel looking directly at the main entrance/facade<br>
                • <strong>One photo only:</strong> Upload your best exterior shot<br>
                • <strong>File size:</strong> Maximum 5MB (recommended: 1-3MB for optimal quality)<br>
                • <strong>Format:</strong> JPG, JPEG, or PNG<br>
                • <strong>Quality:</strong> Clear, well-lit photo showing the hotel's exterior architecture and signage
              </div>
              <div id="photo_preview" style="margin-top:10px; display:none;">
                <img id="preview_image" style="max-width:200px; max-height:150px; border-radius:8px; border:1px solid #e6ecf2;" />
                <div style="font-size:0.85rem; color:#5b6b7b; margin-top:4px;" id="photo_info"></div>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>2) Management/Franchise Company Information</legend>
          <div class="item">
            <label>Is the hotel managed by a management company or franchise operator?</label>
            <select id="is_management_company_managed" name="is_management_company_managed">
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
            <div class="hint">Select "Yes" to provide management/franchise company details.</div>
          </div>
          <div id="managementCompanyFields" style="display:none; margin-top:8px;">
            <div class="row">
              <div class="col-6"><label>Management/Franchise Company Name</label><input name="management_company" autocomplete="section-management organization" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-6"><label>Company Address</label><input name="management_company_address" autocomplete="section-management address-line1" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-6"><label>Company Street Address</label><input name="management_company_street" autocomplete="section-management address-line1" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company City</label><input name="management_company_city" autocomplete="section-management address-level2" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company State/Province</label><input name="management_company_state" autocomplete="section-management address-level1" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company Postal Code</label><input name="management_company_zip" autocomplete="section-management postal-code" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-3"><label>Company Country</label><input name="management_company_country" autocomplete="section-management country-name" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <div class="col-6"><label>Company Website</label><input type="url" name="management_company_website" placeholder="https://" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" /></div>
              <input type="hidden" id="management_company_place_id" name="management_company_place_id" />
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>3) Primary Contacts</legend>
          <div class="hint" style="margin-top:6px">Please assign one role for one user.</div>
          <div class="row sign-contact" data-index="0" style="margin-top:8px">
            <div class="col-6">
              <label>Name <span class="required">*</span></label><input type="text" name="sign_contacts[0][name]" required autocomplete="section-contacts-0 name" />
              <label>Role</label>
              <select name="sign_contacts[0][role]" required onchange="checkRoleConflict(this, 0)">
                <option value="">Select a role</option>
                <option value="Signer">Signer</option>
                <option value="Approver">Approver</option>
              </select>
              <label>Title</label>
              <select name="sign_contacts[0][title]">
                <option value="Sales Coordinator">Sales Coordinator</option>
                <option value="Sales Manager">Sales Manager</option>
                <option value="Director of Sales">Director of Sales</option>
                <option value="Owner">Owner</option>
                <option value="General Manager">General Manager</option>
                <option value="Corporate Director">Corporate Director</option>
                <option value="Hotel Director of Sales">Hotel Director of Sales</option>
              </select>
            </div>
            <div class="col-6">
              <label>Email <span class="required">*</span></label><input type="email" name="sign_contacts[0][email]" required autocomplete="section-contacts-0 email" />
              <label>Phone</label><input type="tel" name="sign_contacts[0][phone]" autocomplete="section-contacts-0 tel" />
            </div>
          </div>
          <div class="row sign-contact" data-index="1" style="margin-top:8px">
            <div class="col-6">
              <label>Name <span class="required">*</span></label><input type="text" name="sign_contacts[1][name]" required autocomplete="section-contacts-1 name" />
              <label>Role</label>
              <select name="sign_contacts[1][role]" required onchange="checkRoleConflict(this, 1)">
                <option value="">Select a role</option>
                <option value="Signer">Signer</option>
                <option value="Approver">Approver</option>
              </select>
              <label>Title</label>
              <select name="sign_contacts[1][title]">
                <option value="Sales Coordinator">Sales Coordinator</option>
                <option value="Sales Manager">Sales Manager</option>
                <option value="Director of Sales">Director of Sales</option>
                <option value="Owner">Owner</option>
                <option value="General Manager">General Manager</option>
                <option value="Corporate Director">Corporate Director</option>
                <option value="Hotel Director of Sales">Hotel Director of Sales</option>
              </select>
            </div>
            <div class="col-6">
              <label>Email <span class="required">*</span></label><input type="email" name="sign_contacts[1][email]" required autocomplete="section-contacts-1 email" />
              <label>Phone</label><input type="tel" name="sign_contacts[1][phone]" autocomplete="section-contacts-1 tel" />
            </div>
          </div>
          <div class="hint" style="margin-top:6px">Approver signs after signer and has higher authority. Signatures apply to important documents that need to be signed.</div>
          <div class="alert err" id="signContactsError" style="display:none; margin-top:8px"></div>
        </fieldset>

        <fieldset>
          <legend>3) AAA Rating</legend>
          <div class="row">
            <div class="col-6">
              <label>Are you an AAA rated hotel? <span class="required">*</span></label>
              <select name="is_aaa_rated" id="is_aaa_rated" required>
                <option value="">Select…</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-6" id="aaa_diamond_section" style="display:none;">
              <label>How many diamond rating do you have? <span class="required">*</span></label>
              <select name="aaa_diamond_rating" id="aaa_diamond_rating">
                <option value="">Select…</option>
                <option value="2 Diamond (APPROVED)">2 Diamond (APPROVED)</option>
                <option value="3 Diamond">3 Diamond</option>
                <option value="4 Diamond">4 Diamond</option>
                <option value="5 Diamond">5 Diamond</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>4) Bank Account Information</legend>
          <p class="muted" style="margin-bottom:16px;">Please provide banking information for payment processing. Choose the appropriate section based on your hotel's location.</p>
          
          <div class="row">
            <div class="col-12">
              <label>Hotel Location <span class="required">*</span></label>
              <select name="hotel_location_type" id="hotel_location_type" required>
                <option value="">Select hotel location (required)…</option>
                <option value="US">United States (US-based hotel)</option>
                <option value="International">International hotel</option>
                <option value="skip">Skip - I'll provide banking information later</option>
              </select>
              <div class="hint">Please select an option to continue. You can choose to skip banking information and provide it later if needed.</div>
            </div>
          </div>

          <!-- ACH Section for US Hotels -->
          <div id="ach_section" style="display:none; margin-top:16px;">
            <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:16px; margin-bottom:16px;">
              <h4 style="margin:0 0 12px 0; color:var(--accent); font-size:1rem;">🏦 ACH Bank Account Information (US Hotels)</h4>
              <div class="hint" style="margin-bottom:12px;">For US-based hotels - Electronic fund transfers via ACH</div>
              
              <div class="row">
                <div class="col-12">
                  <label>Bank Account Name <span class="required">*</span></label>
                  <input name="ach_bank_account_name" id="ach_bank_account_name" placeholder="e.g., ABC Hotel Management LLC" />
                  <button type="button" class="btn subtle" id="copyCompanyToAchName" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from Hotel Name</button>
                </div>
                <div class="col-3">
                  <label>Bank Routing Number <span class="required">*</span></label>
                  <input name="ach_routing_number" id="ach_routing_number" placeholder="9-digit routing number" maxlength="9" pattern="[0-9]{9}" />
                  <div class="hint">9-digit ABA routing number • Bank name will auto-populate when you enter a valid routing number</div>
                </div>
                <div class="col-3">
                  <label>Bank Account Number <span class="required">*</span></label>
                  <input name="ach_account_number" id="ach_account_number" placeholder="Enter account number" />
                </div>
                <div class="col-3">
                  <label>Confirm Bank Account Number</label>
                  <input name="ach_account_number_confirm" id="ach_account_number_confirm" placeholder="Re-enter account number" />
                  <div id="ach_account_match" style="display:none; font-size:0.85rem; margin-top:4px;"></div>
                </div>
                <div class="col-3">
                  <label>Bank Name <span class="required">*</span></label>
                  <input name="ach_bank_name" id="ach_bank_name" placeholder="e.g., Bank of America, Wells Fargo" />
                </div>
                <div class="col-6">
                  <label>Accounts Receivable Contact Email <span class="required">*</span></label>
                  <input type="email" name="ach_ar_email" id="ach_ar_email" placeholder="ar@hotel.com" />
                  <button type="button" class="btn subtle" id="copyArEmailToAch" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from A/R Email</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Wire Transfer Section for International Hotels -->
          <div id="wire_section" style="display:none; margin-top:16px;">
            <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:16px; margin-bottom:16px;">
              <h4 style="margin:0 0 12px 0; color:var(--accent); font-size:1rem;">🌍 Wire Transfer Information (International Hotels)</h4>
              <div class="hint" style="margin-bottom:12px;">For international hotels - International wire transfers</div>
              
              <div class="row">
                <div class="col-12">
                  <label>Bank Account Name <span class="required">*</span></label>
                  <input name="wire_bank_account_name" id="wire_bank_account_name" placeholder="e.g., ABC Hotel Management LLC" />
                  <button type="button" class="btn subtle" id="copyCompanyToWireName" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from Hotel Name</button>
                </div>
                <div class="col-3">
                  <label>Bank Name <span class="required">*</span></label>
                  <input name="wire_bank_name" id="wire_bank_name" placeholder="e.g., HSBC, Deutsche Bank" />
                </div>
                <div class="col-3">
                  <label>SWIFT Code <span class="required">*</span></label>
                  <input name="wire_swift_code" id="wire_swift_code" placeholder="e.g., HSBCGB2L" style="text-transform:uppercase;" />
                  <div class="hint">8-11 character SWIFT/BIC code</div>
                </div>
                <div class="col-3">
                  <label>Bank Account Number <span class="required">*</span></label>
                  <input name="wire_account_number" id="wire_account_number" placeholder="Enter account number" />
                </div>
                <div class="col-3">
                  <label>Confirm Bank Account Number</label>
                  <input name="wire_account_number_confirm" id="wire_account_number_confirm" placeholder="Re-enter account number" />
                  <div id="wire_account_match" style="display:none; font-size:0.85rem; margin-top:4px;"></div>
                </div>
                <div class="col-6">
                  <label>Bank Address</label>
                  <input name="wire_bank_address" id="wire_bank_address" placeholder="Bank street address" />
                </div>
                <div class="col-3">
                  <label>Bank City</label>
                  <input name="wire_bank_city" id="wire_bank_city" placeholder="City" />
                </div>
                <div class="col-3">
                  <label>Bank Country</label>
                  <input name="wire_bank_country" id="wire_bank_country" placeholder="Country" />
                </div>
                <div class="col-6">
                  <label>Accounts Receivable Contact Email <span class="required">*</span></label>
                  <input type="email" name="wire_ar_email" id="wire_ar_email" placeholder="ar@hotel.com" />
                  <button type="button" class="btn subtle" id="copyArEmailToWire" style="margin-top:4px; font-size:0.85rem; padding:4px 8px;">Copy from A/R Email</button>
                </div>
                <div class="col-6">
                  <label>Additional Wire Instructions</label>
                  <textarea name="wire_instructions" id="wire_instructions" placeholder="Any special instructions for wire transfers" style="min-height:60px;"></textarea>
                </div>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Payment & Compliance moved to Terms & Uploads step -->
      </div>

      <!-- PAGE 2 (Rooms & Meeting Space) -->
      <div class="page" data-page="2">
        <fieldset>
          <legend>Sleeping Rooms Inventory</legend>
          <div class="row">
            <div class="col-3"><label>Total Guest Rooms</label><input type="number" name="total_rooms" min="0" /></div>
            <div class="col-3"><label>Kings</label><input type="number" name="king_rooms" min="0" /></div>
            <div class="col-3"><label>Doubles / Queens</label><input type="number" name="double_rooms" min="0" /></div>
            <div class="col-3"><label>Suites</label><input type="number" name="suites" min="0" /></div>
            <div class="col-3"><label>Accessible (ADA) Rooms</label><input type="number" name="ada_rooms" min="0" /></div>
            <div class="col-3"><label>Max Group Block (rooms)</label><input type="number" name="max_group_block" min="0" /></div>
            <div class="col-3"><label>Comp Room Ratio</label><input name="comp_ratio" placeholder="e.g., 1:30" /></div>
            <div class="col-3"><label>Cutoff (days)</label><input type="number" name="cutoff_days" min="0" /></div>
            <div class="col-12">
              <label>Breakfast Included?</label>
              <select name="breakfast_included"><option value="">Select…</option><option>Yes – Full</option><option>Yes – Continental</option><option>No</option></select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Extended Stay</legend>
          <div class="row">
            <div class="col-12">
              <label>Is your property an Extended Stay hotel? <span class="required">*</span></label>
              <select name="is_extended_stay" id="is_extended_stay" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
              <div class="hint">If Yes, more questions appear below.</div>
            </div>
          </div>
        </fieldset>

        <fieldset id="extendedStaySection" style="display:none;">
          <legend>Extended Stay Amenities</legend>
          <div class="row">
            <div class="col-4"><label>In-Room Kitchen <span class="required">*</span></label><select name="ext_kitchen" data-es-required="1"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Fully Equipped? <span class="required">*</span></label><select name="ext_kitchen_equipped" data-es-required="1"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Washer / Dryer <span class="required">*</span></label><select name="ext_washer_dryer" data-es-required="1"><option value="">Select…</option><option>In-room</option><option>On-site – self-service</option><option>On-site – valet</option><option>None</option></select></div>
            <div class="col-4"><label>Stovetop</label><select name="ext_equipment_stovetop"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Oven</label><select name="ext_equipment_oven"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Microwave</label><select name="ext_equipment_microwave"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Refrigerator</label><select name="ext_equipment_fridge"><option value="">Select…</option><option>Full-size</option><option>Mid-size</option><option>Mini</option></select></div>
            <div class="col-4"><label>Dishwasher</label><select name="ext_equipment_dishwasher"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Cookware & Utensils</label><select name="ext_equipment_cookware"><option value="">Select…</option><option>Yes – Full set</option><option>Yes – Basic</option><option>No</option></select></div>
            <div class="col-6"><label>Laundry Details / Cost</label><input name="ext_laundry_cost_notes" /></div>
            <div class="col-6"><label>Housekeeping Frequency</label><input name="ext_housekeeping_frequency" /></div>
            <div class="col-6"><label>Long-Stay Rate Options</label><input name="ext_long_stay_rates" /></div>
            <div class="col-3"><label>Pet Friendly</label><select name="ext_pet_friendly"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-9"><label>Pet Policy/Fees</label><input name="ext_pet_notes" placeholder="Pet policy and applicable fees" /></div>
            <div class="col-4"><label>On-site Market/Pantry</label><select name="ext_market_pantry"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Grocery Delivery Partnership</label><select name="ext_grocery_delivery"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Grocery Partner</label><input name="ext_grocery_partner" /></div>
            <div class="col-4"><label>Ventilated Range Hood</label><select name="ext_kitchen_ventilation"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Fire Suppression at Cooktop</label><select name="ext_fire_suppression"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Cooking Restrictions</label><input name="ext_cooking_restrictions" /></div>
            <div class="col-12"><label>Notes (Extended Stay)</label><textarea name="ext_extended_stay_notes"></textarea></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Meeting Spaces</legend>
          <div class="inline">
            <button class="btn subtle" type="button" id="addRoomBtn">+ Add Meeting Space</button>
            <span class="hint">Add each room with dimensions and capacities.</span>
          </div>
          <div id="rooms"></div>
        </fieldset>

        <fieldset>
          <legend>A/V Services</legend>
          <div class="row">
            <div class="col-6">
              <label>In-house A/V Services? <span class="required">*</span></label>
              <select name="av_in_house" id="av_in_house" required>
                <option value="">Select…</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-6" id="av_provider_section" style="display:none;">
              <label>Name of A/V Service Provider</label>
              <input name="av_provider_name" placeholder="e.g., ABC Audio Visual Services" />
            </div>
            <div class="col-6">
              <label>Allow Outside A/V Services? <span class="required">*</span></label>
              <select name="av_outside_allowed" id="av_outside_allowed" required>
                <option value="">Select…</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-6" id="av_outside_fees_section" style="display:none;">
              <label>Outside A/V Service Fees</label>
              <input name="av_outside_fees" placeholder="e.g., $500 setup fee, $200/day" />
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Rates & Fees</legend>
          <div class="row">
            <div class="col-4"><label>Resort / Destination Fee</label><input name="resort_fee" /></div>
            <div class="col-4"><label>Taxes (Total %) <span class="required">*</span></label><input name="tax_percent" placeholder="e.g., 14.5%" required /></div>
            <div class="col-4"><label>Self-Parking Fee</label><input name="self_parking" /></div>
            <div class="col-4"><label>Valet Parking Fee</label><input name="valet_parking" /></div>
            <div class="col-4"><label>In-Room Wi-Fi Fee</label><input name="wifi_fee" /></div>
          </div>
        </fieldset>
      </div>

      <!-- PAGE 3 (Terms & Uploads) -->
      <div class="page" data-page="3">
        <fieldset>
          <legend>Payment & Compliance</legend>
          <div class="row">
            <div class="col-4">
              <label>Accepts NET30 (CREATA prime)? <span class="required">*</span></label>
              <select name="accepts_net30" id="accepts_net30" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
            </div>
            <div class="col-4">
              <label>Accepts Purchase Orders (PO)? <span class="required">*</span></label>
              <select name="accepts_po" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
            </div>
            <div class="col-6"><label>Attrition Policy</label><input name="attrition_policy" /><div class="hint"><strong>Decision Note:</strong> No attrition is prioritized.</div></div>
            <div class="col-6"><label>Cancellation Policy</label><input name="cancellation_policy" /><div class="hint"><strong>Decision Note:</strong> No cancellation penalties are favored.</div></div>
            <div class="col-12">
              <div class="inline"><input id="terms_ack" type="checkbox" required />
                <label for="terms_ack" style="font-weight:500">I acknowledge that <strong>NET30</strong> is required and CREATA issues a Government-backed <strong>PO</strong>.</label>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Logistics, Security & Accessibility</legend>
          <div class="row">
            <div class="col-4"><label>On-Site Kitchen</label><select name="onsite_kitchen"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Outside Catering Allowed</label><select name="outside_catering"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Special Diets</label><input name="special_diets" placeholder="Halal, Kosher, Vegan, etc." /></div>
            <div class="col-6"><label>F&amp;B Minimums</label><input name="fb_minimums" placeholder="e.g., $15,000/day in ballroom" /></div>
            <div class="col-6"><label>Liquor License</label><select name="liquor_license"><option value="">Select…</option><option>Yes</option><option>No</option></select></div>
            <div class="col-4"><label>Bus / Motorcoach Parking</label><input name="bus_parking" /></div>
            <div class="col-4"><label>Loading Dock / Freight Elevator</label><input name="freight" /></div>
            <div class="col-4"><label>Security</label><input name="security" /></div>
            <div class="col-4"><label>ADA Features</label><input name="ada_features" /></div>
            <div class="col-4"><label>EV Chargers (qty/type)</label><input name="ev_chargers" /></div>
            <div class="col-4">
              <label>Childcare via Third-Party? <span class="required">*</span></label>
              <select name="childcare_third_party" required><option value="">Select…</option><option>Yes – Hotel arranges</option><option>Yes – Referral list only</option><option>No</option></select>
            </div>
            <div class="col-12"><label>Childcare Provider Details</label><input name="childcare_notes" placeholder="Providers, certifications, hours, ratios" /></div>
            <div class="col-4"><label>Union Status</label><select name="union_status"><option value="">Select…</option><option>Union</option><option>Non-Union</option><option>Hybrid</option></select></div>
            <div class="col-12"><label>Blackout Dates</label><textarea name="blackout_dates" placeholder="List known blackout dates or citywides. "></textarea></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Uploads</legend>
          <div class="row">
            <div class="col-6"><label>Hotel Fact Sheet (PDF)</label><input type="file" name="fact_sheet" accept="application/pdf" /></div>
            <div class="col-6"><label>Floor Plans / Diagrams (PDF, multiple)</label><input type="file" name="floor_plans" accept="application/pdf" multiple /></div>
            <div class="col-6"><label>AV Rate Card (PDF)</label><input type="file" name="av_rate_card" accept="application/pdf" /></div>
            <div class="col-6"><label>Banquet Menus (PDF)</label><input type="file" name="banquet_menus" accept="application/pdf" /></div>
            <div class="col-6"><label>Fire/Life Safety Certificate (PDF)</label><input type="file" name="fls_certificate" accept="application/pdf" /></div>
            <div class="col-6"><label>Insurance COI (PDF)</label><input type="file" name="coi" accept="application/pdf" /></div>
            <div class="col-12"><label>Photos (JPG/PNG, multiple)</label><input type="file" name="photos" accept="image/*" multiple /></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Notes (Optional)</legend>
          <textarea name="notes" placeholder="Anything else we should know about your hotel. "></textarea>
        </fieldset>
      </div>

      <!-- PAGE 4 (Completion) -->
      <div class="page" data-page="4">
        <fieldset>
          <legend>Review & Submit</legend>
          <p class="muted">Review your hotel profile information below. Click "Submit Profile" when ready.</p>
          
          <div id="completionSummary" style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin:20px 0;">
            <h3 style="color:#1f2937; margin-top:0; margin-bottom:16px;">📋 Profile Summary</h3>
            <div id="summaryContent">
              <!-- Summary will be populated by JavaScript -->
            </div>
          </div>
          
          <div style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:12px; padding:16px; margin:20px 0;">
            <h4 style="color:#0369a1; margin-top:0; margin-bottom:12px;">⚠️ Important Reminders</h4>
            <ul style="color:#0369a1; margin:0; padding-left:20px;">
              <li><strong>NET30 payment terms</strong> are required for all government contracts</li>
              <li><strong>Purchase Order acceptance</strong> is mandatory</li>
              <li>Your profile will be reviewed before approval</li>
              <li>You'll receive email confirmation once submitted</li>
            </ul>
          </div>

          <!-- Account Upgrade Options -->
          <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin:20px 0;">
            <h3 style="color:#1f2937; margin-top:0; margin-bottom:16px;">🚀 Account Upgrade Options</h3>
            <p style="color:#6b7280; margin-bottom:20px;">Start with our free Basic account. Upgrade later for enhanced features!</p>
            
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
              <!-- Basic Account -->
              <div style="background:#fff; border:2px solid #10b981; border-radius:12px; padding:20px; position:relative;">
                <div style="background:#10b981; color:#fff; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; position:absolute; top:-10px; left:20px;">CURRENT</div>
                <h4 style="color:#1f2937; margin-top:8px; margin-bottom:12px;">Basic Account</h4>
                <div style="font-size:1.5rem; font-weight:700; color:#10b981; margin-bottom:16px;">FREE</div>
                <ul style="color:#6b7280; margin:0; padding-left:20px; font-size:0.9rem;">
                  <li>Hotel profile listing</li>
                  <li>Government event matching</li>
                  <li>Standard support</li>
                  <li>Basic analytics</li>
                </ul>
              </div>

              <!-- Professional Account -->
              <div style="background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:20px; position:relative;">
                <div style="background:#f59e0b; color:#fff; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; position:absolute; top:-10px; left:20px;">COMING SOON</div>
                <h4 style="color:#1f2937; margin-top:8px; margin-bottom:12px;">Professional</h4>
                <div style="font-size:1.5rem; font-weight:700; color:#f59e0b; margin-bottom:16px;">$199/month</div>
                <ul style="color:#6b7280; margin:0; padding-left:20px; font-size:0.9rem;">
                  <li>Priority placement in search</li>
                  <li>Advanced analytics & insights</li>
                  <li>Enhanced profile features</li>
                  <li>Direct messaging with agencies</li>
                  <li>Custom branding on proposals</li>
                </ul>
                <button type="button" class="btn subtle" style="width:100%; margin-top:16px;" onclick="preOrderAccount('professional')">Pre-Order (Coming Soon)</button>
              </div>

              <!-- Enterprise Account -->
              <div style="background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:20px; position:relative;">
                <div style="background:#8b5cf6; color:#fff; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; position:absolute; top:-10px; left:20px;">COMING SOON</div>
                <h4 style="color:#1f2937; margin-top:8px; margin-bottom:12px;">Enterprise</h4>
                <div style="font-size:1.5rem; font-weight:700; color:#8b5cf6; margin-bottom:16px;">$399/month</div>
                <ul style="color:#6b7280; margin:0; padding-left:20px; font-size:0.9rem;">
                  <li>All Professional features</li>
                  <li>Dedicated account manager</li>
                  <li>Custom contract templates</li>
                  <li>Bulk upload capabilities</li>
                  <li>White-label proposals</li>
                  <li>Priority customer support</li>
                </ul>
                <button type="button" class="btn subtle" style="width:100%; margin-top:16px;" onclick="preOrderAccount('enterprise')">Pre-Order (Coming Soon)</button>
              </div>
            </div>
            
            <div style="background:#e0f2fe; border:1px solid #b3e5fc; border-radius:8px; padding:12px; margin-top:16px;">
              <p style="color:#0277bd; margin:0; font-size:0.9rem;">
                <strong>💡 Pre-order benefits:</strong> Get early access and special pricing when these features launch!
              </p>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- Room template -->
      <template id="room-template">
        <div class="item room">
          <div class="row">
            <div class="col-4"><label>Room Name <span class="required">*</span></label><input name="room_name[]" required /></div>
            <div class="col-2"><label>Level</label><input name="room_level[]" /></div>
            <div class="col-3"><label>Area (sq ft)</label><input type="number" name="room_area_sqft[]" min="0" /></div>
            <div class="col-3"><label>Area (m²)</label><input type="number" step="0.1" name="room_area_sqm[]" min="0" /></div>
            <div class="col-3"><label>Dimensions (ft)</label><input name="room_dims_ft[]" placeholder="L x W" /></div>
            <div class="col-3"><label>Ceiling (ft)</label><input type="number" step="0.1" name="room_ceiling_ft[]" min="0" /></div>
            <div class="col-2"><label>Pillar-Free</label><select name="room_pillar_free[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-2"><label>Natural Light</label><select name="room_natural_light[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-2"><label>Divisible</label><select name="room_divisible[]"><option></option><option>Yes</option><option>No</option></select></div>
            <div class="col-12" style="margin-top: 12px;">
              <h4 style="color: #374151; margin: 0 0 8px 0; font-size: 0.95rem; font-weight: 600;">Seating Capacity (Optional - Enter only what applies)</h4>
            </div>
            <div class="col-3"><label>Banquet Rounds</label><input type="number" name="cap_banquet_rounds[]" min="0" placeholder="e.g., 120" /></div>
            <div class="col-3"><label>Theater</label><input type="number" name="cap_theater[]" min="0" placeholder="e.g., 200" /></div>
            <div class="col-3"><label>Classroom</label><input type="number" name="cap_classroom[]" min="0" placeholder="e.g., 80" /></div>
            <div class="col-3"><label>U-Shape</label><input type="number" name="cap_ushape[]" min="0" placeholder="e.g., 24" /></div>
            <div class="col-3"><label>Cocktail Rounds</label><input type="number" name="cap_cocktail_rounds[]" min="0" placeholder="e.g., 150" /></div>
            <div class="col-3"><label>Crescent Rounds</label><input type="number" name="cap_crescent_rounds[]" min="0" placeholder="e.g., 100" /></div>
            <div class="col-3"><label>Hollow Square</label><input type="number" name="cap_hollow_square[]" min="0" placeholder="e.g., 32" /></div>
            <div class="col-3"><label>Banquet (Traditional)</label><input type="number" name="cap_banquet[]" min="0" placeholder="e.g., 80" /></div>
            <div class="col-4"><label>Built-in A/V</label><input name="room_built_in_av[]" /></div>
            <div class="col-4"><label>Power (closest)</label><input name="room_power[]" /></div>
            <div class="col-4"><label>Load-in Door</label><input name="room_loadin[]" /></div>
            <div class="col-12 right"><button class="btn danger remove-room" type="button">Remove Room</button></div>
          </div>
        </div>
      </template>

      <!-- Wizard nav -->
      <div class="hr"></div>
      <div class="nav" id="wizardNav">
        <button type="button" class="btn subtle" id="backBtn">← Back</button>
        <div class="hint" id="navHint">Submit is enabled only when NET30 and PO acceptance are set to Yes.</div>
        <div class="hint" id="guestHint" style="display:none; color:#059669; font-weight:500;">Guest Mode: You can navigate freely between pages without filling required fields.</div>
        <div class="inline">
          <button type="button" class="btn subtle" id="saveDraftBtn" onclick="handleSaveDraft()" style="display:inline-block;">💾 Save Draft</button>
          <button type="button" class="btn" id="nextBtn" onclick="handleNextClick()">Next →</button>
          <button class="btn" id="submitBtn" type="submit" disabled>
            <span class="btn-label">Submit Profile</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- overlays -->
<div class="submitting" id="submitting"><div class="panel"><div class="loader"></div><div><div style="font-weight:700;color:#0b2545">Working…</div><div class="hint">Please wait. Don't close this page.</div></div></div></div>
<div class="toast" id="toast"></div>
<div class="submitting" id="thanks"><div class="panel" style="flex-direction:column;align-items:flex-start">
  <div style="font-size:1.1rem;font-weight:700;color:#0b2545;margin-bottom:6px">Thank you — profile submitted!</div>
  <div id="thanksId" class="hint" style="margin-bottom:10px"></div>
  <div><button class="btn" id="submitAnother">Submit Another Hotel</button></div>
</div></div>

<script>
  // Route prefix for your localRouter
  const API_BASE = '';

  let form, pages, backBtn, nextBtn, submitBtn, navHint;

  let addRoomBtn, rooms, isExtendedStay, acceptsNet30, hasOutdoorFacility, isAaaRated, hotelLocationType;
  let saveDraftBtn, loadDraftBtn, discardDraftBtn, draftStatus, draftInfo;

  const submitting = document.getElementById('submitting');
  const thanks = document.getElementById('thanks');
  const thanksId = document.getElementById('thanksId');
  const submitAnother = document.getElementById('submitAnother');
  const toast = document.getElementById('toast');

  

  const startRadios = Array.from(document.querySelectorAll('input[name="start_mode"]'));
  const signupBox = document.getElementById('signupBox');
  const btnSignup = document.getElementById('btnSignup');

  let current = 0, submittingFlag = false, signedIn = false, currentUserId = null, hasDraft = false, autoSaveTimeout = null;

  // SIMPLE ROLE CONFLICT CHECK - INLINE FUNCTION
  window.checkRoleConflict = function(changedSelect, index) {
    console.log('INLINE: checkRoleConflict called for index', index, 'value:', changedSelect.value);
    
    const role0 = document.querySelector('[name="sign_contacts[0][role]"]').value;
    const role1 = document.querySelector('[name="sign_contacts[1][role]"]').value;
    
    console.log('INLINE: Current roles - role0:', role0, 'role1:', role1);
    
    if (role0 && role1 && role0 === role1) {
      console.log('INLINE: DUPLICATE DETECTED!');
      alert('ROLE CONFLICT!\n\nYou cannot assign the same role to both contacts.\n\nPlease select different roles.');
      changedSelect.value = '';
      return false;
    }
    return true;
  };

  // ENHANCED NEXT BUTTON HANDLER WITH FIELD NAVIGATION
  window.handleNextClick = function() {
    console.log('INLINE: Next button clicked, current page:', current);
    
    // Enhanced validation - find and navigate to missing required fields
    const currentPage = document.querySelector('.page.active');
    if (!currentPage) {
      console.error('INLINE: No active page found!');
      return;
    }
    
    // Check for signer dual info entrance notice
    if (!checkSignerInfo()) {
      return; // Stop if signer info is invalid
    }
    
    // Check for unfilled required fields
    if (!validateRequiredFields()) {
      return; // Stop if required fields are missing
    }
    
    // All validations passed - proceed
    console.log('INLINE: All validations passed, proceeding...');
    
    // Auto-save before moving to next page
    if (signedIn || window.signedIn) {
      handleSaveDraft('auto-next');
    }
    
    // Move to next page
    const totalPages = document.querySelectorAll('.page').length;
    if (current < totalPages - 1) {
      current++;
      console.log('INLINE: Moving to page', current);
      
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none';
      });
      
      // Show target page
      const targetPage = document.querySelector(`[data-page="${current}"]`);
      if (targetPage) {
        targetPage.classList.add('active');
        targetPage.style.display = 'block';
        console.log('INLINE: Page', current, 'is now active');
      }
      
      // Update navigation
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const backBtn = document.getElementById('backBtn');
      
      if (nextBtn) nextBtn.style.display = (current < totalPages - 1) ? 'inline-block' : 'none';
      if (submitBtn) submitBtn.style.display = (current === totalPages - 1) ? 'inline-block' : 'none';
      if (backBtn) backBtn.disabled = (current === 0);
      
      window.scrollTo(0, 0);
    }
  };

  // SIGNER DUAL INFO VALIDATION FUNCTION
  window.checkSignerInfo = function() {
    console.log('Checking signer dual info...');
    
    const role0 = document.querySelector('[name="sign_contacts[0][role]"]');
    const role1 = document.querySelector('[name="sign_contacts[1][role]"]');
    
    if (!role0 || !role1) {
      console.log('Role selectors not found');
      return true; // Skip validation if elements don't exist
    }
    
    const roleValue0 = role0.value;
    const roleValue1 = role1.value;
    
    console.log('Signer roles check:', { role0: roleValue0, role1: roleValue1 });
    
    // Check if both roles are filled and they're the same
    if (roleValue0 && roleValue1 && roleValue0 === roleValue1) {
      console.log('DUPLICATE ROLES DETECTED!');
      
      // Show entrance notice modal
      const modal = document.createElement('div');
      modal.id = 'roleConflictModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 15px;
          max-width: 500px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          text-align: center;
        ">
          <div style="font-size: 3rem; margin-bottom: 15px;">⚠️</div>
          <h3 style="color: #dc2626; margin-bottom: 15px;">SIGNER DUAL INFO ENTRANCE NOTICE</h3>
          <p style="margin-bottom: 20px; line-height: 1.5;">
            <strong>Role Conflict Detected!</strong><br><br>
            You cannot assign the same role to both contacts.<br>
            Each contact must have a different role:
          </p>
          <ul style="text-align: left; margin: 15px 0; padding-left: 20px;">
            <li><strong>Contact 1:</strong> Select "Signer" or "Approver"</li>
            <li><strong>Contact 2:</strong> Select the other role</li>
          </ul>
          <p style="margin-top: 20px; font-size: 0.9rem; color: #666;">
            Please correct this before proceeding.
          </p>
          <button onclick="document.getElementById('roleConflictModal').remove();" style="
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
          ">OK, I'll Fix This</button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Focus on the first role field
      setTimeout(() => {
        role0.focus();
        role0.style.border = '2px solid #dc2626';
        role1.style.border = '2px solid #dc2626';
        
        // Clear highlights when changed
        const clearHighlight = () => {
          role0.style.border = '';
          role1.style.border = '';
        };
        role0.addEventListener('change', clearHighlight, { once: true });
        role1.addEventListener('change', clearHighlight, { once: true });
      }, 500);
      
      return false; // Prevent proceeding
    }
    
    console.log('Signer info validation passed');
    return true;
  };

  // UNFILLED FIELD VALIDATION FUNCTION
  window.validateRequiredFields = function() {
    console.log('Validating required fields...');
    
    const currentPage = document.querySelector('.page.active');
    if (!currentPage) {
      console.error('No active page found for validation!');
      return false;
    }
    
    const requiredFields = currentPage.querySelectorAll('[required]');
    const missingFields = [];
    
    requiredFields.forEach(field => {
      if (!field.value || !field.value.trim()) {
        // Get field label
        let fieldLabel = field.name || field.id || 'Unknown field';
        const label = document.querySelector(`label[for="${field.id}"]`) || 
                     field.closest('.form-group')?.querySelector('label');
        if (label) {
          fieldLabel = label.textContent.replace('*', '').trim();
        }
        
        missingFields.push({
          element: field,
          label: fieldLabel
        });
      }
    });
    
    if (missingFields.length > 0) {
      console.log('Missing required fields:', missingFields.map(f => f.label));
      
      // Show unfilled field notice
      showUnfilledFieldNotice(missingFields);
      return false;
    }
    
    console.log('All required fields validation passed');
    return true;
  };

  // UNFILLED FIELD NOTICE FUNCTION
  window.showUnfilledFieldNotice = function(missingFields) {
    console.log('Showing unfilled field notice for:', missingFields.length, 'fields');
    
    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;
    
    const fieldsList = missingFields.map(f => `<li>${f.label}</li>`).join('');
    
    modal.innerHTML = `
      <div style="
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        text-align: center;
      ">
        <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
        <h3 style="color: #dc2626; margin-bottom: 15px;">UNFILLED FIELD NOTICE</h3>
        <p style="margin-bottom: 20px; line-height: 1.5;">
          <strong>Please complete the following required fields:</strong>
        </p>
        <ul style="text-align: left; margin: 15px 0; padding-left: 20px; color: #dc2626; font-weight: 600;">
          ${fieldsList}
        </ul>
        <p style="margin-top: 20px; font-size: 0.9rem; color: #666;">
          All required fields must be completed before proceeding to the next page.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <button onclick="window.goToFirstMissingField()" style="
            background: #059669;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">Go to First Field</button>
          <button onclick="this.closest('div').remove()" style="
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">Close</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Store missing fields for navigation
    window.currentMissingFields = missingFields;
  };

  // GO TO FIRST MISSING FIELD FUNCTION
  window.goToFirstMissingField = function() {
    if (window.currentMissingFields && window.currentMissingFields.length > 0) {
      const firstField = window.currentMissingFields[0].element;
      
      // Close modal
      document.querySelector('div[style*="position: fixed"]')?.remove();
      
      // Scroll to and focus field
      firstField.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      setTimeout(() => {
        firstField.focus();
        
        // Highlight field
        firstField.style.border = '2px solid #dc2626';
        firstField.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
        
        // Remove highlight when user starts typing
        const removeHighlight = () => {
          firstField.style.border = '';
          firstField.style.boxShadow = '';
          firstField.removeEventListener('input', removeHighlight);
        };
        firstField.addEventListener('input', removeHighlight);
      }, 500);
    }
  };

  // ENHANCED SAVE DRAFT HANDLER - ALWAYS WORKS
  window.handleSaveDraft = function(type = 'manual') {
    console.log('ENHANCED: Save draft called, type:', type);
    
    try {
      // Get all form data
      const form = document.getElementById('hotel-form');
      if (!form) {
        console.error('ENHANCED: Form not found!');
        return false;
      }
      
      const formData = new FormData(form);
      const data = {};
      
      // Convert FormData to object
      for (const [key, value] of formData.entries()) {
        if (data[key]) {
          if (Array.isArray(data[key])) {
            data[key].push(value);
          } else {
            data[key] = [data[key], value];
          }
        } else {
          data[key] = value;
        }
      }
      
      const draftData = {
        formData: data,
        currentStep: current,
        timestamp: new Date().toISOString(),
        userId: currentUserId || 'anonymous'
      };
      
      // Always save to localStorage first (most reliable)
      localStorage.setItem('hotel_registration_draft', JSON.stringify(draftData));
      
      // ALSO save with user-specific key for better reliability
      const userSpecificKey = `hotel_registration_draft_${currentUserId || 'anonymous'}`;
      localStorage.setItem(userSpecificKey, JSON.stringify(draftData));
      
      // ALSO save current page location
      localStorage.setItem('hotel_registration_current_page', current.toString());
      
      // ALSO save with timestamp for debugging
      localStorage.setItem('hotel_registration_last_save', new Date().toISOString());
      
      // ALSO save a backup with current timestamp
      const timestampKey = `hotel_registration_backup_${Date.now()}`;
      localStorage.setItem(timestampKey, JSON.stringify(draftData));
      
      // Clean up old backups (keep only last 3)
      const allKeys = Object.keys(localStorage).filter(key => key.startsWith('hotel_registration_backup_'));
      if (allKeys.length > 3) {
        allKeys.sort().slice(0, -3).forEach(key => localStorage.removeItem(key));
      }
      
      console.log('ENHANCED: Draft saved to localStorage, fields:', Object.keys(data).length, 'page:', current);
      
      // Update auto-save status indicator
      updateAutoSaveStatus(type);
      
      // Update draft status display
      if (typeof updateDraftStatus === 'function') {
        updateDraftStatus();
      }
      
      // Try to save to server if user is signed in
      if ((signedIn || window.signedIn) && currentUserId) {
        saveDraftToServer(data, current).catch(err => {
          console.warn('Server save failed but localStorage succeeded:', err);
        });
      }
      
      // Only show success toast for manual saves
      if (type === 'manual') {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
        toast.textContent = '✅ Draft saved successfully!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      } else {
        console.log('ENHANCED: Auto-save completed silently at', new Date().toLocaleTimeString());
        // Show brief visual feedback for auto-saves
        if (type.startsWith('auto')) {
          const miniToast = document.createElement('div');
          miniToast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-size:0.8rem; opacity:0.9;';
          miniToast.textContent = '✓ Auto-saved';
          document.body.appendChild(miniToast);
          
          setTimeout(() => {
            if (miniToast.parentNode) miniToast.remove();
          }, 2000);
        }
      }
      
      return true;
      
    } catch (error) {
      console.error('ENHANCED: Save draft error:', error);
      
      if (type === 'manual') {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#dc2626; color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:600;';
        toast.textContent = '❌ Failed to save draft';
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      return false;
    }
  };
  
  // Update auto-save status indicator
  function updateAutoSaveStatus(type) {
    const autoSaveStatus = document.getElementById('autoSaveStatus');
    const autoSaveIcon = document.getElementById('autoSaveIcon');
    
    if (autoSaveStatus) {
      const now = new Date();
      const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
      
      if (type.startsWith('auto')) {
        autoSaveStatus.textContent = `Auto-saved at ${timeString}`;
        if (autoSaveIcon) {
          autoSaveIcon.textContent = '🔄'; // spinning icon
          setTimeout(() => {
            if (autoSaveIcon) autoSaveIcon.textContent = '💾';
          }, 1000);
        }
      } else {
        autoSaveStatus.textContent = `Manually saved at ${timeString}`;
        if (autoSaveIcon) {
          autoSaveIcon.textContent = '✅'; // checkmark
          setTimeout(() => {
            if (autoSaveIcon) autoSaveIcon.textContent = '💾';
          }, 2000);
        }
      }
    }
  }

  // AUTO-SAVE SETUP - COMPREHENSIVE APPROACH
  window.setupAutoSave = function() {
    console.log('COMPREHENSIVE: Setting up auto-save');
    
    const form = document.getElementById('hotel-form');
    if (!form) {
      console.error('COMPREHENSIVE: Form not found for auto-save!');
      return;
    }
    
    let autoSaveTimer;
    let isAutoSaveActive = true;
    
    // Add listeners to all form inputs
    const inputs = form.querySelectorAll('input, select, textarea');
    console.log('COMPREHENSIVE: Found', inputs.length, 'inputs for auto-save');
    
    // Clear any existing auto-save timers
    if (window.autoSaveTimer) clearTimeout(window.autoSaveTimer);
    if (window.inputChangeTimeout) clearTimeout(window.inputChangeTimeout);
    
    inputs.forEach((input, index) => {
      // Remove existing listeners to prevent duplicates
      input.removeEventListener('input', window.autoSaveInputHandler);
      input.removeEventListener('change', window.autoSaveChangeHandler);
      
      // Define handlers
      window.autoSaveInputHandler = function(e) {
        if (!isAutoSaveActive) return;
        console.log('COMPREHENSIVE: Input changed, scheduling auto-save:', e.target.name || e.target.id);
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
          if (signedIn || window.signedIn) {
            console.log('COMPREHENSIVE: Auto-save triggered by input change');
            handleSaveDraft('auto-input');
          }
        }, 2000); // Save 2 seconds after typing stops
      };
      
      window.autoSaveChangeHandler = function(e) {
        if (!isAutoSaveActive) return;
        console.log('COMPREHENSIVE: Field changed, auto-saving:', e.target.name || e.target.id);
        clearTimeout(autoSaveTimer);
        setTimeout(() => {
          if (signedIn || window.signedIn) {
            console.log('COMPREHENSIVE: Auto-save triggered by field change');
            handleSaveDraft('auto-change');
          }
        }, 300); // Quick save for select/checkbox changes
      };
      
      input.addEventListener('input', window.autoSaveInputHandler);
      input.addEventListener('change', window.autoSaveChangeHandler);
    });
    
    // Set up periodic auto-save (every 2 minutes)
    function startPeriodicAutoSave() {
      if (window.periodicAutoSaveInterval) clearInterval(window.periodicAutoSaveInterval);
      window.periodicAutoSaveInterval = setInterval(() => {
        if ((signedIn || window.signedIn) && isAutoSaveActive) {
          console.log('COMPREHENSIVE: Periodic auto-save triggered');
          handleSaveDraft('auto-periodic');
        }
      }, 120000); // 2 minutes
    }
    
    startPeriodicAutoSave();
    
    // Store reference for cleanup
    window.cleanupAutoSave = function() {
      isAutoSaveActive = false;
      clearTimeout(autoSaveTimer);
      if (window.periodicAutoSaveInterval) clearInterval(window.periodicAutoSaveInterval);
    };
    
    console.log('COMPREHENSIVE: Auto-save listeners attached with periodic backup');
  };

  // Enhanced auto-save that works in all scenarios
  window.ensureAutoSaveActive = function() {
    console.log('Ensuring auto-save is active...');
    
    // Multiple initialization attempts
    setTimeout(() => setupAutoSave(), 500);
    setTimeout(() => setupAutoSave(), 1500);
    setTimeout(() => setupAutoSave(), 3000);
    
    // Also set up the older method as backup
    setTimeout(() => {
      if (typeof setupAutoSaveOnInput === 'function') {
        setupAutoSaveOnInput();
      }
    }, 1000);
  };

  // Initialize auto-save immediately and with delays
  ensureAutoSaveActive();

  // Check if user is continuing from dashboard (approved user) or editing
  async function checkContinueMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const continueMode = urlParams.get('continue');
    const editMode = urlParams.get('mode');
    const signedInParam = urlParams.get('signedIn');
    const sessionId = localStorage.getItem('fedevent_session');
    
    console.log('checkContinueMode - continueMode:', continueMode, 'editMode:', editMode, 'signedInParam:', signedInParam, 'sessionId:', !!sessionId);
    
    if ((continueMode === 'true' || editMode === 'edit' || signedInParam === 'true') && sessionId) {
      // User is approved and continuing registration - skip to page 2
      signedIn = true;
      
      // Get actual user ID from stored user data
      const userData = localStorage.getItem('fedevent_user');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          currentUserId = user.id || user.userId || user.fedevent_account_number;
          console.log('Found user ID for continue mode:', currentUserId);
        } catch (e) {
          console.error('Error parsing user data:', e);
          currentUserId = null;
        }
      } else {
        currentUserId = null;
      }
      
      // Don't set step here - let loadExistingDraft handle it
      
      // Pre-populate user info if available
      const hotelData = localStorage.getItem('fedevent_hotel');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          let displayText = user.username || 'User';
          if (user.fedevent_account_number) {
            displayText += ` (${user.fedevent_account_number})`;
          }
          const userInfoDiv = document.getElementById('userInfo');
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) {
            userDisplayName.textContent = displayText;
          }
          if (userInfoDiv) {
            userInfoDiv.style.display = 'block';
          }
        } catch (e) {
          console.error('Error parsing user data:', e);
          const userInfoDiv = document.getElementById('userInfo');
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) userDisplayName.textContent = 'User';
          if (userInfoDiv) userInfoDiv.style.display = 'block';
        }
      } else if (hotelData) {
        try {
          const hotel = JSON.parse(hotelData);
          const userInfoDiv = document.getElementById('userInfo');
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) {
            userDisplayName.textContent = `${hotel.name || ''} (${hotel.fedevent_account_number || 'TBD'})`;
          }
          if (userInfoDiv) {
            userInfoDiv.style.display = 'block';
          }
        } catch (e) {
          console.error('Error parsing hotel data:', e);
          const userInfoDiv = document.getElementById('userInfo');
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) userDisplayName.textContent = '';
          if (userInfoDiv) userInfoDiv.style.display = 'block';
        }
      } else {
        const userInfoDiv = document.getElementById('userInfo');
        const userDisplayName = document.getElementById('userDisplayName');
        if (userDisplayName) userDisplayName.textContent = 'Continue Registration';
        if (userInfoDiv) userInfoDiv.style.display = 'block';
      }
      
      // Removed Start step UI (account/guest and policy acceptance)
      const signupBox = document.getElementById('signupBox');
      if (signupBox) signupBox.style.display = 'none';
      const policyAcceptance = document.getElementById('policyAcceptance');
      if (policyAcceptance) policyAcceptance.style.display = 'none';
      
      // Show auto-save info (ALWAYS show for signed-in users)
      const autoSaveInfo = document.getElementById('autoSaveInfo');
      if (autoSaveInfo) {
        autoSaveInfo.style.display = 'block';
        // Update status immediately
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        if (autoSaveStatus) {
          autoSaveStatus.textContent = 'Auto-save active';
        }
      }
      
      // Show loading message
      showToast('🔄 Loading your saved progress...');
      
      // Load existing draft for this user first
      await loadExistingDraft();
        
      // ALSO try to load from multiple sources for reliability
      const userSpecificKey = `hotel_registration_draft_${currentUserId || 'anonymous'}`;
      const userSpecificDraft = localStorage.getItem(userSpecificKey);
      const savedPage = localStorage.getItem('hotel_registration_current_page');
        
      if (userSpecificDraft) {
        try {
          const draftData = JSON.parse(userSpecificDraft);
          console.log('Loading user-specific draft with', Object.keys(draftData.formData || {}).length, 'fields');
          setFormData(draftData.formData || {});
          if (draftData.currentStep !== undefined) {
            current = draftData.currentStep;
            setActiveStep(current);
          }
        } catch (e) {
          console.error('Error loading user-specific draft:', e);
        }
      }
        
      if (savedPage) {
        try {
          const pageNum = parseInt(savedPage);
          if (!isNaN(pageNum) && pageNum >= 0) {
            current = pageNum;
            setActiveStep(current);
            console.log('Restored page from localStorage:', pageNum);
          }
        } catch (e) {
          console.error('Error restoring page:', e);
        }
      }
      
      // If in edit mode, load existing hotel data
      if (editMode === 'edit') {
        await loadExistingHotelData();
      }
      
      // Update navigation
      updateWizardNav();
      return true;
    }
    return false;
  }
  
  // Load existing hotel data for edit mode
  async function loadExistingHotelData() {
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) return;
      
      const response = await fetch('/api/hotel/profile', {
        headers: {
          'Authorization': `Bearer ${sessionId}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const result = await response.json();
        if (result.ok && result.hotel) {
          // Pre-populate form fields with existing hotel data
          populateHotelForm(result.hotel);
        }
      }
    } catch (error) {
      console.error('Error loading hotel data:', error);
    }
  }
  
  // Populate hotel form with existing data
  function populateHotelForm(hotel) {
    // Hotel basic information
    if (hotel.name) document.getElementById('hotelName').value = hotel.name;
    if (hotel.email) document.getElementById('hotelEmail').value = hotel.email;
    if (hotel.phone) document.getElementById('hotelPhone').value = hotel.phone;
    if (hotel.website) document.getElementById('hotelWebsite').value = hotel.website;
    if (hotel.address) document.getElementById('hotelAddress').value = hotel.address;
    if (hotel.city) document.getElementById('hotelCity').value = hotel.city;
    if (hotel.state) document.getElementById('hotelState').value = hotel.state;
    if (hotel.zip) document.getElementById('hotelZip').value = hotel.zip;
    if (hotel.country) document.getElementById('hotelCountry').value = hotel.country;
    
    // Hotel details
    if (hotel.rooms_total) document.getElementById('totalRooms').value = hotel.rooms_total;
    if (hotel.rooms_suites) document.getElementById('suites').value = hotel.rooms_suites;
    if (hotel.rooms_double) document.getElementById('doubleRooms').value = hotel.rooms_double;
    if (hotel.rooms_single) document.getElementById('singleRooms').value = hotel.rooms_single;
    if (hotel.rooms_accessible) document.getElementById('accessibleRooms').value = hotel.rooms_accessible;
    
    // Amenities
    if (hotel.amenities) {
      const amenities = JSON.parse(hotel.amenities);
      amenities.forEach(amenity => {
        const checkbox = document.getElementById(`amenity_${amenity}`);
        if (checkbox) checkbox.checked = true;
      });
    }
    
    // Update the page title to indicate edit mode
    const titleElement = document.querySelector('h1');
    if (titleElement) {
      titleElement.textContent = 'Update Hotel Registration';
    }
  }
  
  // Load existing draft for continuing users
  async function loadExistingDraft() {
    try {
      // First try to load from server using session
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.log('No session available for draft loading');
        // For continue mode without session, start at page 1
        current = 1;
        setActiveStep(1);
        return;
      }
      
      // Try to load draft with or without user ID
      const url = currentUserId ? `/api/draft/load/${currentUserId}` : '/api/draft/load';
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      });
      const result = await response.json();
      
      if (result.ok && result.draft) {
        console.log('Loading server draft for user:', currentUserId);
        setFormData(result.draft.formData);
        if (result.draft.currentPage !== undefined) {
          current = result.draft.currentPage;
          setActiveStep(current);
        }
        hasDraft = true;
        updateDraftStatus();
        showToast('✅ Previous draft loaded successfully');
        return;
      } else {
        console.log('No server draft found for user:', currentUserId);
      }
      
      // Fallback to localStorage
      const localDraft = localStorage.getItem('hotel_registration_draft');
      if (localDraft) {
        const draftData = JSON.parse(localDraft);
        if (draftData.userId === currentUserId) {
          console.log('Loading local draft for user:', currentUserId);
          setFormData(draftData.formData);
          if (draftData.currentStep !== undefined) {
            current = draftData.currentStep;
            setActiveStep(current);
          }
          hasDraft = true;
          updateDraftStatus();
          showToast('✅ Previous draft loaded from local storage');
          return;
        }
      }
      
      // If no draft found, start at page 1 (Company Information) for continue mode
      // since user has already signed up and is continuing their registration
      console.log('No existing draft found, starting at page 1 for continue mode');
      current = 1;
      setActiveStep(1);
      console.log('loadExistingDraft: Set page to 1, current:', current);
    } catch (error) {
      console.error('Error loading existing draft:', error);
    }
  }
  
  // Logout function
  function logout() {
    localStorage.removeItem('fedevent_session');
    localStorage.removeItem('fedevent_user');
    localStorage.removeItem('fedevent_hotel');
    window.location.href = 'hotel-login.html';
  }
  
  // Handle Hotel Portal navigation
  function handleHotelPortalClick() {
    const sessionId = localStorage.getItem('fedevent_session');
    if (sessionId) {
      // User is signed in, go to dashboard
      window.location.href = '/hotel-dashboard.html';
    } else {
      // User is not signed in, go to login
      window.location.href = '/hotel-login.html';
    }
    trackNavigationClick('Hotel Portal');
  }
  
  // Enhanced save draft with auto-save
  function saveDraft(triggerType = 'manual') {
    console.log('saveDraft called with trigger:', triggerType, 'signedIn:', signedIn, 'window.signedIn:', window.signedIn, 'current:', current);
    
    // Use either global signedIn or window.signedIn
    const isSignedIn = signedIn || window.signedIn;
    if (!isSignedIn) {
      console.log('Auto-save skipped: user not signed in');
      return;
    }
    
    try {
      const formData = getFormData();
      console.log('Form data collected:', Object.keys(formData).length, 'fields');
      
      const draftData = {
        formData: formData,
        currentStep: current,
        timestamp: new Date().toISOString(),
        userId: currentUserId
      };
      
      // Save to localStorage first (always works)
      localStorage.setItem('hotel_registration_draft', JSON.stringify(draftData));
      hasDraft = true;
      updateDraftStatus();
      
      console.log('Draft saved to localStorage successfully');
      
      // Try to save to server if user is authenticated
      if (isSignedIn && currentUserId) {
        saveDraftToServer(formData, current);
      }
      
      // Only show success toast for manual saves, not auto-saves
      if (triggerType === 'manual') {
        showToast('✅ Draft saved successfully');
      } else {
        console.log('Auto-save completed silently at', new Date().toLocaleTimeString());
        // Update auto-save text to show last save time
        const autoSaveText = document.getElementById('autoSaveText');
        if (autoSaveText) {
          autoSaveText.textContent = `Last auto-saved: ${new Date().toLocaleTimeString()}`;
        }
      }
      
      console.log('Draft saved successfully at', new Date().toLocaleTimeString());
    } catch (error) {
      console.error('Draft save error:', error);
      if (triggerType === 'manual') {
        showToast('❌ Failed to save draft: ' + error.message);
      }
    }
  }
  
  // Save draft to server
  async function saveDraftToServer(formData, currentPage) {
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('No session ID available for draft save');
        return;
      }
      
      const response = await fetch('/api/draft/save', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionId}`
        },
        body: JSON.stringify({
          userId: currentUserId || null,
          formData: formData,
          currentPage: currentPage
        })
      });
      
      if (!response.ok) {
        console.warn('Server draft save failed, but local save succeeded');
      } else {
        console.log('Draft saved to server successfully');
      }
    } catch (error) {
      console.warn('Server draft save error:', error);
    }
  }
  
  // Auto-save every 2 minutes
  function startAutoSave() {
    if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
      if (signedIn && current > 0) {
        try {
          saveDraft('auto');
        } catch (error) {
          console.error('Auto-save error:', error);
          // Don't show toast for auto-save errors to avoid spam
        }
        startAutoSave(); // Schedule next auto-save
      }
    }, 120000); // 2 minutes (120 seconds)
  }
  
  // Auto-save on form input changes (debounced)
  let inputChangeTimeout = null;
  function setupAutoSaveOnInput() {
    const form = document.getElementById('hotel-form');
    if (!form) {
      console.error('Form element not found for auto-save setup! Expected ID: hotel-form');
      return;
    }
    
    console.log('Setting up auto-save on input changes for form:', form.id);
    
    // Add event listeners to all form inputs
    const inputs = form.querySelectorAll('input, select, textarea');
    console.log('Found', inputs.length, 'form inputs for auto-save');
    
    inputs.forEach((input, index) => {
      // Remove existing listeners to avoid duplicates
      input.removeEventListener('input', handleInputChange);
      input.removeEventListener('change', handleInputChange);
      
      input.addEventListener('input', handleInputChange);
      input.addEventListener('change', handleInputChange);
    });
    
    function handleInputChange(e) {
      const isSignedIn = signedIn || window.signedIn;
      console.log('ENHANCED: Input change detected:', {
        field: e.target.name || e.target.id || 'unnamed',
        value: e.target.value?.substring(0, 20) + '...',
        isSignedIn: isSignedIn
      });
      
      if (isSignedIn) {
        console.log('ENHANCED: Auto-save conditions met, scheduling save...');
        // Debounce auto-save to avoid too many saves
        if (inputChangeTimeout) clearTimeout(inputChangeTimeout);
        inputChangeTimeout = setTimeout(() => {
          console.log('ENHANCED: Executing debounced auto-save');
          saveDraft('input-change');
        }, 3000); // Save 3 seconds after user stops typing
      } else {
        console.log('ENHANCED: Auto-save skipped - not signed in');
      }
    }
    
    console.log('Auto-save input listeners set up successfully');
  }
  
  // Update draft status display
  function updateDraftStatus() {
    if (!draftStatus || !draftInfo) return;
    
    if (hasDraft) {
      try {
        const draftData = JSON.parse(localStorage.getItem('hotel_registration_draft') || '{}');
        if (draftData.timestamp) {
          const savedTime = new Date(draftData.timestamp).toLocaleString();
          draftInfo.textContent = `Last saved: ${savedTime}`;
          draftStatus.style.display = 'block';
        }
      } catch (e) {
        console.error('Error reading draft data:', e);
      }
    } else {
      draftStatus.style.display = 'none';
    }
  }
  
  // Load draft
  function loadDraft() {
    try {
      const draftData = JSON.parse(localStorage.getItem('hotel_registration_draft') || '{}');
      if (draftData.formData) {
        setFormData(draftData.formData);
        if (draftData.currentStep !== undefined) {
          current = draftData.currentStep;
          setActiveStep(current);
        }
        showToast('✅ Draft loaded successfully');
        updateDraftStatus();
      }
    } catch (error) {
      showToast('❌ Failed to load draft: ' + error.message);
      console.error('Draft load error:', error);
    }
  }

  function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=>toast.style.display='none', 2600); }
  function localLogout(){
    try{
      localStorage.removeItem('fedevent_session');
      localStorage.removeItem('fedevent_user');
      localStorage.removeItem('fedevent_hotel');
    }catch(e){}
    window.location.href = '/hotel-login.html';
  }

  // Pre-order account upgrade function
  function preOrderAccount(accountType) {
    const hotelName = document.querySelector('[name="hotel_name"]')?.value || 'Your Hotel';
    const email = document.querySelector('[name="sign_contacts[0][email"]')?.value || '';
    
    const subject = `Pre-Order Interest: ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} Account`;
    const body = `Hello FEDEVENT Team,

I'm interested in pre-ordering the ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} account upgrade for my hotel.

Hotel Name: ${hotelName}
Email: ${email}
Account Type: ${accountType.charAt(0).toUpperCase() + accountType.slice(1)}

Please contact me when this feature becomes available.

Thank you!`;

    const mailtoLink = `mailto:support@fedevent.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink);
    
    // Show confirmation
    showToast(`Pre-order email opened! We'll contact you when ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} accounts are available.`);
  }
  // Add Meeting Room Function
  function addMeetingRoom() {
    console.log('🟢 Adding new meeting room');
    
    const template = document.getElementById('room-template');
    const rooms = document.getElementById('rooms');
    
    if (!template) {
      console.error('🟢 Room template not found!');
      return;
    }
    
    if (!rooms) {
      console.error('🟢 Rooms container not found!');
      return;
    }
    
    const clone = template.content.cloneNode(true);
    const roomDiv = clone.querySelector('.room');
    
    // Add remove button functionality
    const removeBtn = clone.querySelector('.remove-room');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        console.log('🟢 Removing meeting room');
        roomDiv.remove();
        
        // Auto-save after removing room
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('room-removed');
          }, 500);
        }
      });
    }
    
    // Add auto-save listeners to room inputs
    const inputs = clone.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.addEventListener('change', function() {
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('room-data-change');
          }, 1000);
        }
      });
    });
    
    rooms.appendChild(clone);
    
    // Focus on the room name field
    const nameInput = roomDiv.querySelector('input[name="room_name[]"]');
    if (nameInput) {
      setTimeout(() => {
        nameInput.focus();
      }, 100);
    }
    
    console.log('🟢 Meeting room added successfully');
    
    // Auto-save after adding room
    if (signedIn || window.signedIn) {
      setTimeout(() => {
        handleSaveDraft('room-added');
      }, 500);
    }
  }
  
  function updateWizardNav(){
    const last = pages.length - 1;
    nextBtn.style.display   = (current < last) ? 'inline-block' : 'none';
    submitBtn.style.display = (current === last) ? 'inline-block' : 'none';
    backBtn.disabled        = (current === 0);
    navHint.style.visibility= (current === last) ? 'visible' : 'hidden';
    
    // Guest mode removed
    const guestHint = document.getElementById('guestHint');
    if (guestHint) guestHint.style.display = 'none';
    
    // Show save draft button for signed-in users (except on first page)
    if (saveDraftBtn) {
      saveDraftBtn.style.display = (signedIn && current > 0) ? 'inline-block' : 'none';
    }
    
    nextBtn.disabled = false;
    
    // Update progress indicator
    updateProgressIndicator();
  }
  
  // Add Meeting Room Function
  function addMeetingRoom() {
    console.log('🟢 Adding new meeting room');
    
    const template = document.getElementById('room-template');
    const rooms = document.getElementById('rooms');
    
    if (!template) {
      console.error('🟢 Room template not found!');
      return;
    }
    
    if (!rooms) {
      console.error('🟢 Rooms container not found!');
      return;
    }
    
    const clone = template.content.cloneNode(true);
    const roomDiv = clone.querySelector('.room');
    
    // Add remove button functionality
    const removeBtn = clone.querySelector('.remove-room');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        console.log('🟢 Removing meeting room');
        roomDiv.remove();
        
        // Auto-save after removing room
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('room-removed');
          }, 500);
        }
      });
    }
    
    // Add auto-save listeners to room inputs
    const inputs = clone.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.addEventListener('change', function() {
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('room-data-change');
          }, 1000);
        }
      });
    });
    
    rooms.appendChild(clone);
    
    // Focus on the room name field
    const nameInput = roomDiv.querySelector('input[name="room_name[]"]');
    if (nameInput) {
      setTimeout(() => {
        nameInput.focus();
      }, 100);
    }
    
    console.log('🟢 Meeting room added successfully');
    
    // Auto-save after adding room
    if (signedIn || window.signedIn) {
      setTimeout(() => {
        handleSaveDraft('room-added');
      }, 500);
    }
  }
    steps = Array.from(document.querySelectorAll('.step'));
    steps.forEach((step, index) => {
      const stepElement = step;
      const isCompleted = index < current;
      const isCurrent = index === current;
      
      if (isCompleted) {
        stepElement.classList.add('completed');
        stepElement.classList.remove('active');
        const dot = stepElement.querySelector('.dot');
        if (dot) {
          dot.innerHTML = '✓';
          dot.style.background = '#10b981';
          dot.style.color = '#fff';
        }
      } else if (isCurrent) {
        stepElement.classList.add('active');
        stepElement.classList.remove('completed');
        const dot = stepElement.querySelector('.dot');
        if (dot) {
          dot.innerHTML = index + 1;
          dot.style.background = '#0a58ca';
          dot.style.color = '#fff';
        }
      } else {
        stepElement.classList.remove('active', 'completed');
        const dot = stepElement.querySelector('.dot');
        if (dot) {
          dot.innerHTML = index + 1;
          dot.style.background = '#eef4ff';
          dot.style.color = '#0a58ca';
        }
      }
    });
  }
  function setActiveStep(i){
    console.log('Setting active step to:', i, 'pages available:', pages ? pages.length : 'undefined');
    if (!pages || !steps) {
      console.error('Pages or steps not initialized!');
      return;
    }
    current = i;
    pages.forEach((p,idx)=>p.classList.toggle('active', idx===current));
    steps.forEach((s,idx)=>s.classList.toggle('active', idx===current));
    updateWizardNav(); 
    
    // Generate completion summary when reaching the final page
    if (i === 4) {
      generateCompletionSummary();
    }
    
    window.scrollTo(0,0);
    console.log('Active step set to:', i, 'Pages with active class:', document.querySelectorAll('.page.active').length);
  }
  
  function generateCompletionSummary() {
    const summaryContent = document.getElementById('summaryContent');
    if (!summaryContent) return;
    
    const data = getFormData();
    
    const summary = `
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
        <div>
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">🏨 Hotel Information</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Name:</strong> ${data.hotel_name || 'Not provided'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Location:</strong> ${data.city || ''}, ${data.state || ''} ${data.country || ''}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Brand:</strong> ${data.brand || 'Not specified'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Website:</strong> ${data.website || 'Not provided'}</p>
        </div>
        
        <div>
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">👥 Key Contacts</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Sales Director:</strong> ${data.sales_director_name || 'Not provided'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>A/R Contact:</strong> ${data.ar_name || 'Not provided'}</p>
          ${data.csm_name ? `<p style="margin:4px 0; color:#6b7280;"><strong>CSM:</strong> ${data.csm_name}</p>` : ''}
        </div>
        
        <div>
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">🏠 Room Inventory</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Total Rooms:</strong> ${data.total_rooms || 'Not specified'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>King Rooms:</strong> ${data.king_rooms || 'Not specified'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Double/Queen:</strong> ${data.double_rooms || 'Not specified'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Suites:</strong> ${data.suites || 'Not specified'}</p>
        </div>
        
        <div>
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">✅ Compliance Status</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>NET30:</strong> ${data.accepts_net30 || 'Not specified'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Purchase Orders:</strong> ${data.accepts_po || 'Not specified'}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>AAA Rated:</strong> ${data.is_aaa_rated || 'Not specified'}</p>
          ${data.is_aaa_rated === 'Yes' ? `<p style="margin:4px 0; color:#6b7280;"><strong>AAA Rating:</strong> ${data.aaa_diamond_rating || 'Not specified'}</p>` : ''}
        </div>
        
        <div>
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">📊 Meeting Spaces</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Meeting Rooms:</strong> ${document.querySelectorAll('.room').length}</p>
          <p style="margin:4px 0; color:#6b7280;"><strong>Extended Stay:</strong> ${data.is_extended_stay || 'Not specified'}</p>
        </div>
        
        <div>
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">📎 File Uploads</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Files Attached:</strong> ${getFileCount()} files</p>
        </div>
      </div>
    `;
    
    summaryContent.innerHTML = summary;
  }
  function getFileCount() {
    let count = 0;
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      if (input.files && input.files.length > 0) {
        count += input.files.length;
      }
    });
    return count;
  }

  function updateSummary() {
    const summaryContent = document.querySelector('.summary-content');
    if (!summaryContent) return;
    
    const summary = `
      <div class="summary">
        <div class="summary-files">
          <h4 style="color:#1f2937; margin:0 0 8px 0; font-size:1rem;">📎 File Uploads</h4>
          <p style="margin:4px 0; color:#6b7280;"><strong>Files Attached:</strong> ${getFileCount()} files</p>
        </div>
      </div>
    `;
    
    summaryContent.innerHTML = summary;
  }

  function validateCurrentPage(){
    
    // Enhanced validation with field navigation - only validate visible required fields
    const req = pages[current].querySelectorAll('[required]');
    let firstMissingField = null;
    
    // Check hotel location type to determine if bank fields should be skipped
    const hotelLocationSelect = document.getElementById('hotel_location_type');
    const locationType = hotelLocationSelect ? hotelLocationSelect.value : '';
    const skipBankValidation = (locationType === 'skip' || locationType === '');
    
    for (let i=0;i<req.length;i++){ 
      const field = req[i];
      // Skip validation for fields that are in hidden sections
      const isHidden = field.closest('[style*="display: none"]') || field.closest('[style*="display:none"]');
      
      // Skip bank fields if user chose skip or no location
      const isBankField = field.name && (field.name.includes('ach_') || field.name.includes('wire_'));
      const shouldSkipField = isHidden || (isBankField && skipBankValidation);
      
      if (!shouldSkipField && !field.checkValidity()){ 
        if (!firstMissingField) {
          firstMissingField = field;
        }
      } 
    }
    
    // If there's a missing required field, navigate to it
    if (firstMissingField) {
      console.log('Validation failed - navigating to field:', firstMissingField.name || firstMissingField.id);
      
      // Scroll to the missing field
      firstMissingField.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // Focus and highlight the field
      setTimeout(() => {
        firstMissingField.focus();
        
        // Add visual highlight
        firstMissingField.style.border = '2px solid #ef4444';
        firstMissingField.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        // Get field label for better guidance
        let fieldLabel = 'This field';
        const label = document.querySelector(`label[for="${firstMissingField.id}"]`);
        if (label) {
          fieldLabel = label.textContent.replace('*', '').trim();
        } else {
          const closestLabel = firstMissingField.closest('.form-group')?.querySelector('label');
          if (closestLabel) {
            fieldLabel = closestLabel.textContent.replace('*', '').trim();
          }
        }
        
        // Show validation message with field guidance
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          font-size: 1rem;
          text-align: center;
          max-width: 400px;
          border: 2px solid #fca5a5;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">⚠️ Required Field Missing</div>
          <div style="font-weight: 500; opacity: 0.9;">Please complete: <strong>${fieldLabel}</strong></div>
          <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.8;">Field has been highlighted below</div>
        `;
        document.body.appendChild(toast);
        
        // Remove highlight when user starts typing
        const removeHighlight = () => {
          firstMissingField.style.border = '';
          firstMissingField.style.boxShadow = '';
          if (toast.parentNode) {
            toast.remove();
          }
          firstMissingField.removeEventListener('input', removeHighlight);
          firstMissingField.removeEventListener('change', removeHighlight);
        };
        
        firstMissingField.addEventListener('input', removeHighlight);
        firstMissingField.addEventListener('change', removeHighlight);
        
        // Auto-remove toast after 5 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 5000);
        
      }, 500);
      
      return false;
    }
    
    // Step 0 removed (pre-qualification/policies handled during signup)
    
    // Enhanced validation for page 1 (Company Information) - only for signed-in users
    if (current === 1 && !isGuestMode) {
      if (!validateCompanyInfo()) return false;
    }
    
    // Enhanced validation for page 2 (Rooms & Meeting Space) - only for signed-in users
    if (current === 2 && !isGuestMode) {
      if (!validateRoomsAndSpaces()) return false;
    }
    
    // Enhanced validation for page 3 (Terms & Uploads) - only for signed-in users
    if (current === 3 && !isGuestMode) {
      if (!validateTermsAndUploads()) return false;
    }
    
    return true;
  }
  
  function validateCompanyInfo() {
    const hotelName = document.querySelector('[name="hotel_name"]');
    const address = document.querySelector('[name="address"]');
    const city = document.querySelector('[name="city"]');
    const country = document.querySelector('[name="country"]');
    const salesEmail = document.querySelector('[name="sales_director_email"]');
    const arEmail = document.querySelector('[name="ar_email"]');
    const hotelPlaceId = document.getElementById('hotel_place_id');
    
    // Helper function to navigate to field with error
    const navigateToFieldError = (field, message) => {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        field.focus();
        field.style.border = '2px solid #ef4444';
        field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 400px;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">⚠️ Validation Error</div>
          <div style="font-weight: 500; opacity: 0.9;">${message}</div>
        `;
        document.body.appendChild(toast);
        
        const removeHighlight = () => {
          field.style.border = '';
          field.style.boxShadow = '';
          if (toast.parentNode) toast.remove();
          field.removeEventListener('input', removeHighlight);
        };
        
        field.addEventListener('input', removeHighlight);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
      }, 500);
    };
    
    // Check for valid email formats
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (salesEmail && salesEmail.value && !emailRegex.test(salesEmail.value)) {
      navigateToFieldError(salesEmail, 'Please enter a valid sales director email address.');
      return false;
    }
    
    if (arEmail && arEmail.value && !emailRegex.test(arEmail.value)) {
      navigateToFieldError(arEmail, 'Please enter a valid A/R contact email address.');
      return false;
    }
    
    // Google Places selection is optional - only warn if hotel name is filled but no place ID
    if (hotelName && hotelName.value.trim() !== '' && hotelPlaceId && (!hotelPlaceId.value || hotelPlaceId.value.trim() === '')) {
      // Just warn, don't block progression
      console.log('Hotel name filled but no Google Places ID - this is optional');
    }
    
    // Check website format if provided
    const website = document.querySelector('[name="website"]');
    if (website && website.value && website.value.trim() !== '') {
      const urlRegex = /^https?:\/\/.+/;
      if (!urlRegex.test(website.value)) {
        navigateToFieldError(website, 'Please enter a valid website URL starting with http:// or https://');
        return false;
      }
    }
    
    // Validate primary contacts roles: must be different and include exactly one Approver
    if (!validatePrimaryContacts()) return false;
    
    return true;
  }
  
  function validatePrimaryContacts() {
    const role0 = (document.querySelector('[name="sign_contacts[0][role]"]')||{}).value || '';
    const role1 = (document.querySelector('[name="sign_contacts[1][role]"]')||{}).value || '';
    const err = document.getElementById('signContactsError');
    if (err) { err.style.display='none'; err.textContent=''; }
    
    // Only validate when both roles are selected (required will handle empties)
    if (!role0 || !role1) return true;
    
    // Enforce different roles and exactly one Approver
    const rolesSet = new Set([role0, role1]);
    const hasApprover = (role0 === 'Approver') ^ (role1 === 'Approver');
    const hasSigner = rolesSet.has('Signer');
    const differentRoles = rolesSet.size === 2;
    
    if (!(differentRoles && hasApprover && hasSigner)) {
      const message = 'Each contact must have a different role, and exactly one must be Approver (higher authority). The other must be Signer.';
      if (err) { 
        err.style.display='block'; 
        err.style.color = '#b91c1c';
        err.textContent = message; 
      }
      alert(message);
      return false;
    }
    return true;
  }
  
  function validateRoomsAndSpaces() {
    // Helper function to navigate to field with error
    const navigateToFieldError = (field, message) => {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        field.focus();
        field.style.border = '2px solid #ef4444';
        field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 400px;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">⚠️ Validation Error</div>
          <div style="font-weight: 500; opacity: 0.9;">${message}</div>
        `;
        document.body.appendChild(toast);
        
        const removeHighlight = () => {
          field.style.border = '';
          field.style.boxShadow = '';
          if (toast.parentNode) toast.remove();
          field.removeEventListener('input', removeHighlight);
        };
        
        field.addEventListener('input', removeHighlight);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
      }, 500);
    };
    
    // Validate room numbers are positive integers
    const roomFields = ['total_rooms', 'king_rooms', 'double_rooms', 'suites', 'ada_rooms', 'max_group_block'];
    
    for (const fieldName of roomFields) {
      const field = document.querySelector(`[name="${fieldName}"]`);
      if (field && field.value && (isNaN(field.value) || parseInt(field.value) < 0)) {
        const fieldLabel = fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        navigateToFieldError(field, `Please enter a valid number for ${fieldLabel}.`);
        return false;
      }
    }
    
    // Meeting room is optional during progression; encourage but do not block
    
    return true;
  }
  
  function validateTermsAndUploads() {
    // Helper function to navigate to field with error
    const navigateToFieldError = (field, message) => {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        field.focus();
        if (field.type !== 'checkbox') {
          field.style.border = '2px solid #ef4444';
          field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        } else {
          // For checkboxes, highlight the label
          const label = field.closest('label') || document.querySelector(`label[for="${field.id}"]`);
          if (label) {
            label.style.border = '2px solid #ef4444';
            label.style.borderRadius = '4px';
            label.style.padding = '4px';
          }
        }
        
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #dc2626;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 400px;
        `;
        toast.innerHTML = `
          <div style="margin-bottom: 8px; font-size: 1.1em;">⚠️ Validation Error</div>
          <div style="font-weight: 500; opacity: 0.9;">${message}</div>
        `;
        document.body.appendChild(toast);
        
        const removeHighlight = () => {
          if (field.type !== 'checkbox') {
            field.style.border = '';
            field.style.boxShadow = '';
          } else {
            const label = field.closest('label') || document.querySelector(`label[for="${field.id}"]`);
            if (label) {
              label.style.border = '';
              label.style.borderRadius = '';
              label.style.padding = '';
            }
          }
          if (toast.parentNode) toast.remove();
          field.removeEventListener('change', removeHighlight);
          field.removeEventListener('input', removeHighlight);
        };
        
        field.addEventListener('change', removeHighlight);
        field.addEventListener('input', removeHighlight);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
      }, 500);
    };
    
    // Check if terms are acknowledged
    const termsAck = document.getElementById('terms_ack');
    if (!termsAck.checked) {
      navigateToFieldError(termsAck, 'You must acknowledge the NET30 and PO requirements to proceed.');
      return false;
    }
    
    // Check hotel location type to determine if bank validation should apply
    const hotelLocationSelect = document.getElementById('hotel_location_type');
    const locationType = hotelLocationSelect ? hotelLocationSelect.value : '';
    
    // Skip bank validation if user chose 'skip' or left location empty
    if (locationType === 'skip' || locationType === '') {
      console.log('🏦 Skipping bank validation - user chose skip or no selection:', locationType);
      // User chose to skip banking or left it empty - no bank validation needed
    } else {
      // Only validate bank sections if user chose a location and sections are visible
      
      // Bank account confirmation checks
      const ach = document.getElementById('ach_section');
      if (ach && ach.style.display !== 'none') {
        const a1 = (document.getElementById('ach_account_number')||{}).value?.trim() || '';
        const a2 = (document.getElementById('ach_account_number_confirm')||{}).value?.trim() || '';
        const achMatchMsg = document.getElementById('ach_account_match');
        if (a1 || a2) {
          if (!a1 || !a2 || a1 !== a2) {
            if (achMatchMsg) { achMatchMsg.style.display='block'; achMatchMsg.style.color='#b91c1c'; achMatchMsg.textContent='Account numbers do not match.'; }
            const firstEmptyField = !a1 ? document.getElementById('ach_account_number') : document.getElementById('ach_account_number_confirm');
            navigateToFieldError(firstEmptyField, 'ACH account numbers do not match. Please re-enter both fields.');
            return false;
          } else {
            if (achMatchMsg) { achMatchMsg.style.display='block'; achMatchMsg.style.color='#065f46'; achMatchMsg.textContent='Account numbers match.'; }
          }
        }
      }
      const wire = document.getElementById('wire_section');
      if (wire && wire.style.display !== 'none') {
        const w1 = (document.getElementById('wire_account_number')||{}).value?.trim() || '';
        const w2 = (document.getElementById('wire_account_number_confirm')||{}).value?.trim() || '';
        const wireMatchMsg = document.getElementById('wire_account_match');
        if (w1 || w2) {
          if (!w1 || !w2 || w1 !== w2) {
            if (wireMatchMsg) { wireMatchMsg.style.display='block'; wireMatchMsg.style.color='#b91c1c'; wireMatchMsg.textContent='Account numbers do not match.'; }
            const firstEmptyField = !w1 ? document.getElementById('wire_account_number') : document.getElementById('wire_account_number_confirm');
            navigateToFieldError(firstEmptyField, 'Wire account numbers do not match. Please re-enter both fields.');
            return false;
          } else {
            if (wireMatchMsg) { wireMatchMsg.style.display='block'; wireMatchMsg.style.color='#065f46'; wireMatchMsg.textContent='Account numbers match.'; }
          }
        }
      }
    }
    
    // Validate file uploads (optional but check formats if provided)
    const fileInputs = pages[current].querySelectorAll('input[type="file"]');
    for (const input of fileInputs) {
      if (input.files && input.files.length > 0) {
        for (const file of input.files) {
          // Check file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            navigateToFieldError(input, `File "${file.name}" is too large. Maximum file size is 10MB.`);
            return false;
          }
        }
      }
    }
    
    return true;
  }
  function updateSubmitState(){
    const poEl = document.querySelector('[name="accepts_po"]');
    const net30Ok = !acceptsNet30 || acceptsNet30.value === 'Yes';
    const poOk = !poEl || poEl.value === 'Yes';
    submitBtn.disabled = !(net30Ok && poOk);
  }
  function toggleES(){
    const sec = document.getElementById('extendedStaySection');
    const isExtendedStaySelect = document.getElementById('is_extended_stay');
    const on = (isExtendedStaySelect && isExtendedStaySelect.value === 'Yes');
    
    console.log('🏨 toggleES called:', {
      section: !!sec,
      select: !!isExtendedStaySelect,
      value: isExtendedStaySelect?.value,
      shouldShow: on
    });
    
    if (sec) {
      sec.style.display = on ? 'block' : 'none';
      console.log('🏨 Extended Stay section display set to:', sec.style.display);
      
      // Set required fields
      sec.querySelectorAll('[data-es-required]').forEach(el => {
        el.required = on;
        console.log('🏨 Field', el.name, 'required set to:', on);
      });
    } else {
      console.error('🏨 Extended Stay section not found!');
    }
  }
  function toggleAaaDiamond(){
    console.log('toggleAaaDiamond called');
    const sec = document.getElementById('aaa_diamond_section');
    const ratingSelect = document.getElementById('aaa_diamond_rating');
    const aaaSelect = document.getElementById('is_aaa_rated'); // Get fresh reference
    const aaaRatedValue = aaaSelect ? aaaSelect.value : '';
    
    console.log('AAA diamond toggle:', {
      section: !!sec,
      ratingSelect: !!ratingSelect,
      aaaSelect: !!aaaSelect,
      aaaRatedValue: aaaRatedValue
    });
    
    const on = (aaaSelect && aaaSelect.value === 'Yes');
    console.log('Should show diamond section:', on);
    
    if (sec) {
      sec.style.display = on ? 'block' : 'none';
      console.log('Diamond section display set to:', sec.style.display);
    } else {
      console.error('AAA diamond section element not found!');
    }
    
    if (ratingSelect) {
      ratingSelect.required = on;
      console.log('Diamond rating required set to:', on);
    } else {
      console.error('AAA diamond rating select element not found!');
    }
  }
  
  function toggleBankSections(){
    const achSection = document.getElementById('ach_section');
    const wireSection = document.getElementById('wire_section');
    const locationType = hotelLocationType ? hotelLocationType.value : '';
    
    console.log('🏦 toggleBankSections called with locationType:', locationType);
    console.log('🏦 Elements found - ACH:', !!achSection, 'Wire:', !!wireSection, 'LocationSelect:', !!hotelLocationType);
    
    // Hide both sections initially and clear any values
    if (achSection) {
      achSection.style.display = 'none';
      console.log('🏦 ACH section hidden');
    }
    if (wireSection) {
      wireSection.style.display = 'none';
      console.log('🏦 Wire section hidden');
    }
    
    // Remove required from all bank fields first
    const allBankFields = ['ach_bank_account_name', 'ach_routing_number', 'ach_account_number', 'ach_account_number_confirm', 'ach_bank_name', 'ach_ar_email', 
                          'wire_bank_account_name', 'wire_swift_code', 'wire_account_number', 'wire_account_number_confirm', 'wire_bank_name', 'wire_ar_email'];
    allBankFields.forEach(fieldName => {
      const field = document.querySelector(`[name="${fieldName}"]`);
      if (field) {
        field.required = false;
        console.log('🏦 Removed required from:', fieldName);
      }
    });
    
    // Show appropriate section based on selection
    if (locationType === 'US') {
      if (achSection) {
        achSection.style.display = 'block';
        console.log('🏦 ACH section shown (US selected)');
        
        // Make fields conditionally required based on whether user starts typing
        const achRequiredFields = ['ach_bank_account_name', 'ach_routing_number', 'ach_account_number', 'ach_bank_name', 'ach_ar_email'];
        
        // Remove existing listeners to prevent duplicates
        achRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            // Clone to remove all event listeners
            const newField = field.cloneNode(true);
            field.parentNode.replaceChild(newField, field);
          }
        });
        
        // Add fresh listeners - NOTE: confirmation field is NOT required by default
        achRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            const makeFieldsRequired = () => {
              const hasAnyAchData = achRequiredFields.some(fname => {
                const f = document.querySelector(`[name="${fname}"]`);
                return f && f.value.trim() !== '';
              });
              
              if (hasAnyAchData) {
                console.log('🏦 User started typing in ACH fields - making core fields required (not confirmation)');
                // Only make core fields required, NOT the confirmation field
                const coreFields = ['ach_bank_account_name', 'ach_routing_number', 'ach_account_number', 'ach_bank_name', 'ach_ar_email'];
                coreFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = true;
                });
                // Confirmation field stays optional
                const confirmField = document.querySelector('[name="ach_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              } else {
                console.log('🏦 No ACH data - removing required');
                achRequiredFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = false;
                });
                const confirmField = document.querySelector('[name="ach_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              }
            };
            
            field.addEventListener('input', makeFieldsRequired);
            field.addEventListener('blur', makeFieldsRequired);
          }
        });
      }
    } else if (locationType === 'International') {
      if (wireSection) {
        wireSection.style.display = 'block';
        console.log('🏦 Wire section shown (International selected)');
        
        // Make fields conditionally required based on whether user starts typing
        const wireRequiredFields = ['wire_bank_account_name', 'wire_swift_code', 'wire_account_number', 'wire_bank_name', 'wire_ar_email'];
        
        // Remove existing listeners to prevent duplicates
        wireRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            // Clone to remove all event listeners
            const newField = field.cloneNode(true);
            field.parentNode.replaceChild(newField, field);
          }
        });
        
        // Add fresh listeners - NOTE: confirmation field is NOT required by default
        wireRequiredFields.forEach(fieldName => {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (field) {
            const makeFieldsRequired = () => {
              const hasAnyWireData = wireRequiredFields.some(fname => {
                const f = document.querySelector(`[name="${fname}"]`);
                return f && f.value.trim() !== '';
              });
              
              if (hasAnyWireData) {
                console.log('🏦 User started typing in Wire fields - making core fields required (not confirmation)');
                // Only make core fields required, NOT the confirmation field
                const coreFields = ['wire_bank_account_name', 'wire_swift_code', 'wire_account_number', 'wire_bank_name', 'wire_ar_email'];
                coreFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = true;
                });
                // Confirmation field stays optional
                const confirmField = document.querySelector('[name="wire_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              } else {
                console.log('🏦 No Wire data - removing required');
                wireRequiredFields.forEach(fname => {
                  const f = document.querySelector(`[name="${fname}"]`);
                  if (f) f.required = false;
                });
                const confirmField = document.querySelector('[name="wire_account_number_confirm"]');
                if (confirmField) confirmField.required = false;
              }
            };
            
            field.addEventListener('input', makeFieldsRequired);
            field.addEventListener('blur', makeFieldsRequired);
          }
        });
      }
    } else if (locationType === 'skip') {
      // User explicitly chose to skip - show confirmation message
      console.log('🏦 User chose to skip banking information');
      // Both sections remain hidden, no fields are required
    } else {
      // Empty selection or going back to "Select" - hide everything
      console.log('🏦 No location selected or going back to select');
      // Both sections remain hidden, no fields are required
    }
    
    console.log('🏦 Final state - ACH display:', achSection?.style.display, 'Wire display:', wireSection?.style.display);
  }
  function checkOutdoorFacility(){
    if (hasOutdoorFacility && hasOutdoorFacility.value === 'Yes') {
      const message = 'We are unable to accept your hotel if you have outdoor facilities without secure gates. If you would like us to review your location, please reach out to us directly.';
      alert(message);
      return false;
    }
    return true;
  }
  
  function validatePolicies(){
    // Removed - policy confirmations are handled on the dedicated signup page
    return true;
  }
  
  function getFormData() {
    const formData = new FormData(form);
    const data = {};
    for (const [key, value] of formData.entries()) {
      if (data[key]) {
        if (Array.isArray(data[key])) {
          data[key].push(value);
        } else {
          data[key] = [data[key], value];
        }
      } else {
        data[key] = value;
      }
    }
    
    // Prefer official values when a Place ID exists
    if (data.hotel_place_id) {
      if (data.hotel_official_name) data.hotel_name = data.hotel_official_name;
      if (data.hotel_official_address) data.address = data.hotel_official_address.split(',')[0] || data.hotel_official_address;
    }
    if (data.management_company_place_id) {
      if (data.management_company_official_name) data.management_company = data.management_company_official_name;
      if (data.management_company_official_address) data.management_company_address = data.management_company_official_address;
    }
    return data;
  }
  
  function setFormData(data) {
    // Clear existing form data
    form.reset();
    
    // Set form values
    for (const [key, value] of Object.entries(data)) {
      if (key === 'form_type') continue; // Skip hidden form type
      
      const elements = form.querySelectorAll(`[name="${key}"]`);
      elements.forEach((el, index) => {
        if (Array.isArray(value)) {
          if (index < value.length) {
            if (el.type === 'checkbox' || el.type === 'radio') {
              el.checked = el.value === value[index];
            } else {
              el.value = value[index];
            }
          }
        } else {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = el.value === value;
          } else {
            el.value = value;
          }
        }
      });
    }
    
    // Rebuild meeting rooms if they exist
    if (data.room_name && Array.isArray(data.room_name)) {
      rooms.innerHTML = '';
      data.room_name.forEach((_, index) => {
        if (addRoomBtn) addMeetingRoom(); // Use the proper function
        const block = rooms.lastElementChild;
        if (block) {
          const setVal = (selector, value) => {
            const el = block.querySelector(selector);
            if (el && value != null && value !== '') el.value = String(value);
          };
          setVal('input[name="room_name[]"]', data.room_name[index]);
          setVal('input[name="room_level[]"]', data.room_level && data.room_level[index]);
          setVal('input[name="room_area_sqft[]"]', data.room_area_sqft && data.room_area_sqft[index]);
          setVal('input[name="room_area_sqm[]"]', data.room_area_sqm && data.room_area_sqm[index]);
          setVal('input[name="room_dims_ft[]"]', data.room_dims_ft && data.room_dims_ft[index]);
          setVal('input[name="room_ceiling_ft[]"]', data.room_ceiling_ft && data.room_ceiling_ft[index]);
          setVal('select[name="room_pillar_free[]"]', data.room_pillar_free && data.room_pillar_free[index]);
          setVal('select[name="room_natural_light[]"]', data.room_natural_light && data.room_natural_light[index]);
          setVal('select[name="room_divisible[]"]', data.room_divisible && data.room_divisible[index]);
          setVal('input[name="cap_theater[]"]', data.cap_theater && data.cap_theater[index]);
          setVal('input[name="cap_classroom[]"]', data.cap_classroom && data.cap_classroom[index]);
          setVal('input[name="cap_banquet[]"]', data.cap_banquet && data.cap_banquet[index]);
          setVal('input[name="cap_ushape[]"]', data.cap_ushape && data.cap_ushape[index]);
          setVal('input[name="cap_banquet_rounds[]"]', data.cap_banquet_rounds && data.cap_banquet_rounds[index]);
          setVal('input[name="cap_cocktail_rounds[]"]', data.cap_cocktail_rounds && data.cap_cocktail_rounds[index]);
          setVal('input[name="cap_crescent_rounds[]"]', data.cap_crescent_rounds && data.cap_crescent_rounds[index]);
          setVal('input[name="cap_hollow_square[]"]', data.cap_hollow_square && data.cap_hollow_square[index]);
          setVal('input[name="room_built_in_av[]"]', data.room_built_in_av && data.room_built_in_av[index]);
          setVal('input[name="room_power[]"]', data.room_power && data.room_power[index]);
          setVal('input[name="room_loadin[]"]', data.room_loadin && data.room_loadin[index]);
        }
      });
    }
    
    // Update form state
    toggleES();
    toggleAaaDiamond();
    toggleBankSections();
    // Ensure management company section visibility reflects saved value
    const managementSelect = document.getElementById('is_management_company_managed');
    const managementFields = document.getElementById('managementCompanyFields');
    if (managementSelect) {
      // Use the existing change handler to ensure consistent behavior and avoid race conditions
      managementSelect.dispatchEvent(new Event('change'));
    }
    
    // If draft has hotel_place_id but current inputs were typed, prefer stored official values
    const hotelPlaceId = document.getElementById('hotel_place_id');
    if (hotelPlaceId && data.hotel_place_id) {
      hotelPlaceId.value = data.hotel_place_id;
    }
    const mgmtPlaceId = document.getElementById('management_company_place_id');
    if (mgmtPlaceId && data.management_company_place_id) {
      mgmtPlaceId.value = data.management_company_place_id;
    }
    updateSubmitState();
  }
  
  // This function is handled by the enhanced saveDraft function above
  
  async function loadDraft() {
    if (!currentUserId) return;
    
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('No session ID available for draft load');
        return;
      }
      
      const response = await fetch(`${API_BASE}/api/draft/load/${currentUserId}`, {
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      });
      const result = await response.json();
      
      if (result.ok && result.draft) {
        setFormData(result.draft.formData);
        setActiveStep(result.draft.currentPage);
        showToast('Draft loaded successfully');
        hasDraft = false;
        draftStatus.style.display = 'none';
      } else {
        showToast('No draft found');
      }
    } catch (error) {
      console.error('Load draft error:', error);
      showToast('Failed to load draft');
    }
  }
  
  async function deleteDraft() {
    if (!currentUserId) return;
    
    try {
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('No session ID available for draft delete');
        return;
      }
      
      const response = await fetch(`${API_BASE}/api/draft/delete/${currentUserId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      });
      
      const result = await response.json();
      if (result.ok) {
        showToast('Draft deleted');
        hasDraft = false;
        draftStatus.style.display = 'none';
      } else {
        showToast('Failed to delete draft');
      }
    } catch (error) {
      console.error('Delete draft error:', error);
      showToast('Failed to delete draft');
    }
  }
  
  // Initialize Google Places API
  async function initializeGooglePlaces() {
    try {
      const response = await fetch('/api/google-places-key');
      
      if (!response.ok) {
        console.log('Google Places API endpoint not available:', response.status);
        showToast('ℹ️ Google Places API not available - autocomplete disabled');
        return;
      }
      
      const data = await response.json();
      
      // Handle mock mode
      if (data.mockMode) {
        console.log('Development Mode: Google Places API not configured, using mock data');
        showToast('ℹ️ Development Mode: Google Places API not configured');
        return;
      }
      
      googlePlacesApiKey = data.apiKey;
      
      if (googlePlacesApiKey) {
        console.log('Google Places API key loaded successfully');
        initAutocomplete();
      } else {
        console.log('No Google Places API key available');
        showToast('⚠️ Google Places API not configured');
      }
    } catch (error) {
      console.error('Error loading Google Places API key:', error);
      showToast('ℹ️ Google Places API not available - autocomplete disabled');
    }
  }

  async function checkForDraft() {
    if (!currentUserId) return;
    
    try {
      // Initialize Google Places API
      await initializeGooglePlaces();
    } catch (error) {
      console.error('Check draft error:', error);
      showToast('Failed to check for draft');
    }
  }
  
  document.addEventListener('DOMContentLoaded', async function() {
    // Initialize DOM elements
    form = document.getElementById('hotel-form');
    pages = Array.from(document.querySelectorAll('.page'));
    steps = Array.from(document.querySelectorAll('.step'));
    backBtn = document.getElementById('backBtn');
    nextBtn = document.getElementById('nextBtn');
    submitBtn = document.getElementById('submitBtn');
    navHint = document.getElementById('navHint');
    
    // Initialize other DOM elements
    addRoomBtn = document.getElementById('addRoomBtn');
    if (addRoomBtn) {
      console.log('🟢 Setting up Meeting Spaces button');
      
      // Remove existing listeners to prevent duplicates
      const newAddRoomBtn = addRoomBtn.cloneNode(true);
      addRoomBtn.parentNode.replaceChild(newAddRoomBtn, addRoomBtn);
      addRoomBtn = newAddRoomBtn;
      
      addRoomBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('🟢 Add Room button clicked');
        addMeetingRoom();
      });
      
      console.log('🟢 Meeting Spaces button listener attached successfully');
    } else {
      console.error('🟢 Add Room button not found!');
    }
    
    rooms = document.getElementById('rooms');
    isExtendedStay = document.getElementById('is_extended_stay');
    if (isExtendedStay) {
      console.log('🏨 Setting up Extended Stay listener');
      
      // Remove existing listeners
      const newExtendedStaySelect = isExtendedStay.cloneNode(true);
      isExtendedStay.parentNode.replaceChild(newExtendedStaySelect, isExtendedStay);
      isExtendedStay = newExtendedStaySelect;
      
      isExtendedStay.addEventListener('change', function() {
        console.log('🏨 Extended Stay changed to:', this.value);
        toggleES();
        
        // Auto-save when Extended Stay selection changes
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('extended-stay-change');
          }, 500);
        }
      });
      
      // Initialize Extended Stay section based on current value
      console.log('🏨 Initializing Extended Stay with current value:', isExtendedStay.value);
      setTimeout(() => {
        toggleES();
      }, 100);
    } else {
      console.error('🏨 Extended Stay select not found!');
    }
    acceptsNet30 = document.getElementById('accepts_net30');
    hasOutdoorFacility = document.getElementById('has_outdoor_facility');
    isAaaRated = document.getElementById('is_aaa_rated');
    hotelLocationType = document.getElementById('hotel_location_type');
    if (hotelLocationType) {
      console.log('🏦 Setting up hotel location type change listener');
      
      // Remove any existing listeners
      const newLocationSelect = hotelLocationType.cloneNode(true);
      hotelLocationType.parentNode.replaceChild(newLocationSelect, hotelLocationType);
      hotelLocationType = newLocationSelect;
      
      hotelLocationType.addEventListener('change', function() {
        console.log('🏦 Hotel location type changed to:', this.value);
        toggleBankSections();
        
        // Auto-save when user changes location type
        if (signedIn || window.signedIn) {
          setTimeout(() => {
            handleSaveDraft('location-change');
          }, 500);
        }
      });
      
      // Initialize bank sections based on current value
      console.log('🏦 Initializing bank sections with current value:', hotelLocationType.value);
      setTimeout(() => {
        toggleBankSections();
      }, 100);
    } else {
      console.error('🏦 Hotel location type select not found!');
    }
    saveDraftBtn = document.getElementById('saveDraftBtn');
    loadDraftBtn = document.getElementById('loadDraftBtn');
    discardDraftBtn = document.getElementById('discardDraftBtn');
    draftStatus = document.getElementById('draftStatus');
    draftInfo = document.getElementById('draftInfo');
    
    console.log('DOM elements initialized:', { 
      pages: pages.length, 
      steps: steps.length, 
      nextBtn: !!nextBtn,
      form: !!form,
      addRoomBtn: !!addRoomBtn
    });
    
    // Check authentication for signed-in users
    const urlParams = new URLSearchParams(window.location.search);
    const signedInParam = urlParams.get('signedIn');
    
    if (signedInParam === 'true') {
      // Prefer signed-in flow if a session exists; otherwise fall back to guest mode on page 1
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        console.warn('signedIn=true but no session found; falling back to guest mode and showing page 1');
        if (typeof showToast === 'function') {
          try { showToast('Continuing without sign-in — showing page 1'); } catch (e) {}
        }
      } else {
        // Verify session is still valid first using /api/auth/me
        try {
          const authResponse = await fetch('/api/auth/me', {
            headers: {
              'Authorization': `Bearer ${sessionId}`
            }
          });
          
          if (!authResponse.ok) {
            // Session is invalid; clear and continue in guest mode
            await authResponse.json().catch(() => ({}));
            console.warn('Session invalid; clearing and continuing in guest mode');
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            localStorage.removeItem('fedevent_hotel');
          } else {
            const authData = await authResponse.json();
            // Check if user has hotel role
            if (!authData.user || authData.user.role !== 'hotel') {
              console.warn('Non-hotel account; continuing in guest mode');
            } else {
              // Store user data if not already present
              const userData = localStorage.getItem('fedevent_user');
              if (!userData) {
                localStorage.setItem('fedevent_user', JSON.stringify(authData.user));
              }
              // Try to get hotel profile data (but don't fail if hotel_id is null)
              if (authData.user.hotel_id) {
                try {
                  const profileResponse = await fetch('/api/hotel/profile', {
                    headers: {
                      'Authorization': `Bearer ${sessionId}`
                    }
                  });
                  if (profileResponse.ok) {
                    await profileResponse.json();
                  }
                } catch (profileError) {
                  console.log('Could not load hotel profile data, continuing without it');
                }
              }
              // Display user info
              const userInfoDiv = document.getElementById('userInfo');
              const userDisplayName = document.getElementById('userDisplayName');
              if (userInfoDiv && userDisplayName) {
                try {
                  const storedUserData = localStorage.getItem('fedevent_user') || JSON.stringify(authData.user);
                  const user = JSON.parse(storedUserData);
                  if (user) {
                    let displayText = user.username || 'User';
                    if (user.fedevent_account_number) {
                      displayText += ` (${user.fedevent_account_number})`;
                    }
                    userDisplayName.textContent = displayText;
                    userInfoDiv.style.display = 'flex';
                    const backToProfileBtn = document.getElementById('backToProfileBtn');
                    if (backToProfileBtn) backToProfileBtn.style.display = 'inline-block';
                  }
                } catch (e) {
                  console.error('Error displaying user info:', e);
                }
              }
            }
          }
        } catch (error) {
          console.error('Authentication verification failed, continuing in guest mode:', error);
        }
      }
    }
    
    // Initialize Google Places API (with error handling) - moved to after page initialization
    // This will be called after the page is properly initialized
    
    // Check if user is continuing from dashboard
    console.log('Checking continue mode...');
    if (await checkContinueMode()) {
      console.log('Continue mode detected, user is signed in');
      // User is approved and continuing - start auto-save
      startAutoSave();
      setupAutoSaveOnInput(); // Set up auto-save on input changes
      updateDraftStatus();
    } else {
      console.log('No continue mode, setting default page to 1');
      // Default initialization - start at page 1
      setActiveStep(1);
    }
    
    console.log('Page initialization complete, current page:', current);
    
    // Ensure page 1 is visible (fallback)
    if (current === 0 || !document.querySelector('.page.active')) {
      console.log('Fallback: Setting page to 1');
      setActiveStep(1);
    }
    
    // IMMEDIATE AUTO-RESTORE FROM LOCALSTORAGE
    console.log('🔄 Starting immediate auto-restore from localStorage...');
    try {
      // Try multiple localStorage keys for maximum reliability
      const restoreKeys = [
        'hotel_registration_draft',
        `hotel_registration_draft_${currentUserId || 'anonymous'}`,
        ...Object.keys(localStorage).filter(key => key.startsWith('hotel_registration_backup_')).sort().slice(-1)
      ];
      
      let restored = false;
      for (const key of restoreKeys) {
        const savedData = localStorage.getItem(key);
        if (savedData) {
          try {
            const draftData = JSON.parse(savedData);
            if (draftData.formData && Object.keys(draftData.formData).length > 0) {
              console.log('🔄 Restoring from key:', key, 'with', Object.keys(draftData.formData).length, 'fields');
              setFormData(draftData.formData);
              
              // Restore page location
              if (draftData.currentStep !== undefined && draftData.currentStep >= 1) {
                current = draftData.currentStep;
                setActiveStep(current);
                console.log('🔄 Restored to page:', current);
              }
              
              restored = true;
              
              // Show success message
              if (signedIn || window.signedIn) {
                showToast('✅ Your previous progress has been restored!');
              }
              
              break; // Stop after first successful restore
            }
          } catch (e) {
            console.warn('Failed to restore from key:', key, e);
          }
        }
      }
      
      // Also restore current page from dedicated storage
      const savedPage = localStorage.getItem('hotel_registration_current_page');
      if (savedPage && !restored) {
        const pageNum = parseInt(savedPage);
        if (!isNaN(pageNum) && pageNum >= 1) {
          current = pageNum;
          setActiveStep(current);
          console.log('🔄 Restored page location only:', pageNum);
        }
      }
      
      if (restored) {
        // Update status indicators
        const lastSave = localStorage.getItem('hotel_registration_last_save');
        if (lastSave) {
          const autoSaveStatus = document.getElementById('autoSaveStatus');
          if (autoSaveStatus) {
            const saveDate = new Date(lastSave);
            autoSaveStatus.textContent = `Last saved: ${saveDate.toLocaleTimeString()}`;
          }
        }
        
        console.log('🔄 Auto-restore completed successfully');
      } else {
        console.log('🔄 No saved data found to restore');
      }
      
    } catch (error) {
      console.error('🔄 Auto-restore failed:', error);
    }
    
    // Final check - force page 1 to be visible
    setTimeout(() => {
      const activePage = document.querySelector('.page.active');
      if (!activePage) {
        console.log('Emergency fallback: No active page found, forcing page 1');
        setActiveStep(1);
      } else {
        console.log('Active page found:', activePage.getAttribute('data-page'));
      }
    }, 200);
    
    // Initialize Google Places API after page is set up
    setTimeout(async () => {
      try {
        console.log('Initializing Google Places API...');
        await initializeGooglePlaces();
        console.log('Google Places API initialized successfully');
      } catch (error) {
        console.error('Google Places API initialization failed:', error);
        // Don't let this prevent the page from loading
      }
    }, 100);
    
    // Add save draft buttons to all pages (except first page)
    pages.forEach((page, index) => {
      if (index > 0) { // Skip first page
        const navSection = page.querySelector('.nav');
        if (navSection && !page.querySelector('.save-draft-btn')) {
          const saveDraftBtn = document.createElement('button');
          saveDraftBtn.type = 'button';
          saveDraftBtn.className = 'btn subtle save-draft-btn';
          saveDraftBtn.textContent = '💾 Save Draft';
          saveDraftBtn.style.marginLeft = 'auto';
          saveDraftBtn.onclick = saveDraft;
          navSection.insertBefore(saveDraftBtn, navSection.firstChild);
        }
      }
    });
    
    // Wire Next/Back navigation
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        console.log('Next button clicked, current page:', current);
        console.log('Validating current page...');
        if (!validateCurrentPage()) {
          console.log('Validation failed');
          return;
        }
        console.log('Validation passed, moving to next page');
        const last = pages.length - 1;
        if (current < last) {
          setActiveStep(current + 1);
        }
      });
    }
    
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        console.log('Back button clicked, current page:', current);
        if (current > 1) { // Start from page 1 (Company Information)
          setActiveStep(current - 1);
        }
      });
    }
    
    // Live validation for Primary Contacts roles to prevent duplicate or invalid combinations
    const roleSel0 = document.querySelector('[name="sign_contacts[0][role]"]');
    const roleSel1 = document.querySelector('[name="sign_contacts[1][role]"]');
    const signErr  = document.getElementById('signContactsError');
    
    console.log('Role validation setup:', {
      roleSel0: !!roleSel0,
      roleSel1: !!roleSel1,
      signErr: !!signErr
    });
    
    if (!roleSel0 || !roleSel1) {
      console.error('Role selectors not found! Cannot set up validation.');
      return;
    }
    
    function checkForDuplicateRoles(changedElement) {
      const role0 = roleSel0.value;
      const role1 = roleSel1.value;
      
      console.log('Checking roles:', { role0, role1, changedElement: changedElement?.name });
      
      // If both roles are selected and they're the same
      if (role0 && role1 && role0 === role1) {
        console.log('DUPLICATE ROLES DETECTED!');
        
        // Show alert immediately
        alert('⚠️ ROLE CONFLICT!\n\nYou cannot assign the same role to both contacts.\n\nPlease choose:\n• "Signer" for one contact\n• "Approver" for the other contact\n\nThe conflicting selection will be cleared.');
        
        // Clear the field that was just changed
        if (changedElement) {
          console.log('Clearing changed element:', changedElement.name);
          changedElement.value = '';
          changedElement.focus();
        }
        
        // Show visual error
        if (signErr) {
          signErr.style.display = 'block';
          signErr.style.color = '#dc3545';
          signErr.style.backgroundColor = '#f8d7da';
          signErr.style.border = '1px solid #f5c2c7';
          signErr.style.borderRadius = '8px';
          signErr.style.padding = '12px';
          signErr.style.marginTop = '8px';
          signErr.innerHTML = '<strong>⚠️ Role Conflict:</strong> Each contact must have a different role. Please select one Signer and one Approver.';
        }
        
        return true; // Indicates duplicate found
      }
      
      // Clear error if roles are valid
      if (signErr) {
        signErr.style.display = 'none';
      }
      
      return false; // No duplicates
    }
    
    // Direct event handlers
    function handleRole0Change(e) {
      console.log('Role 0 changed to:', e.target.value);
      checkForDuplicateRoles(e.target);
    }
    
    function handleRole1Change(e) {
      console.log('Role 1 changed to:', e.target.value);
      checkForDuplicateRoles(e.target);
    }
    
    // Remove any existing listeners and add new ones
    roleSel0.removeEventListener('change', handleRole0Change);
    roleSel0.addEventListener('change', handleRole0Change);
    console.log('Role 0 change listener attached');
    
    roleSel1.removeEventListener('change', handleRole1Change);
    roleSel1.addEventListener('change', handleRole1Change);
    console.log('Role 1 change listener attached');
    
    // Test the validation immediately after setup
    setTimeout(() => {
      console.log('Testing role validation setup...');
      console.log('Role 0 current value:', roleSel0.value);
      console.log('Role 1 current value:', roleSel1.value);
      if (roleSel0.value && roleSel1.value) {
        checkForDuplicateRoles(null);
      }
    }, 1000);
    
    // Hotel main photo preview and validation
    const hotelPhotoInput = document.getElementById('hotel_main_photo');
    const photoPreview = document.getElementById('photo_preview');
    const previewImage = document.getElementById('preview_image');
    const photoInfo = document.getElementById('photo_info');
    
    if (hotelPhotoInput) {
      hotelPhotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
          photoPreview.style.display = 'none';
          return;
        }
        
        // Validate file size (5MB max)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
          alert('⚠️ File too large!\n\nPlease upload a photo smaller than 5MB.\n\nCurrent file size: ' + (file.size / (1024 * 1024)).toFixed(1) + 'MB');
          e.target.value = '';
          photoPreview.style.display = 'none';
          return;
        }
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          alert('⚠️ Invalid file type!\n\nPlease upload a JPG, JPEG, or PNG image.');
          e.target.value = '';
          photoPreview.style.display = 'none';
          return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          photoPreview.style.display = 'block';
          
          // Show file info
          const sizeInMB = (file.size / (1024 * 1024)).toFixed(1);
          const sizeColor = file.size > (3 * 1024 * 1024) ? '#f59e0b' : '#059669'; // Orange if > 3MB, green otherwise
          photoInfo.innerHTML = `
            <strong>File:</strong> ${file.name}<br>
            <strong>Size:</strong> <span style="color:${sizeColor}">${sizeInMB}MB</span> 
            ${file.size > (3 * 1024 * 1024) ? '(⚠️ Large file - consider resizing for faster upload)' : '(✓ Good size)'}<br>
            <strong>Type:</strong> ${file.type.split('/')[1].toUpperCase()}
          `;
        };
        reader.readAsDataURL(file);
      });
    }
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        if (current > 0) {
          setActiveStep(current - 1);
        }
      });
    }
    
    // AAA diamond toggle wiring
    if (isAaaRated) {
      isAaaRated.addEventListener('change', toggleAaaDiamond);
      // Initialize visibility on load
      toggleAaaDiamond();
    }

    // Set up event listeners for draft functionality
    if (saveDraftBtn) saveDraftBtn.addEventListener('click', saveDraft);
    if (loadDraftBtn) loadDraftBtn.addEventListener('click', loadDraft);
    if (discardDraftBtn) discardDraftBtn.addEventListener('click', () => {
      localStorage.removeItem('hotel_registration_draft');
      hasDraft = false;
      updateDraftStatus();
      showToast('Draft discarded');
    });
    
    // Auto-save on form changes (debounced) - REMOVED to avoid duplication
    // The setupAutoSaveOnInput() function handles this more efficiently

    // Submit (to /local/api/submit)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!validateCurrentPage()) return;
      if (submitBtn.disabled){ alert('NET30 acceptance is required to submit.'); return; }
      if (submittingFlag) return;
      
      // Track form submission
      trackFormSubmission('Hotel Registration');
      
      // Check session validity before submission
      const sessionId = localStorage.getItem('fedevent_session');
      if (!sessionId) {
        alert('Your session has expired. Please log in again.');
        window.location.href = '/hotel-login.html';
        return;
      }
      
      // Verify session is still valid with server
      try {
        const sessionCheck = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${sessionId}`
          }
        });
        
        if (!sessionCheck.ok) {
          // Check if it's actually a session issue
          const errorData = await sessionCheck.json().catch(() => ({}));
          if (sessionCheck.status === 401 || errorData.error?.includes('expired') || errorData.error?.includes('Invalid')) {
            // Session is invalid, redirect to login
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            localStorage.removeItem('fedevent_hotel');
            alert('Your session has expired. Please log in again.');
            window.location.href = '/hotel-login.html';
          } else {
            alert(`Session validation error: ${errorData.error || 'Unable to verify session.'}`);
            // Don't redirect, let user try to submit
          }
          return;
        }
      } catch (sessionError) {
        console.error('Session validation error:', sessionError);
        alert('Unable to verify session. Please log in again.');
        window.location.href = '/hotel-login.html';
        return;
      }
      
      submittingFlag = true; submitting.classList.add('show');
      try{
        const urlParams = new URLSearchParams(window.location.search);
        const editMode = urlParams.get('mode');
        const fd = new FormData(form);
        
        // Determine the appropriate API endpoint based on mode
        const endpoint = editMode === 'edit' ? '/api/hotel/profile' : '/api/submit';
        const method = editMode === 'edit' ? 'PUT' : 'POST';
        
        const resp = await fetch(`${API_BASE}${endpoint}`, { 
          method, 
          body: fd,
          headers: {
            'Authorization': `Bearer ${sessionId}`
          }
        });
        let json;
        try { json = await resp.json(); } catch(parseErr){
          const text = await resp.text(); throw new Error('Submit parse error: ' + text.slice(0,200));
        }
        if (!json.ok){ showToast(json.error || 'Submit failed.'); return; }
        
        // Clear draft after successful submission
        if (currentUserId) {
          try {
            await fetch(`/api/draft/delete/${currentUserId}`, { method: 'DELETE' });
            localStorage.removeItem('hotel_registration_draft');
          } catch (e) {
            console.warn('Failed to clear draft after submission:', e);
          }
        }
        
        if (editMode === 'edit') {
          thanksId.textContent = 'Hotel Profile Updated Successfully!';
          // Redirect back to dashboard after 3 seconds
          setTimeout(() => {
            window.location.href = '/hotel-dashboard.html';
          }, 3000);
        } else {
          thanksId.textContent = 'Hotel ID: ' + (json.hotelId || '');
        }
        submitting.classList.remove('show'); thanks.classList.add('show'); window.scrollTo(0,0);
      }catch(e){ showToast((e && e.message) ? e.message : ('Submit error: ' + e)); }
      finally{ submittingFlag = false; submitting.classList.remove('show'); }
    });

    submitAnother.addEventListener('click', ()=>{
      form.reset(); rooms.innerHTML=''; if (isExtendedStay) isExtendedStay.value='';
      if (hasOutdoorFacility) hasOutdoorFacility.value='';
      if (isAaaRated) isAaaRated.value='';
      document.getElementById('accept_net30').checked = false;
      document.getElementById('accept_no_direct_bill').checked = false;
      document.getElementById('accept_per_diem_discount').checked = false;
      hasDraft = false; draftStatus.style.display = 'none';
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
      
      // Clear any existing drafts
      localStorage.removeItem('hotel_registration_draft');
      if (currentUserId) {
        fetch(`/api/draft/delete/${currentUserId}`, { method: 'DELETE' }).catch(e => console.warn('Failed to clear draft:', e));
      }
      
      toggleES(); updateSubmitState(); toggleAaaDiamond(); toggleBankSections(); setActiveStep(0); thanks.classList.remove('show');
    });
  });
</script>

<footer id="contact">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>FEDEVENT</h3>
                <p>Professional event planning services for U.S. Government agencies.</p>
            </div>
            <div class="footer-section">
                <h3>Services</h3>
                <a href="/hotel-signup.html">Hotel Sourcing</a>
                <a href="/contact.html">Event Planning</a>
                <a href="/government-portal.html">Venue Matching</a>
                <a href="/support-ticket.html">Support Ticket</a>
            </div>
            <div class="footer-section footer-contact">
                <h3>Contact</h3>
                <p>Email: info@fedevent.com</p>
                <p>Phone: (305) 850-7848</p>
                <a href="/admin-login.html" style="color: #d1d5db; text-decoration: none; margin-top: 10px; display: inline-block; padding: 5px 10px; border: 1px solid #374151; border-radius: 4px; font-size: 0.9rem;">
                    🔐 Admin Access
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>fedevent.com is a service of CREATA Global Event Agency LLC</p>
            <p>&copy; 2025 FEDEVENT. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <a href="/admin-login.html" style="color: #9ca3af; text-decoration: none; border-bottom: 1px dotted #9ca3af;">
                    🔐 Admin Sign In
                </a>
            </p>
        </div>
    </div>
</footer>

<style>
    /* Footer Styles */
    footer {
        background: var(--text, #1f2937);
        color: white;
        padding: 3rem 0 1rem;
        margin-top: auto;
    }

    .footer-content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .footer-section h3 {
        margin-bottom: 1rem;
        color: var(--secondary, #f59e0b);
    }

    .footer-section a {
        display: block;
        color: #d1d5db;
        text-decoration: none;
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }

    .footer-section a:hover {
        color: var(--secondary, #f59e0b);
    }

    .footer-contact {
        text-align: right;
    }

    .footer-bottom {
        border-top: 1px solid #374151;
        padding-top: 2rem;
        text-align: center;
        color: #9ca3af;
    }

    /* Responsive Footer */
    @media (max-width: 768px) {
        .footer-content {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .footer-contact {
            text-align: left;
        }
    }
</style>

<script src="/chat.js"></script>
    <script src="/nav.js"></script>

<!-- Emergency form initialization fix -->
<script>
// Force form to show Page 1 on load - emergency fix
setTimeout(() => {
  console.log('Emergency form fix running...');
  
  // Check and set signedIn status
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = localStorage.getItem('fedevent_session');
  const signedInParam = urlParams.get('signedIn');
  const continueParam = urlParams.get('continue');
  
  // Force signedIn to true if session exists and URL indicates signed in
  if (sessionId && (signedInParam === 'true' || continueParam === 'true')) {
    window.signedIn = true;
    // Also set the global variable if it exists
    if (typeof signedIn !== 'undefined') {
      signedIn = true;
    }
    console.log('Emergency fix: signedIn status set to true (both window.signedIn and global signedIn)');
  }
  
  // Force remove active from all pages
  document.querySelectorAll('.page').forEach(p => {
    p.classList.remove('active');
    p.style.display = 'none';
  });
  
  // Force page 1 to be active and visible
  const page1 = document.querySelector('.page[data-page="1"]');
  if (page1) {
    page1.classList.add('active');
    page1.style.display = 'block';
    console.log('Page 1 forced visible');
  }
  
  // Force step 1 to be active
  document.querySelectorAll('.step').forEach((step, index) => {
    step.classList.remove('active', 'completed');
    if (index === 1) { // Step 1 (0-indexed, so index 1 = step 2 visually, but we want step 1)
      step.classList.add('active');
    }
  });
  
  // Actually, let's make step 0 active (Company Information)
  const step0 = document.querySelector('.step[data-step="1"]');
  if (step0) {
    step0.classList.add('active');
    console.log('Step 1 forced active');
  }
  
  // Ensure navigation buttons are working
  const nextBtn = document.getElementById('nextBtn');
  const backBtn = document.getElementById('backBtn');
  if (nextBtn) {
    nextBtn.style.display = 'inline-block';
    nextBtn.disabled = false;
  }
  if (backBtn) {
    backBtn.disabled = true; // First page
  }
  
  // Fix management company fields visibility
  const managementSelect = document.getElementById('is_management_company_managed');
  const managementFields = document.getElementById('managementCompanyFields');
  if (managementSelect && managementFields) {
    console.log('Checking management company visibility...');
    console.log('Management select value:', managementSelect.value);
    
    // Check if there's data in management fields
    const hasData = Array.from(managementFields.querySelectorAll('input')).some(input => input.value.trim() !== '');
    console.log('Management fields have data:', hasData);
    
    // If select is "Yes" or there's data, show the fields
    if (managementSelect.value === 'Yes' || hasData) {
      managementFields.style.display = 'block';
      managementSelect.value = 'Yes'; // Ensure consistency
      console.log('Management company fields made visible');
    } else {
      managementFields.style.display = 'none';
      console.log('Management company fields hidden');
    }
  }
  
  // Initialize auto-save if user is signed in
  if (window.signedIn && typeof setupAutoSaveOnInput === 'function') {
    console.log('Emergency fix: Initializing auto-save...');
    setupAutoSaveOnInput();
    
    if (typeof startAutoSave === 'function') {
      startAutoSave();
      console.log('Emergency fix: Started auto-save timer');
    }
  }
  
  // Initialize AAA diamond toggle
  const aaaRatedSelect = document.getElementById('is_aaa_rated');
  if (aaaRatedSelect && typeof toggleAaaDiamond === 'function') {
    console.log('Emergency fix: Initializing AAA diamond toggle');
    // Add event listener for future changes
    aaaRatedSelect.addEventListener('change', function() {
      console.log('AAA rating changed to:', this.value);
      toggleAaaDiamond();
    });
    // Initialize current state
    toggleAaaDiamond();
  } else {
    console.log('Emergency fix: AAA rating select not found or toggleAaaDiamond not available');
  }
  
  // Force AAA diamond section to work immediately
  setTimeout(() => {
    const aaaSelect = document.getElementById('is_aaa_rated');
    const diamondSection = document.getElementById('aaa_diamond_section');
    
    if (aaaSelect && diamondSection) {
      console.log('Force AAA fix: Setting up direct listener');
      
      // Remove any existing listeners
      const newSelect = aaaSelect.cloneNode(true);
      aaaSelect.parentNode.replaceChild(newSelect, aaaSelect);
      
      // Add direct listener
      newSelect.addEventListener('change', function() {
        console.log('Direct AAA listener: Value changed to', this.value);
        const showDiamond = (this.value === 'Yes');
        diamondSection.style.display = showDiamond ? 'block' : 'none';
        
        const ratingSelect = document.getElementById('aaa_diamond_rating');
        if (ratingSelect) {
          ratingSelect.required = showDiamond;
        }
        
        console.log('Direct AAA listener: Diamond section display:', diamondSection.style.display);
      });
      
      // Check initial state
      if (newSelect.value === 'Yes') {
        diamondSection.style.display = 'block';
        const ratingSelect = document.getElementById('aaa_diamond_rating');
        if (ratingSelect) ratingSelect.required = true;
      }
    }
  }, 100);
  
  // Emergency role validation fix
  setTimeout(() => {
    const role0 = document.querySelector('[name="sign_contacts[0][role]"]');
    const role1 = document.querySelector('[name="sign_contacts[1][role]"]');
    
    if (role0 && role1) {
      console.log('Emergency role validation setup');
      
      function emergencyRoleCheck(changedSelect) {
        const val0 = role0.value;
        const val1 = role1.value;
        
        console.log('Emergency role check:', { val0, val1 });
        
        if (val0 && val1 && val0 === val1) {
          console.log('EMERGENCY: Duplicate roles detected!');
          alert('⚠️ DUPLICATE ROLE ERROR!\n\nYou selected the same role for both contacts.\n\nPlease choose different roles:\n• One "Signer"\n• One "Approver"');
          
          if (changedSelect) {
            changedSelect.value = '';
            changedSelect.focus();
          }
        }
      }
      
      // Clone and replace to ensure clean listeners
      const newRole0 = role0.cloneNode(true);
      const newRole1 = role1.cloneNode(true);
      
      role0.parentNode.replaceChild(newRole0, role0);
      role1.parentNode.replaceChild(newRole1, role1);
      
      newRole0.addEventListener('change', function() {
        console.log('Emergency: Role 0 changed to', this.value);
        emergencyRoleCheck(this);
      });
      
      newRole1.addEventListener('change', function() {
        console.log('Emergency: Role 1 changed to', this.value);
        emergencyRoleCheck(this);
      });
      
      console.log('Emergency role validation listeners attached');
    }
  }, 200);
  
  console.log('Emergency form fix completed');
  
  // IMMEDIATE AUTO-RESTORE on page load
  const immediateRestore = () => {
    console.log('💾 IMMEDIATE: Attempting to restore draft data...');
    
    try {
      // Try multiple sources
      const sources = [
        'hotel_registration_draft',
        `hotel_registration_draft_${currentUserId || 'anonymous'}`,
        'hotel_registration_draft_temp'
      ];
      
      for (const key of sources) {
        const draftData = localStorage.getItem(key);
        if (draftData) {
          try {
            const parsed = JSON.parse(draftData);
            if (parsed.formData && Object.keys(parsed.formData).length > 0) {
              console.log('💾 IMMEDIATE: Restoring from', key, 'with', Object.keys(parsed.formData).length, 'fields');
              setFormData(parsed.formData);
              
              if (parsed.currentStep !== undefined) {
                current = parsed.currentStep;
                setActiveStep(current);
              }
              
              // Show confirmation
              const toast = document.createElement('div');
              toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:8px 12px; border-radius:6px; z-index:10000; font-size:0.8rem;';
              toast.textContent = '✓ Draft restored';
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 3000);
              
              break;
            }
          } catch (e) {
            console.error('💾 IMMEDIATE: Error parsing', key, e);
          }
        }
      }
      
      // Also restore page
      const savedPage = localStorage.getItem('hotel_registration_current_page');
      if (savedPage) {
        const pageNum = parseInt(savedPage);
        if (!isNaN(pageNum) && pageNum >= 0) {
          current = pageNum;
          setActiveStep(current);
          console.log('💾 IMMEDIATE: Restored to page', pageNum);
        }
      }
      
    } catch (error) {
      console.error('💾 IMMEDIATE: Restore failed:', error);
    }
  };
  
  // MULTIPLE AUTO-RESTORE ATTEMPTS FOR MAXIMUM RELIABILITY
  function attemptAutoRestore() {
    console.log('🔄 Attempting auto-restore...');
    
    try {
      // Try multiple localStorage keys
      const restoreKeys = [
        'hotel_registration_draft',
        `hotel_registration_draft_${currentUserId || 'anonymous'}`,
        ...Object.keys(localStorage).filter(key => key.startsWith('hotel_registration_backup_')).sort().slice(-1)
      ];
      
      let restored = false;
      for (const key of restoreKeys) {
        const savedData = localStorage.getItem(key);
        if (savedData) {
          try {
            const draftData = JSON.parse(savedData);
            if (draftData.formData && Object.keys(draftData.formData).length > 0) {
              console.log('🔄 Restoring from key:', key, 'with', Object.keys(draftData.formData).length, 'fields');
              setFormData(draftData.formData);
              
              // Restore page location
              if (draftData.currentStep !== undefined && draftData.currentStep >= 1) {
                current = draftData.currentStep;
                setActiveStep(current);
                console.log('🔄 Restored to page:', current);
              }
              
              restored = true;
              
              // Update status indicators
              const autoSaveStatus = document.getElementById('autoSaveStatus');
              if (autoSaveStatus) {
                const saveDate = draftData.timestamp ? new Date(draftData.timestamp) : new Date();
                autoSaveStatus.textContent = `Restored from: ${saveDate.toLocaleTimeString()}`;
              }
              
              break; // Stop after first successful restore
            }
          } catch (e) {
            console.warn('Failed to restore from key:', key, e);
          }
        }
      }
      
      return restored;
    } catch (error) {
      console.error('🔄 Auto-restore failed:', error);
      return false;
    }
  }
  
  // Multiple restore attempts
  setTimeout(() => {
    console.log('🔄 Auto-restore attempt 1...');
    if (attemptAutoRestore()) {
      console.log('🔄 Auto-restore successful on attempt 1');
    } else {
      setTimeout(() => {
        console.log('🔄 Auto-restore attempt 2...');
        if (attemptAutoRestore()) {
          console.log('🔄 Auto-restore successful on attempt 2');
        } else {
          setTimeout(() => {
            console.log('🔄 Auto-restore attempt 3 (final)...');
            if (attemptAutoRestore()) {
              console.log('🔄 Auto-restore successful on attempt 3');
            } else {
              console.log('🔄 No saved data found to restore after 3 attempts');
            }
          }, 2000);
        }
      }, 1000);
    }
  }, 100);
  
  // Run immediately if signed in
  if (signedIn || window.signedIn) {
    console.log('🔄 Running immediate restore for signed-in user...');
    attemptAutoRestore();
    
    // Also run after a short delay in case DOM isn't ready
    setTimeout(() => {
      console.log('🔄 Running delayed restore...');
      attemptAutoRestore();
    }, 500);
  }
  
  // Add auto-save on page unload as final safety measure
  window.addEventListener('beforeunload', function(e) {
    if ((signedIn || window.signedIn)) {
      console.log('Page unloading - final auto-save attempt');
      try {
        handleSaveDraft('unload-save');
      } catch (error) {
        console.error('Unload save failed:', error);
      }
    }
  });
  
  // Add visibility change auto-save (when user switches tabs)
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && (signedIn || window.signedIn)) {
      console.log('Page hidden - auto-saving');
      handleSaveDraft('visibility-save');
    }
  });
}, 500); // Run after other scripts

// Additional fix that runs later to handle draft loading
setTimeout(() => {
  console.log('Late management company visibility fix running...');
  const managementSelect = document.getElementById('is_management_company_managed');
  const managementFields = document.getElementById('managementCompanyFields');
  
  if (managementSelect && managementFields) {
    const hasData = Array.from(managementFields.querySelectorAll('input')).some(input => input.value.trim() !== '');
    console.log('Late check - Management select value:', managementSelect.value);
    console.log('Late check - Has data:', hasData);
    
    if (managementSelect.value === 'Yes' || hasData) {
      managementFields.style.display = 'block';
      managementSelect.value = 'Yes';
      console.log('Late fix: Management company fields made visible');
    }
  }
  
  // Ensure auto-save is working - late initialization
  if (window.signedIn && typeof setupAutoSaveOnInput === 'function') {
    console.log('Late fix: Re-initializing auto-save...');
    setupAutoSaveOnInput();
  }
  
  // Re-initialize comprehensive auto-save system
  if (window.signedIn || signedIn) {
    console.log('Late fix: Re-initializing comprehensive auto-save...');
    if (typeof ensureAutoSaveActive === 'function') {
      ensureAutoSaveActive();
    }
    
    // Add extra safety auto-save every 30 seconds for signed-in users
    if (window.safetyAutoSaveInterval) clearInterval(window.safetyAutoSaveInterval);
    window.safetyAutoSaveInterval = setInterval(() => {
      if ((signedIn || window.signedIn)) {
        console.log('Safety auto-save triggered');
        handleSaveDraft('safety-periodic');
      }
    }, 30000); // Every 30 seconds as backup
  }
  
  // Late AAA diamond toggle fix
  const lateAaaSelect = document.getElementById('is_aaa_rated');
  if (lateAaaSelect) {
    console.log('Late fix: AAA rating current value:', lateAaaSelect.value);
    if (typeof toggleAaaDiamond === 'function') {
      toggleAaaDiamond();
      console.log('Late fix: AAA diamond toggle executed');
    }
    
    // Ensure event listener is attached
    if (!lateAaaSelect.hasAttribute('data-listener-attached')) {
      lateAaaSelect.addEventListener('change', function() {
        console.log('Late fix: AAA rating changed to:', this.value);
        if (typeof toggleAaaDiamond === 'function') {
          setTimeout(toggleAaaDiamond, 100);
        }
      });
      lateAaaSelect.setAttribute('data-listener-attached', 'true');
      console.log('Late fix: AAA rating change listener attached');
    }
  }
  // Emergency bank sections fix - runs later to ensure everything works
  setTimeout(() => {
    console.log('🏦 Emergency bank sections fix running...');
    const locationSelect = document.getElementById('hotel_location_type');
    const achSection = document.getElementById('ach_section');
    const wireSection = document.getElementById('wire_section');
    
    if (locationSelect) {
      console.log('🏦 Emergency fix - found location select, current value:', locationSelect.value);
      
      // Ensure change listener is attached
      locationSelect.addEventListener('change', function(e) {
        console.log('🏦 Emergency listener - location changed to:', e.target.value);
        
        // Force immediate toggle
        if (typeof toggleBankSections === 'function') {
          toggleBankSections();
        }
        
        // Also try manual toggle as backup
        const achSec = document.getElementById('ach_section');
        const wireSec = document.getElementById('wire_section');
        
        if (achSec) achSec.style.display = 'none';
        if (wireSec) wireSec.style.display = 'none';
        
        if (e.target.value === 'US' && achSec) {
          achSec.style.display = 'block';
          console.log('🏦 Emergency fix - ACH section shown');
        } else if (e.target.value === 'International' && wireSec) {
          wireSec.style.display = 'block';
          console.log('🏦 Emergency fix - Wire section shown');
        }
      });
      
      // Trigger initial toggle
      if (locationSelect.value) {
        console.log('🏦 Emergency fix - triggering initial toggle for:', locationSelect.value);
        locationSelect.dispatchEvent(new Event('change'));
      }
    } else {
      console.error('🏦 Emergency fix - location select not found!');
    }
  }, 2000);
}, 500); // Run after other scripts

</script>

<!-- Missing Functions Fix Script -->
<script src="/missing-functions-fix.js"></script>

</body>
</html>

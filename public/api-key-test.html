<!DOCTYPE html>
<html>
<head>
    <title>Google Places API Key Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Google Places API Key Test</h1>
        <p>This page tests your Google Places API key configuration.</p>
        
        <button id="testButton">Test API Key</button>
        
        <div id="result" class="test-result" style="display: none;"></div>
    </div>

    <script>
        document.getElementById('testButton').addEventListener('click', async function() {
            const button = this;
            const result = document.getElementById('result');
            
            // Disable button during test
            button.disabled = true;
            button.textContent = 'Testing...';
            
            // Show pending result
            result.className = 'test-result pending';
            result.textContent = 'Testing API key configuration...';
            result.style.display = 'block';
            
            try {
                // Fetch the API key from our server
                const keyResponse = await fetch('/api/google-places-key');
                const keyData = await keyResponse.json();
                
                if (keyData.mockMode) {
                    result.className = 'test-result error';
                    result.textContent = `MOCK MODE ACTIVE

Reason: ${keyData.message || 'API key not properly configured'}

In mock mode, the application uses sample data instead of real API calls.`;
                    return;
                }
                
                if (!keyData.apiKey) {
                    result.className = 'test-result error';
                    result.textContent = 'ERROR: No API key found in server response';
                    return;
                }
                
                // Test the Google Places API directly
                const response = await fetch(`https://places.googleapis.com/v1/places:searchText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-Api-Key': keyData.apiKey,
                        'X-Goog-FieldMask': 'places.id,places.displayName'
                    },
                    body: JSON.stringify({
                        textQuery: 'hotel',
                        maxResultCount: 3
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.className = 'test-result success';
                    result.textContent = `SUCCESS!

API Key is valid and working.

Status: ${response.status} ${response.statusText}
Results: ${data.places ? data.places.length : 0} places found

You can now use the Google Places API in your application.`;
                } else {
                    result.className = 'test-result error';
                    result.textContent = `ERROR!

API Key validation failed.

Status: ${response.status} ${response.statusText}
Error: ${JSON.stringify(data, null, 2)}

Troubleshooting steps:
1. Check if the API key is correct
2. Verify API key restrictions in Google Cloud Console
3. Ensure "Places API (New)" is enabled
4. Confirm billing is enabled for your project`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `ERROR!

Failed to test API key: ${error.message}

Troubleshooting steps:
1. Check your internet connection
2. Verify the server is running
3. Check if the API endpoint is accessible`;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Test API Key';
            }
        });
    </script>
</body>
</html>
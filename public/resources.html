<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Per Diem Lookup – FEDEVENT</title>
  <link rel="stylesheet" href="/site.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- D3 + TopoJSON for accurate US state map rendering -->
  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
    <style>
    #mapWrap { width: 100%; background: #ffffff; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    svg.us { width: 100%; height: auto; display:block; }
    .state { fill:#e6f0fb; stroke:#b7c6d9; stroke-width:1; cursor:pointer; transition: fill .15s ease; }
    .state:hover { fill:#bcd8ff; }
    .state-label { font: 10px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; fill:#334155; pointer-events:none; text-anchor: middle; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header>
    <nav class="container">
      <div class="logo-menu" style="position: relative;">
        <a href="javascript:void(0)" class="logo" onclick="toggleLogoDropdown(event)">FEDEVENT <span style="font-size: 0.7em;">▾</span></a>
        <div class="logo-dropdown" id="logoDropdown" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 200px; display: none; z-index: 1000;">
          <a href="/" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Home</a>
          <a href="/hotel-signup.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Hotel Registration</a>
          <a href="/hotel-login.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Hotel Portal</a>
          <a href="/government-portal.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Government Portal</a>
          <a href="/resources.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151; border-bottom: 1px solid #f3f4f6;">Resources</a>
          <a href="/about.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #374151;">About</a>
        </div>
      </div>
      <ul class="nav-links">
        <li id="userMenu" class="user-menu" style="display:none;">
          <a class="user-trigger" href="javascript:void(0)" onclick="toggleUserDropdown(event)">
            <span class="user-avatar" id="userInitial">U</span>
            <span id="userNameLabel">User</span>
            <span aria-hidden>▾</span>
          </a>
          <div class="user-dropdown" id="userDropdown">
            <a href="/hotel-dashboard.html">Hotel Portal</a>
            <a href="/user-profile.html">User Settings</a>
            <button type="button" onclick="logoutUser()">Logout</button>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6" style="margin-top: 80px;">
    <!-- Controls Panel -->
    <section class="bg-white rounded-2xl shadow p-5">
      <h2 class="text-lg font-semibold mb-1">Search Per Diem</h2>
      <p class="text-sm text-gray-600 mb-4">Search by State and City OR by ZIP code. Click a state on the map to list all per diem locations for that state (GSA style).</p>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
        <div>
          <label class="block text-sm font-medium">State</label>
          <select id="stateSelect" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-black/10 p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">City</label>
          <select id="citySelect" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-black/10 p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">OR ZIP Code</label>
          <input id="zipInput" type="text" inputmode="numeric" pattern="[0-9]{5}" maxlength="5" placeholder="e.g., 30301" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-black/10 p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Fiscal Year</label>
          <select id="yearSelect" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-black/10 p-2"></select>
        </div>
      </div>

      <div class="flex gap-3">
        <button id="lookupBtn" class="inline-flex items-center justify-center rounded-xl bg-black text-white px-4 py-2 font-medium hover:bg-gray-800">
          <span id="lookupText">Find rates</span>
          <span id="lookupSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"></span>
        </button>
        <button id="resetBtn" class="inline-flex items-center justify-center rounded-xl bg-white border px-4 py-2 font-medium hover:bg-gray-50">Reset</button>
      </div>
    </section>

    <!-- Available Cities for selected state -->
    <section id="cityListCard" class="bg-white rounded-2xl shadow p-5 hidden">
      <h3 class="text-lg font-semibold mb-2">Available Cities</h3>
      <div id="cityListBody" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
    </section>

    <!-- Results (moved directly under the search form) -->
    <section id="resultCard" class="bg-white rounded-2xl shadow p-5 hidden">
      <h3 class="text-xl font-semibold mb-3">Per Diem</h3>
      <div id="resultBody" class="space-y-3 text-base"></div>
    </section>

    <!-- Available Cities for selected state (moved above the map) -->
    <section id="cityListCard" class="bg-white rounded-2xl shadow p-5 hidden">
      <h3 class="text-xl font-semibold mb-3">Available Cities</h3>
      <div id="cityListBody" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <!-- US Map (SVG rendered by D3 from TopoJSON) -->
    <section class="bg-white rounded-2xl shadow p-5">
      <h2 class="text-lg font-semibold mb-3">Click a State</h2>
      <div id="mapWrap" class="overflow-hidden">
        <svg id="usSvg" class="us" viewBox="0 0 975 610" aria-label="United States map"></svg>
      </div>
      <p class="text-xs text-gray-500 mt-3">Data via GSA Per Diem API (through your server proxy). Click a state to list its cities.</p>
    </section>
    </main>

    <script>
    // --- State list & helpers ---
    const STATES = [
      ["AL","Alabama"],["AK","Alaska"],["AZ","Arizona"],["AR","Arkansas"],["CA","California"],["CO","Colorado"],["CT","Connecticut"],["DE","Delaware"],["DC","District of Columbia"],["FL","Florida"],["GA","Georgia"],["HI","Hawaii"],["ID","Idaho"],["IL","Illinois"],["IN","Indiana"],["IA","Iowa"],["KS","Kansas"],["KY","Kentucky"],["LA","Louisiana"],["ME","Maine"],["MD","Maryland"],["MA","Massachusetts"],["MI","Michigan"],["MN","Minnesota"],["MS","Mississippi"],["MO","Missouri"],["MT","Montana"],["NE","Nebraska"],["NV","Nevada"],["NH","New Hampshire"],["NJ","New Jersey"],["NM","New Mexico"],["NY","New York"],["NC","North Carolina"],["ND","North Dakota"],["OH","Ohio"],["OK","Oklahoma"],["OR","Oregon"],["PA","Pennsylvania"],["PR","Puerto Rico"],["RI","Rhode Island"],["SC","South Carolina"],["SD","South Dakota"],["TN","Tennessee"],["TX","Texas"],["UT","Utah"],["VT","Vermont"],["VA","Virginia"],["WA","Washington"],["WV","West Virginia"],["WI","Wisconsin"],["WY","Wyoming"]
    ];
    const FIPS_TO_ABBR = {"01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT","10":"DE","11":"DC","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN","19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD","25":"MA","26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE","32":"NV","33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND","39":"OH","40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD","47":"TN","48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV","55":"WI","56":"WY","72":"PR"};

    const stateSelect = document.getElementById('stateSelect');
    const citySelect = document.getElementById('citySelect');
    const zipInput = document.getElementById('zipInput');
    const yearSelect = document.getElementById('yearSelect');
    const lookupBtn = document.getElementById('lookupBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultCard = document.getElementById('resultCard');
    const resultBody = document.getElementById('resultBody');

    // Populate dropdowns
    (function initDropdowns(){
      stateSelect.innerHTML = '<option value="">Select state…</option>' + STATES.map(([ab,n])=>`<option value="${ab}">${n}</option>`).join('');
      const now = new Date();
      const fy = now.getFullYear();
      const years = [fy-1, fy, fy+1, fy+2];
      yearSelect.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      yearSelect.value = fy;
      citySelect.innerHTML = '<option value="">(Select state first)</option>';
    })();

    function renderCityList(cities, stateAbbr) {
      const card = document.getElementById('cityListCard');
      const body = document.getElementById('cityListBody');
      if (!cities || !cities.length) {
        body.innerHTML = '<div class="text-sm text-gray-600">No cities found for this state and year.</div>';
        card.classList.remove('hidden');
        return;
      }
      body.innerHTML = cities.map(c => `
        <button data-city="${c}" class="text-left city-card-item px-3 py-2 rounded-lg border hover:bg-gray-50">
          <span class="font-medium">${c}</span>
          <span class="ml-1 text-gray-500">(${stateAbbr})</span>
        </button>
      `).join('');
      card.classList.remove('hidden');

      // Wire clicks to fetch city-specific rates
      body.querySelectorAll('[data-city]').forEach(el => {
        el.addEventListener('click', async () => {
          const city = el.getAttribute('data-city');
          const state = stateAbbr;
          const year = yearSelect.value || '';
          try {
            const data = await fetchPerDiem({ city, state, year });
            const rows = Array.isArray(data?.rows) ? data.rows : (data ? [data] : []);
            showResultTable(rows, `City: ${city}, ${state}`);
          } catch (_) { alert('API error'); }
        });
      });
    }

    function showResultTable(rows, heading) {
      if (!rows || !rows.length) {
        resultBody.innerHTML = `<div>No data returned. Try a different month/year or input.</div>`;
        resultCard.classList.remove('hidden');
        return;
      }
      const table = `
        <div class="mb-2 text-sm text-gray-600">${heading || ''}</div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-left p-2 border">Location</th>
                <th class="text-left p-2 border">Lodging (nightly)</th>
                <th class="text-left p-2 border">M&IE</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => `
                <tr>
                  <td class="p-2 border">${r.location || '—'}</td>
                  <td class="p-2 border">$${Number(r.lodging||0).toFixed(2)}</td>
                  <td class="p-2 border">$${Number(r.mie||0)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      resultBody.innerHTML = table;
      resultCard.classList.remove('hidden');
    }

    async function fetchPerDiem(params) {
      const url = new URL('/api/perdiem', window.location.origin);
      if (params.state) url.searchParams.set('state', params.state);
      if (params.city) url.searchParams.set('city', params.city);
      if (params.zip) url.searchParams.set('zip', params.zip);
      if (params.year) url.searchParams.set('year', params.year);
      // month removed
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('API error');
      return res.json();
    }

    // Search button — by City/State or ZIP
    lookupBtn.addEventListener('click', async () => {
      try {
        // Show loading state
        document.getElementById('lookupText').textContent = 'Loading...';
        document.getElementById('lookupSpinner').classList.remove('hidden');
        lookupBtn.disabled = true;
        
        // Get search parameters
        const params = {
          state: stateSelect.value || '',
          city: citySelect.value || '',
          zip: zipInput.value.trim(),
          year: yearSelect.value || ''
        };
        
        // Validate input - either state/city or zip must be provided
        if (!params.zip && !params.state) {
          alert('Please select a state or enter a ZIP code');
          // Reset button state
          document.getElementById('lookupText').textContent = 'Find rates';
          document.getElementById('lookupSpinner').classList.add('hidden');
          lookupBtn.disabled = false;
          return;
        }
        
        // If ZIP is provided, use only ZIP (ignore state/city)
        if (params.zip) {
          // Validate ZIP code format
          if (!/^\d{5}$/.test(params.zip)) {
            alert('Please enter a valid 5-digit ZIP code');
            // Reset button state
            document.getElementById('lookupText').textContent = 'Find rates';
            document.getElementById('lookupSpinner').classList.add('hidden');
            lookupBtn.disabled = false;
            return;
          }
          // Clear state/city when using ZIP
          params.state = '';
          params.city = '';
        }
        
        // Small delay to show loading state
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Navigate to full-year results page
        const qs = new URLSearchParams({ year: params.year });
        if (params.state) qs.set('state', params.state);
        if (params.city) qs.set('city', params.city);
        if (params.zip) qs.set('zip', params.zip);
        window.location.href = `/perdiem-results.html?${qs.toString()}`;
      } catch (e) { 
        // Reset button state on error
        document.getElementById('lookupText').textContent = 'Find rates';
        document.getElementById('lookupSpinner').classList.add('hidden');
        lookupBtn.disabled = false;
        alert('API error'); 
      }
    });

    resetBtn.addEventListener('click', () => {
      stateSelect.value = '';
      citySelect.innerHTML = '<option value="">(Select state first)</option>';
      zipInput.value = '';
      const now = new Date();
      yearSelect.value = now.getFullYear();
      resultCard.classList.add('hidden');
      document.getElementById('cityListCard').classList.add('hidden');
    });

    // When user selects a state in the form, list its available cities
    stateSelect.addEventListener('change', async () => {
      const state = stateSelect.value;
      if (!state) {
        document.getElementById('cityListCard').classList.add('hidden');
        return;
      }
      const year = yearSelect.value || '';
      try {
        // Use normalized endpoint so mock and real both work
        const data = await fetchPerDiem({ state, year });
        const rows = Array.isArray(data?.rows) ? data.rows : [];
        // Derive city names from rows.location (e.g., "Los Angeles, CA")
        const citySet = new Set();
        for (const r of rows) {
          const loc = String(r.location || '').trim();
          if (!loc) continue;
          const city = loc.split(',')[0].trim();
          if (city && city.toLowerCase() !== 'standard rate') citySet.add(city);
        }
        const cities = Array.from(citySet).sort((a,b)=>a.localeCompare(b));
        renderCityList(cities, state);
      } catch (_) {
        alert('API error');
      }
    });

    // Populate city dropdown from GSA-backed endpoint when state changes
    stateSelect.addEventListener('change', async () => {
      const state = stateSelect.value;
      const year = yearSelect.value || String(new Date().getFullYear());
      citySelect.innerHTML = '<option value="">Loading cities…</option>';
      if (!state) {
        citySelect.innerHTML = '<option value="">(Select state first)</option>';
        return;
      }
      try {
        // Prefer GSA state/year endpoint to mirror official city list
        const url = new URL(`/api/gsa/rates/state/${encodeURIComponent(state)}/year/${encodeURIComponent(year)}`, window.location.origin);
        const rsp = await fetch(url.toString());
        if (rsp.ok) {
          const payload = await rsp.json();
          const raw = payload?.data;
          const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.rates) ? raw.rates : []);
          const cities = Array.from(new Set(arr.map(x => (x.City || x.city || x.location || '').split(',')[0].trim())
            .filter(c => c && c.toLowerCase() !== 'standard rate'))).sort((a,b)=>a.localeCompare(b));
          if (cities.length) {
            citySelect.innerHTML = '<option value="">(All cities)</option>' + cities.map(c=>`<option value="${c}">${c}</option>`).join('');
            return;
          }
        }
        // Fallback to normalized endpoint
        const fallback = await fetchPerDiem({ state, year });
        const rows = Array.isArray(fallback?.rows) ? fallback.rows : [];
        const citySet = new Set();
        rows.forEach(r => { const loc = String(r.location||''); const city = loc.split(',')[0].trim(); if (city && city.toLowerCase() !== 'standard rate') citySet.add(city); });
        const cities = Array.from(citySet).sort((a,b)=>a.localeCompare(b));
        citySelect.innerHTML = '<option value="">(All cities)</option>' + cities.map(c=>`<option value="${c}">${c}</option>`).join('');
      } catch (e) {
        citySelect.innerHTML = '<option value="">(All cities)</option>';
      }
    });

    // Clear ZIP input when state is selected
    stateSelect.addEventListener('change', () => {
      if (stateSelect.value) {
        zipInput.value = '';
      }
    });

    // Clear state/city when ZIP is entered
    zipInput.addEventListener('input', () => {
      if (zipInput.value.trim()) {
        stateSelect.value = '';
        citySelect.innerHTML = '<option value="">(Select state first)</option>';
        document.getElementById('cityListCard').classList.add('hidden');
      }
    });

    // ---- Render the US map with D3 from TopoJSON
    const svg = d3.select('#usSvg');
    const g = svg.append('g');
    const width = 975, height = 610;
    const projection = d3.geoAlbersUsa().scale(1300).translate([width/2, height/2]);
    const path = d3.geoPath(projection);

    fetch('https://unpkg.com/us-atlas@3/states-10m.json')
      .then(r => r.json())
      .then(us => {
        const states = topojson.feature(us, us.objects.states).features;
        g.selectAll('path.state')
          .data(states)
          .enter()
          .append('path')
          .attr('class','state')
          .attr('d', path)
          .on('click', (event, d) => {
            const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
            if (!abbr) return;
            const year = yearSelect.value || '';
            const params = new URLSearchParams({ state: abbr, year: year });
            // Go to full-year results for the state
            window.location.href = `/perdiem-results.html?${params.toString()}`;
          });

        // Borders overlay
        g.append('path')
          .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
          .attr('fill','none')
          .attr('stroke','#94a3b8')
          .attr('stroke-width',0.8)
          .attr('d', path);

        // Labels
        g.selectAll('text.state-label')
          .data(states)
          .enter()
          .append('text')
          .attr('class','state-label')
          .attr('transform', d => `translate(${path.centroid(d)})`)
          .text(d => FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '')
          .attr('opacity', 0.8);
      });
    </script>

        <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>FEDEVENT</h3>
                    <p>Professional event planning services for U.S. Government agencies.</p>
                </div>
                <div class="footer-section">
                    <h3>Services</h3>
                    <a href="/hotel-signup.html">Hotel Sourcing</a>
                    <a href="/contact.html">Event Planning</a>
                    <a href="/government-portal.html">Venue Matching</a>
                    <a href="/support-ticket.html">Support Ticket</a>
                </div>
                <div class="footer-section footer-contact">
                    <h3>Contact</h3>
                    <p>Email: info@fedevent.com</p>
                    <p>Phone: (305) 850-7848</p>
                    <a href="/admin-login.html" style="color: #d1d5db; text-decoration: none; margin-top: 10px; display: inline-block; padding: 5px 10px; border: 1px solid #374151; border-radius: 4px; font-size: 0.9rem;">
                        🔐 Admin Access
                    </a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>fedevent.com is a service of CREATA Global Event Agency LLC</p>
                <p>&copy; 2025 FEDEVENT. All rights reserved.</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">
                    <a href="/admin-login.html" style="color: #9ca3af; text-decoration: none; border-bottom: 1px dotted #9ca3af;">
                        🔐 Admin Sign In
                    </a>
                </p>
            </div>
        </div>
    </footer>

    <style>
        /* Footer Styles */
        footer {
            background: var(--text, #1f2937);
            color: white;
            padding: 3rem 0 1rem;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-section h3 {
            margin-bottom: 1rem;
            color: var(--secondary, #f59e0b);
        }

        .footer-section a {
            display: block;
            color: #d1d5db;
            text-decoration: none;
            margin-bottom: 0.5rem;
            transition: color 0.2s;
        }

        .footer-section a:hover {
            color: var(--secondary, #f59e0b);
        }

        .footer-contact {
            text-align: right;
        }

        .footer-bottom {
            border-top: 1px solid #374151;
            padding-top: 2rem;
            text-align: center;
            color: #9ca3af;
        }

        /* Responsive Footer */
        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .footer-contact {
                text-align: left;
            }
        }
    </style>
    
    <script>
        function toggleUserDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const dd = document.getElementById('userDropdown');
            dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
        }

        function toggleLogoDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const dd = document.getElementById('logoDropdown');
            dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
        }

        function logoutUser() {
            localStorage.removeItem('fedevent_session');
            localStorage.removeItem('fedevent_user');
            window.location.href = '/hotel-login.html';
        }

        function loadUserMenu() {
            try {
                const sessionId = localStorage.getItem('fedevent_session');
                const userRaw = localStorage.getItem('fedevent_user');
                if (!sessionId || !userRaw) return;
                const user = JSON.parse(userRaw);
                let name = user.first_name && user.last_name ? `${user.first_name} ${user.last_name}` : (user.first_name || user.username || user.email || 'User');
                name = name.replace(/\b(Hotel|User)\b/gi, '').trim();
                const initial = (name || 'U').trim().charAt(0).toUpperCase();
                document.getElementById('userNameLabel').textContent = name;
                document.getElementById('userInitial').textContent = initial;
                document.getElementById('userMenu').style.display = 'list-item';
            } catch (e) { /* noop */ }
        }

        document.addEventListener('DOMContentLoaded', loadUserMenu);

        document.addEventListener('click', function(evt){
            const userDd = document.getElementById('userDropdown');
            const logoDd = document.getElementById('logoDropdown');
            const um = document.getElementById('userMenu');
            const logoMenu = document.querySelector('.logo-menu');
            
            if (userDd && um && !um.contains(evt.target)) userDd.style.display = 'none';
            if (logoDd && logoMenu && !logoMenu.contains(evt.target)) logoDd.style.display = 'none';
        });
    </script>
    <script src="/footer.js"></script>
</body>
</html>
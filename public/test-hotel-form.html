<!DOCTYPE html>
<html>
<head>
    <title>Test Hotel Form</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #results { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
        .autocomplete-suggestions { 
            border: 1px solid #ccc; 
            max-height: 200px; 
            overflow-y: auto; 
            position: absolute; 
            background: white; 
            width: calc(100% - 32px); 
            z-index: 1000; 
        }
        .suggestion-item { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid #eee; 
        }
        .suggestion-item:hover { 
            background-color: #f5f5f5; 
        }
    </style>
</head>
<body>
    <h1>Test Hotel Registration Form</h1>
    
    <div class="form-group">
        <label for="hotel_address">Hotel Address:</label>
        <input id="hotel_address" type="text" placeholder="Start typing a hotel address...">
    </div>
    
    <div class="form-group">
        <label for="hotel_name">Hotel Name:</label>
        <input id="hotel_name" type="text" placeholder="Hotel name will be auto-filled">
    </div>
    
    <div class="form-group">
        <label for="hotel_phone">Hotel Phone:</label>
        <input id="hotel_phone" type="text" placeholder="Hotel phone will be auto-filled">
    </div>
    
    <button onclick="testForm()">Test Form</button>
    
    <div id="results"></div>

    <script>
        let googlePlacesApiKey = null;
        
        // Test the form
        async function testForm() {
            try {
                // Fetch the API key from the server
                const response = await fetch('/api/google-places-key');
                
                if (!response.ok) {
                    document.getElementById('results').innerHTML = 
                        `<p class="error">Failed to get API key: ${response.status} ${response.statusText}</p>`;
                    return;
                }
                
                const data = await response.json();
                
                // Handle mock mode
                if (data.mockMode) {
                    document.getElementById('results').innerHTML = 
                        `<p class="warning">Development Mode: ${data.message}</p>`;
                    setupMockAutocomplete();
                    return;
                }
                
                googlePlacesApiKey = data.apiKey;
                
                if (!googlePlacesApiKey) {
                    document.getElementById('results').innerHTML = 
                        `<p class="error">No API key returned from server</p>`;
                    return;
                }
                
                document.getElementById('results').innerHTML = 
                    `<p class="success">API key retrieved successfully!</p>
                     <p>Key (first 10 chars): ${googlePlacesApiKey.substring(0, 10)}...</p>
                     <p>Setting up autocomplete functionality...</p>`;
                
                // Set up autocomplete functionality
                setupAutocomplete();
                
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        // Set up autocomplete functionality
        function setupAutocomplete() {
            const input = document.getElementById('hotel_address');
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'autocomplete-suggestions';
            suggestionsContainer.style.display = 'none';
            input.parentNode.appendChild(suggestionsContainer);
            
            let debounceTimer;
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timer
                clearTimeout(debounceTimer);
                
                if (query.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                // Debounce the API call
                debounceTimer = setTimeout(() => {
                    searchPlaces(query, suggestionsContainer);
                }, 300);
            });
        }
        
        // Search places using Google Places API
        async function searchPlaces(query, suggestionsContainer) {
            if (!googlePlacesApiKey) return;
            
            try {
                const response = await fetch(`https://places.googleapis.com/v1/places:searchText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-Api-Key': googlePlacesApiKey,
                        'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.internationalPhoneNumber'
                    },
                    body: JSON.stringify({
                        textQuery: query,
                        maxResultCount: 5
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                displaySuggestions(data.places || [], suggestionsContainer);
                
            } catch (error) {
                console.error('Error searching places:', error);
                suggestionsContainer.innerHTML = `<div class="suggestion-item error">Error: ${error.message}</div>`;
                suggestionsContainer.style.display = 'block';
            }
        }
        
        // Display autocomplete suggestions
        function displaySuggestions(places, suggestionsContainer) {
            if (places.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsContainer.innerHTML = places.map(place => 
                `<div class="suggestion-item" onclick="selectPlace('${place.id}')">
                    <div><strong>${place.displayName?.text || 'N/A'}</strong></div>
                    <div>${place.formattedAddress || 'N/A'}</div>
                    <div>${place.internationalPhoneNumber || ''}</div>
                </div>`
            ).join('');
            
            suggestionsContainer.style.display = 'block';
        }
        
        // Select a place from suggestions
        async function selectPlace(placeId) {
            if (!googlePlacesApiKey) return;
            
            try {
                // Get detailed place information
                const response = await fetch(`https://places.googleapis.com/v1/places/${placeId}`, {
                    method: 'GET',
                    headers: {
                        'X-Goog-Api-Key': googlePlacesApiKey,
                        'X-Goog-FieldMask': 'id,displayName,formattedAddress,internationalPhoneNumber,websiteUri'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to get place details: ${response.status}: ${errorText}`);
                }
                
                const place = await response.json();
                
                // Hide suggestions
                document.querySelector('.autocomplete-suggestions').style.display = 'none';
                
                // Display selected place in form fields
                document.getElementById('hotel_name').value = place.displayName?.text || '';
                document.getElementById('hotel_phone').value = place.internationalPhoneNumber || '';
                
                document.getElementById('results').innerHTML += 
                    `<p class="success">Place selected and form fields populated!</p>`;
                
                // Clear input
                document.getElementById('hotel_address').value = '';
                
            } catch (error) {
                console.error('Error getting place details:', error);
                document.getElementById('results').innerHTML += 
                    `<p class="error">Error getting place details: ${error.message}</p>`;
            }
        }
        
        // Setup mock autocomplete for development mode
        function setupMockAutocomplete() {
            const input = document.getElementById('hotel_address');
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'autocomplete-suggestions';
            suggestionsContainer.style.display = 'none';
            input.parentNode.appendChild(suggestionsContainer);
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                // Mock suggestions
                const mockPlaces = [
                    {id: '1', displayName: {text: 'Hyatt Place Louisville East'}, formattedAddress: '123 Main Street, Louisville, KY 40202', internationalPhoneNumber: '(555) 123-4567'},
                    {id: '2', displayName: {text: 'Holiday Inn Express'}, formattedAddress: '456 Oak Avenue, Louisville, KY 40203', internationalPhoneNumber: '(555) 987-6543'}
                ];
                
                suggestionsContainer.innerHTML = mockPlaces.map(place => 
                    `<div class="suggestion-item" onclick="selectMockPlace('${place.id}')">
                        <div><strong>${place.displayName.text}</strong></div>
                        <div>${place.formattedAddress}</div>
                        <div>${place.internationalPhoneNumber}</div>
                    </div>`
                ).join('');
                
                suggestionsContainer.style.display = 'block';
            });
        }
        
        // Select a mock place
        function selectMockPlace(placeId) {
            // Mock place data
            const mockPlaces = {
                '1': {displayName: {text: 'Hyatt Place Louisville East'}, internationalPhoneNumber: '(555) 123-4567'},
                '2': {displayName: {text: 'Holiday Inn Express'}, internationalPhoneNumber: '(555) 987-6543'}
            };
            
            const place = mockPlaces[placeId];
            
            // Hide suggestions
            document.querySelector('.autocomplete-suggestions').style.display = 'none';
            
            // Display selected place in form fields
            document.getElementById('hotel_name').value = place.displayName.text;
            document.getElementById('hotel_phone').value = place.internationalPhoneNumber;
            
            document.getElementById('results').innerHTML += 
                `<p class="success">Mock place selected and form fields populated!</p>`;
            
            // Clear input
            document.getElementById('hotel_address').value = '';
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const autocomplete = document.getElementById('hotel_address');
            const suggestions = document.querySelector('.autocomplete-suggestions');
            
            if (suggestions && !autocomplete.contains(event.target) && !suggestions.contains(event.target)) {
                suggestions.style.display = 'none';
            }
        });
    </script>
</body>
</html>